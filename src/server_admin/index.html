<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Overview</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Global Navbar */

ul#globalnav {
    background-color: #ededed;

    list-style: none;
    width: 100%;
    margin: 0;
    padding: 0;

    overflow: hidden;
    position: fixed;
    left: 0px;
    top: 0px;
    font-size: 0.6em;
    height: 30px;
}

ul#globalnav::after {
    content: "";
    display: block;
    clear: both;
}

ul#globalnav li {
    float: left;
}

ul#globalnav li a {
    display: inline-block;
    color: #004670;
    text-align: center;
    padding: 0.75em;
    text-decoration: none;
}

ul#globalnav li a:hover {
    color: #428bca;
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    ul#globalnav {
        font-size: 0.75em;
        height: 40px;
    }

    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    ul#globalnav {
        font-size: 1em;
        height: 48px;
    }

    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}

</style>

<style>
/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#features">1.1. Features</a></li>
<li><a href="#how-does-security-work">1.2. How Does Security Work?</a></li>
<li><a href="#core-concepts-and-terms">1.3. Core Concepts and Terms</a></li>
</ul>
</li>
<li><a href="#server-initialization">2. Server Initialization</a></li>
<li><a href="#admin-console">3. Admin Console</a>
<ul class="sectlevel2">
<li><a href="#the-master-realm">3.1. The Master Realm</a></li>
<li><a href="#_create-realm">3.2. Create a New Realm</a></li>
<li><a href="#_ssl_modes">3.3. SSL Mode</a></li>
<li><a href="#_clear-cache">3.4. Clearing Server Caches</a></li>
<li><a href="#_email">3.5. Email Settings</a></li>
<li><a href="#_themes">3.6. Themes and Internationalization</a>
<ul class="sectlevel3">
<li><a href="#internationalization">3.6.1. Internationalization</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#user-management">4. User Management</a>
<ul class="sectlevel2">
<li><a href="#searching-for-users">4.1. Searching For Users</a></li>
<li><a href="#_create-new-user">4.2. Creating New Users</a></li>
<li><a href="#user-attributes">4.3. User Attributes</a></li>
<li><a href="#user-credentials">4.4. User Credentials</a>
<ul class="sectlevel3">
<li><a href="#changing-passwords">4.4.1. Changing Passwords</a></li>
<li><a href="#changing-otps">4.4.2. Changing OTPs</a></li>
</ul>
</li>
<li><a href="#required-actions">4.5. Required Actions</a>
<ul class="sectlevel3">
<li><a href="#default-required-actions">4.5.1. Default Required Actions</a></li>
<li><a href="#terms-and-conditions">4.5.2. Terms and Conditions</a></li>
</ul>
</li>
<li><a href="#impersonation">4.6. Impersonation</a></li>
<li><a href="#_user-registration">4.7. User Registration</a>
<ul class="sectlevel3">
<li><a href="#_recaptcha">4.7.1. reCAPTCHA Support</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#login-page-settings">5. Login Page Settings</a>
<ul class="sectlevel2">
<li><a href="#forgot-password">5.1. Forgot Password</a></li>
<li><a href="#remember-me">5.2. Remember Me</a></li>
</ul>
</li>
<li><a href="#authentication">6. Authentication</a>
<ul class="sectlevel2">
<li><a href="#_password-policies">6.1. Password Policies</a>
<ul class="sectlevel3">
<li><a href="#password-policy-types">6.1.1. Password Policy Types</a></li>
</ul>
</li>
<li><a href="#otp-policies">6.2. OTP Policies</a>
<ul class="sectlevel3">
<li><a href="#totp-vs-hotp">6.2.1. TOTP vs. HOTP</a></li>
<li><a href="#totp-configuration-options">6.2.2. TOTP Configuration Options</a></li>
<li><a href="#hotp-configuration-options">6.2.3. HOTP Configuration Options</a></li>
</ul>
</li>
<li><a href="#_authentication-flows">6.3. Authentication Flows</a></li>
<li><a href="#executions">6.4. Executions</a></li>
<li><a href="#_kerberos">6.5. Kerberos</a>
<ul class="sectlevel3">
<li><a href="#setup-of-kerberos-server">6.5.1. Setup of Kerberos server</a></li>
<li><a href="#setup-and-configuration-of-keycloak-server">6.5.2. Setup and configuration of Keycloak server</a></li>
<li><a href="#setup-and-configuration-of-client-machines">6.5.3. Setup and configuration of client machines</a></li>
<li><a href="#example-setups">6.5.4. Example setups</a></li>
<li><a href="#credential-delegation">6.5.5. Credential Delegation</a></li>
<li><a href="#troubleshooting">6.5.6. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#features-2">6.6. Features</a>
<ul class="sectlevel3">
<li><a href="#supported-certificate-identity-sources">6.6.1. Supported Certificate Identity Sources</a></li>
<li><a href="#regular-expressions">6.6.2. Regular Expressions</a></li>
<li><a href="#mapping-certificate-identity-to-an-existing-user">6.6.3. Mapping certificate identity to an existing user</a></li>
<li><a href="#other-features-extended-certificate-validation">6.6.4. Other Features: Extended Certificate Validation</a></li>
</ul>
</li>
<li><a href="#enable-x-509-client-certificate-user-authentication">6.7. Enable X.509 Client Certificate User Authentication</a>
<ul class="sectlevel3">
<li><a href="#enable-mutual-ssl-in-wildfly">6.7.1. Enable mutual SSL in WildFly</a></li>
<li><a href="#enable-https-listener">6.7.2. Enable https listener</a></li>
</ul>
</li>
<li><a href="#adding-x-509-client-certificate-authentication-to-a-browser-flow">6.8. Adding X.509 Client Certificate Authentication to a Browser Flow</a>
<ul class="sectlevel3">
<li><a href="#configuring-x-509-client-certificate-authentication">6.8.1. Configuring X.509 Client Certificate Authentication</a></li>
</ul>
</li>
<li><a href="#adding-x-509-client-certificate-authentication-to-a-direct-grant-flow">6.9. Adding X.509 Client Certificate Authentication to a Direct Grant Flow</a></li>
<li><a href="#troubleshooting-2">6.10. Troubleshooting</a>
<ul class="sectlevel3">
<li><a href="#direct-grant-authentication-with-x-509">6.10.1. Direct Grant authentication with X.509</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sso-protocols">7. SSO Protocols</a>
<ul class="sectlevel2">
<li><a href="#_oidc">7.1. Open ID Connect</a>
<ul class="sectlevel3">
<li><a href="#_oidc-auth-flows">7.1.1. OIDC Auth Flows</a></li>
<li><a href="#keycloak-server-oidc-uri-endpoints">7.1.2. Keycloak Server OIDC URI Endpoints</a></li>
</ul>
</li>
<li><a href="#_saml">7.2. SAML</a>
<ul class="sectlevel3">
<li><a href="#saml-bindings">7.2.1. SAML Bindings</a></li>
<li><a href="#keycloak-server-saml-uri-endpoints">7.2.2. Keycloak Server SAML URI Endpoints</a></li>
</ul>
</li>
<li><a href="#openid-connect-vs-saml">7.3. OpenID Connect vs. SAML</a></li>
<li><a href="#_docker">7.4. Docker Registry v2 Authentication</a>
<ul class="sectlevel3">
<li><a href="#docker-auth-flow">7.4.1. Docker Auth Flow</a></li>
<li><a href="#keycloak-docker-registry-v2-authentication-server-uri-endpoints">7.4.2. Keycloak Docker Registry v2 Authentication Server URI Endpoints</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_clients">8. Managing Clients</a>
<ul class="sectlevel2">
<li><a href="#oidc-clients">8.1. OIDC Clients</a>
<ul class="sectlevel3">
<li><a href="#_client-credentials">8.1.1. Confidential Client Credentials</a></li>
</ul>
</li>
<li><a href="#_service_accounts">8.2. Service Accounts</a></li>
<li><a href="#saml-clients">8.3. SAML Clients</a>
<ul class="sectlevel3">
<li><a href="#idp-initiated-login">8.3.1. IDP Initiated Login</a></li>
<li><a href="#saml-entity-descriptors">8.3.2. SAML Entity Descriptors</a></li>
</ul>
</li>
<li><a href="#client-links">8.4. Client Links</a></li>
<li><a href="#_protocol-mappers">8.5. OIDC Token and SAML Assertion Mappings</a></li>
<li><a href="#generating-client-adapter-config">8.6. Generating Client Adapter Config</a></li>
<li><a href="#_client_templates">8.7. Client Templates</a></li>
</ul>
</li>
<li><a href="#roles">9. Roles</a>
<ul class="sectlevel2">
<li><a href="#realm-roles">9.1. Realm Roles</a></li>
<li><a href="#client-roles">9.2. Client Roles</a></li>
<li><a href="#_composite-roles">9.3. Composite Roles</a></li>
<li><a href="#user-role-mappings">9.4. User Role Mappings</a>
<ul class="sectlevel3">
<li><a href="#default-roles">9.4.1. Default Roles</a></li>
</ul>
</li>
<li><a href="#_client_scope">9.5. Client Scope</a></li>
</ul>
</li>
<li><a href="#groups">10. Groups</a>
<ul class="sectlevel2">
<li><a href="#groups-vs-roles">10.1. Groups vs. Roles</a></li>
<li><a href="#default-groups">10.2. Default Groups</a></li>
</ul>
</li>
<li><a href="#_admin_permissions">11. Admin Console Access Control and Permissions</a>
<ul class="sectlevel2">
<li><a href="#master-realm-access-control">11.1. Master Realm Access Control</a>
<ul class="sectlevel3">
<li><a href="#global-roles">11.1.1. Global Roles</a></li>
<li><a href="#realm-specific-roles">11.1.2. Realm Specific Roles</a></li>
</ul>
</li>
<li><a href="#_per_realm_admin_permissions">11.2. Dedicated Realm Admin Consoles</a></li>
<li><a href="#_fine_grain_permissions">11.3. Fine Grain Admin Permissions</a>
<ul class="sectlevel3">
<li><a href="#managing-one-specific-client">11.3.1. Managing One Specific Client</a></li>
<li><a href="#restrict-user-role-mapping">11.3.2. Restrict User Role Mapping</a></li>
<li><a href="#full-list-of-permissions">11.3.3. Full List of Permissions</a></li>
</ul>
</li>
<li><a href="#realm_keys">11.4. Realm Keys</a>
<ul class="sectlevel3">
<li><a href="#rotating-keys">11.4.1. Rotating keys</a></li>
<li><a href="#adding-a-generated-keypair">11.4.2. Adding a generated keypair</a></li>
<li><a href="#adding-an-existing-keypair-and-certificate">11.4.3. Adding an existing keypair and certificate</a></li>
<li><a href="#loading-keys-from-a-java-keystore">11.4.4. Loading keys from a Java Keystore</a></li>
<li><a href="#making-keys-passive">11.4.5. Making keys passive</a></li>
<li><a href="#disabling-keys">11.4.6. Disabling keys</a></li>
<li><a href="#compromised-keys">11.4.7. Compromised keys</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_identity_broker">12. Identity Brokering</a>
<ul class="sectlevel2">
<li><a href="#_identity_broker_overview">12.1. Brokering Overview</a></li>
<li><a href="#default_identity_provider">12.2. Default Identity Provider</a></li>
<li><a href="#_general-idp-config">12.3. General Configuration</a></li>
<li><a href="#social-identity-providers">12.4. Social Identity Providers</a>
<ul class="sectlevel3">
<li><a href="#google">12.4.1. Google</a></li>
<li><a href="#facebook">12.4.2. Facebook</a></li>
<li><a href="#twitter">12.4.3. Twitter</a></li>
<li><a href="#github">12.4.4. Github</a></li>
<li><a href="#linkedin">12.4.5. LinkedIn</a></li>
<li><a href="#microsoft">12.4.6. Microsoft</a></li>
<li><a href="#paypal">12.4.7. PayPal</a></li>
<li><a href="#do-the-following-changes">12.4.8. Do the following changes:</a></li>
<li><a href="#stackoverflow">12.4.9. StackOverflow</a></li>
<li><a href="#openshift">12.4.10. Openshift</a></li>
</ul>
</li>
<li><a href="#openid-connect-v1-0-identity-providers">12.5. OpenID Connect v1.0 Identity Providers</a></li>
<li><a href="#saml-v2-0-identity-providers">12.6. SAML v2.0 Identity Providers</a>
<ul class="sectlevel3">
<li><a href="#_identity_broker_saml_sp_descriptor">12.6.1. SP Descriptor</a></li>
</ul>
</li>
<li><a href="#_client_suggested_idp">12.7. Client Suggested Identity Provider</a></li>
<li><a href="#_mappers">12.8. Mapping Claims and Assertions</a></li>
<li><a href="#available-user-session-data">12.9. Available User Session Data</a></li>
<li><a href="#_identity_broker_first_login">12.10. First Login Flow</a>
<ul class="sectlevel3">
<li><a href="#default-first-login-flow">12.10.1. Default First Login Flow</a></li>
</ul>
</li>
<li><a href="#retrieving-external-idp-tokens">12.11. Retrieving External IDP Tokens</a></li>
</ul>
</li>
<li><a href="#user-session-management">13. User Session Management</a>
<ul class="sectlevel2">
<li><a href="#administering-sessions">13.1. Administering Sessions</a>
<ul class="sectlevel3">
<li><a href="#logout-all-limitations">13.1.1. Logout All Limitations</a></li>
<li><a href="#application-drilldown">13.1.2. Application Drilldown</a></li>
<li><a href="#user-drilldown">13.1.3. User Drilldown</a></li>
</ul>
</li>
<li><a href="#_revocation-policy">13.2. Revocation Policies</a></li>
<li><a href="#_timeouts">13.3. Session and Token Timeouts</a></li>
<li><a href="#_offline-access">13.4. Offline Access</a></li>
</ul>
</li>
<li><a href="#_user-storage-federation">14. User Storage Federation</a>
<ul class="sectlevel2">
<li><a href="#adding-a-provider">14.1. Adding a Provider</a></li>
<li><a href="#_ldap">14.2. LDAP and Active Directory</a>
<ul class="sectlevel3">
<li><a href="#storage-mode">14.2.1. Storage Mode</a></li>
<li><a href="#edit-mode">14.2.2. Edit Mode</a></li>
<li><a href="#other-config-options">14.2.3. Other config options</a></li>
<li><a href="#connect-to-ldap-over-ssl">14.2.4. Connect to LDAP over SSL</a></li>
<li><a href="#sync-of-ldap-users-to-keycloak">14.2.5. Sync of LDAP users to Keycloak</a></li>
<li><a href="#_ldap_mappers">14.2.6. LDAP Mappers</a></li>
</ul>
</li>
<li><a href="#_sssd">14.3. SSSD and FreeIPA Identity Management Integration</a>
<ul class="sectlevel3">
<li><a href="#freeipa-idm-server">14.3.1. FreeIPA/IdM Server</a></li>
<li><a href="#sssd-and-d-bus">14.3.2. SSSD and D-Bus</a></li>
<li><a href="#enabling-the-sssd-federation-provider">14.3.3. Enabling the SSSD Federation Provider</a></li>
</ul>
</li>
<li><a href="#configuring-a-federated-sssd-store">14.4. Configuring a Federated SSSD Store</a></li>
<li><a href="#custom-providers">14.5. Custom Providers</a></li>
</ul>
</li>
<li><a href="#auditing-and-events">15. Auditing and Events</a>
<ul class="sectlevel2">
<li><a href="#login-events">15.1. Login Events</a>
<ul class="sectlevel3">
<li><a href="#event-types">15.1.1. Event Types</a></li>
<li><a href="#event-listener">15.1.2. Event Listener</a></li>
</ul>
</li>
<li><a href="#admin-events">15.2. Admin Events</a></li>
</ul>
</li>
<li><a href="#_export_import">16. Export and Import</a>
<ul class="sectlevel2">
<li><a href="#admin-console-export-import">16.1. Admin console export/import</a></li>
</ul>
</li>
<li><a href="#_account-service">17. User Account Service</a>
<ul class="sectlevel2">
<li><a href="#themeable">17.1. Themeable</a></li>
</ul>
</li>
<li><a href="#threat-model-mitigation">18. Threat Model Mitigation</a>
<ul class="sectlevel2">
<li><a href="#password-guess-brute-force-attacks">18.1. Password guess: brute force attacks</a>
<ul class="sectlevel3">
<li><a href="#password-policies">18.1.1. Password Policies</a></li>
</ul>
</li>
<li><a href="#clickjacking">18.2. Clickjacking</a></li>
<li><a href="#ssl-https-requirement">18.3. SSL/HTTPS Requirement</a></li>
<li><a href="#csrf-attacks">18.4. CSRF Attacks</a></li>
<li><a href="#_unspecific-redirect-uris">18.5. Unspecific Redirect URIs</a></li>
<li><a href="#compromised-access-and-refresh-tokens">18.6. Compromised Access and Refresh Tokens</a></li>
<li><a href="#compromised-authorization-code">18.7. Compromised Authorization Code</a></li>
<li><a href="#open-redirectors">18.8. Open redirectors</a></li>
<li><a href="#password-database-compromised">18.9. Password database compromised</a></li>
<li><a href="#limiting-scope">18.10. Limiting Scope</a></li>
<li><a href="#sql-injection-attacks">18.11. SQL Injection Attacks</a></li>
</ul>
</li>
<li><a href="#admin-cli">19. Admin CLI</a>
<ul class="sectlevel2">
<li><a href="#installing-admin-cli">19.1. Installing Admin CLI</a></li>
<li><a href="#using-admin-cli">19.2. Using Admin CLI</a></li>
<li><a href="#authenticating">19.3. Authenticating</a></li>
<li><a href="#_working_with_alternative_configurations">19.4. Working with alternative configurations</a></li>
<li><a href="#basic-operations-and-resource-uris">19.5. Basic operations, and resource URIs</a></li>
<li><a href="#realm-operations">19.6. Realm operations</a></li>
<li><a href="#role-operations">19.7. Role operations</a></li>
<li><a href="#client-operations">19.8. Client operations</a></li>
<li><a href="#user-operations">19.9. User operations</a></li>
<li><a href="#group-operations">19.10. Group operations</a></li>
<li><a href="#identity-providers-operations">19.11. Identity Providers operations</a></li>
<li><a href="#storage-providers-operations">19.12. Storage Providers operations</a></li>
<li><a href="#adding-mappers">19.13. Adding mappers</a></li>
<li><a href="#authentication-operations">19.14. Authentication operations</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak is a single sign on solution for web apps and RESTful web services.  The goal of Keycloak
is to make security simple so that it is easy for application developers to secure the apps and services they have deployed
in their organization.  Security features that developers normally have to write for themselves are provided out of the box
and are easily tailorable to the individual requirements of your organization.  Keycloak provides customizable
user interfaces for login, registration, administration, and account management.  You can also use Keycloak as an
integration platform to hook it into existing LDAP and Active Directory servers.  You can also delegate authentication to third
party identity providers like Facebook and Google+.</p>
</div>
<div class="sect2">
<h3 id="features"><a class="anchor" href="#features"></a>1.1. Features</h3>
<div class="ulist">
<ul>
<li>
<p>Single-Sign On and Single-Sign Out for browser applications.</p>
</li>
<li>
<p>OpenID Connect support.</p>
</li>
<li>
<p>OAuth 2.0 support.</p>
</li>
<li>
<p>SAML support.</p>
</li>
<li>
<p>Identity Brokering - Authenticate with external OpenID Connect or SAML Identity Providers.</p>
</li>
<li>
<p>Social Login - Enable login with Google, GitHub, Facebook, Twitter, and other social networks.</p>
</li>
<li>
<p>User Federation - Sync users from LDAP and Active Directory servers.</p>
</li>
<li>
<p>Kerberos bridge - Automatically authenticate users that are logged-in to a Kerberos server.</p>
</li>
<li>
<p>Admin Console for central management of users, roles, role mappings, clients and configuration.</p>
</li>
<li>
<p>Account Management console that allows users to centrally manage their account.</p>
</li>
<li>
<p>Theme support - Customize all user facing pages to integrate with your applications and branding.</p>
</li>
<li>
<p>Two-factor Authentication - Support for TOTP/HOTP via Google Authenticator or FreeOTP.</p>
</li>
<li>
<p>Login flows - optional user self-registration, recover password, verify email, require password update, etc.</p>
</li>
<li>
<p>Session management - Admins and users themselves can view and manage user sessions.</p>
</li>
<li>
<p>Token mappers - Map user attributes, roles, etc. how you want into tokens and statements.</p>
</li>
<li>
<p>Not-before revocation policies per realm, application and user.</p>
</li>
<li>
<p>CORS support - Client adapters have built-in support for CORS.</p>
</li>
<li>
<p>Service Provider Interfaces (SPI) - A number of SPIs to enable customizing various aspects of the server. Authentication flows, user federation providers,
protocol mappers and many more.</p>
</li>
<li>
<p>Client adapters for JavaScript applications, WildFly, JBoss EAP, Fuse, Tomcat, Jetty, Spring, etc.</p>
</li>
<li>
<p>Supports any platform/language that has an OpenID Connect Resource Provider library or SAML 2.0 Service Provider library.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="how-does-security-work"><a class="anchor" href="#how-does-security-work"></a>1.2. How Does Security Work?</h3>
<div class="paragraph">
<p>Keycloak is a separate server that you manage on your network.  Applications are configured to point to and
be secured by this server.  Keycloak uses open protocol standards like <a href="http://openid.net/connect/">Open ID Connect</a>
or <a href="http://saml.xml.org/saml-specifications">SAML 2.0</a> to secure
your applications.  Browser applications redirect a user&#8217;s browser from the application to the Keycloak authentication
server where they enter their credentials.  This is important because users are completely isolated from applications and
applications never see a user&#8217;s credentials.  Applications instead are given an identity token or assertion that is cryptographically
signed.  These tokens can have identity information like username, address, email, and other profile data.  They can also
hold permission data so that applications can make authorization decisions.  These tokens can also be used to make secure
invocations on REST-based services.</p>
</div>
</div>
<div class="sect2">
<h3 id="core-concepts-and-terms"><a class="anchor" href="#core-concepts-and-terms"></a>1.3. Core Concepts and Terms</h3>
<div class="paragraph">
<p>There are some key concepts and terms you should be aware of before attempting to use Keycloak to secure your web applications
and REST services.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">users</dt>
<dd>
<p>Users are entities that are able to log into your system.  They can have attributes associated with themselves like email,
username, address, phone number, and birth day.  They can be assigned group membership and have specific roles assigned to them.</p>
</dd>
<dt class="hdlist1">authentication</dt>
<dd>
<p>The process of identifying and validating a user.</p>
</dd>
<dt class="hdlist1">authorization</dt>
<dd>
<p>The process of granting access to a user.</p>
</dd>
<dt class="hdlist1">credentials</dt>
<dd>
<p>Credentials are pieces of data that Keycloak uses to verify the identity of a user.  Some examples are passwords,
one-time-passwords, digital certificates, or even fingerprints.</p>
</dd>
<dt class="hdlist1">roles</dt>
<dd>
<p>Roles identify a type or category of user.  <code>Admin</code>, <code>user</code>, <code>manager</code>, and <code>employee</code> are all typical roles that may exist
in an organization.  Applications often assign access and permissions to specific roles rather than individual users as dealing
with users can be too fine grained and hard to manage.</p>
</dd>
<dt class="hdlist1">user role mapping</dt>
<dd>
<p>A user role mapping defines a mapping between a role and a user.  A user can be associated with zero or more roles.  This
role mapping information can be encapsulated into tokens and assertions so that applications can decide access permissions on
various resources they manage.</p>
</dd>
<dt class="hdlist1">composite roles</dt>
<dd>
<p>A composite role is a role that can be associated with other roles.  For example a <code>superuser</code> composite role could be associated with the
<code>sales-admin</code> and <code>order-entry-admin</code> roles.  If a user is mapped to the <code>superuser</code> role they also inherit the <code>sales-admin</code> and <code>order-entry-admin</code> roles.</p>
</dd>
<dt class="hdlist1">groups</dt>
<dd>
<p>Groups manage groups of users.  Attributes can be defined for a group.  You can map roles to a group as well.  Users that become members of a group
inherit the attributes and role mappings that group defines.</p>
</dd>
<dt class="hdlist1">realms</dt>
<dd>
<p>A realm manages a set of users, credentials, roles, and groups.  A user belongs to and logs into a realm.  Realms are isolated from one another
and can only manage and authenticate the users that they control.</p>
</dd>
<dt class="hdlist1">clients</dt>
<dd>
<p>Clients are entities that can request Keycloak to authenticate a user.  Most often, clients are applications and services that
want to use Keycloak to secure themselves and provide a single sign-on solution.  Clients can also be entities that just want to request
identity information or an access token so that they can securely invoke other services on the network that are secured by Keycloak.</p>
</dd>
<dt class="hdlist1">client adapters</dt>
<dd>
<p>Client adapters are plugins that you install into your application environment to be able to communicate and be secured by Keycloak.  Keycloak
has a number of adapters for different platforms that you can download.  There are also third-party adapters you can get for environments that we don&#8217;t cover.</p>
</dd>
<dt class="hdlist1">consent</dt>
<dd>
<p>Consent is when you as an admin want a user to give permission to a client before that client can participate in the authentication process.
After a user provides their credentials, Keycloak will pop up a screen identifying the client requesting a login and what identity
information is requested of the user.  User can decide whether or not to grant the request.</p>
</dd>
<dt class="hdlist1">client templates</dt>
<dd>
<p>When a client is registered you need to enter configuration information about that client.  It is often useful to store a template
to make create new clients easier.  Keycloak provides the concept of a client template for this.</p>
</dd>
<dt class="hdlist1">client role</dt>
<dd>
<p>Clients can define roles that are specific to them.  This is basically a role namespace dedicated to the client.</p>
</dd>
<dt class="hdlist1">identity token</dt>
<dd>
<p>A token that provides identity information about the user.  Part of the OpenID Connect specification.</p>
</dd>
<dt class="hdlist1">access token</dt>
<dd>
<p>A token that can be provided as part of an HTTP request that grants access to the service being invoked on.  This is part of
the OpenID Connect and OAuth 2.0 specification.</p>
</dd>
<dt class="hdlist1">assertion</dt>
<dd>
<p>Information about a user.  This usually pertains to an XML blob that is included in a SAML authentication response that
provided identity metadata about an authenticated user.</p>
</dd>
<dt class="hdlist1">service account</dt>
<dd>
<p>Each client has a built-in service account which allows it to obtain an access token.</p>
</dd>
<dt class="hdlist1">direct grant</dt>
<dd>
<p>A way for a client to obtain an access token on behalf of a user via a REST invocation.</p>
</dd>
<dt class="hdlist1">protocol mappers</dt>
<dd>
<p>For each client you can tailor what claims and assertions are stored in the OIDC token or SAML assertion.  You do this per client by creating and configuring
protocol mappers.</p>
</dd>
<dt class="hdlist1">session</dt>
<dd>
<p>When a user logs in, a session is created to manage the login session.  A session contains information like when the user logged in and what
applications have participated within single-sign on during that session.  Both admins and users can view session information.</p>
</dd>
<dt class="hdlist1">user federation provider</dt>
<dd>
<p>Keycloak can store and manage users.  Often, companies already have LDAP or Active Directory services that store user and credential
information.  You can point Keycloak to validate credentials from those external stores and pull in identity information.</p>
</dd>
<dt class="hdlist1">identity provider</dt>
<dd>
<p>An identity provider (IDP) is a service that can authenticate a user.  Keycloak is an IDP.</p>
</dd>
<dt class="hdlist1">identity provider federation</dt>
<dd>
<p>Keycloak can be configured to delegate authentication to one or more IDPs.  Social login via
Facebook or Google+ is an example of identity provider federation.  You can also hook Keycloak to delegate
authentication to any other Open ID Connect or SAML 2.0 IDP.</p>
</dd>
<dt class="hdlist1">identity provider mappers</dt>
<dd>
<p>When doing IDP federation you can map incoming tokens and assertions to user and session attributes.  This helps you propagate identity information from the external IDP
to your client requesting authentication.</p>
</dd>
<dt class="hdlist1">required actions</dt>
<dd>
<p>Required actions are actions a user must perform during the authentication process.  A user will not be able to complete the authentication process until these actions
are complete.  For example, an admin may schedule users to reset their passwords every month.  An <code>update password</code> required action would be set for all these
users.</p>
</dd>
<dt class="hdlist1">authentication flows</dt>
<dd>
<p>Authentication flows are work flows a user must perform when interacting with certain aspects of the system.  A login flow can define
what credential types are required.  A registration flow defines what profile information a user must enter and whether something like reCAPTCHA
must be used to filter out bots.  Credential reset flow defines what actions a user must do before they can reset their password.</p>
</dd>
<dt class="hdlist1">events</dt>
<dd>
<p>Events are audit streams that admins can view and hook into.</p>
</dd>
<dt class="hdlist1">themes</dt>
<dd>
<p>Every screen provided by Keycloak is backed by a theme.  Themes define HTML templates and stylesheets which you can override as needed.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-initialization"><a class="anchor" href="#server-initialization"></a>2. Server Initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After performing all the installation and configuration tasks defined in the <a href="http://www.keycloak.org/docs/3.4/server_installation/">Server Installation and Configuration Guide</a>,
you will need to create an initial admin account.
Keycloak does not have any configured admin account out of the box.
This account will allow you to create an admin that can log into the <em>master</em> realm&#8217;s administration console so that
you can start creating realms, users and registering applications to be secured by Keycloak.</p>
</div>
<div class="paragraph">
<p>If your
server is accessible from <code>localhost</code>, you can boot it up and create this admin user by going to the <a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a> URL.</p>
</div>
<div class="paragraph">
<div class="title">Welcome Page</div>
<p><span class="image"><img src="./keycloak-images/initial-welcome-page.png" alt="initial welcome page"></span></p>
</div>
<div class="paragraph">
<p>Simply specify the username and password you want for this initial admin.</p>
</div>
<div class="paragraph">
<p>If you cannot access the server via a <code>localhost</code> address, or just want to provision Keycloak from the command line
you can do this with the <code>&#8230;&#8203;/bin/add-user-keycloak</code> script.</p>
</div>
<div class="paragraph">
<div class="title">add-user-keycloak script</div>
<p><span class="image"><img src="./keycloak-images/add-user-script.png" alt="add user script"></span></p>
</div>
<div class="paragraph">
<p>The parameters are a little different depending if you are using the standalone operation mode or domain operation mode.  For
standalone mode, here is how you use the script.</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/add-user-keycloak.sh -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\add-user-keycloak.bat -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For domain mode, you have to point the script to one of your server hosts using the <code>-sc</code> switch.</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/add-user-keycloak.sh --sc domain/servers/server-one/configuration -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\add-user-keycloak.bat --sc domain/servers/server-one/configuration -r master -u &lt;username&gt; -p &lt;password&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="admin-console"><a class="anchor" href="#admin-console"></a>3. Admin Console</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The bulk of your administrative tasks will be done through the Keycloak Admin Console.
You can go to the console url directly at <a href="http://localhost:8080/auth/admin/" class="bare">http://localhost:8080/auth/admin/</a></p>
</div>
<div class="paragraph">
<div class="title">Login Page</div>
<p><span class="image"><img src="./keycloak-images/login-page.png" alt="login page"></span></p>
</div>
<div class="paragraph">
<p>Enter the username and password you created on the Welcome Page or the <code>add-user-keycloak</code> script in the bin directory.
This will bring you to the Keycloak Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">Admin Console</div>
<p><span class="image"><img src="./keycloak-images/admin-console.png" alt="admin console"></span></p>
</div>
<div class="paragraph">
<p>The left drop down menu allows you to pick a realm you want to manage or to create a new one.  The right drop down menu allows you to view your user account or logout.
If you are curious about a certain feature, button, or field within the Admin Console, simply hover your mouse
over any question mark <code>?</code> icon.  This will pop up tooltip text to describe the area of the console you are interested in.
The image above shows the tooltip in action.</p>
</div>
<div class="sect2">
<h3 id="the-master-realm"><a class="anchor" href="#the-master-realm"></a>3.1. The Master Realm</h3>
<div class="paragraph">
<p>When you boot Keycloak for the first time Keycloak creates a
pre-defined realm for you. This initial realm is the <em>master</em> realm. It is the
highest level in the hierarchy of realms. Admin accounts in this realm have
permissions to view and manage any other realm created on the server instance.
When you define your initial admin account, you create an account in the
<em>master</em> realm. Your initial login to the admin console will also be via the
<em>master</em> realm.</p>
</div>
<div class="paragraph">
<p>We recommend that you do not use the <em>master</em> realm to manage the users
and applications in your organization. Reserve use of the <em>master</em> realm for
<em>super</em> admins to create and manage the realms in your system. Following this
security model helps prevent accidental changes and follows the tradition
of permitting user accounts access to only those privileges and powers necessary
for the successful completion of their current task.</p>
</div>
<div class="paragraph">
<p>It is possible to disable the <em>master</em> realm and define admin accounts within
each individual new realm you create. Each realm has its own dedicated Admin
Console that you can log into with local accounts. This guide talks more about
this in the <a href="#_per_realm_admin_permissions">Dedicated Realm Admin Consoles</a>
chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create-realm"><a class="anchor" href="#_create-realm"></a>3.2. Create a New Realm</h3>
<div class="paragraph">
<p>Creating a new realm is very simple.
Mouse over the top left corner drop down menu that is titled with <code>Master</code>.  If you are logged in the master realm
this drop down menu lists all the realms created.  The last entry of this drop down menu is always <code>Add Realm</code>.  Click
this to add a realm.</p>
</div>
<div class="paragraph">
<div class="title">Add Realm Menu</div>
<p><span class="image"><img src="./keycloak-images/add-realm-menu.png" alt="add realm menu"></span></p>
</div>
<div class="paragraph">
<p>This menu option will bring you to the <code>Add Realm</code> page.  Specify the realm name you want to define and click the <code>Create</code> button.
Alternatively you can import a JSON document that defines your new realm.  We&#8217;ll go over this in more detail in the
<a href="#_export_import">Export and Import</a> chapter.</p>
</div>
<div class="paragraph">
<div class="title">Create Realm</div>
<p><span class="image"><img src="./keycloak-images/create-realm.png" alt="create realm"></span></p>
</div>
<div class="paragraph">
<p>After creating the realm you are brought back to the main Admin Console page. The current realm will now be set to
the realm you just created.  You can switch between managing different realms by doing a mouse over on the
top left corner drop down menu.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ssl_modes"><a class="anchor" href="#_ssl_modes"></a>3.3. SSL Mode</h3>
<div class="paragraph">
<p>Each realm has an SSL Mode associated with it.  The SSL Mode defines the SSL/HTTPS requirements for interacting with the realm.
Browsers and applications that interact with the realm must honor the SSL/HTTPS requirements defined by the SSL Mode or they
will not be allowed to interact with the server.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Keycloak is not set up by default to handle SSL/HTTPS.
          It is highly recommended that you either enable SSL on the Keycloak server itself or on a reverse proxy in front of the Keycloak server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To configure the SSL Mode of your realm, you need to click on the <code>Realm Settings</code> left menu item and go to the <code>Login</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>The <code>Require SSL</code> option allows you to pick the SSL Mode you want.  Here is an explanation of each mode:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">external requests</dt>
<dd>
<p>Users can interact with Keycloak so long as they stick to private IP addresses like <code>localhost</code>, <code>127.0.0.1</code>, <code>10.0.x.x</code>, <code>192.168.x.x</code>, and <code>172..16.x.x</code>.
If you try to access Keycloak from a non-private IP address you will get an error.</p>
</dd>
<dt class="hdlist1">none</dt>
<dd>
<p>Keycloak does not require SSL.  This should really only be used in development when you are playing around with things and don&#8217;t want to bother
configuring SSL on your server.</p>
</dd>
<dt class="hdlist1">all requests</dt>
<dd>
<p>Keycloak requires SSL for all IP addresses.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_clear-cache"><a class="anchor" href="#_clear-cache"></a>3.4. Clearing Server Caches</h3>
<div class="paragraph">
<p>Keycloak will cache everything it can in memory within the limits of your JVM and/or the limits you&#8217;ve configured
it for.  If the Keycloak database is modified by a third party (i.e. a DBA) outside the scope of the server&#8217;s REST APIs or Admin Console
there&#8217;s a chance parts of the in-memory cache may be stale.  You can clear the realm cache, user cache or cache of external public keys (Public keys of
 external clients or Identity providers, which Keycloak usually uses for verify signatures of particular external entity) from the Admin Console by going
to the <code>Realm Settings</code> left menu item and the <code>Cache</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Cache tab</div>
<p><span class="image"><img src="./keycloak-images/cache-tab.png" alt="cache tab"></span></p>
</div>
<div class="paragraph">
<p>Just click the <code>clear</code> button on the cache you want to evict.</p>
</div>
</div>
<div class="sect2">
<h3 id="_email"><a class="anchor" href="#_email"></a>3.5. Email Settings</h3>
<div class="paragraph">
<p>Keycloak sends emails to users to verify their email address, when they forget their passwords, or when an admin needs to
receive notifications about a server event.
To enable Keycloak to send emails you need to provide Keycloak with your SMTP server settings.
This is configured per realm.  Go to the <code>Realm Settings</code> left menu
item and click the <code>Email</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Email Tab</div>
<p><span class="image"><img src="./keycloak-images/email-tab.png" alt="email tab"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Host</dt>
<dd>
<p><code>Host</code> denotes the SMTP server hostname used for sending emails.</p>
</dd>
<dt class="hdlist1">Port</dt>
<dd>
<p><code>Port</code> denotes the SMTP server port.</p>
</dd>
<dt class="hdlist1">From</dt>
<dd>
<p><code>From</code> denotes the address used for the <code>From</code> SMTP-Header for the emails sent.</p>
</dd>
<dt class="hdlist1">From Display Name</dt>
<dd>
<p><code>From Display Name</code> allows to configure an user friendly email address aliases (optional). If not set the plain <code>From</code> email address will be displayed in email clients.</p>
</dd>
<dt class="hdlist1">Reply To</dt>
<dd>
<p><code>Reply To</code> denotes the address used for the <code>Reply-To</code> SMTP-Header for the mails sent (optional). If not set the plain <code>From</code> email address will be used.</p>
</dd>
<dt class="hdlist1">Reply To Display Name</dt>
<dd>
<p><code>Reply To Display Name</code> allows to configure an user friendly email address aliases (optional). If not set the plain <code>Reply To</code> email address will be displayed.</p>
</dd>
<dt class="hdlist1">Envelope From</dt>
<dd>
<p><code>Envelope From</code> denotes the <a href="https://en.wikipedia.org/wiki/Bounce_address">Bounce Address</a> used for the <code>Return-Path</code> SMTP-Header for the mails sent (optional).</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As emails are used for recovering usernames and passwords it&#8217;s recommended to use SSL or TLS, especially if the SMTP server is on an external network.
To enable SSL click on <code>Enable SSL</code> or to enable TLS click on <code>Enable TLS</code>.
You will most likely also need to change the <code>Port</code> (the default port for SSL/TLS is 465).</p>
</div>
<div class="paragraph">
<p>If your SMTP server requires authentication click on <code>Enable Authentication</code> and insert the <code>Username</code> and <code>Password</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_themes"><a class="anchor" href="#_themes"></a>3.6. Themes and Internationalization</h3>
<div class="paragraph">
<p>Themes allow you to change the look and feel of any UI in Keycloak.  Themes are configured per realm.  To change
a theme go to the <code>Realm Settings</code> left menu item and click on the <code>Themes</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Themes Tab</div>
<p><span class="image"><img src="./keycloak-images/themes-tab.png" alt="themes tab"></span></p>
</div>
<div class="paragraph">
<p>Pick the theme you want for each UI category and click <code>Save</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Login Theme</dt>
<dd>
<p>Username password entry, OTP entry, new user registration, and other similar screens related to login.</p>
</dd>
<dt class="hdlist1">Account Theme</dt>
<dd>
<p>Each user has an User Account Management UI.</p>
</dd>
<dt class="hdlist1">Admin Console Theme</dt>
<dd>
<p>The skin of the Keycloak Admin Console.</p>
</dd>
<dt class="hdlist1">Email Theme</dt>
<dd>
<p>Whenever Keycloak has to send out an email, it uses templates defined in this theme to craft the email.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> goes into how to create a new themes or modify existing ones.</p>
</div>
<div class="sect3">
<h4 id="internationalization"><a class="anchor" href="#internationalization"></a>3.6.1. Internationalization</h4>
<div class="paragraph">
<p>Every UI screen is internationalized in Keycloak.  The default language is English, but if you turn on the
<code>Internationalization</code> switch on the <code>Theme</code> tab you can choose which locales you want to support and what the default locale
will be.  The next time a user logs in, they will be able to choose a language on the login page to use for the login screens,
User Account Management UI, and Admin Console.  The <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> explains
how you can offer additional languages.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-management"><a class="anchor" href="#user-management"></a>4. User Management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes the administration functions for managing users.</p>
</div>
<div class="sect2">
<h3 id="searching-for-users"><a class="anchor" href="#searching-for-users"></a>4.1. Searching For Users</h3>
<div class="paragraph">
<p>If you need to manage a specific user, click on <code>Users</code> in the left menu bar.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/users.png" alt="users"></span></p>
</div>
<div class="paragraph">
<p>This menu option brings you to the user list page.  In the search box you can type in a full name, last name, or email address
you want to search for in the user database.  The query will bring up all users that match your criteria.  The <code>View all users</code> button
will list every user in the system.  This will search just local Keycloak database and not the federated database (ie. LDAP)
because some backends like LDAP don&#8217;t have a way to page through users. So if you want the users from federated backend to be synced into Keycloak
database you need to either:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adjust search criteria. That will sync just the backend users matching the criteria into Keycloak database.</p>
</li>
<li>
<p>Go to <code>User Federation</code> tab and click <code>Sync all users</code> or <code>Sync changed users</code> in the page with your federation provider.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="#_user-storage-federation">User Federation</a> for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create-new-user"><a class="anchor" href="#_create-new-user"></a>4.2. Creating New Users</h3>
<div class="paragraph">
<p>To create a user click on <code>Users</code> in the left menu bar.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/users.png" alt="users"></span></p>
</div>
<div class="paragraph">
<p>This menu option brings you to the user list page.  On the right side of the empty user list, you should see an <code>Add User</code>
button.  Click that to start creating your new user.</p>
</div>
<div class="paragraph">
<div class="title">Add User</div>
<p><span class="image"><img src="./keycloak-images/add-user.png" alt="add user"></span></p>
</div>
<div class="paragraph">
<p>The only required field is <code>Username</code>.  Click save.  This will bring you to the management page for your new user.</p>
</div>
</div>
<div class="sect2">
<h3 id="user-attributes"><a class="anchor" href="#user-attributes"></a>4.3. User Attributes</h3>
<div class="paragraph">
<p>Beyond basic user metadata like name and email, you can store arbitrary user attributes.  Choose a user to manage
then click on the <code>Attributes</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/user-attributes.png" alt="user attributes"></span></p>
</div>
<div class="paragraph">
<p>Enter in the attribute name and value in the empty fields and click the <code>Add</code> button next to it to add a new field.
Note that any edits you make on this page will not be stored until you hit the <code>Save</code> button.</p>
</div>
</div>
<div class="sect2">
<h3 id="user-credentials"><a class="anchor" href="#user-credentials"></a>4.4. User Credentials</h3>
<div class="paragraph">
<p>When viewing a user if you go to the <code>Credentials</code> tab you can manage a user&#8217;s credentials.</p>
</div>
<div class="paragraph">
<div class="title">Credential Management</div>
<p><span class="image"><img src="./keycloak-images/user-credentials.png" alt="user credentials"></span></p>
</div>
<div class="sect3">
<h4 id="changing-passwords"><a class="anchor" href="#changing-passwords"></a>4.4.1. Changing Passwords</h4>
<div class="paragraph">
<p>To change a user&#8217;s password, type in a new one.  A <code>Reset Password</code> button will show up that you click after you&#8217;ve typed everything in.
If the <code>Temporary</code> switch is on, this new password can only be used once and the user will be asked to change their password after they have
logged in.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you have <a href="#_email">email</a> set up, you can send an email to the user that asks
them to reset their password.  Choose <code>Update Password</code> from the <code>Reset Actions</code> list box and click <code>Send Email</code>. You can optionally
set the validity of the e-mail link which defaults to the one preset in <code>Tokens</code> tab in the realm settings.
The sent email contains a link that will bring the user to the update password screen.</p>
</div>
</div>
<div class="sect3">
<h4 id="changing-otps"><a class="anchor" href="#changing-otps"></a>4.4.2. Changing OTPs</h4>
<div class="paragraph">
<p>You cannot configure One-Time Passwords for a specific user within the Admin Console.  This is the responsibility of the user.
If the user has lost their OTP generator all you can do is disable OTP for them on the <code>Credentials</code> tab.
If OTP is optional in your realm, the user will have to go to the User Account Management service to re-configure a new
OTP generator. If OTP is required, then the user will be asked to re-configure a new OTP generator when they log in.</p>
</div>
<div class="paragraph">
<p>Like passwords, you can alternatively send an email to the user that will ask them to reset their OTP generator.  Choose
<code>Configure OTP</code> in the <code>Reset Actions</code> list box and click the <code>Send Email</code> button.  The sent email
contains a link that will bring the user to the OTP setup screen.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="required-actions"><a class="anchor" href="#required-actions"></a>4.5. Required Actions</h3>
<div class="paragraph">
<p>Required Actions are tasks that a user must finish before they are allowed to log in.  A user must provide their credentials before required actions are executed.  Once a required action is completed, the user will not have
to perform the action again.
Here are an explanation of some of the built-in required action types:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Update Password</dt>
<dd>
<p>When set, a user must change their password.</p>
</dd>
<dt class="hdlist1">Configure OTP</dt>
<dd>
<p>When set, a user must configure a one-time password generator on their mobile device using either the Free OTP or Google Authenticator application.</p>
</dd>
<dt class="hdlist1">Verify Email</dt>
<dd>
<p>When set, a user must verify that they have a valid email account.  An email will be sent to the user with a link they have to click.  Once this workflow
is successfully completed, they will be allowed to log in.</p>
</dd>
<dt class="hdlist1">Update Profile</dt>
<dd>
<p>This required action asks the user to update their profile information, i.e. their name, address, email, and/or phone number.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Admins can add required actions for each individual user within the user&#8217;s <code>Details</code> tab in the Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">Setting Required Action</div>
<p><span class="image"><img src="./keycloak-images/user-required-action.png" alt="user required action"></span></p>
</div>
<div class="paragraph">
<p>In the <code>Required User Actions</code> list box, select all the actions you want to add to the account.  If you want to remove one, click the <code>X</code> next to the
action name.  Also remember to click the <code>Save</code> button after you&#8217;ve decided what actions to add.</p>
</div>
<div class="sect3">
<h4 id="default-required-actions"><a class="anchor" href="#default-required-actions"></a>4.5.1. Default Required Actions</h4>
<div class="paragraph">
<p>You can also specify required actions that will be added to an account whenever a new user is created, i.e. through the <code>Add User</code> button the user
list screen, or via the <a href="#_user-registration">user registration</a> link on the login page.  To specify
the default required actions go to the <code>Authentication</code> left menu item and click on the <code>Required Actions</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Default Required Actions</div>
<p><span class="image"><img src="./keycloak-images/default-required-actions.png" alt="default required actions"></span></p>
</div>
<div class="paragraph">
<p>Simply click the checkbox in the <code>Default Action</code> column of the required actions that you want to be executed when a brand new user logs in.</p>
</div>
</div>
<div class="sect3">
<h4 id="terms-and-conditions"><a class="anchor" href="#terms-and-conditions"></a>4.5.2. Terms and Conditions</h4>
<div class="paragraph">
<p>Many organizations have a requirement that when a new user logs in for the first time, they need to agree to the terms and conditions
of the website.  Keycloak has this functionality implemented as a required action, but it requires some configuration.  For one, you
have to go to the <code>Required Actions</code> tab described earlier and enable the <code>Terms and Conditions</code> action.  You must also edit the
<em>terms.ftl</em> file in the <em>base</em> login theme.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more information on extending and
creating themes.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="impersonation"><a class="anchor" href="#impersonation"></a>4.6. Impersonation</h3>
<div class="paragraph">
<p>It is often useful for an admin to impersonate a user.  For example, a user may be experiencing a bug in one of your applications and
an admin may want to impersonate the user to see if they can duplicate the problem.  Admins with the appropriate permission
can impersonate a user.  There are two locations an admin can initiate impersonation.  The first is on the <code>Users</code> list tab.</p>
</div>
<div class="paragraph">
<div class="title">Users</div>
<p><span class="image"><img src="./keycloak-images/user-search.png" alt="user search"></span></p>
</div>
<div class="paragraph">
<p>You can see here that the admin has searched for <code>jim</code>.  Next to Jim&#8217;s account you can see an impersonate button.  Click that
to impersonate the user.</p>
</div>
<div class="paragraph">
<p>Also, you can impersonate the user from the user <code>Details</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">User Details</div>
<p><span class="image"><img src="./keycloak-images/user-details.png" alt="user details"></span></p>
</div>
<div class="paragraph">
<p>Near the bottom of the page you can see the <code>Impersonate</code> button.  Click that to impersonate the user.</p>
</div>
<div class="paragraph">
<p>When impersonating, if the admin and the user are in the same realm, then the admin will be logged out and automatically logged
in as the user being impersonated.  If the admin and user are not in the same realm, the admin will remain logged in, but additionally
be logged in as the user in that user&#8217;s realm.  In both cases, the browser will be redirected to the impersonated user&#8217;s User Account Management
page.</p>
</div>
<div class="paragraph">
<p>Any user with the realm&#8217;s <code>impersonation</code> role can impersonate a user.  Please see the <a href="#_admin_permissions">Admin Console Access Control</a> chapter
for more details on assigning administration permissions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user-registration"><a class="anchor" href="#_user-registration"></a>4.7. User Registration</h3>
<div class="paragraph">
<p>You can enable Keycloak to allow user self registration.  When enabled, the login page has a registration
link the user can click on to create their new account.  Enabling registration is pretty simple.  Go to the
<code>Realm Settings</code> left menu and click it.  Then go to the <code>Login</code> tab.  There is a <code>User Registration</code> switch on this
tab.  Turn it on, then click the <code>Save</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>After you enable this setting, a <code>Register</code> link should show up on the login page.</p>
</div>
<div class="paragraph">
<div class="title">Registration Link</div>
<p><span class="image"><img src="./keycloak-images/registration-link.png" alt="registration link"></span></p>
</div>
<div class="paragraph">
<p>Clicking on this link will bring the user to the registration page where they have to enter in some user profile information
and a new password.</p>
</div>
<div class="paragraph">
<div class="title">Registration Form</div>
<p><span class="image"><img src="./keycloak-images/registration-form.png" alt="registration form"></span></p>
</div>
<div class="paragraph">
<p>You can change the look and feel of the registration form as well as removing or adding additional fields that must be entered.
See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more information.</p>
</div>
<div class="sect3">
<h4 id="_recaptcha"><a class="anchor" href="#_recaptcha"></a>4.7.1. reCAPTCHA Support</h4>
<div class="paragraph">
<p>To safeguard registration against bots, Keycloak has integration with Google reCAPTCHA.
To enable this you need to first go to <a href="https://developers.google.com/recaptcha/">Google Recaptcha Website</a>
and create an API key so that you can get your reCAPTCHA site key and secret.
(FYI, localhost works by default so you don&#8217;t have to specify a domain).</p>
</div>
<div class="paragraph">
<p>Next, there are a few steps you need to perform in the Keycloak Admin Console.
Click the <code>Authentication</code> left menu item and go to the <code>Flows</code> tab.  Select the <code>Registration</code> flow from the drop down
list on this page.</p>
</div>
<div class="paragraph">
<div class="title">Registration Flow</div>
<p><span class="image"><img src="./keycloak-images/registration-flow.png" alt="registration flow"></span></p>
</div>
<div class="paragraph">
<p>Set the 'reCAPTCHA' requirement to <code>Required</code> by clicking the appropriate radio button.  This will enable
reCAPTCHA on the screen.  Next, you have to enter in the reCAPTCHA site key and secret that you generated at the Google reCAPTCHA Website.
Click on the 'Actions' button that is to the right of the reCAPTCHA flow entry, then "Config" link, and enter in the reCAPTCHA site key and secret on this config page.</p>
</div>
<div class="paragraph">
<div class="title">Recaptcha Config Page</div>
<p><span class="image"><img src="./keycloak-images/recaptcha-config.png" alt="recaptcha config"></span></p>
</div>
<div class="paragraph">
<p>The final step you have to do is to change some default HTTP response headers that Keycloak sets.  Keycloak
will prevent a website from including any login page within an iframe.  This is to prevent clickjacking attacks.  You need to
authorize Google to use the registration page within an iframe.  Go to
the <code>Realm Settings</code> left menu item and then go to the <code>Security Defenses</code> tab.  You will need to add <code>https://www.google.com</code> to the
values of both the <code>X-Frame-Options</code> and <code>Content-Security-Policy</code> headers.</p>
</div>
<div class="paragraph">
<div class="title">Authorizing Iframes</div>
<p><span class="image"><img src="./keycloak-images/security-headers.png" alt="security headers"></span></p>
</div>
<div class="paragraph">
<p>Once you do this, reCAPTCHA should show up on your registration page.  You may want to edit <em>register.ftl</em> in your login
theme to muck around with the placement and styling of the reCAPTCHA button.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>
for more information on extending and creating themes.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="login-page-settings"><a class="anchor" href="#login-page-settings"></a>5. Login Page Settings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several nice built-in login page features you can enable if you need the functionality.</p>
</div>
<div class="sect2">
<h3 id="forgot-password"><a class="anchor" href="#forgot-password"></a>5.1. Forgot Password</h3>
<div class="paragraph">
<p>If you enable it, users are able to reset their credentials if they forget their password or lose their OTP generator.
Go to the <code>Realm Settings</code> left menu item, and click on the <code>Login</code> tab.  Switch on the <code>Forgot Password</code> switch.</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>A <code>forgot password</code> link will now show up on your login pages.</p>
</div>
<div class="paragraph">
<div class="title">Forgot Password Link</div>
<p><span class="image"><img src="./keycloak-images/forgot-password-link.png" alt="forgot password link"></span></p>
</div>
<div class="paragraph">
<p>Clicking on this link will bring the user
to a page where they can enter in their username or email and receive an email with a link to reset their credentials.</p>
</div>
<div class="paragraph">
<div class="title">Forgot Password Page</div>
<p><span class="image"><img src="./keycloak-images/forgot-password-page.png" alt="forgot password page"></span></p>
</div>
<div class="paragraph">
<p>The text sent in the email is completely configurable. You just need to extend or edit the theme associated with it.
See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more information.</p>
</div>
<div class="paragraph">
<p>When the user clicks on the email link, they will be asked to update their password, and, if they have an OTP generator
set up, they will also be asked to reconfigure this as well.  Depending on the security requirements of your organization
you may not want users to be able to reset their OTP generator through email.  You can change this behavior by
going to the <code>Authentication</code> left menu item, clicking on the <code>Flows</code> tab, and selecting the <code>Reset Credentials</code> flow:</p>
</div>
<div class="paragraph">
<div class="title">Reset Credentials Flow</div>
<p><span class="image"><img src="./keycloak-images/reset-credentials-flow.png" alt="reset credentials flow"></span></p>
</div>
<div class="paragraph">
<p>If you do not want OTP reset, then just chose the <code>disabled</code> radio button to the right of <code>Reset OTP</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="remember-me"><a class="anchor" href="#remember-me"></a>5.2. Remember Me</h3>
<div class="paragraph">
<p>If a logged in user closes their browser, their session is destroyed and they will have to log in again.  You can set things
up so that if a user checks a <em>remember me</em> checkbox, they will remain logged in even if the browser is closed.  This basically
turns the login cookie from a session-only cookie to a persistence cookie.</p>
</div>
<div class="paragraph">
<p>To enable this feature go to <code>Realm Settings</code> left menu item and click on the <code>Login</code> tab and turn on the <code>Remember Me</code> switch:</p>
</div>
<div class="paragraph">
<div class="title">Login Tab</div>
<p><span class="image"><img src="./keycloak-images/login-tab.png" alt="login tab"></span></p>
</div>
<div class="paragraph">
<p>Once you save this setting, a <code>remember me</code> checkbox will be displayed on the realm&#8217;s login page.</p>
</div>
<div class="paragraph">
<div class="title">Remember Me</div>
<p><span class="image"><img src="./keycloak-images/remember-me.png" alt="remember me"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a>6. Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are a few features you should be aware of when configuring authentication for your realm.  Many organizations
have strict password and OTP policies that you can enforce via settings in the Admin Console.  You may or may not
want to require different credential types for authentication.  You may want to give users the option to login via
Kerberos or disable or enable various built-in credential types.  This chapter covers all of these topics.</p>
</div>
<div class="sect2">
<h3 id="_password-policies"><a class="anchor" href="#_password-policies"></a>6.1. Password Policies</h3>
<div class="paragraph">
<p>Each new realm created has no password policies associated with it.  Users can have as short, as long, as complex,
as insecure a password, as they want.  Simple settings are fine for development or learning Keycloak,
but unacceptable in production environments.  Keycloak has a rich set of password policies you can enable
through the Admin Console.</p>
</div>
<div class="paragraph">
<p>Click on the <code>Authentication</code> left menu item and go to the <code>Password Policy</code> tab.  Choose the policy you want to add in the
right side drop down list box.  This will add the policy in the table on the screen.  Choose the parameters for the policy.
Hit the <code>Save</code> button to store your changes.</p>
</div>
<div class="paragraph">
<div class="title">Password Policy</div>
<p><span class="image"><img src="./keycloak-images/password-policy.png" alt="password policy"></span></p>
</div>
<div class="paragraph">
<p>After saving your policy, user registration and the Update Password required action will enforce your new policy.  An example of a user
failing the policy check:</p>
</div>
<div class="paragraph">
<div class="title">Failed Password Policy</div>
<p><span class="image"><img src="./keycloak-images/failed-password-policy.png" alt="failed password policy"></span></p>
</div>
<div class="paragraph">
<p>If the password policy is updated, an Update Password action must be set for every user. An automatic trigger is scheduled as a future enhancement.</p>
</div>
<div class="sect3">
<h4 id="password-policy-types"><a class="anchor" href="#password-policy-types"></a>6.1.1. Password Policy Types</h4>
<div class="paragraph">
<p>Here&#8217;s an explanation of each policy type:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">HashAlgorithm</dt>
<dd>
<p>Passwords are not stored as clear text. Instead they are hashed using standard hashing algorithms before they are stored or validated.
The only built-in and default algorithm available is PBKDF2. See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>
on how to plug in your own algorithm. Note that if you do change the algorithm, password hashes will not change in storage until
the next time the user logs in.</p>
</dd>
<dt class="hdlist1">Hashing Iterations</dt>
<dd>
<p>This value specifies the number of times a password will be hashed before it is stored or verified. The default value is 20,000.
This hashing is done in the rare case that a hacker gets access to your password database. Once they have access to the database,
they can reverse engineer user passwords.
The industry recommended value for this parameter changes every year as CPU power improves. A higher hashing iteration value takes more CPU power for hashing,
and can impact performance. You&#8217;ll have to weigh what is more important to you. Performance or protecting your passwords stores.
There may be more cost effective ways of protecting your password stores.</p>
</dd>
<dt class="hdlist1">Digits</dt>
<dd>
<p>The number of digits required to be in the password string.</p>
</dd>
<dt class="hdlist1">Lowercase Characters</dt>
<dd>
<p>The number of lower case letters required to be in the password string.</p>
</dd>
<dt class="hdlist1">Uppercase Characters</dt>
<dd>
<p>The number of upper case letters required to be in the password string.</p>
</dd>
<dt class="hdlist1">Special Characters</dt>
<dd>
<p>The number of special characters like '?!#%$' required to be in the password string.</p>
</dd>
<dt class="hdlist1">Not Username</dt>
<dd>
<p>When set, the password is not allowed to be the same as the username.</p>
</dd>
<dt class="hdlist1">Regular Expression</dt>
<dd>
<p>Define one or more Perl regular expression patterns that passwords must match.</p>
</dd>
<dt class="hdlist1">Expire Password</dt>
<dd>
<p>The number of days for which the password is valid. After the number of days has expired, the user is required to change their password.</p>
</dd>
<dt class="hdlist1">Not Recently Used</dt>
<dd>
<p>This policy saves a history of previous passwords. The number of old passwords stored is configurable. When a user changes their password
they cannot use any stored passwords.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="otp-policies"><a class="anchor" href="#otp-policies"></a>6.2. OTP Policies</h3>
<div class="paragraph">
<p>Keycloak has a number of policies you can set up for your FreeOTP or Google Authenticator One-Time Password
generator.  Click on the <code>Authentication</code> left menu item and go to the <code>OTP Policy</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">OTP Policy</div>
<p><span class="image"><img src="./keycloak-images/otp-policy.png" alt="otp policy"></span></p>
</div>
<div class="paragraph">
<p>Any policies you set here will be used to validate one-time passwords.  When configuring OTP, FreeOTP and Google Authenticator
can scan a QR code that is generated on the OTP set up page that Keycloak has.  The bar code is also
generated from information configured on the <code>OTP Policy</code> tab.</p>
</div>
<div class="sect3">
<h4 id="totp-vs-hotp"><a class="anchor" href="#totp-vs-hotp"></a>6.2.1. TOTP vs. HOTP</h4>
<div class="paragraph">
<p>There are two different algorithms to choose from for your OTP generators.  Time Based (TOTP) and Counter Based (HOTP).
For TOTP, your token generator will hash the current time and a shared secret.  The server validates the OTP by comparing
the all hashes within a certain window of time to the submitted value.  So, TOTPs are valid only for a short window of time (usually 30 seconds).
For HOTP a shared counter is used instead of the current time.  The server increments the counter with each successful OTP login.  So, valid OTPs only
change after a successful login.</p>
</div>
<div class="paragraph">
<p>TOTP is considered a little more secure because the matchable OTP is only valid for a short window of time while the OTP for HOTP can
be valid for an indeterminate amount of time.  HOTP is much more user friendly as the user won&#8217;t have to hurry to enter in their
OTP before the time interval is up.  With the way Keycloak has implemented TOTP this distinction becomes a little more
blurry.  HOTP requires a database update every time the server wants to increment the counter.  This can be a performance drain
on the authentication server when there is heavy load.  So, to provide a more efficient alternative, TOTP does not remember passwords
used.  This bypasses the need to do any DB updates, but the downside is that TOTPs can be re-used in the valid time interval.  For future
versions of Keycloak it is planned that you will be able to configure whether TOTP checks older OTPs in the time interval.</p>
</div>
</div>
<div class="sect3">
<h4 id="totp-configuration-options"><a class="anchor" href="#totp-configuration-options"></a>6.2.2. TOTP Configuration Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">OTP Hash Algorithm</dt>
<dd>
<p>Default is SHA1, more secure options are SHA256 and SHA512.</p>
</dd>
<dt class="hdlist1">Number of Digits</dt>
<dd>
<p>How many characters is the OTP?  Short means more user friendly as it is less the user has to type.  More means more security.</p>
</dd>
<dt class="hdlist1">Look Ahead Window</dt>
<dd>
<p>How many intervals ahead should the server try and match the hash?  This exists so just in case the clock of the TOTP generator
or authentication server get out of sync.  The default value of 1 is usually good enough.  For example, if the time interval
for a new token is every 30 seconds, the default value of 1 means that it will only accept valid tokens in that 30 second window.
Each increment of this config value will increase the valid window by 30 seconds.</p>
</dd>
<dt class="hdlist1">OTP Token Period</dt>
<dd>
<p>Time interval in seconds a new TOTP will be generated by the token generator.  And, the time window the server is matching a hash.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="hotp-configuration-options"><a class="anchor" href="#hotp-configuration-options"></a>6.2.3. HOTP Configuration Options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">OTP Hash Algorithm</dt>
<dd>
<p>Default is SHA1, more secure options are SHA256 and SHA512.</p>
</dd>
<dt class="hdlist1">Number of Digits</dt>
<dd>
<p>How many characters is the OTP?  Short means more user friendly as it is less the user has to type.  More means more security.</p>
</dd>
<dt class="hdlist1">Look Ahead Window</dt>
<dd>
<p>How many counters ahead should the server try and match the hash?  The default value is 1.  This exists to cover the case
where the user&#8217;s counter gets ahead of the server&#8217;s.  This can often happen as users often increment the counter
manually too many times by accident.  This value really should be increased to a value of 10 or so.</p>
</dd>
<dt class="hdlist1">Initial Counter</dt>
<dd>
<p>What is the value of the initial counter?</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authentication-flows"><a class="anchor" href="#_authentication-flows"></a>6.3. Authentication Flows</h3>
<div class="paragraph">
<p>An <em>authentication flow</em> is a container for all authentications, screens, and actions that must happen during login, registration, and other
Keycloak workflows.
If you go to the admin console <code>Authentication</code> left menu item and go to the <code>Flows</code> tab, you can view all the defined flows
in the system and what actions and checks each flow requires.  This section does a walk through of the browser login flow.  In the
left drop down list select <code>browser</code> to come to the screen shown below:</p>
</div>
<div class="paragraph">
<div class="title">Browser Flow</div>
<p><span class="image"><img src="./keycloak-images/browser-flow.png" alt="browser flow"></span></p>
</div>
<div class="paragraph">
<p>If you hover over the tooltip (the tiny question mark) to the right of the flow selection list, this will describe what the
flow is and does.</p>
</div>
<div class="paragraph">
<p>The <code>Auth Type</code> column is the name of authentication or action that will be executed.  If an authentication is indented
this means it is in a sub-flow and may or may not be executed depending on the behavior of its parent.  The <code>Requirement</code>
column is a set of radio buttons which define whether or not the action will execute.  Let&#8217;s describe what each radio
button means:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Required</dt>
<dd>
<p>This authentication execution must execute successfully.  If the user doesn&#8217;t have that type of authentication mechanism
configured and there is a required action associated with that authentication type, then a required action will be attached
to that account.  For example, if you switch <code>OTP Form</code> to <code>Required</code>, users that don&#8217;t have an OTP generator configured
will be asked to do so.</p>
</dd>
<dt class="hdlist1">Optional</dt>
<dd>
<p>If the user has the authentication type configured, it will be executed.  Otherwise, it will be ignored.</p>
</dd>
<dt class="hdlist1">Disabled</dt>
<dd>
<p>If disabled, the authentication type is not executed.</p>
</dd>
<dt class="hdlist1">Alternative</dt>
<dd>
<p>This means that at least one alternative authentication type must execute successfully at that level of the flow.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This is better described in an example.  Let&#8217;s walk through the <code>browser</code> authentication flow.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The first authentication type is <code>Cookie</code>.  When a user successfully logs in for the first time, a session cookie is set.
If this cookie has already been set, then this authentication type is successful.
Since the cookie provider returned success and each execution at this level of the flow is <em>alternative</em>, no other execution is executed and this results in a successful login.</p>
</li>
<li>
<p>Next the flow looks at the Kerberos execution.  This authenticator is disabled by default and will be skipped.</p>
</li>
<li>
<p>The next execution is a subflow called Forms.  Since this subflow is marked as <em>alternative</em> it will not be executed if the <code>Cookie</code> authentication type passed.
This subflow contains additional authentication type that needs to be executed.
The executions for this subflow are loaded and the same processing logic occurs</p>
</li>
<li>
<p>The first execution in the Forms subflow is the Username Password Form.  This authentication type renders the username and password page.
It is marked as <em>required</em> so the user must enter in a valid username and password.</p>
</li>
<li>
<p>The next execution is the OTP Form.
This is marked as <em>optional</em>.  If the user has OTP set up, then this authentication type must run and be successful.  If the user doesn&#8217;t
have OTP set up, this authentication type is ignored.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="executions"><a class="anchor" href="#executions"></a>6.4. Executions</h3>
<div class="paragraph">
<p>Executions can be used</p>
</div>
<div class="paragraph">
<div class="title">Script Authenticator</div>
<p>A <em>script</em> authenticator allows to define custom authentication logic via JavaScript.
Custom authenticators. Authentication scripts must at least provide one of the following functions:
<code>authenticate(..)</code> which is called from <code>Authenticator#authenticate(AuthenticationFlowContext)</code>
<code>action(..)</code> which is called from <code>Authenticator#action(AuthenticationFlowContext)</code></p>
</div>
<div class="paragraph">
<p>Custom <code>Authenticator&#8217;s should at least provide the `authenticate(..)</code> function.
The following script <code>javax.script.Bindings</code> are available for convenient use within script code.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>script</code></dt>
<dd>
<p>the <code>ScriptModel</code> to access script metadata</p>
</dd>
<dt class="hdlist1"><code>realm</code></dt>
<dd>
<p>the <code>RealmModel</code></p>
</dd>
<dt class="hdlist1"><code>user</code></dt>
<dd>
<p>the current <code>UserModel</code></p>
</dd>
<dt class="hdlist1"><code>session</code></dt>
<dd>
<p>the active <code>KeycloakSession</code></p>
</dd>
<dt class="hdlist1"><code>authenticationSession</code></dt>
<dd>
<p>the current <code>AuthenticationSessionModel</code></p>
</dd>
<dt class="hdlist1"><code>httpRequest</code></dt>
<dd>
<p>the current <code>org.jboss.resteasy.spi.HttpRequest</code></p>
</dd>
<dt class="hdlist1"><code>LOG</code></dt>
<dd>
<p>a <code>org.jboss.logging.Logger</code> scoped to <code>ScriptBasedAuthenticator</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note that additional context information can be extracted from the <code>context</code> argument passed
to the <code>authenticate(context)</code> <code>action(context)</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>AuthenticationFlowError = Java.type("org.keycloak.authentication.AuthenticationFlowError");

function authenticate(context) {

  LOG.info(script.name + " --&gt; trace auth for: " + user.username);

  if (   user.username === "tester"
      &amp;&amp; user.getAttribute("someAttribute")
      &amp;&amp; user.getAttribute("someAttribute").contains("someValue")) {

      context.failure(AuthenticationFlowError.INVALID_USER);
      return;
  }

  context.success();
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kerberos"><a class="anchor" href="#_kerberos"></a>6.5. Kerberos</h3>
<div class="paragraph">
<p>Keycloak supports login with a Kerberos ticket through the SPNEGO protocol.
SPNEGO (Simple and Protected GSSAPI Negotiation Mechanism) is used to authenticate transparently through the web browser after the user
has been authenticated when logging-in his session.
For non-web cases or when ticket is not available during login, Keycloak also supports login with Kerberos username/password.</p>
</div>
<div class="paragraph">
<p>A typical use case for web authentication is the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User logs into his desktop (Such as a Windows machine in Active Directory domain or Linux machine with Kerberos integration enabled).</p>
</li>
<li>
<p>User then uses his browser (IE/Firefox/Chrome) to access a web application secured by Keycloak.</p>
</li>
<li>
<p>Application redirects to Keycloak login.</p>
</li>
<li>
<p>Keycloak renders HTML login screen together with status 401 and HTTP header <code>WWW-Authenticate: Negotiate</code></p>
</li>
<li>
<p>In case that the browser has Kerberos ticket from desktop login, it transfers the desktop sign on information to the Keycloak
in header <code>Authorization: Negotiate 'spnego-token'</code> . Otherwise it just displays the login screen.</p>
</li>
<li>
<p>Keycloak validates token from the browser and authenticates the user.
It provisions user data from LDAP (in case of LDAPFederationProvider with Kerberos authentication support) or let user
to update his profile and prefill data (in case of KerberosFederationProvider).</p>
</li>
<li>
<p>Keycloak returns back to the application.
Communication between Keycloak and application happens through OpenID Connect or SAML messages.
The fact that Keycloak was authenticated through Kerberos is hidden from the application.
So Keycloak acts as broker to Kerberos/SPNEGO login.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For setup there are 3 main parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Setup and configuration of Kerberos server (KDC)</p>
</li>
<li>
<p>Setup and configuration of Keycloak server</p>
</li>
<li>
<p>Setup and configuration of client machines</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="setup-of-kerberos-server"><a class="anchor" href="#setup-of-kerberos-server"></a>6.5.1. Setup of Kerberos server</h4>
<div class="paragraph">
<p>This is platform dependent.
Exact steps depend on your OS and the Kerberos vendor you&#8217;re going to use.
Consult Windows Active Directory, MIT Kerberos and your OS documentation for how exactly to setup and configure Kerberos server.</p>
</div>
<div class="paragraph">
<p>At least you will need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add some user principals to your Kerberos database.
You can also integrate your Kerberos with LDAP, which means that user accounts will be provisioned from LDAP server.</p>
</li>
<li>
<p>Add service principal for "HTTP" service.
For example if your Keycloak server will be running on <code>www.mydomain.org</code> you may need to add principal <code>HTTP/www.mydomain.org@MYDOMAIN.ORG</code>
assuming that MYDOMAIN.ORG will be your Kerberos realm.</p>
<div class="paragraph">
<p>For example on MIT Kerberos you can run a "kadmin" session.
If you are on the same machine where is MIT Kerberos, you can simply use the command:</p>
</div>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sudo kadmin.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then add HTTP principal and export his key to a keytab file with the commands like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>addprinc -randkey HTTP/www.mydomain.org@MYDOMAIN.ORG
ktadd -k /tmp/http.keytab HTTP/www.mydomain.org@MYDOMAIN.ORG</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Keytab file <code>/tmp/http.keytab</code> will need to be accessible on the host where Keycloak server will be running.</p>
</div>
</div>
<div class="sect3">
<h4 id="setup-and-configuration-of-keycloak-server"><a class="anchor" href="#setup-and-configuration-of-keycloak-server"></a>6.5.2. Setup and configuration of Keycloak server</h4>
<div class="paragraph">
<p>You need to install a kerberos client on your machine.  This is also platform dependent.
If you are on Fedora, Ubuntu or RHEL, you can install the package <code>freeipa-client</code>, which contains a Kerberos client and several other utilities.
Configure the kerberos client (on linux it&#8217;s in file <code>/etc/krb5.conf</code> ). You need to put your Kerberos realm and at least configure the HTTP domains your server will be running on.
For the example realm MYDOMAIN.ORG you may configure the <code>domain_realm</code> section like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[domain_realm]
  .mydomain.org = MYDOMAIN.ORG
  mydomain.org = MYDOMAIN.ORG</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you need to export the keytab file with the HTTP principal and make sure the file is accessible to the process under which Keycloak server is running.
For production, it&#8217;s ideal if it&#8217;s readable just by this process and not by someone else.
For the MIT Kerberos example above, we already exported keytab to <code>/tmp/http.keytab</code> . If your KDC and Keycloak are running on same host,
you have that file already available.</p>
</div>
<div class="sect4">
<h5 id="enable-spnego-processing"><a class="anchor" href="#enable-spnego-processing"></a>Enable SPNEGO Processing</h5>
<div class="paragraph">
<p>Keycloak does not have the SPNEGO protocol support turned on by default.  So, you have to go to the <a href="#_authentication-flows">browser flow</a>
and enable <code>Kerberos</code>.</p>
</div>
<div class="paragraph">
<div class="title">Browser Flow</div>
<p><span class="image"><img src="./keycloak-images/browser-flow.png" alt="browser flow"></span></p>
</div>
<div class="paragraph">
<p>Switch the <code>Kerberos</code> requirement from <em>disabled</em> to either <em>alternative</em> or <em>required</em>.  <em>Alternative</em> basically means that Kerberos is optional.  If
the user&#8217;s browser hasn&#8217;t been configured to work with SPNEGO/Kerberos, then Keycloak will fall back to the regular login screens.  If you set the requirement
to <em>required</em> then all users must have Kerberos enabled for their browser.</p>
</div>
</div>
<div class="sect4">
<h5 id="configure-kerberos-user-storage-federation-provider"><a class="anchor" href="#configure-kerberos-user-storage-federation-provider"></a>Configure Kerberos User Storage Federation Provider</h5>
<div class="paragraph">
<p>Now that the SPNEGO protocol is turned on at the authentication server, you&#8217;ll need to configure how Keycloak interprets the Kerberos ticket.
This is done through <a href="#_user-storage-federation">User Storage Federation</a>. We have 2 different federation providers with Kerberos authentication support.</p>
</div>
<div class="paragraph">
<p>If you want to authenticate with Kerberos backed by an LDAP server, you have to first configure the <a href="#_ldap">LDAP Federation Provider</a>.
If you look at the configuration page for your LDAP provider you&#8217;ll see a <code>Kerberos Integration</code> section.</p>
</div>
<div class="paragraph">
<div class="title">LDAP Kerberos Integration</div>
<p><span class="image"><img src="./keycloak-images/ldap-kerberos.png" alt="ldap kerberos"></span></p>
</div>
<div class="paragraph">
<p>Turning on the switch <code>Allow Kerberos authentication</code> will make Keycloak use the Kerberos principal to lookup information about the user so that it can
be imported into the Keycloak environment.</p>
</div>
<div class="paragraph">
<p>If your Kerberos solution is not backed by an LDAP server, you have to use the <code>Kerberos</code> User Storage Federation Provider.  Go to the <code>User Federation</code>
left menu item and select <code>Kerberos</code> from the <code>Add provider</code> select box.</p>
</div>
<div class="paragraph">
<div class="title">Kerberos User Storage Provider</div>
<p><span class="image"><img src="./keycloak-images/kerberos-provider.png" alt="kerberos provider"></span></p>
</div>
<div class="paragraph">
<p>This provider parses the Kerberos ticket for simple principal information and does a small import into the local Keycloak database.
User profile information like first name, last name, and email are not provisioned.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setup-and-configuration-of-client-machines"><a class="anchor" href="#setup-and-configuration-of-client-machines"></a>6.5.3. Setup and configuration of client machines</h4>
<div class="paragraph">
<p>Clients need to install kerberos client and setup krb5.conf as described above.
Additionally they need to enable SPNEGO login support in their browser.
See <a href="http://www.microhowto.info/howto/configure_firefox_to_authenticate_using_spnego_and_kerberos.html">configuring Firefox for Kerberos</a> if you are using that browser.
URI <code>.mydomain.org</code> must be allowed in the <code>network.negotiate-auth.trusted-uris</code> config option.</p>
</div>
<div class="paragraph">
<p>In a Windows domain, clients usually don&#8217;t need to configure anything special as IE is already able to participate in SPNEGO authentication for the Windows domain.</p>
</div>
</div>
<div class="sect3">
<h4 id="example-setups"><a class="anchor" href="#example-setups"></a>6.5.4. Example setups</h4>
<div class="paragraph">
<p>For easier testing with Kerberos, we provided some example setups to test.</p>
</div>
<div class="sect4">
<h5 id="keycloak-and-freeipa-docker-image"><a class="anchor" href="#keycloak-and-freeipa-docker-image"></a>Keycloak and FreeIPA docker image</h5>
<div class="paragraph">
<p>Once you install <a href="https://www.docker.com/">docker</a>, you can run docker image with FreeIPA server installed.
FreeIPA provides integrated security solution with MIT Kerberos and 389 LDAP server among other things . The image provides also Keycloak
server configured with LDAP Federation provider and enabled SPNEGO/Kerberos authentication against the FreeIPA server.
See details <a href="https://github.com/mposolda/keycloak-freeipa-docker/blob/master/README.md">here</a> .</p>
</div>
</div>
<div class="sect4">
<h5 id="apacheds-testing-kerberos-server"><a class="anchor" href="#apacheds-testing-kerberos-server"></a>ApacheDS testing Kerberos server</h5>
<div class="paragraph">
<p>For quick testing and unit tests, we use a very simple <a href="http://directory.apache.org/apacheds/">ApacheDS</a> Kerberos server.
You need to build Keycloak from sources and then run the Kerberos server with maven-exec-plugin from our testsuite.
See details <a href="https://github.com/keycloak/keycloak/blob/master/misc/Testsuite.md#user-content-kerberos-server">here</a> .</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="credential-delegation"><a class="anchor" href="#credential-delegation"></a>6.5.5. Credential Delegation</h4>
<div class="paragraph">
<p>Kerberos 5 supports the concept of credential delegation.  In this scenario, your applications may want access to the Kerberos ticket so that
they can re-use it to interact with other services secured by Kerberos.  Since the SPNEGO protocol is processed in the Keycloak server,
you have to propagate the GSS credential to your application
within the  OpenID Connect token claim or a SAML assertion attribute that is transmitted to your application from the Keycloak server.
To have this claim inserted into the token or assertion, each application will need to enable the built-in protocol mapper called <code>gss delegation credential</code>.
This is enabled in the <code>Mappers</code> tab of the application&#8217;s
client page.  See <a href="#_protocol-mappers">Protocol Mappers</a> chapter for more details.</p>
</div>
<div class="paragraph">
<p>Applications will need to deserialize the claim it receives from Keycloak before it can use it to make GSS calls against other services.
Once you deserialize the credential from the access token to the GSSCredential object, the GSSContext will need to be created with this credential
passed to the method <code>GSSManager.createContext</code> for example like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// Obtain accessToken in your application.
KeycloakPrincipal keycloakPrincipal = (KeycloakPrincipal) servletReq.getUserPrincipal();
AccessToken accessToken = keycloakPrincipal.getKeycloakSecurityContext().getToken();

// Retrieve kerberos credential from accessToken and deserialize it
String serializedGssCredential = (String) accessToken.getOtherClaims().
    get(org.keycloak.common.constants.KerberosConstants.GSS_DELEGATION_CREDENTIAL);

GSSCredential deserializedGssCredential = org.keycloak.common.util.KerberosSerializationUtils.
    deserializeCredential(serializedGssCredential);

// Create GSSContext to call other kerberos-secured services
GSSContext context = gssManager.createContext(serviceName, krb5Oid,
    deserializedGssCredential, GSSContext.DEFAULT_LIFETIME);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have an example, that shows this in detail.
It&#8217;s in <code>examples/kerberos</code> in the Keycloak example distribution or demo distribution download.
You can also check the example sources directly <a href="https://github.com/keycloak/keycloak/tree/master/examples/kerberos">here</a> .</p>
</div>
<div class="paragraph">
<p>Note that you also need to configure <code>forwardable</code> kerberos tickets in <code>krb5.conf</code> file and add support for delegated credentials to your browser.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Credential delegation has some security implications so only use it if you really need it.
         It&#8217;s highly recommended to use it together with HTTPS.
         See for example <a href="http://www.microhowto.info/howto/configure_firefox_to_authenticate_using_spnego_and_kerberos.html">this article</a> for more details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>6.5.6. Troubleshooting</h4>
<div class="paragraph">
<p>If you have issues, we recommend that you enable additional logging to debug the problem:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enable <code>Debug</code> flag in admin console for Kerberos or LDAP federation providers</p>
</li>
<li>
<p>Enable TRACE logging for category <code>org.keycloak</code> in logging section of <code>standalone/configuration/standalone.xml</code> to receive more info <code>standalone/log/server.log</code></p>
</li>
<li>
<p>Add system properties <code>-Dsun.security.krb5.debug=true</code> and <code>-Dsun.security.spnego.debug=true</code>
## X.509 Client Certificate User Authentication</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keycloak supports login with a X.509 client certificate if the server is configured for mutual SSL authentication.</p>
</div>
<div class="paragraph">
<p>A typical workflow is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A client sends an authentication request over SSL/TLS channel</p>
</li>
<li>
<p>During SSL/TLS handshake, the server and the client exchange their x.509/v3 certificates</p>
</li>
<li>
<p>The container (wildfly) validates the certificate PKIX path and the certificate expiration</p>
</li>
<li>
<p>The x.509 client certificate authenticator validates the client certificate as follows:</p>
<div class="ulist">
<ul>
<li>
<p>Optionally checks the certificate revocation status using CRL and/or CRL Distribution Points</p>
</li>
<li>
<p>Optionally checks the Certificate revocation status using OCSP (Online Certificate Status Protocol)</p>
</li>
<li>
<p>Optinally validates whether the key usage in the certificate matches the expected key usage</p>
</li>
<li>
<p>Optionally validates whether the extended key usage in the certificate matches the expected extended key usage</p>
</li>
</ul>
</div>
</li>
<li>
<p>If any of the above checks fails, the x.509 authentication fails</p>
</li>
<li>
<p>Otherwise, the authenticator extracts the certificate identity and maps it to an existing user</p>
</li>
<li>
<p>Once the certificate is mapped to an existing user, the behavior diverges depending on the authentication flow:</p>
<div class="ulist">
<ul>
<li>
<p>In the Browser Flow, the server prompts the user to confirm identity or to ignore it and instead sign in with username/password</p>
</li>
<li>
<p>In the case of the Direct Grant Flow, the server signs in the user</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="features-2"><a class="anchor" href="#features-2"></a>6.6. Features</h3>
<div class="sect3">
<h4 id="supported-certificate-identity-sources"><a class="anchor" href="#supported-certificate-identity-sources"></a>6.6.1. Supported Certificate Identity Sources</h4>
<div class="ulist">
<ul>
<li>
<p>Match SubjectDN using regular expression</p>
</li>
<li>
<p>X500 Subject&#8217;s e-mail attribute</p>
</li>
<li>
<p>X500 Subject&#8217;s Common Name attribute</p>
</li>
<li>
<p>Match IssuerDN using regular expression</p>
</li>
<li>
<p>X500 Issuer&#8217;s e-mail attribute</p>
</li>
<li>
<p>X500 Issuer&#8217;s Common Name attribute</p>
</li>
<li>
<p>Certificate Serial Number</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="regular-expressions"><a class="anchor" href="#regular-expressions"></a>6.6.2. Regular Expressions</h4>
<div class="paragraph">
<p>The certificate identity can be extracted from either Subject DN or Issuer DN using a regular expression as a filter. For example, the regular expression below will match the e-mail attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>emailAddress=(.*?)(?:,|$)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The regular expression filtering is applicable only if the <code>Identity Source</code> is set to either <code>Match SubjectDN using regular expression</code> or <code>Match IssuerDN using regular expression</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="mapping-certificate-identity-to-an-existing-user"><a class="anchor" href="#mapping-certificate-identity-to-an-existing-user"></a>6.6.3. Mapping certificate identity to an existing user</h4>
<div class="paragraph">
<p>The certificate identity mapping can be configured to map the extracted user identity to an existing user&#8217;s username or e-mail or to a custom attribute which value matches the certificate identity. For example, setting the <code>Identity source</code> to <em>Subject&#8217;s e-mail</em> and <code>User mapping method</code> to <em>Username or email</em> will have the X.509 client certificate authenticator use the e-mail attribute in the certificate&#8217;s Subject DN  as a search criteria to look up an existing user by username or by e-mail.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please notice that if we disable <code>Login with email</code> at realm settings, the same rules will be applied to certificate authentication. In other words, users won&#8217;t be able to log in using e-mail attribute.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="other-features-extended-certificate-validation"><a class="anchor" href="#other-features-extended-certificate-validation"></a>6.6.4. Other Features: Extended Certificate Validation</h4>
<div class="ulist">
<ul>
<li>
<p>Revocation status checking using CRL</p>
</li>
<li>
<p>Revocation status checking using CRL/Distribution Point</p>
</li>
<li>
<p>Revocation status checking using OCSP/Responder URI</p>
</li>
<li>
<p>Certificate KeyUsage validation</p>
</li>
<li>
<p>Certificate ExtendedKeyUsage validation</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="enable-x-509-client-certificate-user-authentication"><a class="anchor" href="#enable-x-509-client-certificate-user-authentication"></a>6.7. Enable X.509 Client Certificate User Authentication</h3>
<div class="paragraph">
<p>The following sections describe how to configure Wildfly/Undertow and the Keycloak Server to enable X.509 client certificate authentication.</p>
</div>
<div class="sect3">
<h4 id="enable-mutual-ssl-in-wildfly"><a class="anchor" href="#enable-mutual-ssl-in-wildfly"></a>6.7.1. Enable mutual SSL in WildFly</h4>
<div class="paragraph">
<p>See <a href="https://docs.jboss.org/author/display/WFLY10/Admin+Guide#AdminGuide-EnableSSL">Enable SSL</a> and <a href="https://docs.jboss.org/author/display/WFLY10/Admin+Guide#AdminGuide-%7B%7B%3Cssl%2F%3E%7D%7D">SSL</a> for the instructions how to enable SSL in Wildfly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open $KEYCLOAK_HOME/standalone/configuration/standalone.xml and add a new realm:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;security-realms&gt;
    &lt;security-realm name="ssl-realm"&gt;
        &lt;server-identities&gt;
            &lt;ssl&gt;
                &lt;keystore path="servercert.jks"
                          relative-to="jboss.server.config.dir"
                          keystore-password="servercert password"/&gt;
            &lt;/ssl&gt;
        &lt;/server-identities&gt;
        &lt;authentication&gt;
            &lt;truststore path="truststore.jks"
                        relative-to="jboss.server.config.dir"
                        keystore-password="truststore password"/&gt;
        &lt;/authentication&gt;
    &lt;/security-realm&gt;
&lt;/security-realms&gt;</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>ssl/keystore</code></dt>
<dd>
<p>The <code>ssl</code> element contains the <code>keystore</code> element that defines how to load the server public key pair from a JKS keystore</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/path</code></dt>
<dd>
<p>A path to a JKS keystore</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/relative-to</code></dt>
<dd>
<p>Defines a path the keystore path is relative to</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/keystore-password</code></dt>
<dd>
<p>The password to open the keystore</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/alias</code> (optional)</dt>
<dd>
<p>The alias of the entry in the keystore. Set it if the keystore contains multiple entries</p>
</dd>
<dt class="hdlist1"><code>ssl/keystore/key-password</code> (optional)</dt>
<dd>
<p>The private key password, if different from the keystore password.</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore</code></dt>
<dd>
<p>Defines how to load a trust store to verify the certificate presented by the remote side of the inbound/outgoing connection. Typically, the truststore contains a collection of trusted CA certificates.</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore/path</code></dt>
<dd>
<p>A path to a JKS keystore that contains the certificates of the trusted CAs (certificate authorities)</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore/relative-to</code></dt>
<dd>
<p>Defines a path the truststore path is relative to</p>
</dd>
<dt class="hdlist1"><code>authentication/truststore/keystore-password</code></dt>
<dd>
<p>The password to open the truststore</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="enable-https-listener"><a class="anchor" href="#enable-https-listener"></a>6.7.2. Enable https listener</h4>
<div class="paragraph">
<p>See <a href="https://docs.jboss.org/author/display/WFLY10/Admin+Guide#AdminGuide-HTTPSlistener">HTTPS Listener</a> for the instructions how to enable HTTPS in Wildfly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the &lt;https-listener&gt; element as shown below:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:3.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ....
    <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;https-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ssl-realm</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">verify-client</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">REQUESTED</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/server&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>https-listener/security-realm</code></dt>
<dd>
<p>The value must match the name of the realm from the previous section</p>
</dd>
<dt class="hdlist1"><code>https-listener/verify-client</code></dt>
<dd>
<p>If set to <code>REQUESTED</code>, the server will optionally ask for a client certificate. Setting the attribute to <code>REQUIRED</code> will have the server to refuse inbound connections if no client certificate has been provided.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-x-509-client-certificate-authentication-to-a-browser-flow"><a class="anchor" href="#adding-x-509-client-certificate-authentication-to-a-browser-flow"></a>6.8. Adding X.509 Client Certificate Authentication to a Browser Flow</h3>
<div class="ulist">
<ul>
<li>
<p>Select a realm, click on Authentication link, select the "Browser" flow</p>
</li>
<li>
<p>Make a copy of the buit-in "Browser" flow. You may want to give the new flow a distinctive name, i.e. "X.509 Browser"</p>
</li>
<li>
<p>Using the drop down, select the copied flow, and click on "Add Execution"</p>
</li>
<li>
<p>Select "X509/Validate User Form" using the drop down and click on "Save"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-execution.png" alt="x509 execution"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the up/down arrows, change the order of the "X509/Validate Username Form" by moving it above the "Browser Forms" execution, and set the requirement to "ALTERNATIVE"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-browser-flow.png" alt="x509 browser flow"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select the "Bindings" tab, find the drop down for "Browser Flow". Select the newly created X509 browser flow from the drop down and click on "Save".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-browser-flow-bindings.png" alt="x509 browser flow bindings"></span></p>
</div>
<div class="sect3">
<h4 id="configuring-x-509-client-certificate-authentication"><a class="anchor" href="#configuring-x-509-client-certificate-authentication"></a>6.8.1. Configuring X.509 Client Certificate Authentication</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-configuration.png" alt="x509 configuration"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>User Identity Source</code></dt>
<dd>
<p>Defines how to extract the user identity from a client certificate.</p>
</dd>
<dt class="hdlist1"><code>A regular expression</code> (optional)</dt>
<dd>
<p>Defines a regular expression to use as a filter to extract the certificate identity. The regular expression must contain a single group.</p>
</dd>
<dt class="hdlist1"><code>User Mapping Method</code></dt>
<dd>
<p>Defines how to match the certificate identity to an existing user. <em>Username or e-mail</em> will search for an existing user by username or e-mail. <em>Custom Attribute Mapper</em> will  search for an existing user with a custom attribute which value matches the certificate identity. The name of the custom attribute is configurable.</p>
</dd>
<dt class="hdlist1"><code>A name of user attribute</code> (optional)</dt>
<dd>
<p>A custom attribute which value will be matched against the certificate identity.</p>
</dd>
<dt class="hdlist1"><code>CRL Checking Enabled</code> (optional)</dt>
<dd>
<p>Defines whether to check the revocation status of the certificate using Certificate Revocation List.</p>
</dd>
<dt class="hdlist1"><code>Enable CRL Distribution Point to check certificate revocation status</code> (optional)</dt>
<dd>
<p>Defines whether to use CDP to check the certificate revocation status. Most PKI authorities include CDP in their certificates.</p>
</dd>
<dt class="hdlist1"><code>CRL file path</code> (optional)</dt>
<dd>
<p>Defines a path to a file that contains a CRL list. The value must be a path to a valid file if <code>CRL Checking Enabled</code> option is turned on.</p>
</dd>
<dt class="hdlist1"><code>OCSP Checking Enabled</code>(optional)</dt>
<dd>
<p>Defines whether to check the certificate revocation status using Online Certificate Status Protocol.</p>
</dd>
<dt class="hdlist1"><code>OCSP Responder URI</code> (optional)</dt>
<dd>
<p>Allows to override a value of the OCSP responder URI in the certificate.</p>
</dd>
<dt class="hdlist1"><code>Validate Key Usage</code> (optional)</dt>
<dd>
<p>Verifies whether the certificate&#8217;s KeyUsage extension bits are set. For example, "digitalSignature,KeyEncipherment" will verify if  bits 0 and 2 in the KeyUsage extension are asserted. Leave the parameter empty to disable the Key Usage validaion. See <a href="https://tools.ietf.org/html/rfc5280#section-4.2.1.3">RFC5280, Section-4.2.1.3</a>. The server will raise an error only when flagged as critical by the issuing CA and there is a key usage extension mismatch.</p>
</dd>
<dt class="hdlist1"><code>Validate Extended Key Usage</code> (optional)</dt>
<dd>
<p>Verifies one or more purposes as defined in the Extended Key Usage extension. See <a href="https://tools.ietf.org/html/rfc5280#section-4.2.1.12">RFC5280, Section-4.2.1.12</a>. Leave the parameter empty to disable the Extended Key Usage validation. The server will raise an error only when flagged as critical by the issuing CA and there is a key usage extension mismatch.</p>
</dd>
<dt class="hdlist1"><code>Bypass identity confirmation</code></dt>
<dd>
<p>If set, X.509 client certificate authentication will not prompt the user to confirm the certificate identity and will automatiocally sign in the user upon successful authentication.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-x-509-client-certificate-authentication-to-a-direct-grant-flow"><a class="anchor" href="#adding-x-509-client-certificate-authentication-to-a-direct-grant-flow"></a>6.9. Adding X.509 Client Certificate Authentication to a Direct Grant Flow</h3>
<div class="ulist">
<ul>
<li>
<p>Using keycloak admin console, click on "Authentication" and select the "Direct Grant" flow,</p>
</li>
<li>
<p>Make a copy of the build-in "Direct Grant" flow. You may want to give the new flow a distinctive name, i.e. "X509 Direct Grant",</p>
</li>
<li>
<p>Delete "Validate Username" and "Password" authenticators,</p>
</li>
<li>
<p>Click on "Execution" and add "X509/Validate Username" and click on "Save" to add the execution step to the parent flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-directgrant-execution.png" alt="x509 directgrant execution"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the <code>Requirement</code> to <em>REQUIRED</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-directgrant-flow.png" alt="x509 directgrant flow"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set up the x509 authentication configuration by following the steps described earlier in the x.509 Browser Flow section.</p>
</li>
<li>
<p>Select the "Bindings" tab, find the drop down for "Direct Grant Flow". Select the newly created X509 direct grant flow from the drop down and click on "Save".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/x509-directgrant-flow-bindings.png" alt="x509 directgrant flow bindings"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting-2"><a class="anchor" href="#troubleshooting-2"></a>6.10. Troubleshooting</h3>
<div class="sect3">
<h4 id="direct-grant-authentication-with-x-509"><a class="anchor" href="#direct-grant-authentication-with-x-509"></a>6.10.1. Direct Grant authentication with X.509</h4>
<div class="paragraph">
<p>The following template can be used to request a token using the Resource Owner Password Credentials Grant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ curl https://[host][:port]/auth/realms/master/protocol/openid-connect/token \
       --insecure \
       --data "grant_type=password&amp;scope=openid profile&amp;username=&amp;password=&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET" \
       -E /path/to/client_cert.crt \
       --key /path/to/client_cert.key</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>[host][:port]</code></dt>
<dd>
<p>The host and the port number of a remote Keycloak server that has been configured to allow users authenticate with x.509 client certificates using the Direct Grant Flow.</p>
</dd>
<dt class="hdlist1"><code>CLIENT_ID</code></dt>
<dd>
<p>A client id.</p>
</dd>
<dt class="hdlist1"><code>CLIENT_SECRET</code></dt>
<dd>
<p>For confidential clients, a client secret; otherwise, leave it empty.</p>
</dd>
<dt class="hdlist1"><code>client_cert.crt</code></dt>
<dd>
<p>A public key certificate that will be used to verify the identity of the client in mutual SSL authentication. The certificate should be in PEM format.</p>
</dd>
<dt class="hdlist1"><code>client_cert.key</code></dt>
<dd>
<p>A private key in the public key pair. Also expected in PEM format.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sso-protocols"><a class="anchor" href="#sso-protocols"></a>7. SSO Protocols</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The chapter gives a brief overview of the authentication protocols and how the Keycloak authentication server
and the applications it secures interact with these protocols.</p>
</div>
<div class="sect2">
<h3 id="_oidc"><a class="anchor" href="#_oidc"></a>7.1. Open ID Connect</h3>
<div class="paragraph">
<p><a href="http://openid.net/connect/">Open ID Connect</a> (OIDC) is an authentication protocol that is an extension of <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0</a>.
While OAuth 2.0 is only a framework for building authorization protocols and is mainly incomplete, OIDC is a full-fledged authentication and authorization
protocol.  OIDC also makes heavy use of the <a href="https://jwt.io">Json Web Token</a> (JWT) set of standards.  These standards define an
identity token JSON format and ways to digitally sign and encrypt that data in a compact and web-friendly way.</p>
</div>
<div class="paragraph">
<p>There are really two types of use cases when using OIDC.  The first is an application that asks the Keycloak server to authenticate
a user for them.  After a successful login, the application will receive an <em>identity token</em> and an <em>access token</em>.  The <em>identity token</em>
contains information about the user such as username, email, and other profile information.  The <em>access token</em> is digitally signed by
the realm and contains access information (like user role mappings) that the application can use to determine what resources the user
is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services.  In this case, the client asks Keycloak
to obtain an <em>access token</em> it can use to invoke on other remote services on behalf of the user.  Keycloak authenticates the user
then asks the user for consent to grant access to the client requesting it.  The client then receives the <em>access token</em>.  This <em>access token</em>
is digitally signed by the realm.  The client can make REST invocations on remote services using this <em>access token</em>.  The REST service
extracts the <em>access token</em>, verifies the signature of the token, then decides based on access information within the token whether or not to process
the request.</p>
</div>
<div class="sect3">
<h4 id="_oidc-auth-flows"><a class="anchor" href="#_oidc-auth-flows"></a>7.1.1. OIDC Auth Flows</h4>
<div class="paragraph">
<p>OIDC has different ways for a client or application to authenticate a user and receive an <em>identity</em> and <em>access</em> token.  Which
path you use depends greatly on the type of application or client requesting access.  All of these flows are described in the
OIDC and OAuth 2.0 specifications so only a brief overview will be provided here.</p>
</div>
<div class="sect4">
<h5 id="authorization-code-flow"><a class="anchor" href="#authorization-code-flow"></a>Authorization Code Flow</h5>
<div class="paragraph">
<p>This is a browser-based protocol and it is what we recommend you use to authenticate and authorize browser-based applications.  It makes
heavy use of browser redirects to obtain an <em>identity</em> and <em>access</em> token.  Here&#8217;s a brief summary:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browser visits application.  The application notices the user is not logged in, so it redirects the browser to Keycloak
to be authenticated.  The application passes along a callback URL (a redirect URL) as a query parameter in this browser redirect
that Keycloak will use when it finishes authentication.</p>
</li>
<li>
<p>Keycloak authenticates the user and creates a one-time, very short lived, temporary code.  Keycloak
redirects back to the application using the callback URL provided earlier and additionally adds the temporary code
as a query parameter in the callback URL.</p>
</li>
<li>
<p>The application extracts the temporary code and makes a background out of band REST invocation to Keycloak
to exchange the code for an <em>identity</em>, <em>access</em> and <em>refresh</em> token.  Once this temporary code has been used once
to obtain the tokens, it can never be used again.  This prevents potential replay attacks.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is important to note that <em>access</em> tokens are usually short lived and often expired after only minutes.  The additional <em>refresh</em>
token that was transmitted by the login protocol allows the application to obtain a new access token after it expires.  This
refresh protocol is important in the situation of a compromised system.  If access tokens are short lived, the whole system is only
vulnerable to a stolen token for the lifetime of the access token.  Future refresh token requests will fail if an admin
has revoked access.  This makes things more secure and more scalable.</p>
</div>
<div id="_confidential-clients" class="paragraph">
<p>Another important aspect of this flow is the concept of a <em>public</em> vs. a <em>confidential</em> client.  <em>Confidential</em> clients are required
to provide a client secret when they exchange the temporary codes for tokens.  <em>Public</em> clients are not required to provide this client secret.
<em>Public</em> clients are perfectly fine so long as HTTPS is strictly enforced and you are very strict about what redirect URIs are registered for the
client.  HTML5/JavaScript clients always have to be <em>public</em> clients because there is no way to transmit the client secret to them in a secure
manner.  Again, this is ok so long as you use HTTPS and strictly enforce redirect URI registration.  This guide goes more detail
into this in the <a href="#_clients">Managing Clients</a> chapter.</p>
</div>
</div>
<div class="sect4">
<h5 id="implicit-flow"><a class="anchor" href="#implicit-flow"></a>Implicit Flow</h5>
<div class="paragraph">
<p>This is a browser-based protocol that is similar to Authorization Code Flow except there are fewer requests and no refresh tokens involved.
We do not recommend this flow as there remains the possibility of <em>access</em> tokens being leaked in the browser history as tokens are transmitted
via redirect URIs (see below).  Also, since this flow doesn&#8217;t provide the client with a refresh token, access tokens would either have to
be long-lived or users would have to re-authenticate when they expired.  This flow is supported because it is in the OIDC and OAuth 2.0 specification.
Here&#8217;s a brief summary of the protocol:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browser visits application.  The application notices the user is not logged in, so it redirects the browser to Keycloak
to be authenticated.  The application passes along a callback URL (a redirect URL) as a query parameter in this browser redirect
that Keycloak will use when it finishes authentication.</p>
</li>
<li>
<p>Keycloak authenticates the user and creates an <em>identity</em> and <em>access</em> token.  Keycloak
redirects back to the application using the callback URL provided earlier and additionally adding the <em>identity</em> and
<em>access</em> tokens as query parameters in the callback URL.</p>
</li>
<li>
<p>The application extracts the <em>identity</em> and <em>access</em> tokens from the callback URL.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="resource-owner-password-credentials-grant-direct-access-grants"><a class="anchor" href="#resource-owner-password-credentials-grant-direct-access-grants"></a>Resource Owner Password Credentials Grant (Direct Access Grants)</h5>
<div class="paragraph">
<p>This is referred to in the Admin Console as <em>Direct Access Grants</em>. This is used by REST clients that want to obtain a token on behalf of a user.  It is one HTTP POST request that contains
the credentials of the user as well as the id of the client and the client&#8217;s secret (if it is a confidential client).  The user&#8217;s credentials
are sent within form parameters.  The HTTP response contains
<em>identity</em>, <em>access</em>, and <em>refresh</em> tokens.</p>
</div>
</div>
<div class="sect4">
<h5 id="_client_credentials_grant"><a class="anchor" href="#_client_credentials_grant"></a>Client Credentials Grant</h5>
<div class="paragraph">
<p>This is also used by REST clients, but instead of obtaining a token that works on behalf
of an external user, a token is created based on the metadata and permissions of a service account that is associated with the client.
More info together with example is in <a href="#_service_accounts">Service Accounts</a> chapter.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-server-oidc-uri-endpoints"><a class="anchor" href="#keycloak-server-oidc-uri-endpoints"></a>7.1.2. Keycloak Server OIDC URI Endpoints</h4>
<div class="paragraph">
<p>Here&#8217;s a list of OIDC endpoints that the Keycloak publishes.  These URLs are useful if you are using a non-Keycloak client adapter to
talk OIDC with the auth server.  These are all relative URLs and the root of the URL being the HTTP(S) protocol, hostname, and usually path prefixed with
<em>/auth</em>:  i.e. https://localhost:8080/auth</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/token</dt>
<dd>
<p>This is the URL endpoint for obtaining a temporary code in the Authorization Code Flow or for obtaining tokens via the
Implicit Flow, Direct Grants, or Client Grants.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/auth</dt>
<dd>
<p>This is the URL endpoint for the Authorization Code Flow to turn a temporary code into a token.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/logout</dt>
<dd>
<p>This is the URL endpoint for performing logouts.</p>
</dd>
<dt class="hdlist1">/realms/{realm-name}/protocol/openid-connect/userinfo</dt>
<dd>
<p>This is the URL endpoint for the User Info service described in the OIDC specification.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In all of these replace <em>{realm-name}</em> with the name of the realm.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_saml"><a class="anchor" href="#_saml"></a>7.2. SAML</h3>
<div class="paragraph">
<p><a href="http://saml.xml.org/saml-specifications">SAML 2.0</a> is a similar specification to OIDC but a lot older and more mature.  It has its roots in SOAP and the plethora
of WS-* specifications so it tends to be a bit more verbose than OIDC.  SAML 2.0 is primarily an authentication protocol
that works by exchanging XML documents between the authentication server and the application.  XML signatures and encryption
is used to verify requests and responses.</p>
</div>
<div class="paragraph">
<p>There is really two types of use cases when using SAML.  The first is an application that asks the Keycloak server to authenticate
a user for them.  After a successful login, the application will receive an XML document that contains
something called a SAML assertion that specify various attributes about the user.  This XML document is digitally signed by
the realm and contains access information (like user role mappings) that the application can use to determine what resources the user
is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services.  In this case, the client asks Keycloak
to obtain an SAML assertion it can use to invoke on other remote services on behalf of the user.</p>
</div>
<div class="sect3">
<h4 id="saml-bindings"><a class="anchor" href="#saml-bindings"></a>7.2.1. SAML Bindings</h4>
<div class="paragraph">
<p>SAML defines a few different ways to exchange XML documents when executing the authentication protocol.  The <em>Redirect</em> and <em>Post</em> bindings
cover browser based applications.  The <em>ECP</em> binding covers REST invocations.  There are other binding types but Keycloak only
supports those three.</p>
</div>
<div class="sect4">
<h5 id="redirect-binding"><a class="anchor" href="#redirect-binding"></a>Redirect Binding</h5>
<div class="paragraph">
<p>The <em>Redirect</em> Binding uses a series of browser redirect URIs to exchange information.  This is a rough overview of
how it works.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The user visits the application and the application finds the user is not authenticated.  It generates an XML authentication
request document and encodes it as a query param in a URI that is used to redirect to the Keycloak server.
Depending on your settings, the application may also digitally sign this XML document and also stuff this signature as a query
param in the redirect URI to Keycloak.  This signature is used to validate the client that sent this
request.</p>
</li>
<li>
<p>The browser is redirected to Keycloak.  The server extracts the XML auth request document and verifies
the digital signature if required.  The user then has to enter in their credentials to be authenticated.</p>
</li>
<li>
<p>After authentication, the server generates an XML authentication response document.  This document contains
a SAML assertion that holds metadata about the user like name, address, email, and any role mappings the user
might have.  This document is almost always digitally signed using XML signatures, and may also be encrypted.</p>
</li>
<li>
<p>The XML auth response document is then encoded as a query param in a redirect URI that brings the browser back
to the application.  The digital signature is also included as a query param.</p>
</li>
<li>
<p>The application receives the redirect URI and extracts the XML document and verifies the realm&#8217;s signature to make
sure it is receiving a valid auth response.  The information inside the SAML assertion is then used to make
access decisions or display user data.</p>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="post-binding"><a class="anchor" href="#post-binding"></a>POST Binding</h5>
<div class="paragraph">
<p>The SAML <em>POST</em> binding works almost the exact same way as the <em>Redirect</em> binding, but instead of GET requests, XML
documents are exchanged by POST requests.  The <em>POST</em> Binding uses JavaScript to trick the browser into making a POST request to
the Keycloak server or application when exchanging documents.  Basically HTTP responses contain an HTML document
that contains an HTML form with embedded JavaScript.  When the page is loaded, the JavaScript automatically invokes the form.
You really don&#8217;t need to know about this stuff, but it is a pretty clever trick.</p>
</div>
</div>
<div class="sect4">
<h5 id="ecp"><a class="anchor" href="#ecp"></a>ECP</h5>
<div class="paragraph">
<p>ECP stands for "Enhanced Client or Proxy", a SAML v.2.0 profile which allows for the exchange of SAML attributes outside the context of a web browser.
This is used most often for REST or SOAP-based clients.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-server-saml-uri-endpoints"><a class="anchor" href="#keycloak-server-saml-uri-endpoints"></a>7.2.2. Keycloak Server SAML URI Endpoints</h4>
<div class="paragraph">
<p>Keycloak really only has one endpoint for all SAML requests.</p>
</div>
<div class="paragraph">
<p><code>http(s)://authserver.host/auth/realms/{realm-name}/protocol/saml</code></p>
</div>
<div class="paragraph">
<p>All bindings use this endpoint.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openid-connect-vs-saml"><a class="anchor" href="#openid-connect-vs-saml"></a>7.3. OpenID Connect vs. SAML</h3>
<div class="paragraph">
<p>Choosing between OpenID Connect and SAML is not just a matter of using a newer protocol (OIDC) instead of the older more mature protocol (SAML).</p>
</div>
<div class="paragraph">
<p>In most cases Keycloak recommends using OIDC.</p>
</div>
<div class="paragraph">
<p>SAML tends to be a bit more verbose than OIDC.</p>
</div>
<div class="paragraph">
<p>Beyond verbosity of exchanged data, if you compare the specifications you&#8217;ll find that OIDC was designed to work with the web while SAML was retrofitted to work on top of the web.  For example, OIDC is also more suited for HTML5/JavaScript applications because it is
easier to implement on the client side than SAML. As tokens are in the JSON format,
they are easier to consume by JavaScript. You will also find several nice features that
make implementing security in your web applications easier. For example, check out the <a href="http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification">iframe trick</a> that the specification uses to easily determine if a user is still logged in or not.</p>
</div>
<div class="paragraph">
<p>SAML has its uses though. As you see the OIDC specifications evolve you see they implement more and more features that SAML has had for years. What we often see is that people pick SAML over OIDC because of the perception that it is more mature and also because they already have existing applications that are secured with it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_docker"><a class="anchor" href="#_docker"></a>7.4. Docker Registry v2 Authentication</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Docker authentication is disabled by default. To enable see <a href="http://www.keycloak.org/docs/3.4/server_installation/#_profiles">Profiles</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://docs.docker.com/registry/spec/auth/">Docker Registry V2 Authentciation</a> is an OIDC-Like protocol used to authenticate users against a Docker registry.  Keycloak&#8217;s implementation of this protocol allows for a Keycloak authentication server to be used by a Docker client to authenticate against a registry.  While this protocol uses fairly standard token and signature mechanisms, it has a few wrinkles that prevent it from being treated as a true OIDC implementation.  The largest deviations include a very specific JSON format for requests and responses as well as the ability to understand how to map repository names and permissions to the OAuth scope mechanism.</p>
</div>
<div class="sect3">
<h4 id="docker-auth-flow"><a class="anchor" href="#docker-auth-flow"></a>7.4.1. Docker Auth Flow</h4>
<div class="paragraph">
<p>The <a href="https://docs.docker.com/registry/spec/auth/token/">Docker API documentation</a> best describes and illustrates this process, however a brief summary will be given below from the perspective of they Keycloak authentication server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This flow assumes that a <code>docker login</code> command has already been performed
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>The flow begins when the Docker client requests a resource from the Docker registry.  If the resource is protected and no auth token is present in the request, the Docker registry server will respond to the client with a 401 + some information on required permissions and where to find the authorization server.</p>
</li>
<li>
<p>The Docker client will construct an authentication request based on the 401 response from the Docker registry.  The client will then use the locally cached credentials (from a previously run <code>docker login</code> command) as part of a <a href="https://tools.ietf.org/html/rfc2617">HTTP Basic Authentication</a> request to the Keycloak authentication server.</p>
</li>
<li>
<p>The Keycloak authentication server will attempt to authenticate the user and return a JSON body containing an OAuth-style Bearer token.</p>
</li>
<li>
<p>The Docker client will get the bearer token from the JSON response and use it in the Authorization header to request the protected resource.</p>
</li>
<li>
<p>When the Docker registry recieves the new request for the protected resource with the token from the Keycloak server, the registry validates the token and grants access to the requested resource (if appropriate).</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="keycloak-docker-registry-v2-authentication-server-uri-endpoints"><a class="anchor" href="#keycloak-docker-registry-v2-authentication-server-uri-endpoints"></a>7.4.2. Keycloak Docker Registry v2 Authentication Server URI Endpoints</h4>
<div class="paragraph">
<p>Keycloak really only has one endpoint for all Docker auth v2 requests.</p>
</div>
<div class="paragraph">
<p><code>http(s)://authserver.host/auth/realms/{realm-name}/protocol/docker-v2</code></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clients"><a class="anchor" href="#_clients"></a>8. Managing Clients</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clients are entities that can request authentication of a user.  Clients come in two forms.
The first type of client is an application that wants
to participate in single-sign-on.  These clients just want Keycloak to provide security for them.  The other type
of client is one that is requesting an access token so that it can invoke other services on behalf of the authenticated user.
This section discusses various aspects around configuring clients and various ways to do it.</p>
</div>
<div class="sect2">
<h3 id="oidc-clients"><a class="anchor" href="#oidc-clients"></a>8.1. OIDC Clients</h3>
<div class="paragraph">
<p><a href="#_oidc">OpenID Connect</a> is the preferred protocol to secure applications.  It was designed from the ground up to be web friendly
and work best with HTML5/JavaScript applications.</p>
</div>
<div class="paragraph">
<p>To create an OIDC client go to the <code>Clients</code> left menu item.  On this page you&#8217;ll see a <code>Create</code> button on the right.</p>
</div>
<div class="paragraph">
<div class="title">Clients</div>
<p><span class="image"><img src="./keycloak-images/clients.png" alt="clients"></span></p>
</div>
<div class="paragraph">
<p>This will bring you to the <code>Add Client</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Client</div>
<p><span class="image"><img src="./keycloak-images/add-client-oidc.png" alt="add client oidc"></span></p>
</div>
<div class="paragraph">
<p>Enter in the <code>Client ID</code> of the client.  This should be a simple
alpha-numeric string that will be used in requests and in the Keycloak database to identify the client.
Next select <code>openid-connect</code> in the <code>Client Protocol</code> drop down box.
Ignore the <code>Client Template</code> listbox for now,
we&#8217;ll go over that later in this chapter.
Finally enter in the base URL of your
application in the <code>Root URL</code> field and click <code>Save</code>.  This will create the client and bring you to the client <code>Settings</code>
tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Settings</div>
<p><span class="image"><img src="./keycloak-images/client-settings-oidc.png" alt="client settings oidc"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through each configuration item on this page.</p>
</div>
<div class="paragraph">
<p><strong>Client ID</strong></p>
</div>
<div class="paragraph">
<p>This specifies an alpha-numeric string that will be used as the client identifier for OIDC requests.</p>
</div>
<div class="paragraph">
<p><strong>Name</strong></p>
</div>
<div class="paragraph">
<p>This is the display name for the client whenever it is displayed in a Keycloak UI screen.  You can localize
the value of this field by setting up a replacement string value i.e. ${myapp}.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>
for more information.</p>
</div>
<div class="paragraph">
<p><strong>Description</strong></p>
</div>
<div class="paragraph">
<p>This specifies the description of the client.  This can also be localized.</p>
</div>
<div class="paragraph">
<p><strong>Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is turned off, the client will not be allowed to request authentication.</p>
</div>
<div class="paragraph">
<p><strong>Consent Required</strong></p>
</div>
<div class="paragraph">
<p>If this is on, then users will get a consent page which asks the user if they grant access to that application.  It will also
display the metadata that the client is interested in so that the user knows exactly what information the client is getting access to.
If you&#8217;ve ever done a social login to Google, you&#8217;ll often see a similar page.  Keycloak provides the same functionality.</p>
</div>
<div id="_access-type" class="paragraph">
<p><strong>Access Type</strong></p>
</div>
<div class="paragraph">
<p>This defines the type of the OIDC client.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>confidential</em></dt>
<dd>
<p>Confidential access type is for server-side clients that need to perform a browser login and require a client secret when they turn an access code into an access token,
(see <a href="https://tools.ietf.org/html/rfc6749#section-4.1.3">Access Token Request</a> in the OAuth 2.0 spec for more details). This type should be used for server-side applications.</p>
</dd>
<dt class="hdlist1"><em>public</em></dt>
<dd>
<p>Public access type is for client-side clients that need to perform a browser login. With a client-side application there is no way to keep a secret safe. Instead it is very important to restrict  access by configuring correct redirect URIs for the client.</p>
</dd>
<dt class="hdlist1"><em>bearer-only</em></dt>
<dd>
<p>Bearer-only access type means that the application only allows bearer token requests.
If this is turned on, this application cannot participate in browser logins.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><strong>Root URL</strong></p>
</div>
<div class="paragraph">
<p>If Keycloak uses any configured relative URLs, this value is prepended to them.</p>
</div>
<div class="paragraph">
<p><strong>Valid Redirect URIs</strong></p>
</div>
<div class="paragraph">
<p>This is a required field.  Enter in a URL pattern and click the + sign to add.  Click the - sign next to URLs you want to remove.
Remember that you still have to click the <code>Save</code> button!
Wildcards (\*) are only allowed at the end of a URI, i.e. http://host.com/*</p>
</div>
<div class="paragraph">
<p>You should take extra precautions when registering valid redirect URI patterns. If you make
them too general you are vulnerable to attacks.  See <a href="#_unspecific-redirect-uris">Threat Model Mitigation</a> chapter
for more information.</p>
</div>
<div class="paragraph">
<p><strong>Base URL</strong></p>
</div>
<div class="paragraph">
<p>If Keycloak needs to link to the client, this URL is used.</p>
</div>
<div class="paragraph">
<p><strong>Standard Flow Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is on, clients are allowed to use the OIDC <a href="#_oidc-auth-flows">Authorization Code Flow</a>.</p>
</div>
<div class="paragraph">
<p><strong>Implicit Flow Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is on, clients are allowed to use the OIDC <a href="#_oidc-auth-flows">Implicit Flow</a>.</p>
</div>
<div class="paragraph">
<p><strong>Direct Grants Enabled</strong></p>
</div>
<div class="paragraph">
<p>If this is on, clients are allowed to use the OIDC <a href="#_oidc-auth-flows">Direct Grants</a>.</p>
</div>
<div class="paragraph">
<p><strong>Admin URL</strong></p>
</div>
<div class="paragraph">
<p>For Keycloak specific client adapters, this is the callback endpoint for the client.  The Keycloak
server will use this URI to make callbacks like pushing revocation policies, performing backchannel logout, and other
administrative operations.  For Keycloak servlet adapters, this can be the root URL of the servlet application.
For more information see <a href="http://www.keycloak.org/docs/3.4/securing_apps/">Securing Applications and Services Guide</a>.</p>
</div>
<div class="paragraph">
<p><strong>Web Origins</strong></p>
</div>
<div class="paragraph">
<p>This option centers around <a href="http://www.w3.org/TR/cors/">CORS</a> which stands for Cross-Origin Resource Sharing.
If browser JavaScript tries to make an AJAX HTTP request to a server whose domain is different from the one the
JavaScript code came from, then the request must use CORS.
The server must handle CORS requests in a special way, otherwise the browser will not display or allow the request to be processed.
This protocol exists to protect against XSS, CSRF and other JavaScript-based attacks.</p>
</div>
<div class="paragraph">
<p>Keycloak has support for validated CORS requests.  The way it works is that the domains listed in the
<code>Web Origins</code> setting for the client are embedded within the access token sent to the client application.  The client
application can then use this information to decide whether or not to allow a CORS request to be invoked on it.  This is
an extension to the OIDC protocol so only Keycloak client adapters support this feature.
See <a href="http://www.keycloak.org/docs/3.4/securing_apps/">Securing Applications and Services Guide</a> for more information.</p>
</div>
<div class="paragraph">
<p>To fill in the <code>Web Origins</code> data, enter in a base URL and click the + sign to add.  Click the - sign next to URLs you want to remove.
Remember that you still have to click the <code>Save</code> button!</p>
</div>
<div class="sect3">
<h4 id="_client-credentials"><a class="anchor" href="#_client-credentials"></a>8.1.1. Confidential Client Credentials</h4>
<div class="paragraph">
<p>If you&#8217;ve set the client&#8217;s <a href="#_access-type">access type</a> to <code>confidential</code> in the client&#8217;s
<code>Settings</code> tab, a new <code>Credentials</code> tab will show up. As part of dealing with this
type of client you have to configure the client&#8217;s credentials.</p>
</div>
<div class="paragraph">
<div class="title">Credentials Tab</div>
<p><span class="image"><img src="./keycloak-images/client-credentials.png" alt="client credentials"></span></p>
</div>
<div class="paragraph">
<p>The <code>Client Authenticator</code> list box specifies the type of credential you are going to use for your confidential client.
It defaults to client ID and secret.  The secret is automatically generated for you and the <code>Regenerate Secret</code>
button allows you to recreate this secret if you want or need to.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can opt to use a signed Json Web Token (JWT) instead of a secret.</p>
</div>
<div class="paragraph">
<div class="title">Signed JWT</div>
<p><span class="image"><img src="./keycloak-images/client-credentials-jwt.png" alt="client credentials jwt"></span></p>
</div>
<div class="paragraph">
<p>When choosing this credential type you will have to also generate a private key and certificate for the client.  The private key
will be used to sign the JWT, while the certificate is used by the server to verify the signature.  Click on the
<code>Generate new keys and certificate</code> button to start this process.</p>
</div>
<div class="paragraph">
<div class="title">Generate Keys</div>
<p><span class="image"><img src="./keycloak-images/generate-client-keys.png" alt="generate client keys"></span></p>
</div>
<div class="paragraph">
<p>When you generate these keys, Keycloak will store the certificate, and you&#8217;ll need to download the private key
and certificate for your client to use.  Pick the archive format you want and specify the password for the private key
and store.</p>
</div>
<div class="paragraph">
<p>You can also opt to
generate these via an external tool and just import the client&#8217;s certificate.</p>
</div>
<div class="paragraph">
<div class="title">Import Certificate</div>
<p><span class="image"><img src="./keycloak-images/import-client-cert.png" alt="import client cert"></span></p>
</div>
<div class="paragraph">
<p>There are multiple formats you can import from, just choose the archive format you have the certificate stored in,
select the file, and click the <code>Import</code> button.</p>
</div>
<div class="paragraph">
<p>Finally note that you don&#8217;t even need to import certificate if you choose to <code>Use JWKS URL</code> . In that case, you can provide the URL where
client publishes it&#8217;s public key in <a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html">JWK</a> format. This is flexible because when
client changes it&#8217;s keys, Keycloak will automatically download them without need to re-import anything on Keycloak side.</p>
</div>
<div class="paragraph">
<p>If you use client secured by Keycloak adapter, you can configure the JWKS URL like <a href="https://myhost.com/myapp/k_jwks" class="bare">https://myhost.com/myapp/k_jwks</a> assuming that <a href="https://myhost.com/myapp" class="bare">https://myhost.com/myapp</a> is the
root URL of your client application. See <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for additional details.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
For the performance purposes, Keycloak caches the public keys of the OIDC clients. If you think that private key of your client
was compromised, it is obviously good to update your keys, but it&#8217;s also good to clear the keys cache. See <a href="#_clear-cache">Clearing the cache</a>
section for more details.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_service_accounts"><a class="anchor" href="#_service_accounts"></a>8.2. Service Accounts</h3>
<div class="paragraph">
<p>Each OIDC client has a built-in <em>service account</em> which allows it to obtain an access token.
This is covered in the OAuth 2.0 specifiation under <a href="#_client_credentials_grant">Client Credentials Grant</a>.
To use this feature you must set the <a href="#_access-type">Access Type</a> of your client to <code>confidential</code>.  When you do this,
the <code>Service Accounts Enabled</code> switch will appear.  You need to turn on this switch.  Also make sure that you have
configured your <a href="#_client-credentials">client credentials</a>.</p>
</div>
<div class="paragraph">
<p>To use it you must have registered a valid <code>confidential</code> Client and you need to check the switch <code>Service Accounts Enabled</code> in Keycloak admin console for this client.
In tab <code>Service Account Roles</code> you can configure the roles available to the service account retrieved on behalf of this client.
Don&#8217;t forget that you need those roles to be available in Scopes of this client as well (unless you have <code>Full Scope Allowed</code> on). As in normal login, roles from access token are the intersection of scopes and the service account roles.</p>
</div>
<div class="paragraph">
<p>The REST URL to invoke on is <code>/auth/realms/{realm-name}/protocol/openid-connect/token</code>.
Invoking on this URL is a POST request and requires you to post the client credentials.
By default, client credentials are represented by clientId and clientSecret of the client in <code>Authorization: Basic</code> header, but you can also authenticate the client with a signed JWT assertion or any other custom mechanism for client authentication.
You also need to use the parameter <code>grant_type=client_credentials</code> as per the OAuth2 specification.</p>
</div>
<div class="paragraph">
<p>For example the POST invocation to retrieve a service account can look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>    POST /auth/realms/demo/protocol/openid-connect/token
    Authorization: Basic cHJvZHVjdC1zYS1jbGllbnQ6cGFzc3dvcmQ=
    Content-Type: application/x-www-form-urlencoded

    grant_type=client_credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>The response would be this <a href="https://tools.ietf.org/html/rfc6749#section-4.4.3">standard JSON document</a> from the OAuth 2.0 specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>HTTP/1.1 200 OK
Content-Type: application/json;charset=UTF-8
Cache-Control: no-store
Pragma: no-cache

{
    "access_token":"2YotnFZFEjr1zCsicMWpAA",
    "token_type":"bearer",
    "expires_in":60,
    "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "refresh_expires_in":600,
    "id_token":"tGzv3JOkF0XG5Qx2TlKWIA",
    "not-before-policy":0,
    "session_state":"234234-234234-234234"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The retrieved access token can be refreshed or logged out by an out-of-bound request.</p>
</div>
</div>
<div class="sect2">
<h3 id="saml-clients"><a class="anchor" href="#saml-clients"></a>8.3. SAML Clients</h3>
<div class="paragraph">
<p>Keycloak supports <a href="#_saml">SAML 2.0</a> for registered applications.
Both POST and Redirect bindings are supported.
You can choose to require client signature validation and can have the server sign and/or encrypt responses as well.</p>
</div>
<div class="paragraph">
<p>To create a SAML client go to the <code>Clients</code> left menu item.  On this page you&#8217;ll see a <code>Create</code> button on the right.</p>
</div>
<div class="paragraph">
<div class="title">Clients</div>
<p><span class="image"><img src="./keycloak-images/clients.png" alt="clients"></span></p>
</div>
<div class="paragraph">
<p>This will bring you to the <code>Add Client</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Client</div>
<p><span class="image"><img src="./keycloak-images/add-client-saml.png" alt="add client saml"></span></p>
</div>
<div class="paragraph">
<p>Enter in the <code>Client ID</code> of the client.  This is often a URL and will be the expected <code>issuer</code> value in SAML requests sent
by the application.  Next select <code>saml</code> in the <code>Client Protocol</code> drop down box.
Ignore the <code>Client Template</code> listbox for now,
we&#8217;ll go over that later in this chapter.
Finally enter in the <code>Client SAML Endpoint</code> URL.  Enter the
URL you want the Keycloak server to send SAML requests and responses to.  Usually applications have only one URL for processing SAML requests.
If your application has different URLs for its bindings, don&#8217;t worry, you can fix this in the <code>Settings</code> tab of the client.
Click <code>Save</code>.  This will create the client and bring you to the client <code>Settings</code>
tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Settings</div>
<p><span class="image"><img src="./keycloak-images/client-settings-saml.png" alt="client settings saml"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Client ID</dt>
<dd>
<p>This value must match the issuer value sent with AuthNRequests.
Keycloak will pull the issuer from the Authn SAML request and match it to a client by this value.</p>
</dd>
<dt class="hdlist1">Name</dt>
<dd>
<p>This is the display name for the client whenever it is displayed in a Keycloak UI screen.  You can localize
the value of this field by setting up a replacement string value i.e. ${myapp}.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>
for more information.</p>
</dd>
<dt class="hdlist1">Description</dt>
<dd>
<p>This specifies the description of the client.  This can also be localized.</p>
</dd>
<dt class="hdlist1">Enabled</dt>
<dd>
<p>If this is turned off, the client will not be allowed to request authentication.</p>
</dd>
<dt class="hdlist1">Consent Required</dt>
<dd>
<p>If this is on, then users will get a consent page which asks the user if they grant access to that application.  It will also
display the metadata that the client is interested in so that the user knows exactly what information the client is getting access to.
If you&#8217;ve ever done a social login to Google, you&#8217;ll often see a similar page.  Keycloak provides the same functionality.</p>
</dd>
<dt class="hdlist1">Include AuthnStatement</dt>
<dd>
<p>SAML login responses may specify the authentication method used (password, etc.) as well as a timestamp of the login.
Setting this to on will include that statement in the response document.</p>
</dd>
<dt class="hdlist1">Sign Documents</dt>
<dd>
<p>When turned on, Keycloak will sign the document using the realm&#8217;s private key.</p>
</dd>
<dt class="hdlist1">Optimize REDIRECT signing key lookup</dt>
<dd>
<p>When turned on, the SAML protocol messages will include Keycloak
native extension that contains a hint with signing key ID. When the SP
understands this extension, it can use it for signature validation instead of
attempting to validate signature with all known keys. This option only applies to
REDIRECT bindings where the signature is transferred in query parameters where
there is no place with this information in the signature information
(contrary to POST binding messages where key ID is always included in
document signature). Currently this is relevant to situations where both
IDP and SP are provided by Keycloak server and adapter. This
option is only relevant when <code>Sign Documents</code> is switched on.</p>
</dd>
<dt class="hdlist1">Sign Assertions</dt>
<dd>
<p>The <code>Sign Documents</code> switch signs the whole document.
With this setting the assertion is also signed and embedded within the SAML XML Auth response.</p>
</dd>
<dt class="hdlist1">Signature Algorithm</dt>
<dd>
<p>Choose between a variety of algorithms for signing SAML documents.</p>
</dd>
<dt class="hdlist1">SAML Signature Key Name</dt>
<dd>
<p>Signed SAML documents sent via POST binding contain identification of signing key in <code>KeyName</code>
element. This by default contains Keycloak key ID. However various vendors might
expect a different key name or no key name at all. This switch controls whether <code>KeyName</code>
contains key ID (option <code>KEY_ID</code>), subject from certificate corresponding to the realm key
(option <code>CERT_SUBJECT</code> - expected for instance by Microsoft Active Directory Federation
Services), or that the key name hint is completely omitted from the SAML message (option <code>NONE</code>).</p>
</dd>
<dt class="hdlist1">Canonicalization Method</dt>
<dd>
<p>Canonicalization method for XML signatures.</p>
</dd>
<dt class="hdlist1">Encrypt Assertions</dt>
<dd>
<p>Encrypt assertions in SAML documents with the realm&#8217;s private key.
The AES algorithm is used with a key size of 128 bits.</p>
</dd>
<dt class="hdlist1">Client Signature Required</dt>
<dd>
<p>Expect that documents coming from a client are signed.
Keycloak will validate this signature using the client public key or cert set up in the <code>SAML Keys</code> tab.</p>
</dd>
<dt class="hdlist1">Force POST Binding</dt>
<dd>
<p>By default, Keycloak will respond using the initial SAML binding of the original request.
By turning on this switch, you will force Keycloak to always respond using the SAML POST Binding even if the original request was the Redirect binding.</p>
</dd>
<dt class="hdlist1">Front Channel Logout</dt>
<dd>
<p>If true, this application requires a browser redirect to be able to perform a logout.
For example, the application may require a cookie to be reset which could only be done via a redirect.
If this switch is false, then Keycloak will invoke a background SAML request to logout the application.</p>
</dd>
<dt class="hdlist1">Force Name ID Format</dt>
<dd>
<p>If the request has a name ID policy, ignore it and used the value configured in the admin console under Name ID Format</p>
</dd>
<dt class="hdlist1">Name ID Format</dt>
<dd>
<p>Name ID Format for the subject.
If no name ID policy is specified in the request or if the Force Name ID Format attribute is true, this value is used.
Properties used for each of the respective formats are defined below.</p>
</dd>
<dt class="hdlist1">Root URL</dt>
<dd>
<p>If Keycloak uses any configured relative URLs, this value is prepended to them.</p>
</dd>
<dt class="hdlist1">Valid Redirect URIs</dt>
<dd>
<p>This is an optional field.  Enter in a URL pattern and click the + sign to add.  Click the - sign next to URLs you want to remove.
Remember that you still have to click the <code>Save</code> button!
Wildcards (\*) are only allowed at the end of of a URI, i.e. http://host.com/*.  This field is used when the exact SAML
endpoints are not registered and Keycloak is pull the Assertion Consumer URL from the request.</p>
</dd>
<dt class="hdlist1">Base URL</dt>
<dd>
<p>If Keycloak needs to link to the client, this URL would be used.</p>
</dd>
<dt class="hdlist1">Master SAML Processing URL</dt>
<dd>
<p>This URL will be used for all SAML requests and the response will be directed to the SP.
It will be used as the Assertion Consumer Service URL and the Single Logout Service URL.
If a login request contains the Assertion Consumer Service URL, that will take precedence, but this URL must be valided by a registered Valid Redirect URI pattern</p>
</dd>
<dt class="hdlist1">Assertion Consumer Service POST Binding URL</dt>
<dd>
<p>POST Binding URL for the Assertion Consumer Service.</p>
</dd>
<dt class="hdlist1">Assertion Consumer Service Redirect Binding URL</dt>
<dd>
<p>Redirect Binding URL for the Assertion Consumer Service.</p>
</dd>
<dt class="hdlist1">Logout Service POST Binding URL</dt>
<dd>
<p>POST Binding URL for the Logout Service.</p>
</dd>
<dt class="hdlist1">Logout Service Redirect Binding URL</dt>
<dd>
<p>Redirect Binding URL for the Logout Service.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="idp-initiated-login"><a class="anchor" href="#idp-initiated-login"></a>8.3.1. IDP Initiated Login</h4>
<div class="paragraph">
<p>IDP Initiated Login is a feature that allows you to set up an endpoint on the Keycloak server that will log you into a specific application/client.
In the <code>Settings</code> tab for your client, you need to specify the <code>IDP Initiated SSO URL Name</code>.
This is a simple string with no whitespace in it.
After this you can reference your client at the following URL: <code>root/auth/realms/{realm}/protocol/saml/clients/{url-name}</code></p>
</div>
<div class="paragraph">
<p>If your client requires a special relay state, you can also configure this on the <code>Settings</code> tab in the <code>IDP Initiated SSO Relay State</code> field.
Alternatively, browsers can specify the relay state in a <code>RelayState</code> query parameter, i.e.
<code>root/auth/realms/{realm}/protocol/saml/clients/{url-name}?RelayState=thestate</code>.</p>
</div>
<div class="paragraph">
<p>When using <a href="#_identity_broker">identity brokering</a>, it is possible to set up an IDP Initiated Login for a client from an
external IDP. The actual client is set up for IDP Initiated Login at broker IDP as described above. The external IDP has
to set up the client for application IDP Initiated Login that will point to a special URL pointing to the broker and
representing IDP Initiated Login endpoint for a selected client at the brokering IDP. This means that in client settings
at the external IDP:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IDP Initiated SSO URL Name</code> is set to a name that will be published as IDP Initiated Login initial point,</p>
</li>
<li>
<p><code>Assertion Consumer Service POST Binding URL</code> in the <code>Fine Grain SAML Endpoint Configuration</code> section has
to be set to the following URL:
<code>broker-root/auth/realms/{broker-realm}/broker/{idp-name}/endpoint/clients/{client-id}</code>, where:</p>
<div class="ulist">
<ul>
<li>
<p><em>broker-root</em> is base broker URL</p>
</li>
<li>
<p><em>broker-realm</em> is name of the realm at broker where external IDP is declared</p>
</li>
<li>
<p><em>idp-name</em> is name of the external IDP at broker</p>
</li>
<li>
<p><em>client-id</em> is the value of <code>IDP Initiated SSO URL Name</code> attribute of the SAML client defined at broker. It is
this client, which will be made available for IDP Initiated Login from the external IDP.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Please note that you can import basic client settings from the brokering IDP into client settings of the external IDP -
just use <a href="#_identity_broker_saml_sp_descriptor">SP Descriptor</a> available from the settings of the identity provider in
the brokering IDP, and add <code>clients/<em>client-id</em></code> to the endpoint URL.</p>
</div>
</div>
<div class="sect3">
<h4 id="saml-entity-descriptors"><a class="anchor" href="#saml-entity-descriptors"></a>8.3.2. SAML Entity Descriptors</h4>
<div class="paragraph">
<p>Instead of manually registering a SAML 2.0 client, you can import it via a standard SAML Entity Descriptor XML file.
There is an <code>Import</code> option on the Add Client page.</p>
</div>
<div class="paragraph">
<div class="title">Add Client</div>
<p><span class="image"><img src="./keycloak-images/add-client-saml.png" alt="add client saml"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Select File</code> button and load your entity descriptor file.  You should review all the information there to make sure everything is set up correctly.</p>
</div>
<div class="paragraph">
<p>Some SAML client adapters like <em>mod-auth-mellon</em> need the XML Entity Descriptor for the IDP.  You can obtain this by
going to this public URL:  <code>root/auth/realms/{realm}/protocol/saml/descriptor</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-links"><a class="anchor" href="#client-links"></a>8.4. Client Links</h3>
<div class="paragraph">
<p>For scenarios where one wants to link from one client to another, Keycloak provides a special redirect endpoint: <code>/realms/realm_name/clients/{client-id}/redirect</code>.</p>
</div>
<div class="paragraph">
<p>If a client accesses this endpoint via an <code>HTTP GET</code> request, Keycloak returns the configured base URL for the provided Client and Realm in the form of an <code>HTTP 307</code> (Temporary Redirect) via the response&#8217;s <code>Location</code> header.</p>
</div>
<div class="paragraph">
<p>Thus, a client only needs to know the Realm name and the Client ID in order to link to them.
This indirection helps avoid hard-coding client base URLs.</p>
</div>
<div class="paragraph">
<p>As an example, given the realm <code>master</code> and the client-id <code>account</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://host:port/auth/realms/master/clients/account/redirect</code></pre>
</div>
</div>
<div class="paragraph">
<p>Would temporarily redirect to: <a href="http://host:port/auth/realms/master/account" class="bare">http://host:port/auth/realms/master/account</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_protocol-mappers"><a class="anchor" href="#_protocol-mappers"></a>8.5. OIDC Token and SAML Assertion Mappings</h3>
<div class="paragraph">
<p>Applications that receive ID Tokens, Access Tokens, or SAML assertions may need or want different user metadata and roles.
Keycloak allows you to define what exactly is transferred.
You can hardcode roles, claims and custom attributes.
You can pull user metadata into a token or assertion.
You can rename roles.
Basically you have a lot of control of what exactly goes back to the client.</p>
</div>
<div class="paragraph">
<p>Within the Admin Console, if you go to an application you&#8217;ve registered, you&#8217;ll see a <code>Mappers</code> tab.  Here&#8217;s one for
an OIDC based client.</p>
</div>
<div class="paragraph">
<div class="title">Mappers Tab</div>
<p><span class="image"><img src="./keycloak-images/mappers-oidc.png" alt="mappers oidc"></span></p>
</div>
<div class="paragraph">
<p>Each client has several built-in mappers that are created for it by default.  They map things like, for example, email address to
a specific claim in the identity and access token.  Their function should each be self explanatory from their name.  There
are additional pre-configured mappers that are not attached to the client that you can add
by clicking the <code>Add Builtin</code> button.</p>
</div>
<div class="paragraph">
<p>Each mapper has common settings as well as additional ones depending on which type of mapper you are adding.  Click the <code>Edit</code> button
next to one of the mappers in the list to get to the config screen.</p>
</div>
<div class="paragraph">
<div class="title">Mapper Config</div>
<p><span class="image"><img src="./keycloak-images/mapper-config.png" alt="mapper config"></span></p>
</div>
<div class="paragraph">
<p>The best way to learn about a config option is to hover over its tooltip.  There are a few config options that
are common to all mappers:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Consent Required</dt>
<dd>
<p>If your client requires consent, this mapper will be displayed on the consent screen shown to the user.</p>
</dd>
<dt class="hdlist1">Consent Text</dt>
<dd>
<p>If your client requires consent and the <code>Consent</code> switch is on, this is the text that will be displayed by the user.
The value for this text is localizable by specifying a substitution variable with <code>${var-name}</code> strings.  The
localized value is then configured within property files in your theme.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>
for more information on localization.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Most OIDC mappers also allow you to control where the claim gets put.  You can opt to include or exclude the claim from both the
<em>id</em> and <em>access</em> tokens by fiddling with the <code>Add to ID token</code> and <code>Add to access token</code> switches.</p>
</div>
<div class="paragraph">
<p>Finally, you can also add other mapper types.  If you go back to the <code>Mappers</code> tab, click the <code>Create</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Add Mapper</div>
<p><span class="image"><img src="./keycloak-images/add-mapper.png" alt="add mapper"></span></p>
</div>
<div class="paragraph">
<p>Pick a <code>Mapper Type</code> from the list box.  If you hover over the tooltip, you&#8217;ll see a description of what that mapper type does.
Different config parameters will appear for different mapper types.</p>
</div>
</div>
<div class="sect2">
<h3 id="generating-client-adapter-config"><a class="anchor" href="#generating-client-adapter-config"></a>8.6. Generating Client Adapter Config</h3>
<div class="paragraph">
<p>The Keycloak can pre-generate configuration files that you can use to install a client adapter for in your application&#8217;s
deployment environment.  A number of adapter types are supported for both OIDC and SAML.  Go to the <code>Installation</code> tab of the
client you want to generate configuration for.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/client-installation.png" alt="client installation"></span></p>
</div>
<div class="paragraph">
<p>Select the <code>Format Option</code> you want configuration generated for.  All Keycloak client adapters for OIDC and SAML
are supported.  The mod-auth-mellon Apache HTTPD adapter for SAML is supported as well as standard SAML entity descriptor files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_client_templates"><a class="anchor" href="#_client_templates"></a>8.7. Client Templates</h3>
<div class="paragraph">
<p>If you have a lot of applications you need to secure and register within your organization it can become quite tedious
to configure the <a href="#_protocol-mappers">protocol mappers</a>
and <a href="#_client_scope">scope</a> for each of these clients.  Keycloak allows you to define shared client configuration in an entity called a <em>client template</em>.</p>
</div>
<div class="paragraph">
<p>To create a client template, go to the <code>Client Templates</code> left menu item.  This initial screen shows you a list of currently defined templates.</p>
</div>
<div class="paragraph">
<p>To create a template click the <code>Create</code> button.  This brings you to a simple screen in which you name the template and hit save.
A <em>client template</em> will have similar tabs to regular clients.  You&#8217;ll be able to define <a href="#_protocol-mappers">protocol mappers</a>
and <a href="#_client_scope">scope</a> which can be inherited by other clients.</p>
</div>
<div class="paragraph">
<p>Having a client inherit from a template is as simple as choosing the template from the <code>Client Template</code> drop down list on either the
<code>Add Client</code> or client <code>Settings</code> tab.  You will see the <code>Mappers</code> and <code>Scope</code> tabs get additional switches which allow you
to turn on or off inheriting from the parent template.</p>
</div>
<div class="paragraph">
<p>Future versions of client templating may get more inheritable configuration options, but for now, that&#8217;s all there is to talk about.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="roles"><a class="anchor" href="#roles"></a>9. Roles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Roles identify a type or category of user.  <code>Admin</code>, <code>user</code>, <code>manager</code>, and <code>employee</code> are all typical roles that may exist
in an organization.
Applications often assign access and permissions to specific roles rather than individual users as dealing
with users can be too fine grained and hard to manage.  For example, the Admin Console has specific roles which give permission to users
to access parts of the Admin Console UI and perform certain actions.  There is a global namespace for roles and each client also has its own
dedicated namespace where roles can be defined.</p>
</div>
<div class="sect2">
<h3 id="realm-roles"><a class="anchor" href="#realm-roles"></a>9.1. Realm Roles</h3>
<div class="paragraph">
<p>Realm-level roles are a global namespace to define your roles. You can see the list of built-in and created roles by clicking the <code>Roles</code> left menu item.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/roles.png" alt="roles"></span></p>
</div>
<div class="paragraph">
<p>To create a role, click <strong>Add Role</strong> on this page, enter in the name and description of the role, and click <strong>Save</strong>.</p>
</div>
<div class="paragraph">
<div class="title">Add Role</div>
<p><span class="image"><img src="./keycloak-images/role.png" alt="role"></span></p>
</div>
<div class="paragraph">
<p>The value for the <code>description</code> field is localizable by specifying a substitution variable with <code>${var-name}</code> strings. The localized value is then configured within property files in your theme. See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more information on localization. If a client requires user <em>consent</em>, this description string is displayed on the consent page for the user.</p>
</div>
<div class="paragraph">
<p>If the client has to explicitly request for a realm role, set <code>Scope Param Required</code> to true. The role then has to be specified using the <code>scope</code> parameter when requesting a token. Multiple realm roles are separated by space:</p>
</div>
<div class="paragraph">
<p><code>scope=admin user</code></p>
</div>
</div>
<div class="sect2">
<h3 id="client-roles"><a class="anchor" href="#client-roles"></a>9.2. Client Roles</h3>
<div class="paragraph">
<p>Client roles are basically a namespace dedicated to a client. Each client gets its own namespace. Client roles are managed under the <code>Roles</code> tab under each individual client. You interact with this UI the same way you do for realm-level roles.</p>
</div>
<div class="paragraph">
<p>If the client has to explicitly request another client&#8217;s role, the role has to be prefixed with the client ID when performing a request using the scope parameter. For example, if the client ID is <code>account</code> and the role is <code>admin</code>, the scope parameter is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>`scope=account/admin`</pre>
</div>
</div>
<div class="paragraph">
<p>As noted in the realm roles section, multiple roles are separated by spaces.</p>
</div>
</div>
<div class="sect2">
<h3 id="_composite-roles"><a class="anchor" href="#_composite-roles"></a>9.3. Composite Roles</h3>
<div class="paragraph">
<p>Any realm or client level role can be turned into a <em>composite role</em>.
A <em>composite role</em> is a role that has one or more additional roles associated with it.
When a composite role is mapped to the user, the user also gains the roles associated with that composite.  This inheritance
is recursive so any composite of composites also gets inherited.</p>
</div>
<div class="paragraph">
<p>To turn a regular role into a composite role, go to the role detail page and flip the <code>Composite Role</code> switch on.</p>
</div>
<div class="paragraph">
<div class="title">Composite Role</div>
<p><span class="image"><img src="./keycloak-images/composite-role.png" alt="composite role"></span></p>
</div>
<div class="paragraph">
<p>Once you flip this switch the role selection UI will be displayed lower on the page and you&#8217;ll be able to associate
realm level and client level roles to the composite you are creating.  In this example, the <code>employee</code> realm-level
role was associated with the <code>developer</code> composite role.  Any user with the <code>developer</code> role will now also inherit
the <code>employee</code> role too.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When tokens and SAML assertions are created, any composite will also have its associated roles added to the claims and
      assertions of the authentication response sent back to the client.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="user-role-mappings"><a class="anchor" href="#user-role-mappings"></a>9.4. User Role Mappings</h3>
<div class="paragraph">
<p>User role mappings can be assigned individually to each user through the <code>Role Mappings</code> tab for that single user.</p>
</div>
<div class="paragraph">
<div class="title">Role Mappings</div>
<p><span class="image"><img src="./keycloak-images/user-role-mappings.png" alt="user role mappings"></span></p>
</div>
<div class="paragraph">
<p>In the above example, we are about to assign the composite role <code>developer</code> that was created in the <a href="#_composite-roles">Composite Roles</a>
chapter.</p>
</div>
<div class="paragraph">
<div class="title">Effective Role Mappings</div>
<p><span class="image"><img src="./keycloak-images/effective-role-mappings.png" alt="effective role mappings"></span></p>
</div>
<div class="paragraph">
<p>Once the <code>developer</code> role is assigned, you see that the <code>employee</code> role that is associated with the <code>developer</code> composite shows up in the <code>Effective Roles</code>.
<code>Effective Roles</code> are all roles that are explicitly assigned to the user as well as any roles that are inherited from composites.</p>
</div>
<div class="sect3">
<h4 id="default-roles"><a class="anchor" href="#default-roles"></a>9.4.1. Default Roles</h4>
<div class="paragraph">
<p>Default roles allow you to automatically assign user role mappings when any user is newly created or imported through
<a href="#_identity_broker">Identity Brokering</a>.
To specify default roles go to the <code>Roles</code> left menu item, and click the <code>Default Roles</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Default Roles</div>
<p><span class="image"><img src="./keycloak-images/default-roles.png" alt="default roles"></span></p>
</div>
<div class="paragraph">
<p>As you can see from the screenshot, there are already a number of <em>default roles</em> set up by default.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_client_scope"><a class="anchor" href="#_client_scope"></a>9.5. Client Scope</h3>
<div class="paragraph">
<p>When an OIDC access token or SAML assertion is created, all the user role mappings of the user are, by default, added as claims
within the token or assertion.  Applications use this information to make access decisions on the resources controlled by that
application.  In Keycloak, access tokens are digitally signed and can actually be re-used by the application
to invoke on other remotely secured REST services.  This means that if an application gets compromised or there is a rogue
client registered with the realm, attackers can get access tokens that have a broad range of permissions and your whole
network is compromised.  This is where <em>client scope</em> becomes important.</p>
</div>
<div class="paragraph">
<p><em>Client scope</em> is a way to limit the roles that get declared inside an access token.  When a client requests that a user
be authenticated, the access token they receive back will only contain the role mappings you&#8217;ve explicitly specified
for the client&#8217;s scope.  This allows you to limit the permissions each individual access token has rather than giving the
client access to all of the user&#8217;s permissions.  By default, each client gets all the role mappings of the user.
You can view this in the <code>Scope</code> tab of each client.</p>
</div>
<div class="paragraph">
<div class="title">Full Scope</div>
<p><span class="image"><img src="./keycloak-images/full-client-scope.png" alt="full client scope"></span></p>
</div>
<div class="paragraph">
<p>You can see from the picture that the effective roles of the scope are every declared role in the realm.
To change this default behavior, you must explicitly turn off the <code>Full Scope Allowed</code> switch and declare the specific roles you want in each individual
client.  Alternatively, you can also use <a href="#_client_templates">client templates</a>
to define the scope for a whole set of clients.</p>
</div>
<div class="paragraph">
<div class="title">Partial Scope</div>
<p><span class="image"><img src="./keycloak-images/client-scope.png" alt="client scope"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="groups"><a class="anchor" href="#groups"></a>10. Groups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Groups in Keycloak allow you to manage a common set of attributes and role mappings for a set of users.
Users can be members of zero or more groups.
Users inherit the attributes and role mappings assigned to each group.  To manage groups go to the <code>Groups</code> left menu
item.</p>
</div>
<div class="paragraph">
<div class="title">Groups</div>
<p><span class="image"><img src="./keycloak-images/groups.png" alt="groups"></span></p>
</div>
<div class="paragraph">
<p>Groups are hierarchical.
A group can have many subgroups, but a group can only have one parent.
Subgroups inherit the attributes and role mappings from the parent.
This applies to the user as well.
So, if you have a parent group and a child group and a user that only belongs to the child group, the user inherits the attributes and role mappings of both the parent and child.
In this example, we have a top level <code>Sales</code> group and a child <code>North America</code> subgroup.  To add a group, click on the
parent you want to add a new child to and click <code>New</code> button.  Select the <code>Groups</code> icon in the tree to make a top-level group.
Entering in a group name in the <code>Create Group</code> screen and hitting <code>Save</code> will bring you to the individual group management page.</p>
</div>
<div class="paragraph">
<div class="title">Group</div>
<p><span class="image"><img src="./keycloak-images/group.png" alt="group"></span></p>
</div>
<div class="paragraph">
<p>The <code>Attributes</code> and <code>Role Mappings</code> tab work exactly as the tabs with similar names under a user.  Any attributes and role mappings
you define will be inherited by the groups and users that are members of this group.</p>
</div>
<div class="paragraph">
<p>To add a user to a group you need to go all the way back to the user detail page and click on the <code>Groups</code> tab there.</p>
</div>
<div class="paragraph">
<div class="title">User Groups</div>
<p><span class="image"><img src="./keycloak-images/user-groups.png" alt="user groups"></span></p>
</div>
<div class="paragraph">
<p>Select a group from the <code>Available Groups</code> tree and hit the <code>join</code> button to add the user to a group.  Vice versa to remove a group.
Here we&#8217;ve added the user <em>Jim</em> to the <em>North America</em> sales group.  If you go back to the detail page for that group and
select the <code>Membership</code> tab, <em>Jim</em> is now displayed there.</p>
</div>
<div class="paragraph">
<div class="title">Group Membership</div>
<p><span class="image"><img src="./keycloak-images/group-membership.png" alt="group membership"></span></p>
</div>
<div class="sect2">
<h3 id="groups-vs-roles"><a class="anchor" href="#groups-vs-roles"></a>10.1. Groups vs. Roles</h3>
<div class="paragraph">
<p>In the IT world the concepts of Group and Role are often blurred and interchangeable.
In Keycloak, Groups are just a collection of users that you can apply roles and attributes to in one place.
Roles define a type of user and applications assign permission and access control to roles</p>
</div>
<div class="paragraph">
<p>Aren&#8217;t <a href="#_composite-roles">Composite Roles</a> also similar to Groups?
Logically they provide the same exact functionality, but the difference is conceptual.
Composite roles should be used to apply the permission model to your set of services and applications.
Groups should focus on collections of users and their roles in your organization.
Use groups to manage users.  Use composite roles to manage applications and services.</p>
</div>
</div>
<div class="sect2">
<h3 id="default-groups"><a class="anchor" href="#default-groups"></a>10.2. Default Groups</h3>
<div class="paragraph">
<p>Default groups allow you to automatically assign group membership whenever any new user is created or imported through
<a href="#_identity_broker">Identity Brokering</a>.
To specify default groups go to the <code>Groups</code> left menu item, and click the <code>Default Groups</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Default Groups</div>
<p><span class="image"><img src="./keycloak-images/default-groups.png" alt="default groups"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_admin_permissions"><a class="anchor" href="#_admin_permissions"></a>11. Admin Console Access Control and Permissions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Each realm created on the Keycloak has a dedicated Admin Console from which that realm can be managed.
The <code>master</code> realm is a special realm that allows admins to manage more than one realm on the system.  You can also
define fine-grained access to users in different realms to manage the server.  This chapter goes over all the scenarios for this.</p>
</div>
<div class="sect2">
<h3 id="master-realm-access-control"><a class="anchor" href="#master-realm-access-control"></a>11.1. Master Realm Access Control</h3>
<div class="paragraph">
<p>The <code>master</code> realm in Keycloak is a special realm and treated differently than other realms.
Users in the Keycloak <code>master</code> realm can be granted permission to manage zero or more realms that are deployed on the Keycloak server.
When a realm is created, Keycloak automatically creates various roles that grant fine-grain permissions to access that new realm.
Access to The Admin Console and Admin REST endpoints can be controlled by mapping these roles to users in the <code>master</code> realm.
It&#8217;s possible to create multiple super users,  as well as users that can only manage specific realms.</p>
</div>
<div class="sect3">
<h4 id="global-roles"><a class="anchor" href="#global-roles"></a>11.1.1. Global Roles</h4>
<div class="paragraph">
<p>There are two realm-level roles in the <code>master</code> realm.
These are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>admin</p>
</li>
<li>
<p>create-realm</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Users with the <code>admin</code> role are super users and have full access to manage any realm on the server.  Users with the <code>create-realm</code> role
are allowed to create new realms.  They will be granted full access to any new realm they create.</p>
</div>
</div>
<div class="sect3">
<h4 id="realm-specific-roles"><a class="anchor" href="#realm-specific-roles"></a>11.1.2. Realm Specific Roles</h4>
<div class="paragraph">
<p>Admin users within the <code>master</code> realm can be granted management privileges to one or more other realms in the system.
Each realm in Keycloak is represented by a client in the <code>master</code> realm.
The name of the client is <code>&lt;realm name&gt;-realm</code>.  These clients each have client-level roles defined which define varying
level of access to manage an individual realm.</p>
</div>
<div class="paragraph">
<p>The roles available are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>view-realm</p>
</li>
<li>
<p>view-users</p>
</li>
<li>
<p>view-clients</p>
</li>
<li>
<p>view-events</p>
</li>
<li>
<p>manage-realm</p>
</li>
<li>
<p>manage-users</p>
</li>
<li>
<p>create-client</p>
</li>
<li>
<p>manage-clients</p>
</li>
<li>
<p>manage-events</p>
</li>
<li>
<p>view-identity-providers</p>
</li>
<li>
<p>manage-identity-providers</p>
</li>
<li>
<p>impersonation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assign the roles you want to your users and they will only be able to use that specific part of the administration console.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Admins with the <code>manage-users</code> role will only be able to assign admin roles to users that they themselves have.  So, if an admin has the <code>manage-users</code> role but doesn&#8217;t have the <code>manage-realm</code> role, they will not be able to assign this role.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_per_realm_admin_permissions"><a class="anchor" href="#_per_realm_admin_permissions"></a>11.2. Dedicated Realm Admin Consoles</h3>
<div class="paragraph">
<p>Each realm has a dedicated Admin Console that can be accessed by going to the url <code>/auth/admin/{realm-name}/console</code>.
Users within that realm can be granted realm management permissions by assigning specific user role mappings.</p>
</div>
<div class="paragraph">
<p>Each realm has a built-in client called <code>realm-management</code>.  You can view this client by going to the
<code>Clients</code> left menu item of your realm.  This client defines client-level roles that specify permissions that can be granted to manage the realm.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>view-realm</p>
</li>
<li>
<p>view-users</p>
</li>
<li>
<p>view-clients</p>
</li>
<li>
<p>view-events</p>
</li>
<li>
<p>manage-realm</p>
</li>
<li>
<p>manage-users</p>
</li>
<li>
<p>create-client</p>
</li>
<li>
<p>manage-clients</p>
</li>
<li>
<p>manage-events</p>
</li>
<li>
<p>view-identity-providers</p>
</li>
<li>
<p>manage-identity-providers</p>
</li>
<li>
<p>impersonation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Assign the roles you want to your users and they will only be able to use that specific part of the administration console.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fine_grain_permissions"><a class="anchor" href="#_fine_grain_permissions"></a>11.3. Fine Grain Admin Permissions</h3>
<div class="paragraph">
<p>Sometimes roles like <code>manage-realm</code> or <code>manage-users</code> are too coarse grain and you want to create
restricted admin accounts that have more fine grain permissions.  Keycloak allows you to define
and assign restricted access policies for managing a realm.  Things like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Managing one specific client</p>
</li>
<li>
<p>Managing users that belong to a specific group</p>
</li>
<li>
<p>Managing membership of a group</p>
</li>
<li>
<p>Limited user management.</p>
</li>
<li>
<p>Fine grain impersonization control</p>
</li>
<li>
<p>Being able to assign a specific restricted set of roles to users.</p>
</li>
<li>
<p>Being able to assign a specific restricted set of roles to a composite role.</p>
</li>
<li>
<p>Being able to assign a specific restricted set of roles to a client&#8217;s scope.</p>
</li>
<li>
<p>New general policies for viewing and managing users, groups, roles, and clients.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There&#8217;s some important things to note about fine grain admin permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fine grain admin permissions were implemented on top of <a href="http://www.keycloak.org/docs/3.4/authorization_services/">Authorization Services</a>.  It is highly recommended that you read up on those features before diving into fine grain permissions.</p>
</li>
<li>
<p>Fine grain permissions are only available within <a href="#_per_realm_admin_permissions">dedicated admin consoles</a> and admins defined within those realms.  You cannot define cross-realm fine grain permissions.</p>
</li>
<li>
<p>Fine grain permissions are used to grant additional permissions.  You cannot override the
default behavior of the built in admin roles.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="managing-one-specific-client"><a class="anchor" href="#managing-one-specific-client"></a>11.3.1. Managing One Specific Client</h4>
<div class="paragraph">
<p>Let&#8217;s look first at allowing
an admin to manage one client and one client only.  In our example we have a realm
called <code>test</code> and a client called <code>sales-application</code>.  In realm <code>test</code> we will give a
user in that realm permission to only manage that application.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
You cannot do cross realm fine grain permissions.  Admins in the <code>master</code> realm are limited to the predefined admin roles defined in previous chapters.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="permission-setup"><a class="anchor" href="#permission-setup"></a>Permission Setup</h5>
<div class="paragraph">
<p>The first thing we must do is login to the Admin Console so we can set up permissions for that client.  We navigate to the management section
of the client we want to define fine-grain permissions for.</p>
</div>
<div class="paragraph">
<div class="title">Client Management</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client.png" alt="fine grain client"></span></p>
</div>
<div class="paragraph">
<p>You should see a tab menu item called <code>Permissions</code>.  Click on that tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Permissions Tab</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-permissions-tab-off.png" alt="fine grain client permissions tab off"></span></p>
</div>
<div class="paragraph">
<p>By default, each client is not enabled to do fine grain permissions.  So turn the <code>Permissions Enabled</code> switch to on
to initialize permissions.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you turn the <code>Permissions Enabled</code> switch to off, it will delete any and all permissions you have defined for this client.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Client Permissions Tab</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-permissions-tab-on.png" alt="fine grain client permissions tab on"></span></p>
</div>
<div class="paragraph">
<p>When you witch <code>Permissions Enabled</code> to on, it initializes various permission objects behind the scenes
using <a href="http://www.keycloak.org/docs/3.4/authorization_services/">Authorization Services</a>.  For this example, we&#8217;re
interested in the <code>manage</code> permission for the client.  Clicking on that will redirect you
to the permission that handles the <code>manage</code> permission for the client.  All authorization
objects are contained in the <code>realm-management</code> client&#8217;s <code>Authorization</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Client Manage Permission</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-manage-permissions.png" alt="fine grain client manage permissions"></span></p>
</div>
<div class="paragraph">
<p>When first initialized the <code>manage</code> permission does not have any policies associated with it.
You will need to create one by going to the policy tab.  To get there fast, click on
the <code>Authorization</code> link shown in the above image. Then click on the policies tab.</p>
</div>
<div class="paragraph">
<p>There&#8217;s a pull down menu on this page called <code>Create policy</code>.  There&#8217;s a multitude of policies
you can define.  You can define a policy that is associated with a role or a group or even define
rules in Javascript.  For this simple example, we&#8217;re going to create a <code>User Policy</code>.</p>
</div>
<div class="paragraph">
<div class="title">User Policy</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-user-policy.png" alt="fine grain client user policy"></span></p>
</div>
<div class="paragraph">
<p>This policy will match a hard-coded user in the user database.  In this case it is the <code>sales-admin</code> user.  We must then go back to the
<code>sales-application</code> client&#8217;s <code>manage</code> permission page and assign the policy to the permission object.</p>
</div>
<div class="paragraph">
<div class="title">Assign User Policy</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-assign-user-policy.png" alt="fine grain client assign user policy"></span></p>
</div>
<div class="paragraph">
<p>The <code>sales-admin</code> user can now has permission to manage the <code>sales-application</code> client.</p>
</div>
<div class="paragraph">
<p>There&#8217;s one more thing we have to do.  Go to the <code>Role Mappings</code> tab and assign the <code>query-clients</code>
role to the <code>sales-admin</code>.</p>
</div>
<div class="paragraph">
<div class="title">Assign query-clients</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-assign-query-clients.png" alt="fine grain assign query clients"></span></p>
</div>
<div class="paragraph">
<p>Why do you have to do this?  This role tells the Admin Console
what menu items to render when the <code>sales-admin</code> visits the Admin Console.  The <code>query-clients</code>
role tells the Admin Console that it should render client menus for the <code>sales-admin</code> user.</p>
</div>
<div class="paragraph">
<p>IMPORTANT If you do not set the <code>query-clients</code> role, restricted admins like <code>sales-admin</code> will not see any menu options when they log into the Admin Console</p>
</div>
</div>
<div class="sect4">
<h5 id="testing-it-out"><a class="anchor" href="#testing-it-out"></a>Testing It Out.</h5>
<div class="paragraph">
<p>Next we log out of the master realm and and re-login to the <a href="#_per_realm_admin_permissions">dedicated admin console</a> for the <code>test</code> realm
using the <code>sales-admin</code> as a username.  This is located under <code>/auth/admin/test/console</code>.</p>
</div>
<div class="paragraph">
<div class="title">Sales Admin Login</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-sales-admin-login.png" alt="fine grain sales admin login"></span></p>
</div>
<div class="paragraph">
<p>This admin is now able to manage this one client.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="restrict-user-role-mapping"><a class="anchor" href="#restrict-user-role-mapping"></a>11.3.2. Restrict User Role Mapping</h4>
<div class="paragraph">
<p>Another thing you might want to do is to restrict the set a roles an admin is allowed
to assign to a user.  Continuing our last example, let&#8217;s expand the permission set of the 'sales-admin'
user so that he can also control which users are allowed to access this application.  Through fine grain permissions we can
enable it so that the <code>sales-admin</code> can only assign roles that grant specific access to
the <code>sales-application</code>.  We can also restrict it so that the admin can only map roles
and not perform any other types of user administration.</p>
</div>
<div class="paragraph">
<p>The <code>sales-application</code> has defined three different client roles.</p>
</div>
<div class="paragraph">
<div class="title">Sales Application Roles</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-sales-application-roles.png" alt="fine grain sales application roles"></span></p>
</div>
<div class="paragraph">
<p>We want the <code>sales-admin</code> user to be able to map these roles to any user in the system.  The
first step to do this is to allow the role to be mapped by the admin.  If we click on the
<code>viewLeads</code> role, you&#8217;ll see that there is a <code>Permissions</code> tab for this role.</p>
</div>
<div class="paragraph">
<div class="title">View Leads Role Permission Tab</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-view-leads-role-tab.png" alt="fine grain view leads role tab"></span></p>
</div>
<div class="paragraph">
<p>If we click on that tab and turn the <code>Permissions Enabled</code> on, you&#8217;ll see that there
are a number of actions we can apply policies to.</p>
</div>
<div class="paragraph">
<div class="title">View Leads Permissions</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-view-leads-permissions.png" alt="fine grain view leads permissions"></span></p>
</div>
<div class="paragraph">
<p>The one we are interested in is <code>map-role</code>.  Click on this permission and add the same
User Policy that was created in the earlier example.</p>
</div>
<div class="paragraph">
<div class="title">Map-roles Permission</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-map-roles-permission.png" alt="fine grain map roles permission"></span></p>
</div>
<div class="paragraph">
<p>What we&#8217;ve done is say that the <code>sales-admin</code> can map the <code>viewLeads</code> role.  What we have
not done is specify which users the admin is allowed to map this role too.  To do that
we must go to the <code>Users</code> section of the admin console for this realm.  Clicking on the
<code>Users</code> left menu item brings us to the users interface of the realm.  You should see a
<code>Permissions</code> tab.  Click on that and enable it.</p>
</div>
<div class="paragraph">
<div class="title">Users Permissions</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-users-permissions.png" alt="fine grain users permissions"></span></p>
</div>
<div class="paragraph">
<p>The permission we are interested in is <code>map-roles</code>.  This is a restrictive policy
in that it only allows admins the ability to map roles to a user.  If we click on the
<code>map-roles</code> permission and again add the User Policy we created for this, our <code>sales-admin</code>
will be able to map roles to any user.</p>
</div>
<div class="paragraph">
<p>The last thing we have to do is add the <code>view-users</code> role to the <code>sales-admin</code>.  This will
allow the admin to view users in the realm he wants to add the <code>sales-application</code> roles to.</p>
</div>
<div class="paragraph">
<div class="title">Add view-users</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-add-view-users.png" alt="fine grain add view users"></span></p>
</div>
<div class="sect4">
<h5 id="testing-it-out-2"><a class="anchor" href="#testing-it-out-2"></a>Testing It Out.</h5>
<div class="paragraph">
<p>Next we log out of the master realm and and re-login to the <a href="#_per_realm_admin_permissions">dedicated admin console</a> for the <code>test</code> realm
using the <code>sales-admin</code> as a username.  This is located under <code>/auth/admin/test/console</code>.</p>
</div>
<div class="paragraph">
<p>You will see that now the <code>sales-admin</code> can view users in the system.  If you select one of the
users you&#8217;ll see that each user detail page is read only, except for the <code>Role Mappings</code> tab.
Going to these tab you&#8217;ll find that there are no <code>Available</code> roles for the admin to
map to the user except when we browse the <code>sales-application</code> roles.</p>
</div>
<div class="paragraph">
<div class="title">Add viewLeads</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-add-view-leads.png" alt="fine grain add view leads"></span></p>
</div>
<div class="paragraph">
<p>We&#8217;ve only specified that the <code>sales-admin</code> can map the <code>viewLeads</code> role.</p>
</div>
</div>
<div class="sect4">
<h5 id="per-client-map-roles-shortcut"><a class="anchor" href="#per-client-map-roles-shortcut"></a>Per Client map-roles Shortcut</h5>
<div class="paragraph">
<p>It would be tedious if we had to do this for every client role that the <code>sales-application</code> published.
to make things easier, there&#8217;s a way to specify that an admin can map any role defined
by a client.  If we log back into the admin console to our master realm admin and go back
  to the <code>sales-application</code> permissions page, you&#8217;ll see the <code>map-roles</code> permission.</p>
</div>
<div class="paragraph">
<div class="title">Client map-roles Permission</div>
<p><span class="image"><img src="./keycloak-images/fine-grain-client-permissions-tab-on.png" alt="fine grain client permissions tab on"></span></p>
</div>
<div class="paragraph">
<p>If you grant access to this particular parmission to an admin, that admin will be able
map any role defined by the client.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="full-list-of-permissions"><a class="anchor" href="#full-list-of-permissions"></a>11.3.3. Full List of Permissions</h4>
<div class="paragraph">
<p>You can do a lot more with fine grain permissions beyond managing a specific client or the specific roles of a client.
This chapter defines the whole list of permission types that can be described for
a realm.</p>
</div>
<div class="sect4">
<h5 id="role"><a class="anchor" href="#role"></a>Role</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for a specific role, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">map-role</dt>
<dd>
<p>Policies that decide if an admin can map this role to a user.  These policies
only specify that the role can be mapped to a user, not that the admin is allowed
to perform user role mapping tasks.  The admin will also have to have manage or
role mapping permissions.  See <a href="#_users-permissions">Users Permissions</a> for more information.</p>
</dd>
<dt class="hdlist1">map-role-composite</dt>
<dd>
<p>Policies that decide if an admin can map this role as a composite to another role.
An admin can define roles for a client if he has manage permissions for that client
but he will not be able to add composites to those roles unless he has the
<code>map-role-composite</code> privileges for the role he wants to add as a composite.</p>
</dd>
<dt class="hdlist1">map-role-client-scope</dt>
<dd>
<p>Policies that decide if an admin can apply this role to the scope of a client.
Even if the admin can manage the client, he will not have permission to
create tokens for that client that contain this role unless this privilege
is granted.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="client"><a class="anchor" href="#client"></a>Client</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for a specific client, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">view</dt>
<dd>
<p>Policies that decide if an admin can view the client&#8217;s configuration.</p>
</dd>
<dt class="hdlist1">manage</dt>
<dd>
<p>Policies that decide if an admin can view and manage the client&#8217;s configuration.
There is some issues with this in that privileges could be leaked unintentionally.
For example, the admin could define a protocol mapper that hardcoded a role
even if the admin does not have privileges to map the role to the client&#8217;s scope.
This is currently the limitation of protocol mappers as they don&#8217;t have a way
to assign individual permissions to them like roles do.</p>
</dd>
<dt class="hdlist1">configure</dt>
<dd>
<p>Reduced set of prileges to manage the client.  Its like the <code>manage</code> scope except
the admin is not allowed to define protocol mappers, change the client template,
or the client&#8217;s scope.</p>
</dd>
<dt class="hdlist1">map-roles</dt>
<dd>
<p>Policies that decide if an admin can map any role defined by the client to a user.
This is a shortcut, easy-of-use feature to avoid having to defin policies
for each and every role defined by the client.</p>
</dd>
<dt class="hdlist1">map-roles-composite</dt>
<dd>
<p>Policies that decide if an admin can map any role defined by the client
as a composite to another role.
This is a shortcut, easy-of-use feature to avoid having to define policies
for each and every role defined by the client.</p>
</dd>
<dt class="hdlist1">map-roles-client-scope</dt>
<dd>
<p>Policies that decide if an admin can map any role defined by the client
to the scope of another client.
This is a shortcut, easy-of-use feature to avoid having to define policies
for each and every role defined by the client.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_users-permissions"><a class="anchor" href="#_users-permissions"></a>Users</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for all users, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">view</dt>
<dd>
<p>Policies that decide if an admin can view all users in the realm.</p>
</dd>
<dt class="hdlist1">manage</dt>
<dd>
<p>Policies that decide if an admin can manage all users in the realm.  This
permission grants the admin the privilege to perfor user role mappings, but
it does not specify which roles the admin is allowed to map.  You&#8217;ll need to
define the privilege for each role you want the admin to be able to map.</p>
</dd>
<dt class="hdlist1">map-roles</dt>
<dd>
<p>This is a subset of the privileges granted by the <code>manage</code> scope.  In this
case the admin is only allowed to map roles.  The admin is not allowed to perform
any other user management operation.  Also, like <code>manage</code>, the roles that the
admin is allowed to apply must be specified per role or per set of roles if dealing
with client roles.</p>
</dd>
<dt class="hdlist1">manage-group-membership</dt>
<dd>
<p>Similar to <code>map-roles</code> except that it pertains to group membership: which
groups a user can be added or removed from.  These
policies just grant the admin permission to manage group membership, not which
groups the admin is allowed to manage membership for.  You&#8217;ll have to
specify policies for each group&#8217;s <code>manage-members</code> permission.</p>
</dd>
<dt class="hdlist1">impersonate</dt>
<dd>
<p>Policies that decide if the admin is allowed to impersonate other users.  These
policies are applied to the admin&#8217;s attributes and role mappings.</p>
</dd>
<dt class="hdlist1">user-impersonated</dt>
<dd>
<p>Policies that decide which users can be impersonated.  These policies will be
applied to the user being impersonated.  For example, you might want to define
a policy that will forbid anybody from impersonating a user that has admin
privileges.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="group"><a class="anchor" href="#group"></a>Group</h5>
<div class="paragraph">
<p>When going to the <code>Permissions</code> tab for a specific group, you will see these
permission types listed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">view</dt>
<dd>
<p>Policies that decide if the admin can view information about the group.</p>
</dd>
<dt class="hdlist1">manage</dt>
<dd>
<p>Policies that decide if the admin can manage the configuration of the group.</p>
</dd>
<dt class="hdlist1">view-members</dt>
<dd>
<p>Policies that decide if the admin can view the user details of members of the group.</p>
</dd>
<dt class="hdlist1">manage-members</dt>
<dd>
<p>Policies that decide if the admin can manage the users that belong to this group.</p>
</dd>
<dt class="hdlist1">manage-membership</dt>
<dd>
<p>Policies that decide if an admin can change the membership of the group.  Add or
remove members from the group.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="realm_keys"><a class="anchor" href="#realm_keys"></a>11.4. Realm Keys</h3>
<div class="paragraph">
<p>The authentication protocols that are used by Keycloak require cryptographic signatures and sometimes
encryption.  Keycloak uses asymmetric key pairs, a private and public key, to accomplish this.</p>
</div>
<div class="paragraph">
<p>Keycloak has a single active keypair at a time, but can have several passive keys as well. The active keypair
is used to create new signatures, while the passive keypairs can be used to verify previous signatures. This makes it
possible to regularly rotate the keys without any downtime or interruption to users.</p>
</div>
<div class="paragraph">
<p>When a realm is created a key pair and a self-signed certificate is automatically generated.</p>
</div>
<div class="paragraph">
<p>To view the active keys for a realm select the realm in the admin console click on <code>Realm settings</code> then <code>Keys</code>. This
will show the currently active keys for the realm. Keycloak currently only supports RSA signatures so there
is only one active keypair. In the future as more signature algorithms are added there will be more active keypairs.</p>
</div>
<div class="paragraph">
<p>To view all available keys select <code>All</code>. This will show all active, passive and disabled keys. A keypair can have the
status <code>Active</code>, but still not be selected as the currently active keypair for the realm. The selected active pair which
is used for signatures is selected based on the first key provider sorted by priority that is able to provide an
 active keypair.</p>
</div>
<div class="sect3">
<h4 id="rotating-keys"><a class="anchor" href="#rotating-keys"></a>11.4.1. Rotating keys</h4>
<div class="paragraph">
<p>It&#8217;s recommended to regularly rotate keys. To do so you should start by creating new keys with a higher priority than
the existing active keys. Or create new keys with the same priority and making the previous keys passive.</p>
</div>
<div class="paragraph">
<p>Once new keys are available all new tokens and cookies will be signed with the new keys. When a user authenticates to an
application the SSO cookie is updated with the new signature. When OpenID Connect tokens are refreshed new tokens are
signed with the new keys. This means that over time all cookies and tokens will use the new keys and after a while the
old keys can be removed.</p>
</div>
<div class="paragraph">
<p>How long you wait to delete old keys is a tradeoff between security and making sure all cookies and tokens are updated.
In general it should be acceptable to drop old keys after a few weeks. Users that have not been active in the period
between the new keys where added and the old keys removed will have to re-authenticate.</p>
</div>
<div class="paragraph">
<p>This also applies to offline tokens. To make sure they are updated the applications need to refresh the tokens before
the old keys are removed.</p>
</div>
<div class="paragraph">
<p>As a guideline it may be a good idea to create new keys every 3-6 months and delete old keys 1-2 months after the new
keys where created.</p>
</div>
</div>
<div class="sect3">
<h4 id="adding-a-generated-keypair"><a class="anchor" href="#adding-a-generated-keypair"></a>11.4.2. Adding a generated keypair</h4>
<div class="paragraph">
<p>To add a new generated keypair select <code>Providers</code> and choose <code>rsa-generated</code> from the dropdown. You can change the priority
to make sure the new keypair becomes the active keypair. You can also change the <code>keysize</code> if you want smaller or larger keys (default is 2048,
supported values are 1024, 2048 and 4096).</p>
</div>
<div class="paragraph">
<p>Click <code>Save</code> to add the new keys. This will generated a new keypair including a self-signed certificate.</p>
</div>
<div class="paragraph">
<p>Changing the priority for a provider will not cause the keys to be re-generated, but if you want to change the keysize
you can edit the provider and new keys will be generated.</p>
</div>
</div>
<div class="sect3">
<h4 id="adding-an-existing-keypair-and-certificate"><a class="anchor" href="#adding-an-existing-keypair-and-certificate"></a>11.4.3. Adding an existing keypair and certificate</h4>
<div class="paragraph">
<p>To add a keypair and certificate obtained elsewhere select <code>Providers</code> and choose <code>rsa</code> from the dropdown. You can change
the priority to make sure the new keypair becomes the active keypair.</p>
</div>
<div class="paragraph">
<p>Click on <code>Select file</code> for <code>Private RSA Key</code> to upload your private key. The file should be encoded in PEM format. You
don&#8217;t need to upload the public key as it is automatically extracted from the private key.</p>
</div>
<div class="paragraph">
<p>If you have a signed certificate for the keys click on <code>Select file</code> next to <code>X509 Certificate</code>. If you don&#8217;t have one
 you can skip this and a self-signed certificate will be generated.</p>
</div>
</div>
<div class="sect3">
<h4 id="loading-keys-from-a-java-keystore"><a class="anchor" href="#loading-keys-from-a-java-keystore"></a>11.4.4. Loading keys from a Java Keystore</h4>
<div class="paragraph">
<p>To add a keypair and certificate stored in a Java Keystore file on the host select <code>Providers</code> and choose <code>java-keystore</code>
from the dropdown. You can change the priority to make sure the new keypair becomes the active keypair.</p>
</div>
<div class="paragraph">
<p>Fill in the values for <code>Keystore</code>, <code>Keystore Password</code>, <code>Key Alias</code> and <code>Key Password</code> and click on <code>Save</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-keys-passive"><a class="anchor" href="#making-keys-passive"></a>11.4.5. Making keys passive</h4>
<div class="paragraph">
<p>Locate the keypair in <code>Active</code> or <code>All</code> then click on the provider in the <code>Provider</code> column. This will take you to the
configuration screen for the key provider for the keys. Click on <code>Active</code> to turn it <code>OFF</code>, then click on <code>Save</code>. The
keys will no longer be active and can only be used for verifying signatures.</p>
</div>
</div>
<div class="sect3">
<h4 id="disabling-keys"><a class="anchor" href="#disabling-keys"></a>11.4.6. Disabling keys</h4>
<div class="paragraph">
<p>Locate the keypair in <code>Active</code> or <code>All</code> then click on the provider in the <code>Provider</code> column. This will take you to the
configuration screen for the key provider for the keys. Click on <code>Enabled</code> to turn it <code>OFF</code>, then click on <code>Save</code>. The
keys will no longer be enabled.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can delete the provider from the <code>Providers</code> table.</p>
</div>
</div>
<div class="sect3">
<h4 id="compromised-keys"><a class="anchor" href="#compromised-keys"></a>11.4.7. Compromised keys</h4>
<div class="paragraph">
<p>Keycloak has the signing keys stored just locally and they are never shared with the client applications, users or other
entities. However if you think that your realm signing key was compromised, you should first generate new keypair as described above and
then immediatelly remove the compromised keypair.</p>
</div>
<div class="paragraph">
<p>Then to ensure that client applications won&#8217;t accept the tokens signed by the compromised key, you should update and push not-before policy for
the realm, which is doable from the admin console. Pushing new policy will ensure that client applications won&#8217;t accept the existing
tokens signed by the compromised key, but also the client application will be forced to download new keypair from the Keycloak, hence
the tokens signed by the compromised key won&#8217;t be valid anymore. Note that your REST and confidential clients must have set <code>Admin URL</code>, so that
Keycloak is able to send them the request about pushed not-before policy.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identity_broker"><a class="anchor" href="#_identity_broker"></a>12. Identity Brokering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An Identity Broker is an intermediary service that connects multiple service providers with different identity providers.
As an intermediary service, the identity broker is responsible for creating
a trust relationship with an external identity provider in order to use its identities to access internal services exposed by service providers.</p>
</div>
<div class="paragraph">
<p>From a user perspective, an identity broker provides a user-centric and centralized way to manage identities across different security
domains or realms. An existing account can be linked with one or more identities from different identity providers or even created
based on the identity information obtained from them.</p>
</div>
<div class="paragraph">
<p>An identity provider is usually based on a specific protocol that is used to authenticate and communicate authentication and authorization information to their users.
It can be a social provider such as Facebook, Google or Twitter.  It can be a business partner whose users need to access your services. Or it can be a cloud-based identity
service that you want to integrate with.</p>
</div>
<div class="paragraph">
<p>Usually, identity providers are based on the following protocols:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SAML v2.0</code></p>
</li>
<li>
<p><code>OpenID Connect v1.0</code></p>
</li>
<li>
<p><code>OAuth v2.0</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the next sections we&#8217;ll see how to configure and use Keycloak as an identity broker, covering some important aspects such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Social Authentication</code></p>
</li>
<li>
<p><code>OpenID Connect v1.0 Brokering</code></p>
</li>
<li>
<p><code>SAML v2.0 Brokering</code></p>
</li>
<li>
<p><code>Identity Federation</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_identity_broker_overview"><a class="anchor" href="#_identity_broker_overview"></a>12.1. Brokering Overview</h3>
<div class="paragraph">
<p>When using Keycloak as an identity broker, users are not forced to provide their credentials in order to authenticate in a specific realm.
Instead, they are presented with a list of identity providers from which they can authenticate.</p>
</div>
<div class="paragraph">
<p>You can also configure a default broker. In this case the user will not be given a choice, but instead be redirected directly to the parent broker.</p>
</div>
<div class="paragraph">
<p>The following diagram demonstrates the steps involved when using Keycloak to broker an external identity provider:</p>
</div>
<div class="paragraph">
<div class="title">Identity Broker Flow</div>
<p><span class="image"><img src="./images/identity_broker_flow.png" alt="identity broker flow"></span></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User is not authenticated and requests a protected resource in a client application.</p>
</li>
<li>
<p>The client applications redirects the user to Keycloak to authenticate.</p>
</li>
<li>
<p>At this point the user is presented with the login page where there is a list of identity providers supported by a realm.</p>
</li>
<li>
<p>User selects one of the identity providers by clicking on its respective button or link.</p>
</li>
<li>
<p>Keycloak issues an authentication request to the target identity provider asking for authentication and the user
is redirected to the login page of the identity provider.
The connection properties and other configuration options for the identity provider were previously set by the administrator in the Admin Console.</p>
</li>
<li>
<p>User provides his credentials or consent in order to authenticate in the identity provider.</p>
</li>
<li>
<p>Upon a successful authentication by the identity provider, the user is redirected back to Keycloak with an authentication response.
Usually this response contains a security token that will be used by Keycloak to trust the authentication performed by the identity provider
and retrieve information about the user.</p>
</li>
<li>
<p>Now Keycloak is going to check if the response from the identity provider is valid.
If valid, it will import and create a new user or just skip that if the user already exists.
If it is a new user, Keycloak may ask the identity provider for information about the user if that info doesn&#8217;t already exist in the token.
This is what we call <em>identity federation</em>.
If the user already exists Keycloak may ask him to link the identity returned from the identity provider with his existing account.
We call this process <em>account linking</em>.
What exactly is done is configurable and can be specified by setup of <a href="#_identity_broker_first_login">First Login Flow</a> . At the end of this step, Keycloak authenticates the user and issues its own token in order to access the requested resource in the service provider.</p>
</li>
<li>
<p>Once the user is locally authenticated, Keycloak redirects the user to the service provider by sending the token previously issued during the local authentication.</p>
</li>
<li>
<p>The service provider receives the token from Keycloak and allows access to the protected resource.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There are some variations of this flow that we will talk about later.
For instance, instead of presenting a list of identity providers, the client application can request a specific one.
Or you can tell Keycloak to force the user to provide additional information before federating his identity.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Different protocols may require different authentication flows.
      At this moment, all the identity providers supported by Keycloak use a flow just like described above.
      However, despite the protocol in use, user experience should be pretty much the same.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you may notice, at the end of the authentication process Keycloak will always issue its own token to client applications.
What this means is that client applications are completely decoupled from external identity providers.
They don&#8217;t need to know which protocol (eg.: SAML, OpenID Connect, OAuth, etc) was used or how the user&#8217;s identity was validated.
They only need to know about Keycloak.</p>
</div>
</div>
<div class="sect2">
<h3 id="default_identity_provider"><a class="anchor" href="#default_identity_provider"></a>12.2. Default Identity Provider</h3>
<div class="paragraph">
<p>It&#8217;s possible to automatically redirect to a identity provider instead of displaying the login form. To enable this go to <code>Authentication</code> select the <code>Browser</code> flow. Then click on config for the <code>Identity Provider Redirector</code> authenticator. Set <code>Default Identity Provider</code> to the alias of the identity provider you want to automatically redirect users to.</p>
</div>
<div class="paragraph">
<p>If the configured default identity provider is not found the login form will be displayed instead.</p>
</div>
<div class="paragraph">
<p>This authenticator is also responsible for dealing with the <code>kc_idp_hint</code> query parameter. See <a href="#_client_suggested_idp">client suggested identity provider</a> section for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_general-idp-config"><a class="anchor" href="#_general-idp-config"></a>12.3. General Configuration</h3>
<div class="paragraph">
<p>The identity broker configuration is all based on identity providers.
Identity providers are created for each realm and by default they are enabled for every single application.
That means that users from a realm can use any of the registered identity providers when signing in to an application.</p>
</div>
<div class="paragraph">
<p>In order to create an identity provider click the <code>Identity Providers</code> left menu item.</p>
</div>
<div class="paragraph">
<div class="title">Identity Providers</div>
<p><span class="image"><img src="./keycloak-images/identity-providers.png" alt="identity providers"></span></p>
</div>
<div class="paragraph">
<p>In the drop down list box, choose the identity provider you want to add.  This will bring you to the
configuration page for that identity provider type.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/add-identity-provider.png" alt="add identity provider"></span></p>
</div>
<div class="paragraph">
<p>Above is an example of configuring a Google social login provider.  Once you configure an IDP, it will appear on the Keycloak
login page as an option.</p>
</div>
<div class="paragraph">
<div class="title">IDP login page</div>
<p><span class="image"><img src="./keycloak-images/identity-provider-login-page.png" alt="identity provider login page"></span></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Social</dt>
<dd>
<p>Social providers allow you to enable social authentication in your realm.
Keycloak makes it easy to let users log in to your application using an existing account with a social network.
Currently Facebook, Google, Twitter, GitHub, LinkedIn, Microsoft, and StackOverflow are supported with more planned for the future.</p>
</dd>
<dt class="hdlist1">Protocol-based</dt>
<dd>
<p>Protocol-based providers are those that rely on a specific protocol in order to authenticate and authorize users.
They allow you to connect to any identity provider compliant with a specific protocol.
Keycloak provides support for SAML v2.0 and OpenID Connect v1.0 protocols.
It makes it easy to configure and broker any identity provider based on these open standards.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Although each type of identity provider has its own configuration options, all of them share some very common configuration.
Regardless the identity provider you are creating, you&#8217;ll see the following configuration options available:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Common Configuration</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alias</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The alias is an unique identifier for an identity provider. It is used to reference an identity provider internally.
 Some protocols such as OpenID Connect require a redirect URI or callback url in order to communicate with an identity provider.
 In this case, the alias is used to build the redirect URI.
 Every single identity provider must have an alias. Examples are facebook, google, idp.acme.com, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enabled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Turn the provider on/off</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hide On Login Page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this switch is on, this provider will not be shown as a login option on the login page.  Clients can still request to use this provider by using the 'kc_idp_hint' parameter in the URL they use to request a login.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link Only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this switch is on, this provider cannot be used to login users and will not be shown as an option on the login page.  Existing accounts can still be linked with this provider though.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Store Tokens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not to store the token received from the identity provider.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stored Tokens Readable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not users are allowed to retrieve the stored identity provider token.  This also applies to the <em>broker</em> client-level
 role <em>read token</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trust email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the identity provider supplies an email address this email address will be trusted.  If the realm required email validation,
 users that log in from this IDP will not have to go through the email verification process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GUI order</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The order number that sorts how the available IDPs are listed on the Keycloak login page.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First Login Flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the authentication flow that will be triggered for users that log into Keycloak through this IDP
 for the first time ever.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Post Login Flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentication flow that is triggered after the user finishes logging in with the external identity provider.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="social-identity-providers"><a class="anchor" href="#social-identity-providers"></a>12.4. Social Identity Providers</h3>
<div class="paragraph">
<p>For Internet facing applications, it is quite burdensome for users to have to register at your site to obtain access.
It requires them to remember yet another username and password combination.  Social identity providers allow you to delegate
authentication to a semi-trusted and respected entity where the user probably already has an account.
Keycloak provides built-in support for the most common social networks out there, such as Google, Facebook, Twitter, Github, LinkedIn, Microsoft and StackOverflow.</p>
</div>
<div class="sect3">
<h4 id="google"><a class="anchor" href="#google"></a>12.4.1. Google</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to Google.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Google</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/google-add-identity-provider.png" alt="google add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Google.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Google when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Google you first have to create a project and a client in the <a href="https://console.cloud.google.com/project">Google Developer Console</a>.
Then you need to copy the client id and secret into the Keycloak Admin Console.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Google often changes the look and feel of the Google Developer Console, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s see first how to create a project with Google.</p>
</div>
<div class="paragraph">
<p>Log in to the <a href="https://console.cloud.google.com/project">Google Developer Console</a>.</p>
</div>
<div class="paragraph">
<div class="title">Google Developer Console</div>
<p><span class="image"><img src="./images/google-developer-console.png" alt="google developer console"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Create Project</code> button.
Use any value for <code>Project name</code> and <code>Project ID</code> you want, then click the <code>Create</code> button.
Wait for the project to be created (this may take a while).  Once created you will be brought to the project&#8217;s dashboard.</p>
</div>
<div class="paragraph">
<div class="title">Dashboard</div>
<p><span class="image"><img src="./images/google-dashboard.png" alt="google dashboard"></span></p>
</div>
<div class="paragraph">
<p>To be able to retrieve the profiles of Google users, you need to turn on the Google+ APIs.  Select the <code>Enable and manage APIs</code>
and click the <code>Google+ API</code> link.</p>
</div>
<div class="paragraph">
<div class="title">APIs</div>
<p><span class="image"><img src="./images/google-api-list.png" alt="google api list"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Enable</code> button on this page.  You will get a message that you must create the credentials of your project.
So click the <code>Go to Credentials</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Go To Credentials</div>
<p><span class="image"><img src="./images/google-go-to-credentials.png" alt="google go to credentials"></span></p>
</div>
<div class="paragraph">
<p>You will then be brought to the credentials page.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you logout in the middle of this, there is a menu in the top left hand corner.  Select <code>API Manager</code> and it
       will bring you to your desired screen.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will then be asked to specify what credentials you need and what type of data you will be accessing.</p>
</div>
<div class="paragraph">
<div class="title">Add Credentials</div>
<p><span class="image"><img src="./images/google-add-credentials.png" alt="google add credentials"></span></p>
</div>
<div class="paragraph">
<p>Select <code>Web server</code> and <code>User data</code> and click the <code>What credentials do I need?</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Create OAuth ID</div>
<p><span class="image"><img src="./images/google-create-oauth-id.png" alt="google create oauth id"></span></p>
</div>
<div class="paragraph">
<p>Next you&#8217;ll need to create an OAuth 2.0 client ID.  Specify the name you want for your client.  You&#8217;ll also need to
copy and paste the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page into the
<code>Authorized redirect URIs</code> field.  After you do this, click the <code>Create client ID</code> button.</p>
</div>
<div class="paragraph">
<p>When users log into Google from Keycloak they will see a consent screen from Google which will ask the user
if Keycloak is allowed to view information about their user profile.  The next Google config screen asks
you for information about this screen.</p>
</div>
<div class="paragraph">
<p>Once you click <code>Done</code> you will be brought to the <code>Credentials</code> page.  Click on your new OAuth 2.0 Client ID to view
the settings of your new Google Client.</p>
</div>
<div class="paragraph">
<div class="title">Google Client Credentials</div>
<p><span class="image"><img src="./images/google-client-credentials.png" alt="google client credentials"></span></p>
</div>
<div class="paragraph">
<p>You will need to obtain the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
<div class="paragraph">
<p>One config option to note on the <code>Add identity provider</code> page for Google is the <code>Default Scopes</code> field.
This field allows you to manually specify the scopes that users must authorize when authenticating with this provider.
For a complete list of scopes, please take a look at <a href="https://developers.google.com/oauthplayground/" class="bare">https://developers.google.com/oauthplayground/</a> . By default, Keycloak
uses the following scopes: <code>openid</code> <code>profile</code> <code>email</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="facebook"><a class="anchor" href="#facebook"></a>12.4.2. Facebook</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to Facebook.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Facebook</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/facebook-add-identity-provider.png" alt="facebook add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Facebook.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Facebook when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Facebook you first have to create a project and a client in the <a href="https://developers.facebook.com/">Facebook Developer Console</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Facebook often changes the look and feel of the Facebook Developer Console, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once you&#8217;ve logged into the console there is a pull down menu in the top right corner of the screen that says <code>My Apps</code>.  Select the <code>Add a New App</code>
menu item.</p>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/facebook-add-new-app.png" alt="facebook add new app"></span></p>
</div>
<div class="paragraph">
<p>Select the <code>Website</code> icon.  Click the <code>Skip and Create App ID</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Create a New App ID</div>
<p><span class="image"><img src="./images/facebook-create-app-id.png" alt="facebook create app id"></span></p>
</div>
<div class="paragraph">
<p>The email address and app category are required fields.  Once you&#8217;re done with that, you will be brought to the dashboard
for the application.  Click the <code>Settings</code> left menu item.</p>
</div>
<div class="paragraph">
<div class="title">Create a New App ID</div>
<p><span class="image"><img src="./images/facebook-app-settings.png" alt="facebook app settings"></span></p>
</div>
<div class="paragraph">
<p>Click on the <code>+ Add Platform</code> button at the end of this page and select the <code>Website</code> icon.  Copy and paste the <code>Redirect URI</code> from the
Keycloak <code>Add identity provider</code> page into the <code>Site URL</code> of the Facebook <code>Website</code> settings block.</p>
</div>
<div class="paragraph">
<div class="title">Specify Website</div>
<p><span class="image"><img src="./images/facebook-app-settings-website.png" alt="facebook app settings website"></span></p>
</div>
<div class="paragraph">
<p>After this it is necessary to make the Facebook app public. Click <code>App Review</code> left menu item and switch button to "Yes".</p>
</div>
<div class="paragraph">
<p>You will need also to obtain the App ID and App Secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page. To obtain this click on the <code>Dashboard</code> left menu item and click on <code>Show</code> under <code>App Secret</code>. Go back to Keycloak and specify those items and finally save your Facebook Identity Provider.</p>
</div>
<div class="paragraph">
<p>One config option to note on the <code>Add identity provider</code> page for Facebook is the <code>Default Scopes</code> field.
This field allows you to manually specify the scopes that users must authorize when authenticating with this provider.
For a complete list of scopes, please take a look at <a href="https://developers.facebook.com/docs/graph-api" class="bare">https://developers.facebook.com/docs/graph-api</a>. By default, Keycloak
uses the following scopes: <code>email</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="twitter"><a class="anchor" href="#twitter"></a>12.4.3. Twitter</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to Twitter.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Twitter</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/twitter-add-identity-provider.png" alt="twitter add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Twitter.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Twitter when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Twtter you first have to create an application in the <a href="https://apps.twitter.com">Twitter Application Management</a>.</p>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/twitter-app-register.png" alt="twitter app register"></span></p>
</div>
<div class="paragraph">
<p>Click on the <code>Create New App</code> button.  This will bring you to the <code>Create an Application</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/twitter-app-create.png" alt="twitter app create"></span></p>
</div>
<div class="paragraph">
<p>Enter in a Name and Description.  The Website can be anything, but cannot have a <code>localhost</code> address.  For the
<code>Callback URL</code> you must copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
You cannot use <code>localhost</code> in the <code>Callback URL</code>.  Instead replace it with <code>127.0.0.1</code> if you are trying to
         testdrive Twitter login on your laptop.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After clicking save you will be brought to the <code>Details</code> page.</p>
</div>
<div class="paragraph">
<div class="title">App Details</div>
<p><span class="image"><img src="./images/twitter-details.png" alt="twitter details"></span></p>
</div>
<div class="paragraph">
<p>Next go to the <code>Keys and Access Tokens</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Keys and Access Tokens</div>
<p><span class="image"><img src="./images/twitter-keys.png" alt="twitter keys"></span></p>
</div>
<div class="paragraph">
<p>Finally, you will need to obtain the API Key and secret from this page and copy them back into the <code>Client ID</code> and <code>Client Secret</code> fields on the Keycloak <code>Add identity provider</code> page.</p>
</div>
</div>
<div class="sect3">
<h4 id="github"><a class="anchor" href="#github"></a>12.4.4. Github</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to Github.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Github</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/github-add-identity-provider.png" alt="github add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Github.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Github when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Github you first have to register an application project in
<a href="https://github.com/settings/developers">GitHub Developer applications</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Github often changes the look and feel of application registration, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/github-developer-applications.png" alt="github developer applications"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Register a new application</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Register App</div>
<p><span class="image"><img src="./images/github-register-app.png" alt="github register app"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the
<code>Authorization callback URL</code> field on the Github <code>Register a new OAuth application</code> page.  Once you&#8217;ve completed this
page you will be brought to the application&#8217;s management page.</p>
</div>
<div class="paragraph">
<div class="title">Github App Page</div>
<p><span class="image"><img src="./images/github-app-page.png" alt="github app page"></span></p>
</div>
<div class="paragraph">
<p>You will need to obtain the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="linkedin"><a class="anchor" href="#linkedin"></a>12.4.5. LinkedIn</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to LinkedIn.  First, go to the <code>Identity Providers</code> left menu item
and select <code>LinkedIn</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/linked-in-add-identity-provider.png" alt="linked in add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from LinkedIn.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to LinkedIn when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with LinkedIn you first have to create an application in <a href="https://www.linkedin.com/developer/apps">LinkedIn Developer Network</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
LinkedIn may change the look and feel of application registration, so these directions may not always be up to date.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Developer Network</div>
<p><span class="image"><img src="./images/linked-in-developer-network.png" alt="linked in developer network"></span></p>
</div>
<div class="paragraph">
<p>Click on the <code>Create Application</code> button.  This will bring you to the <code>Create a New Application</code> Page.</p>
</div>
<div class="paragraph">
<div class="title">Create App</div>
<p><span class="image"><img src="./images/linked-in-create-app.png" alt="linked in create app"></span></p>
</div>
<div class="paragraph">
<p>Fill in the form with the approriate values, then click the <code>Submit</code> button.  This will bring you to the new application&#8217;s settings page.</p>
</div>
<div class="paragraph">
<div class="title">App Settings</div>
<p><span class="image"><img src="./images/linked-in-app-settings.png" alt="linked in app settings"></span></p>
</div>
<div class="paragraph">
<p>Select <code>r_basicprofile</code> and <code>r_emailaddress</code> in the <code>Default Application Permissions</code> section.
You&#8217;ll have to copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the
<code>OAuth 2.0</code> <code>Authorized Redirect URLs</code> field on the LinkedIn app settings page.  Don&#8217;t forget to click the <code>Update</code> button after
you do this!</p>
</div>
<div class="paragraph">
<p>You will then need to obtain the client ID and secret from this page so you can enter them into the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="microsoft"><a class="anchor" href="#microsoft"></a>12.4.6. Microsoft</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to Microsoft.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Microsoft</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/microsoft-add-identity-provider.png" alt="microsoft add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from Microsoft.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to Microsoft when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with Microsoft account you first have to register an OAuth application at Microsoft.
Go to the <a href="https://account.live.com/developers/applications/create">Microsoft Application Registration</a> url.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Microsoft often changes the look and feel of application registration, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/microsoft-app-register.png" alt="microsoft app register"></span></p>
</div>
<div class="paragraph">
<p>Enter in the application name and click <code>Create application</code>.  This will bring you to the application settings page of your
new application.</p>
</div>
<div class="paragraph">
<div class="title">Settings</div>
<p><span class="image"><img src="./images/microsoft-app-settings.png" alt="microsoft app settings"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and add it to the
<code>Redirect URIs</code> field on the Microsoft application page.  Be sure to click the <code>Add Url</code> button and <code>Save</code> your changes.</p>
</div>
<div class="paragraph">
<p>Finally, you will need to obtain the Application ID and secret from this page so you can enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="paypal"><a class="anchor" href="#paypal"></a>12.4.7. PayPal</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to PayPal.  First, go to the <code>Identity Providers</code> left menu item
and select <code>PayPal</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/paypal-add-identity-provider.png" alt="paypal add identity provider"></span></p>
</div>
<div class="paragraph">
<p>You can&#8217;t click save yet, as you&#8217;ll need to obtain a <code>Client ID</code> and <code>Client Secret</code> from PayPal.  One piece of data you&#8217;ll need from this
page is the <code>Redirect URI</code>.  You&#8217;ll have to provide that to PayPal when you register Keycloak as a client there, so
copy this URI to your clipboard.</p>
</div>
<div class="paragraph">
<p>To enable login with PayPal you first have to register an application project in
<a href="https://developer.paypal.com/developer/applications">PayPal Developer applications</a>.</p>
</div>
<div class="paragraph">
<div class="title">Add a New App</div>
<p><span class="image"><img src="./images/paypal-developer-applications.png" alt="paypal developer applications"></span></p>
</div>
<div class="paragraph">
<p>Click the <code>Create App</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Register App</div>
<p><span class="image"><img src="./images/paypal-register-app.png" alt="paypal register app"></span></p>
</div>
<div class="paragraph">
<p>You will now be brought to the app settings page.</p>
</div>
</div>
<div class="sect3">
<h4 id="do-the-following-changes"><a class="anchor" href="#do-the-following-changes"></a>12.4.8. Do the following changes:</h4>
<div class="ulist">
<ul>
<li>
<p>Choose to configure either Sandbox or Live (choose Live if you haven&#8217;t enabled the <code>Target Sandbox</code> switch on the <code>Add identity provider</code> page)</p>
</li>
<li>
<p>Copy Client ID and Secret so you can paste them into the Keycloak <code>Add identity provider</code> page.</p>
</li>
<li>
<p>Scroll down to <code>App Settings</code></p>
</li>
<li>
<p>Copy the <code>Redirect URI</code> from the Keycloak <code>Add Identity Provider</code> page and enter it into the <code>Return URL</code> field.</p>
</li>
<li>
<p>Check the <code>Log In with PayPal</code> checkbox.</p>
</li>
<li>
<p>Check the <code>Full name</code> checkbox under the personal information section.</p>
</li>
<li>
<p>Check the <code>Email address</code> checkbox under the address information section.</p>
</li>
<li>
<p>Add both a privacy and a user agreement URL pointing to the respective pages on your domain.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="stackoverflow"><a class="anchor" href="#stackoverflow"></a>12.4.9. StackOverflow</h4>
<div class="paragraph">
<p>There are a number of steps you have to complete to be able to login to StackOverflow.  First, go to the <code>Identity Providers</code> left menu item
and select <code>StackOverflow</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/stack-overflow-add-identity-provider.png" alt="stack overflow add identity provider"></span></p>
</div>
<div class="paragraph">
<p>To enable login with StackOverflow you first have to register an OAuth application on <a href="https://stackapps.com/">StackApps</a>.
Go to <a href="https://stackapps.com/apps/oauth/register">registering your application on Stack Apps</a> url and login.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
StackOverflow often changes the look and feel of application registration, so these directions might not always be up to date and the
      configuration steps might be slightly different.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Register Application</div>
<p><span class="image"><img src="./images/stack-overflow-app-register.png" alt="stack overflow app register"></span></p>
</div>
<div class="paragraph">
<p>Enter in the application name and the OAuth Domain Name of your application and click <code>Register your Application</code>.  Type in anything you want
for the other items.</p>
</div>
<div class="paragraph">
<div class="title">Settings</div>
<p><span class="image"><img src="./images/stack-overflow-app-settings.png" alt="stack overflow app settings"></span></p>
</div>
<div class="paragraph">
<p>Finally, you will need to obtain the client ID, secret, and key from this page so you can enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
</div>
<div class="sect3">
<h4 id="openshift"><a class="anchor" href="#openshift"></a>12.4.10. Openshift</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Openshift Online is currently in the developer preview mode. This documentation has been based on on-premise installations and local <code>minishift</code> development environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a just a few steps you have to complete to be able to login to OpenShift.  First, go to the <code>Identity Providers</code> left menu item
and select <code>Openshift</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./images/openshift-add-identity-provider.png" alt="openshift add identity provider"></span></p>
</div>
<div class="paragraph">
<div class="title">Registering OAuth client</div>
<p>You can register your client using <code>oc</code> command line tool.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ oc create -f &lt;(echo '
kind: OAuthClient
apiVersion: v1
metadata:
 name: kc-client <i class="conum" data-value="1"></i><b>(1)</b>
secret: &quot;...&quot; <i class="conum" data-value="2"></i><b>(2)</b>
redirectURIs:
 - &quot;http://www.example.com/&quot; <i class="conum" data-value="3"></i><b>(3)</b>
grantMethod: prompt <i class="conum" data-value="4"></i><b>(4)</b>
')</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>name</code> of your OAuth client. Passed as <code>client_id</code> request parameter when making requests to <code><em>&lt;openshift_master&gt;</em>/oauth/authorize</code> and <code><em>&lt;openshift_master&gt;</em>/oauth/token</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>secret</code> is used as the <code>client_secret</code> request parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>redirect_uri</code> parameter specified in requests to <code><em>&lt;openshift_master&gt;</em>/oauth/authorize</code> and <code><em>&lt;openshift_master&gt;</em>/oauth/token</code> must be equal to (or prefixed by) one of the URIs in <code>redirectURIs</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>grantMethod</code> is used to determine what action to take when this client requests tokens and has not yet been granted access by the user.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="paragraph">
<p>Use client ID and secret defined by <code>oc create</code> command to enter them back on the Keycloak <code>Add identity provider</code> page.
Go back to Keycloak and specify those items.</p>
</div>
<div class="paragraph">
<p>Please refer to <a href="https://docs.openshift.org/latest/architecture/additional_concepts/authentication.html#oauth">official Openshift documentation</a> for more detailed guides.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openid-connect-v1-0-identity-providers"><a class="anchor" href="#openid-connect-v1-0-identity-providers"></a>12.5. OpenID Connect v1.0 Identity Providers</h3>
<div class="paragraph">
<p>Keycloak can broker identity providers based on the OpenID Connect protocol.  These IDPs must support the <a href="#_oidc">Authorization Code Flow</a>
as defined by the specification in order to authenticate the user and authorize access.</p>
</div>
<div class="paragraph">
<p>To begin configuring an OIDC provider, go to the <code>Identity Providers</code> left menu item
and select <code>OpenID Connect v1.0</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/oidc-add-identity-provider.png" alt="oidc add identity provider"></span></p>
</div>
<div class="paragraph">
<p>The initial configuration options on this page are described in <a href="#_general-idp-config">General IDP Configuration</a>.
You must define the OpenID Connection configuration options as well.  They basically describe the OIDC IDP you are communicating with.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 2. OpenID Connect Config</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization URL endpoint required by the OIDC protocol</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token URL endpoint required by the OIDC protocol</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logout URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logout URL endpoint defined in the OIDC protocol.  This value is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backchannel Logout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backchannel logout is a background, out-of-band, REST invocation to the IDP to logout the user.  Some IDPs can only perform logout through browser redirects as they may
 only be able to identity sessions via a browser cookie.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Info URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User Info URL endpoint defined by the OIDC protocol.  This is an endpoint from which user profile information can be downloaded.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client ID</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This realm will act as an OIDC client to the external federation IDP you are configuring here.  Your realm will need a OIDC client ID when using the Authorization Code Flow
 to interact with the external IDP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client Secret</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This realm will need a client secret to use when using the Authorization Code Flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Issuer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Responses from the IDP may contain an issuer claim.  This config value is optional.  If specified, this claim will be validated against the value you provide.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Scopes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Space-separated list of OIDC scopes to send with the authentication request.  The default is <code>openid</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prompt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Another optional switch.  This is the prompt parameter defined by the OIDC specification. Through it you can force re-authentication and other options.  See the specification for
 more details</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validate Signatures</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Another optional switch. This is to specify if Keycloak will verify the signatures on the external ID Token signed by this Identity provider. If this is on,
the Keycloak will need to know the public key of the external OIDC identity provider. See below for how to setup it.
WARNING: For the performance purposes, Keycloak caches the public key of the external OIDC identity provider. If you think that private key of your Identity provider
was compromised, it is obviously good to update your keys, but it&#8217;s also good to clear the keys cache. See
<a href="#_clear-cache">Clearing the cache</a> section for more details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use JWKS URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable if <code>Validate Signatures</code> is on. If the switch is on, then identity provider public keys  will be downloaded from given JWKS URL.
 This allows great flexibility because new keys will be always re-downloaded again when identity provider generates new keypair. If the switch is off,
 then public key (or certificate) from the Keycloak DB is used, so when identity provider keypair changes, you always need to import new key to the Keycloak DB as well.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWKS URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL where identity provider keys in JWK format are stored. See <a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html">JWK specification</a> for more details.
 If you use external Keycloak identity provider, then you can use URL like <a href="http://broker-keycloak:8180/auth/realms/test/protocol/openid-connect/certs" class="bare">http://broker-keycloak:8180/auth/realms/test/protocol/openid-connect/certs</a> assuming your brokered
 Keycloak is running on <a href="http://broker-keycloak:8180" class="bare">http://broker-keycloak:8180</a> and it&#8217;s realm is <code>test</code> .</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validating Public Key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable if <code>Use JWKS URL</code> is off. Here is the public key in PEM format that must be used to verify external IDP signatures.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validating Public Key Id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Applicable if <code>Use JWKS URL</code> is off. This field specifies ID of the public key in PEM format. This config value is optional. As there is no standard way
 for computing key ID from key, various external identity providers might use different algorithm from Keycloak. If the value of this field
 is not specified, the validating public key specified above is used for all requests regardless of key ID sent by external IDP. When set, value of this
 field serves as key ID used by Keycloak for validating signatures from such providers and must match the key ID specified by the IDP.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also import all this configuration data by providing a URL or file that points to OpenID Provider Metadata (see OIDC Discovery specification).
If you are connecting to a Keycloak external IDP, you can import the IDP setttings from the url <code>&lt;root&gt;/auth/realms/{realm-name}/.well-known/openid-configuration</code>.
This link is a JSON document describing metadata about the IDP.</p>
</div>
</div>
<div class="sect2">
<h3 id="saml-v2-0-identity-providers"><a class="anchor" href="#saml-v2-0-identity-providers"></a>12.6. SAML v2.0 Identity Providers</h3>
<div class="paragraph">
<p>Keycloak can broker identity providers based on the SAML v2.0 protocol.</p>
</div>
<div class="paragraph">
<p>To begin configuring an SAML v2.0 provider, go to the <code>Identity Providers</code> left menu item
and select <code>SAML v2.0</code> from the <code>Add provider</code> drop down list.  This will bring you to the <code>Add identity provider</code> page.</p>
</div>
<div class="paragraph">
<div class="title">Add Identity Provider</div>
<p><span class="image"><img src="./keycloak-images/saml-add-identity-provider.png" alt="saml add identity provider"></span></p>
</div>
<div class="paragraph">
<p>The initial configuration options on this page are described in <a href="#_general-idp-config">General IDP Configuration</a>.
You must define the SAML configuration options as well.  They basically describe the SAML IDP you are communicating with.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 3. SAML Config</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Sign-On Service URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a required field and specifies the SAML endpoint to start the authentication process.  If your SAML IDP publishes an IDP entity descriptor, the value of
 this field will be specified there.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Single Logout Service URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is an optional field that specifies the SAML logout endpoint. If your SAML IDP publishes an IDP entity descriptor, the value of
 this field will be specified there.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Backchannel Logout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable if your SAML IDP supports backchannel logout</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NameID Policy Format</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the URI reference corresponding to a name identifier format. Defaults to urn:oasis:names:tc:SAML:2.0:nameid-format:persistent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP-POST Binding Response</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this realm responds to any SAML requests sent by the external IDP, which SAML binding should be used?  If set to <code>off</code>, then the Redirect Binding will be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP-POST Binding for AuthnRequest</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When this realm requests authentication from the external SAML IDP, which SAML binding should be used?  If set to <code>off</code>, then the Redirect Binding will be used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Want AuthnRequests Signed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, it will use the realm&#8217;s keypair to sign requests sent to the external SAML IDP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signature Algorithm</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If <code>Want AuthnRequests Signed</code> is on, then you can also pick the signature algorithm to use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAML Signature Key Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Signed SAML documents sent via POST binding contain identification of signing key in <code>KeyName</code>
 element. This by default contains Keycloak key ID. However various external SAML IDPs might
 expect a different key name or no key name at all. This switch controls whether <code>KeyName</code>
 contains key ID (option <code>KEY_ID</code>), subject from certificate corresponding to the realm key
 (option <code>CERT_SUBJECT</code> - expected for instance by Microsoft Active Directory Federation
 Services), or that the key name hint is completely omitted from the SAML message (option <code>NONE</code>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Force Authentication</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates that the user will be forced to enter in their credentials at the external IDP even if they are already logged in.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validate Signature</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not the realm should expect that SAML requests and responses from the external IDP be digitally signed.  It is highly recommended you turn this on!</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validating X509 Certificate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The public certificate that will be used to validate the signatures of SAML requests and responses from the external IDP.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also import all this configuration data by providing a URL or file that points to the SAML IDP entity descriptor of the external IDP.
If you are connecting to a Keycloak external IDP, you can import the IDP setttings from the url <code>&lt;root&gt;/auth/realms/{realm-name}/protocol/saml/descriptor</code>.
This link is an XML document describing metadata about the IDP.</p>
</div>
<div class="paragraph">
<p>You can also import all this configuration data by providing a URL or XML file that points to the entity descriptor of the external SAML IDP you want to connect to.</p>
</div>
<div class="sect3">
<h4 id="_identity_broker_saml_sp_descriptor"><a class="anchor" href="#_identity_broker_saml_sp_descriptor"></a>12.6.1. SP Descriptor</h4>
<div class="paragraph">
<p>Once you create a SAML provider, there is an <code>EXPORT</code> button that appears when viewing that provider.
Clicking this button will export a SAML SP entity descriptor which you can use to import into the external SP provider.</p>
</div>
<div class="paragraph">
<p>This metadata is also available publicly by going to the URL</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http[s]://{host:port}/auth/realms/{realm-name}/broker/{broker-alias}/endpoint/descriptor</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_client_suggested_idp"><a class="anchor" href="#_client_suggested_idp"></a>12.7. Client Suggested Identity Provider</h3>
<div class="paragraph">
<p>OIDC applications can bypass the Keycloak login page by specifying a hint on which
identity provider they want to use.</p>
</div>
<div class="paragraph">
<p>This is done by setting the <code>kc_idp_hint</code> query parameter in the Authorization Code Flow authorization endpoint.</p>
</div>
<div class="paragraph">
<p>Keycloak OIDC client adapters also allow you to specify this query parameter when you access a secured resource
at the application.</p>
</div>
<div class="paragraph">
<p>For example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GET /myapplication.com?kc_idp_hint=facebook HTTP/<span class="float">1.1</span>
Host: localhost:<span class="integer">8080</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, is expected that your realm has an identity provider with an alias <code>facebook</code>. If this provider doesn&#8217;t exist the login form will be displayed.</p>
</div>
<div class="paragraph">
<p>If you are using <code>keycloak.js</code> adapter, you can also achieve the same behavior:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">var keycloak = <span class="keyword">new</span> Keycloak(<span class="string"><span class="delimiter">'</span><span class="content">keycloak.json</span><span class="delimiter">'</span></span>);

keycloak.createLoginUrl({
        idpHint: <span class="string"><span class="delimiter">'</span><span class="content">facebook</span><span class="delimiter">'</span></span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>kc_idp_hint</code> query parameter also allows the client to override the default identity provider if one is configured for the <code>Identity Provider Redirector</code> authenticator. The client can also disable the automatic redirecting by setting the <code>kc_idp_hint</code> query parameter to an empty value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mappers"><a class="anchor" href="#_mappers"></a>12.8. Mapping Claims and Assertions</h3>
<div class="paragraph">
<p>You can import the SAML and OpenID Connect metadata provided by the external IDP you are authenticating with into the environment
of the realm.  This allows you to extract user profile metadata and other information so that you can make it available to your
applications.</p>
</div>
<div class="paragraph">
<p>Each new user that logs into your realm via an external identity provider will have an entry for it created in the local
Keycloak database.  The act of importing metadata from the SAML or OIDC assertions and claims will create this data
with the local realm database.</p>
</div>
<div class="paragraph">
<p>If you click on an identity provider listed in the <code>Identity Providers</code> page for your realm, you will be brought to the IDPs
<code>Settings</code> tab.  On this page is also a <code>Mappers</code> tab.  Click on that tab to start mapping your incoming IDP metadata.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/identity-provider-mappers.png" alt="identity provider mappers"></span></p>
</div>
<div class="paragraph">
<p>There is a <code>Create</code> button on this page.
Clicking on this create button allows you to create a broker mapper.
Broker mappers can import SAML attributes or OIDC ID/Access token claims into user attributes and user role mappings.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/identity-provider-mapper.png" alt="identity provider mapper"></span></p>
</div>
<div class="paragraph">
<p>Select a mapper from the <code>Mapper Type</code> list.  Hover over the tooltip to see a description of what the mapper does.  The
tooltips also describe what configuration information you need to enter. Click <code>Save</code> and your new mapper will be added.</p>
</div>
<div class="paragraph">
<p>For JSON based claims, you can use dot notation for nesting and square brackets to access array fields by index.
For example 'contact.address[0].country'.</p>
</div>
<div class="paragraph">
<p>To investigate the structure of user profile JSON data provided by social providers you can enable the <code>DEBUG</code> level logger <code>org.keycloak.social.user_profile_dump</code>.
This is done in the server&#8217;s app-server configuration file (domain.xml or standalone.xml).</p>
</div>
</div>
<div class="sect2">
<h3 id="available-user-session-data"><a class="anchor" href="#available-user-session-data"></a>12.9. Available User Session Data</h3>
<div class="paragraph">
<p>After a user logs in from the external IDP, there&#8217;s some additional user session note data that Keycloak stores that you can access.
This data can be propagated to the client requesting a login via the token or SAML assertion being passed back to it by using an appropriate client mapper.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">identity_provider</dt>
<dd>
<p>This is the IDP alias of the broker used to perform the login.</p>
</dd>
<dt class="hdlist1">identity_provider_identity</dt>
<dd>
<p>This is the IDP username of the currently authenticated user. This is often same like the Keycloak username, but doesn&#8217;t necessarily needs to be.
For example Keycloak user <code>john</code> can be linked to the Facebook user <code>john123@gmail.com</code>, so in that case value of user session note will be <code>john123@gmail.com</code> .</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can use a <a href="#_protocol-mappers">Protocol Mapper</a> of type <code>User Session Note</code> to propagate this information to your clients.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_broker_first_login"><a class="anchor" href="#_identity_broker_first_login"></a>12.10. First Login Flow</h3>
<div class="paragraph">
<p>When a user logs in through identity brokering some aspects of the user are imported and linked within the realm&#8217;s local database.
When Keycloak successfully authenticates users through an external identity provider
there can be two situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is already a Keycloak user account imported and linked with the authenticated identity provider account.
In this case, Keycloak will just authenticate as the existing user and redirect back to application.</p>
</li>
<li>
<p>There is not yet an existing Keycloak user account imported and linked for this external user.
Usually you just want to register and import the new account into Keycloak database, but what if there is an existing
Keycloak account with the same email? Automatically linking the existing local account to the external
identity provider is a potential security hole as you can&#8217;t always trust the information you get from the external identity provider.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Different organizations have different requirements when dealing with some of the conflicts and situations listed above.
For this, there is a <code>First Login Flow</code> option in the IDP settings which allows you to choose a <a href="#_authentication-flows">workflow</a> that will be
used after a user logs in from an external IDP the first time.
By default it points to <code>first broker login</code> flow, but you can configure and use your own flow and use different flows for different identity providers.</p>
</div>
<div class="paragraph">
<p>The flow itself is configured in admin console under <code>Authentication</code> tab.
When you choose <code>First Broker Login</code> flow, you will see what authenticators are used by default.
You can re-configure the existing flow. (For example you can disable some authenticators, mark some of them as <code>required</code>, configure some authenticators, etc).</p>
</div>
<div class="paragraph">
<p>You can also create a new authentication flow and/or write your own Authenticator implementations and use it in your flow.
See <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more details.</p>
</div>
<div class="sect3">
<h4 id="default-first-login-flow"><a class="anchor" href="#default-first-login-flow"></a>12.10.1. Default First Login Flow</h4>
<div class="paragraph">
<p>Let&#8217;s describe the default behaviour provided by <code>First Broker Login</code> flow.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Review Profile</dt>
<dd>
<p>This authenticator might display the profile info page, where the user can review his profile retrieved from an identity provider.
The authenticator is configurable.
You can set the <code>Update Profile On First Login</code> option.
When <code>On</code>, users will be always presented with the profile page asking for additional information in order to federate their identities.
When <code>missing</code>, users will be presented with the profile page only if some mandatory information (email, first name, last name) is not provided by the identity provider.
If <code>Off</code>, the profile page won&#8217;t be displayed, unless user clicks in later phase on <code>Review profile info</code> link (page displayed in later phase
by <code>Confirm Link Existing Account</code> authenticator)</p>
</dd>
<dt class="hdlist1">Create User If Unique</dt>
<dd>
<p>This authenticator checks if there is already an existing Keycloak account with same email or username like the account from the identity provider.
If it&#8217;s not, then the authenticator just creates a new local Keycloak account and links it with the identity provider and the whole flow is finished.
Otherwise it goes to the next <code>Handle Existing Account</code> subflow.
If you always want to ensure that there is no duplicated account, you can mark this authenticator as <code>REQUIRED</code> . In this case, the user
will see the error page if there is existing Keycloak account and the user will need to link his identity provider account through Account management.</p>
</dd>
<dt class="hdlist1">Confirm Link Existing Account</dt>
<dd>
<p>On the info page, the user will see that there is an existing Keycloak account with same email.
He can review his profile again and use different email or username (flow is restarted and goes back to <code>Review Profile</code> authenticator).
Or he can confirm that he wants to link the identity provider account with his existing Keycloak account.
Disable this authenticator if you don&#8217;t want users to see this confirmation page, but go straight to linking identity provider account by email verification or re-authentication.</p>
</dd>
<dt class="hdlist1">Verify Existing Account By Email</dt>
<dd>
<p>This authenticator is <code>ALTERNATIVE</code> by default, so it&#8217;s used only if the realm has SMTP setup configured.
It will send mail to the user, where he can confirm that he wants to link the identity provider with his Keycloak account.
Disable this if you don&#8217;t want to confirm linking by email, but instead you always want users to reauthenticate with their password (and alternatively OTP).</p>
</dd>
<dt class="hdlist1">Verify Existing Account By Re-authentication</dt>
<dd>
<p>This authenticator is used if email authenticator is disabled or non-available (SMTP not configured for realm). It will display a login screen
where the user needs to authenticate with his password to link his Keycloak account with the Identity provider.
User can also re-authenticate with some different identity provider, which is already linked to his Keycloak account.
You can also force users to use OTP. Otherwise it&#8217;s optional and used only if OTP is already set for the user account.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="retrieving-external-idp-tokens"><a class="anchor" href="#retrieving-external-idp-tokens"></a>12.11. Retrieving External IDP Tokens</h3>
<div class="paragraph">
<p>Keycloak allows you to store tokens and responses from the authentication process with the external IDP.
For that, you can use the <code>Store Token</code> configuration option on the IDP&#8217;s settings page.</p>
</div>
<div class="paragraph">
<p>Application code can retrieve these tokens and responses to pull in extra user information, or to securely invoke requests on the external IDP.
For example, an application might want to use the Google token to invoke on other Google services and REST APIs.
To retrieve a token for a particular identity provider you need to send a request as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">GET /auth/realms/{realm}/broker/{provider_alias}/token HTTP/<span class="float">1.1</span>
Host: localhost:<span class="integer">8080</span>
Authorization: Bearer &lt;KEYCLOAK ACCESS TOKEN&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>An application must have authenticated with Keycloak and have received an access token.  This access token
will need to have the <code>broker</code> client-level role <code>read-token</code> set.  This means that the user must have a role mapping for this role
and the client application must have that role within its scope.
In this case, given that you are accessing a protected service in Keycloak, you need to send the access token issued by Keycloak during the user authentication.
In the broker configuration page you can automatically assign this role to newly imported users by turning on the <code>Stored Tokens Readable</code> switch.</p>
</div>
<div class="paragraph">
<p>These external tokens can be re-established by either logging in again through the provider, or using the client initiated account linking API.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-session-management"><a class="anchor" href="#user-session-management"></a>13. User Session Management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a user logs into a realm, Keycloak maintains a user session for them and remembers each and every client they
have visited within the session.  There are a lot of administrative
functions that realm admins can perform on these user sessions.  They can view login stats for the entire realm and dive down
into each client to see who is logged in and where.  Admins can logout a user or set of users from the Admin Console. They
can revoke tokens and set up all the token and session timeouts there too.</p>
</div>
<div class="sect2">
<h3 id="administering-sessions"><a class="anchor" href="#administering-sessions"></a>13.1. Administering Sessions</h3>
<div class="paragraph">
<p>If you go to the <code>Sessions</code> left menu item you can see a top level view of the number of sessions that are currently active in the realm.</p>
</div>
<div class="paragraph">
<div class="title">Sessions</div>
<p><span class="image"><img src="./keycloak-images/sessions.png" alt="sessions"></span></p>
</div>
<div class="paragraph">
<p>A list of clients is given and how many active sessions there currently are for that client. You can also logout all
users in the realm by clicking the <code>Logout all</code> button on the right side of this list.</p>
</div>
<div class="sect3">
<h4 id="logout-all-limitations"><a class="anchor" href="#logout-all-limitations"></a>13.1.1. Logout All Limitations</h4>
<div class="paragraph">
<p>Any SSO cookies set will now be invalid and clients that request authentication in active browser sessions will now have to
re-login.  Only certain clients are notified of this logout event, specifically clients that are using the Keycloak
OIDC client adapter. Other client types (i.e. SAML) will not receive a backchannel logout request.</p>
</div>
<div class="paragraph">
<p>It is important to note that any outstanding access tokens are not revoked by clicking <code>Logout all</code>.  They have to
expire naturally.  You have to push a <a href="#_revocation-policy">revocation policy</a> out to
clients, but that also only works with clients using the Keycloak OIDC client adapter.</p>
</div>
</div>
<div class="sect3">
<h4 id="application-drilldown"><a class="anchor" href="#application-drilldown"></a>13.1.2. Application Drilldown</h4>
<div class="paragraph">
<p>On the <code>Sessions</code> page, you can also drill down to each client. This will bring you to the <code>Sessions</code> tab of that client.
Clicking on the <code>Show Sessions</code> button there allows you to see which users are logged into that application.</p>
</div>
<div class="paragraph">
<div class="title">Application Sessions</div>
<p><span class="image"><img src="./keycloak-images/application-sessions.png" alt="application sessions"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="user-drilldown"><a class="anchor" href="#user-drilldown"></a>13.1.3. User Drilldown</h4>
<div class="paragraph">
<p>If you go to the <code>Sessions</code> tab of an individual user, you can also view the session information.</p>
</div>
<div class="paragraph">
<div class="title">User Sessions</div>
<p><span class="image"><img src="./keycloak-images/user-sessions.png" alt="user sessions"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revocation-policy"><a class="anchor" href="#_revocation-policy"></a>13.2. Revocation Policies</h3>
<div class="paragraph">
<p>If your system is compromised you will want a way to revoke all sessions and access tokens that have been handed out.
You can do this by going to the <code>Revocation</code> tab of the <code>Sessions</code> screen.</p>
</div>
<div class="paragraph">
<div class="title">Revocation</div>
<p><span class="image"><img src="./keycloak-images/revocation.png" alt="revocation"></span></p>
</div>
<div class="paragraph">
<p>You can only set a time-based revocation policy.  The console allows you to specify a time and date where any session
or token issued before that time and date is invalid.  The <code>Set to now</code> will set the policy to the current time and date.
The <code>Push</code> button will push this revocation policy to any registered OIDC client that has the Keycloak
OIDC client adapter installed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_timeouts"><a class="anchor" href="#_timeouts"></a>13.3. Session and Token Timeouts</h3>
<div class="paragraph">
<p>Keycloak gives you fine grain control of session, cookie, and token timeouts.  This is all done on the
<code>Tokens</code> tab in the <code>Realm Settings</code> left menu item.</p>
</div>
<div class="paragraph">
<div class="title">Tokens Tab</div>
<p><span class="image"><img src="./keycloak-images/tokens-tab.png" alt="tokens tab"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s walk through each of the items on this page.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Configuration</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Revoke Refresh Token</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For OIDC clients that are doing the refresh token flow, this flag, if on, will revoke that refresh token and issue another with the request that the client has to use.
 This basically means that refresh tokens have a one time use.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO Session Idle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Also pertains to OIDC clients.  If the user is not active for longer than this timeout, the user session will be invalidated.  How is idle time checked?
 A client requesting authentication will bump the idle timeout.  Refresh token requests will also bump the idle timeout.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSO Session Max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time before a user session is expired and invalidated.  This is a hard number and time.  It controls the maximum time
 a user session can remain active, regardless of activity.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offline Session Idle</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For <a href="#_offline-access">offline access</a>, this is the time the session is allowed to remain idle before the offline token is revoked.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Token Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When an OIDC access token is created, this value affects the expiration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Token Lifespan For Implicit Flow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">With the Implicit Flow no refresh token is provided. For this reason there&#8217;s a separate timeout for access tokens created with the Implicit Flow.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client login timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the maximum time that a client has to finish the Authorization Code Flow in OIDC.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Total time a login must take.  If authentication takes longer than this time then the user will have to start the authentication process over.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Login action timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time a user can spend on any one page in the authentication process.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User-Initiated Action Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time before an action permit sent by a user (e.g. forgot password e-mail) is expired. This value is recommended to be short because it is expected that the user would react to self-created action quickly.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default Admin-Initiated Action Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time before an action permit sent to a user by an admin is expired. This value is recommended to be long to allow admins send e-mails for users that are currently offline. The default timeout can be overridden right before issuing the token.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Override User-Initiated Action Lifespan</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permits the possibility of having independent timeouts per operation (e.g. e-mail verification, forgot password, user actions and Identity Provider E-mail Verification). This field is non mandatory and if nothing is specified it defaults to the value configured at <em>User-Initiated Action Lifespan</em>.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_offline-access"><a class="anchor" href="#_offline-access"></a>13.4. Offline Access</h3>
<div class="paragraph">
<p>Offline access is a feature described in <a href="http://openid.net/specs/openid-connect-core-1_0.html#OfflineAccess">OpenID Connect specification</a> .
The idea is that during login, your client application will request an Offline token instead of a classic Refresh token.
The application can save this offline token in a database or on disk and can use it later even if user is logged out.
This is useful if your application needs to do some "offline" actions on behalf of user even when the user is not online.
An example is a periodic backup of some data every night.</p>
</div>
<div class="paragraph">
<p>Your application is responsible for persisting the offline token in some storage (usually a database) and then using it to manually retrieve new access token from Keycloak server.</p>
</div>
<div class="paragraph">
<p>The difference between a classic Refresh token and an Offline token is, that an offline token will never expire and is not subject of <code>SSO Session Idle timeout</code> .
The offline token is valid even after a user logout or server restart.
However by default you do need to use the offline token for a refresh token action at least once per 30 days (this value, <code>Offline Session Idle timeout</code>, can be changed in the administration console in the <code>Tokens</code> tab under <code>Realm Settings</code>). Also if you enable the option <code>Revoke refresh tokens</code>, then each offline token can be used just once.
So after refresh, you always need to store the new offline token from refresh response into your DB instead of the previous one.</p>
</div>
<div class="paragraph">
<p>Users can view and revoke offline tokens that have been granted by them in the <a href="#_account-service">User Account Service</a>.
The admin user can revoke offline tokens for individual users in admin console in the <code>Consents</code> tab of a particular user.
The admin can also view all the offline tokens issued in the <code>Offline Access</code> tab of each client.
Offline tokens can also be revoked by setting a <a href="#_revocation-policy">revocation policy</a>.</p>
</div>
<div class="paragraph">
<p>To be able to issue an offline token, users need to have the role mapping for the realm-level role <code>offline_access</code>.
Clients also need to have that role in their scope.</p>
</div>
<div class="paragraph">
<p>The client can request an offline token by adding the parameter <code>scope=offline_access</code> when sending authorization request to Keycloak.
The Keycloak OIDC client adapter automatically adds this parameter when you use it to access secured URL of your application (i.e.
http://localhost:8080/customer-portal/secured?scope=offline_access). The Direct Access Grant and Service Accounts also
support offline tokens if you include <code>scope=offline_access</code> in the body of the authentication request.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user-storage-federation"><a class="anchor" href="#_user-storage-federation"></a>14. User Storage Federation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many companies have existing user databases that hold information about users and their passwords or other credentials.
In may cases, it is just not possible to migrate off of those existing stores to a pure Keycloak deployment.
Keycloak can federate existing external user databases.
Out of the box we have support for LDAP and Active Directory.  You can also code your own extension for any custom
user databases you might have using our User Storage SPI.</p>
</div>
<div class="paragraph">
<p>The way it works is that when a user logs in, Keycloak will look into its own internal user store to find the user.
If it can&#8217;t find it there it will iterate
over every User Storage provider you have configured for the realm until it finds a match.  Data from the external store is mapped into a common user model that is consumed by the Keycloak
runtime.  This common user model can then be mapped to OIDC token claims and SAML assertion attributes.</p>
</div>
<div class="paragraph">
<p>External user databases rarely have every piece of data need to support all the features that Keycloak has.
In this case, the User Storage Provider can opt to store some things locally in the Keycloak user store.
Some providers even import the user locally and sync periodically with the external store.  All this depends on the capabilities of the provider and how its configured.  For example, your
external user store may not support OTP.  Depending on the provider, this OTP support can be handled and stored by Keycloak</p>
</div>
<div class="sect2">
<h3 id="adding-a-provider"><a class="anchor" href="#adding-a-provider"></a>14.1. Adding a Provider</h3>
<div class="paragraph">
<p>To add a storage provider go to the <code>User Federation</code> left menu item in the Admin Console.</p>
</div>
<div class="paragraph">
<div class="title">User Federation</div>
<p><span class="image"><img src="./keycloak-images/user-federation.png" alt="user federation"></span></p>
</div>
<div class="paragraph">
<p>On the right side, there is an <code>Add Provider</code> list box.  Choose the provider type you want to add and you will be brought to the configuration page of that provider.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ldap"><a class="anchor" href="#_ldap"></a>14.2. LDAP and Active Directory</h3>
<div class="paragraph">
<p>Keycloak comes with a built-in LDAP/AD provider.  It is possible to federate multiple different LDAP servers in the same
Keycloak realm.  You can map LDAP user attributes into the Keycloak common user model.
By default, it maps username, email, first name, and last name, but you are free to configure additional <a href="#_ldap_mappers">mappings</a>.
The LDAP provider also supports password validation via LDAP/AD protocols and different storage, edit, and synchronization modes.</p>
</div>
<div class="paragraph">
<p>To configure a federated LDAP store go to the Admin Console.
Click on the <code>User Federation</code> left menu option.
When you get to this page there is an <code>Add Provider</code> select box.
You should see <em>ldap</em> within this list.
Selecting <em>ldap</em> will bring you to the ldap configuration page.</p>
</div>
<div class="sect3">
<h4 id="storage-mode"><a class="anchor" href="#storage-mode"></a>14.2.1. Storage Mode</h4>
<div class="paragraph">
<p>By default, Keycloak will import users from LDAP into the local Keycloak user database. This copy of the user
is either synchronized on demand, or through a periodic background task.
The one exception to this is passwords.  Passwords are not imported and password validation is
delegated to the LDAP server.  The benefits to this approach is that all Keycloak features will work as any extra
per-user data that is needed can be stored locally.  This approach also reduces load on the LDAP server as uncached users are loaded
from the Keycloak database the 2nd time they are accessed.  The only load your LDAP server will have is password validation.
The downside to this approach is that when a user is first queried, this will require a Keycloak database insert.  The import will
also have to be synchronized with your LDAP server as needed.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can choose not to import users into the Keycloak user database.  In this case, the common user model
that the  Keycloak runtime uses is backed only by the LDAP server.  This means that if LDAP doesn&#8217;t support
a piece of data that a Keycloak feature needs that feature will not work.
The benefit to this approach is that you do not have the overhead of importing and synchronizing a copy of the LDAP user into the
Keycloak user database.</p>
</div>
<div class="paragraph">
<p>This storage mode is controled by the <code>Import Enabled</code> switch.  Set to <code>On</code> to import users.</p>
</div>
</div>
<div class="sect3">
<h4 id="edit-mode"><a class="anchor" href="#edit-mode"></a>14.2.2. Edit Mode</h4>
<div class="paragraph">
<p>Users, through the <a href="#_account-service">User Account Service</a>, and admins through the Admin Console
have the ability to modify user metadata.  Depending on your setup you may or may not have LDAP update privileges.  The
<code>Edit Mode</code> configuration option defines the edit policy you have with your LDAP store.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">READONLY</dt>
<dd>
<p>Username, email, first name, last name, and other mapped attributes will be unchangeable.
Keycloak will show an error anytime anybody tries to update these fields.
Also, password updates will not be supported.</p>
</dd>
<dt class="hdlist1">WRITABLE</dt>
<dd>
<p>Username, email, first name, last name, and other mapped attributes and passwords can all be updated and will be synchronized automatically with your LDAP store.</p>
</dd>
<dt class="hdlist1">UNSYNCED</dt>
<dd>
<p>Any changes to username, email, first name, last name, and passwords will be stored in Keycloak local storage.
It is up to you to figure out how to synchronize back to LDAP. This allows Keycloak deployments to support
updates of user metadata on a read-only LDAP server.  This option only applies when you are importing users from LDAP into the local Keycloak user database.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="other-config-options"><a class="anchor" href="#other-config-options"></a>14.2.3. Other config options</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Console Display Name</dt>
<dd>
<p>Name used when this provider is referenced in the admin console</p>
</dd>
<dt class="hdlist1">Priority</dt>
<dd>
<p>The priority of this provider when looking up users or for adding registrations.</p>
</dd>
<dt class="hdlist1">Sync Registrations</dt>
<dd>
<p>Does your LDAP support adding new users?  Click this switch if you want new users created by Keycloak in the admin console or the registration page
to be added to LDAP.</p>
</dd>
<dt class="hdlist1">Allow Kerberos authentication</dt>
<dd>
<p>Enable Kerberos/SPNEGO authentication in realm with users data provisioned from LDAP.
More info in <a href="#_kerberos">Kerberos section</a>.</p>
</dd>
<dt class="hdlist1">Other options</dt>
<dd>
<p>The rest of the configuration options should be self explanatory.
You can mouseover the tooltips in Admin Console to see some more details about them.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="connect-to-ldap-over-ssl"><a class="anchor" href="#connect-to-ldap-over-ssl"></a>14.2.4. Connect to LDAP over SSL</h4>
<div class="paragraph">
<p>When you configure a secured connection URL to your LDAP store(for example <code>ldaps://myhost.com:636</code> ),
Keycloak will use SSL for the communication with LDAP server.
The important thing is to properly configure a truststore on the Keycloak server side, otherwise Keycloak can&#8217;t trust the SSL connection to LDAP.</p>
</div>
<div class="paragraph">
<p>The global truststore for the Keycloak can be configured with the Truststore SPI.  Please check out the <a href="http://www.keycloak.org/docs/3.4/server_installation/">Server Installation and Configuration Guide</a> for more detail.
If you don&#8217;t configure the truststore SPI, the truststore will fallback to the default mechanism provided by Java (either the file provided by system property <code>javax.net.ssl.trustStore</code>
or the cacerts file from the JDK if the system property is not set).</p>
</div>
<div class="paragraph">
<p>There is a configuration property <code>Use Truststore SPI</code> in the LDAP federation provider configuration, where you can choose whether the Truststore SPI is used.
By default, the value is <code>Only for ldaps</code>, which is fine for most deployments.  The Truststore SPI will only be used
if the connection to LDAP starts with <code>ldaps</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="sync-of-ldap-users-to-keycloak"><a class="anchor" href="#sync-of-ldap-users-to-keycloak"></a>14.2.5. Sync of LDAP users to Keycloak</h4>
<div class="paragraph">
<p>If you have import enabled, the LDAP Provider will automatically take care of synchronization (import) of needed LDAP users into the Keycloak local database.
As users log in, the LDAP provider will import the LDAP user
into the Keycloak database and then authenticate against the LDAP password. This is the only time users will be imported.
If you go to the <code>Users</code> left menu item in the Admin Console and click the <code>View all users</code> button, you will only see those LDAP users that
have been authenticated at least once by Keycloak.  It is implemented this way so that admins don&#8217;t accidentally try to import a huge LDAP DB of users.</p>
</div>
<div class="paragraph">
<p>If you want to sync all LDAP users into the Keycloak database, you may configure and enable the <code>Sync Settings</code> of the LDAP provider you configured.
There are 2 types of synchronization:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Periodic Full sync</dt>
<dd>
<p>This will synchronize all LDAP users into Keycloak DB.
Those LDAP users, which already exist in Keycloak and were changed in LDAP directly will be updated in Keycloak DB
(For example if user <code>Mary Kelly</code> was changed in LDAP to <code>Mary Smith</code>).</p>
</dd>
<dt class="hdlist1">Periodic Changed users sync</dt>
<dd>
<p>When syncing occurs, only those users that were created or updated after the last sync will be updated and/or imported.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The best way to handle syncing is to click the <code>Synchronize all users</code> button when you first create the LDAP provider,
then set up a periodic sync of changed users.  The configuration page for your LDAP Provider has several options to support you.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ldap_mappers"><a class="anchor" href="#_ldap_mappers"></a>14.2.6. LDAP Mappers</h4>
<div class="paragraph">
<p>LDAP mappers are <code>listeners</code>, which are triggered by the LDAP Provider at various points, provide another extension point to LDAP integration.
They are triggered when a user logs in via LDAP and needs to be imported, during Keycloak initiated registration, or when a user is queried from the Admin Console.
When you create an LDAP Federation provider, Keycloak will automatically provide set of built-in <code>mappers</code> for this provider.
You are free to change this set and create a new mapper or update/delete existing ones.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">User Attribute Mapper</dt>
<dd>
<p>This allows you to specify which LDAP attribute is mapped to which attribute of Keycloak user.
So, for example, you can configure that LDAP attribute <code>mail</code> to the attribute <code>email</code> in the Keycloak database.
For this mapper implementation, there is always a one-to-one mapping (one LDAP attribute is mapped to one Keycloak attribute)</p>
</dd>
<dt class="hdlist1">FullName Mapper</dt>
<dd>
<p>This allows you to specify that the full name of the user, which is saved in some LDAP attribute (usually <code>cn</code> ) will be mapped to <code>firstName</code> and <code>lastname</code> attributes in the Keycloak database.
Having <code>cn</code> to contain full name of user is a common case for some LDAP deployments.</p>
</dd>
<dt class="hdlist1">Role Mapper</dt>
<dd>
<p>This allows you to configure role mappings from LDAP into Keycloak role mappings.
One Role mapper can be used to map LDAP roles (usually groups from a particular branch of LDAP tree) into roles corresponding to either realm roles or client roles of a specified client.
It&#8217;s not a problem to configure more Role mappers for the same LDAP provider.
So for example you can specify that role mappings from groups under
<code>ou=main,dc=example,dc=org</code> will be mapped to realm role mappings and role mappings from groups under
<code>ou=finance,dc=example,dc=org</code> will be mapped to client role mappings of client <code>finance</code> .</p>
</dd>
<dt class="hdlist1">Hardcoded Role Mapper</dt>
<dd>
<p>This mapper will grant a specified Keycloak role to each Keycloak user linked with LDAP.</p>
</dd>
<dt class="hdlist1">Group Mapper</dt>
<dd>
<p>This allows you to configure group mappings from LDAP into Keycloak group mappings.
Group mapper can be used to map LDAP groups from a particular branch of an LDAP tree into groups in Keycloak.
It will also propagate user-group mappings from LDAP into user-group mappings in Keycloak.</p>
</dd>
<dt class="hdlist1">MSAD User Account Mapper</dt>
<dd>
<p>This mapper is specific to Microsoft Active Directory (MSAD). It&#8217;s able to tightly integrate the MSAD user account state
into the Keycloak account state (account enabled, password is expired etc).
It&#8217;s using the <code>userAccountControl</code> and <code>pwdLastSet</code> LDAP attributes.  (both are specific to MSAD and are not LDAP standard).
For example if <code>pwdLastSet</code> is <code>0</code>, the Keycloak user is required to update their password
and there will be an UPDATE_PASSWORD required action added to the user. If <code>userAccountControl</code> is
<code>514</code> (disabled account) the Keycloak user is disabled as well.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>By default, there are User Attribute mappers that map basic Keycloak user attributes like username, firstname, lastname, and email to corresponding LDAP attributes.
You are free to extend these and provide additional attribute mappings.
Admin console provides tooltips, which should help with configuring the corresponding mappers.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sssd"><a class="anchor" href="#_sssd"></a>14.3. SSSD and FreeIPA Identity Management Integration</h3>
<div class="paragraph">
<p>Keycloak also comes with a built-in <a href="https://fedoraproject.org/wiki/Features/SSSD">SSSD</a> (System Security Services Daemon) plugin. SSSD is part of the latest Fedora or Red Hat Enterprise Linux and provides access to multiple identity and authentication providers. It provides benefits such as failover and offline support. To see configuration options and for more information see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system-level_authentication_guide/sssd">the Red Hat Enterprise Linux Identity Management documentation</a>.</p>
</div>
<div class="paragraph">
<p>SSSD also integrates with the FreeIPA identity management (IdM) server, providing authentication and access control. For Keycloak, we benefit from this integration authenticating against <a href="http://tldp.org/HOWTO/User-Authentication-HOWTO/x115.html">PAM</a> services and retrieving user data from SSSD. For more information about using Red Hat Identity Management in Linux environments, see <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/linux_domain_identity_authentication_and_policy_guide/index">the Red Hat Enterprise Linux Identity Management documentation</a>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/keycloak-sssd-freeipa-integration-overview.png" alt="keycloak sssd freeipa integration overview"></span></p>
</div>
<div class="paragraph">
<p>Most of the communication between Keycloak and SSSD occurs through read-only D-Bus interfaces. For this reason, the only way to provision and update users is to use the FreeIPA/IdM administration interface. By default, like the LDAP federation provider, it is set up only to import username, email, first name, and last name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Groups and roles are automatically registered, but not synchronized, so any changes made by the Keycloak administrator directly in Keycloak is not synchronized with SSSD.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Information on how to configure the FreeIPA/IdM server follows.</p>
</div>
<div class="sect3">
<h4 id="freeipa-idm-server"><a class="anchor" href="#freeipa-idm-server"></a>14.3.1. FreeIPA/IdM Server</h4>
<div class="paragraph">
<p>As a matter of simplicity, a <a href="https://hub.docker.com/r/freeipa/freeipa-server/">FreeIPA Docker image</a> already available is used. To set up a server, see the <a href="https://www.freeipa.org/page/Quick_Start_Guide">FreeIPA documentation</a>.</p>
</div>
<div class="paragraph">
<p>Running a FreeIPA server with Docker requires this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>docker run --name freeipa-server-container -it \
-h server.freeipa.local -e PASSWORD=YOUR_PASSWORD \
-v /sys/fs/cgroup:/sys/fs/cgroup:ro \
-v /var/lib/ipa-data:/data:Z adelton/freeipa-server</pre>
</div>
</div>
<div class="paragraph">
<p>The parameter <code>-h</code> with <code>server.freeipa.local</code> represents the FreeIPA/IdM server hostname. Be sure to change <code>YOUR_PASSWORD</code> to a password of your choosing.</p>
</div>
<div class="paragraph">
<p>After the container starts, change <code>/etc/hosts</code> to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>x.x.x.x     server.freeipa.local</pre>
</div>
</div>
<div class="paragraph">
<p>If you do not make this change, you must set up a DNS server.</p>
</div>
<div class="paragraph">
<p>So that the SSSD federation provider is started and running on Keycloak you must enroll your Linux machine in the IPA domain:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ipa-client-install --mkhomedir -p admin -w password</pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that everything is working as expected, on the client machine, run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>kinit admin</pre>
</div>
</div>
<div class="paragraph">
<p>You should be prompted for the password. After that, you can add users to the IPA server using this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ ipa user-add john --first=John --last=Smith --email=john@smith.com --phone=042424242 --street="Testing street" \      --city="Testing city" --state="Testing State" --postalcode=0000000000</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sssd-and-d-bus"><a class="anchor" href="#sssd-and-d-bus"></a>14.3.2. SSSD and D-Bus</h4>
<div class="paragraph">
<p>As mentioned previously, the federation provider obtains the data from SSSD using D-BUS and authentication occurs using <a href="http://tldp.org/HOWTO/User-Authentication-HOWTO/x115.html">PAM</a>.</p>
</div>
<div class="paragraph">
<p>First, you have to install the sssd-dbus RPM, which allows information from SSSD to be transmitted over the system bus.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo yum install sssd-dbus</pre>
</div>
</div>
<div class="paragraph">
<p>You must run the provisioning script available from the Keycloak distribution:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/federation-sssd-setup.sh</pre>
</div>
</div>
<div class="paragraph">
<p>This script makes the necessary changes to <code>/etc/sssd/sssd.conf</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[domain/your-hostname.local]
...
ldap_user_extra_attrs = mail:mail, sn:sn, givenname:givenname, telephoneNumber:telephoneNumber
...
[sssd]
services = nss, sudo, pam, ssh, ifp
...
[ifp]
allowed_uids = root, yourOSUsername
user_attributes = +mail, +telephoneNumber, +givenname, +sn</pre>
</div>
</div>
<div class="paragraph">
<p>Also, a <code>keycloak</code> file is included under <code>/etc/pam.d/</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>auth    required   pam_sss.so
account required   pam_sss.so</pre>
</div>
</div>
<div class="paragraph">
<p>Ensure everything is working as expected by running <code>dbus-send</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo dbus-send --print-reply --system --dest=org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe org.freedesktop.sssd.infopipe.GetUserGroups string:john</pre>
</div>
</div>
<div class="paragraph">
<p>You should be able to see the user&#8217;s group. If this command returns a timeout or an error, it means that the federation provider will also not be able to retrieve anything on Keycloak.</p>
</div>
<div class="paragraph">
<p>Most of the time this occurs because the machine was not enrolled in the FreeIPA IdM server or you do not have permission to access the SSSD service.</p>
</div>
<div class="paragraph">
<p>If you do not have permission, ensure that the user running Keycloak is included in the <code>/etc/sssd/sssd.conf</code> file in the following section:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ifp]
allowed_uids = root, your_username</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enabling-the-sssd-federation-provider"><a class="anchor" href="#enabling-the-sssd-federation-provider"></a>14.3.3. Enabling the SSSD Federation Provider</h4>
<div class="paragraph">
<p>Keycloak uses DBus-Java to communicate at a low level with D-Bus, which depends on the <a href="http://www.matthew.ath.cx/projects/java/">Unix Sockets Library</a>.</p>
</div>
<div class="paragraph">
<p>An RPM for this library can be found in <a href="https://github.com/keycloak/libunix-dbus-java/releases">this repository</a>. Before installing it, be sure to check the RPM signature:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ rpm -K libunix-dbus-java-0.8.0-1.fc24.x86_64.rpm
libunix-dbus-java-0.8.0-1.fc24.x86_64.rpm:
  Header V4 RSA/SHA256 Signature, key ID 84dc9914: OK
  Header SHA1 digest: OK (d17bb7ebaa7a5304c1856ee4357c8ba4ec9c0b89)
  V4 RSA/SHA256 Signature, key ID 84dc9914: OK
  MD5 digest: OK (770c2e68d052cb4a4473e1e9fd8818cf)
$ sudo yum install libunix-dbus-java-0.8.0-1.fc24.x86_64.rpm</pre>
</div>
</div>
<div class="paragraph">
<p>For authentication with PAM Keycloak uses JNA. Be sure you have this package installed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo yum install jna</pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>sssctl user-checks</code> command to validate your setup:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ sudo sssctl user-checks admin -s keycloak</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-a-federated-sssd-store"><a class="anchor" href="#configuring-a-federated-sssd-store"></a>14.4. Configuring a Federated SSSD Store</h3>
<div class="paragraph">
<p>After installation, you need to configure a federated SSSD store.</p>
</div>
<div class="paragraph">
<p>To configure a federated SSSD store, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Navigate to the Administration Console.</p>
</li>
<li>
<p>From the left menu, select <strong>User Federation.</strong></p>
</li>
<li>
<p>From the <strong>Add Provider</strong> dropdown list, select <strong>sssd.</strong> The sssd configuration page opens.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you can authenticate against Keycloak using FreeIPA/IdM credentials.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom-providers"><a class="anchor" href="#custom-providers"></a>14.5. Custom Providers</h3>
<div class="paragraph">
<p>Keycloak does have an SPI for User Storage Federation that you can use to write your own custom providers.
You can find documentation for this in our <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auditing-and-events"><a class="anchor" href="#auditing-and-events"></a>15. Auditing and Events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak provides a rich set of auditing capabilities.  Every single login action can be recorded and stored in
the database and reviewed in the Admin Console.  All admin actions can also be recorded and reviewed.  There is also a Listener SPI
with which plugins can listen for these events and perform some action.  Built-in listeners include a simple log file and the ability
to send an email if an event occurs.</p>
</div>
<div class="sect2">
<h3 id="login-events"><a class="anchor" href="#login-events"></a>15.1. Login Events</h3>
<div class="paragraph">
<p>Login events occur for things like when a user logs in successfully, when somebody enters in a bad password, or when a user account
is updated.  Every single event that happens to a user can be recorded and viewed.  By default, no events are stored
or viewed in the Admin Console.  Only error events are logged to the console and the server&#8217;s log file.  To start
persisting  you&#8217;ll need to enable storage.  Go to the <code>Events</code> left menu item and select the <code>Config</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Event Configuration</div>
<p><span class="image"><img src="./keycloak-images/login-events-config.png" alt="login events config"></span></p>
</div>
<div class="paragraph">
<p>To start storing events you&#8217;ll need to turn the <code>Save Events</code> switch to on under the <code>Login Events Settings</code>.</p>
</div>
<div class="paragraph">
<div class="title">Save Events</div>
<p><span class="image"><img src="./keycloak-images/login-events-settings.png" alt="login events settings"></span></p>
</div>
<div class="paragraph">
<p>The <code>Saved Types</code> field allows you to specify which event types you want to store in the event store.  The <code>Clear events</code>
button allows you to delete all the events in the database. The <code>Expiration</code> field allows you to specify how long you want
to keep events stored.  Once you&#8217;ve enabled storage of login events and decided on your settings, don&#8217;t forget to click
the <code>Save</code> button on the bottom of this page.</p>
</div>
<div class="paragraph">
<p>To view events, go to the <code>Login Events</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Login Events</div>
<p><span class="image"><img src="./keycloak-images/login-events.png" alt="login events"></span></p>
</div>
<div class="paragraph">
<p>As you can see, there&#8217;s a lot of information stored and, if you are storing every event, there are a lot of events stored for
each login action.  The <code>Filter</code> button on this page allows you to filter which events you are actually interested in.</p>
</div>
<div class="paragraph">
<div class="title">Login Event Filter</div>
<p><span class="image"><img src="./keycloak-images/login-events-filter.png" alt="login events filter"></span></p>
</div>
<div class="paragraph">
<p>In this screenshot, we&#8217;re filtering only <code>Login</code> events.  Clicking the <code>Update</code> button runs the filter.</p>
</div>
<div class="sect3">
<h4 id="event-types"><a class="anchor" href="#event-types"></a>15.1.1. Event Types</h4>
<div class="paragraph">
<p>Login events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login - A user has logged in.</p>
</li>
<li>
<p>Register - A user has registered.</p>
</li>
<li>
<p>Logout - A user has logged out.</p>
</li>
<li>
<p>Code to Token - An application/client has exchanged a code for a token.</p>
</li>
<li>
<p>Refresh Token - An application/client has refreshed a token.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Account events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Social Link - An account has been linked to a social provider.</p>
</li>
<li>
<p>Remove Social Link - A social provider has been removed from an account.</p>
</li>
<li>
<p>Update Email - The email address for an account has changed.</p>
</li>
<li>
<p>Update Profile - The profile for an account has changed.</p>
</li>
<li>
<p>Send Password Reset - A password reset email has been sent.</p>
</li>
<li>
<p>Update Password - The password for an account has changed.</p>
</li>
<li>
<p>Update TOTP - The TOTP settings for an account have changed.</p>
</li>
<li>
<p>Remove TOTP - TOTP has been removed from an account.</p>
</li>
<li>
<p>Send Verify Email - An email verification email has been sent.</p>
</li>
<li>
<p>Verify Email - The email address for an account has been verified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For all events there is a corresponding error event.</p>
</div>
</div>
<div class="sect3">
<h4 id="event-listener"><a class="anchor" href="#event-listener"></a>15.1.2. Event Listener</h4>
<div class="paragraph">
<p>Event listeners listen for events and perform an action based on that event.  There are two built-in
listeners that come with Keycloak: Logging Event Listener and Email Event Listener.</p>
</div>
<div class="paragraph">
<p>The Logging Event Listener writes to a log file whenever an error event occurs and is enabled by default.
Here&#8217;s an example log message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>11:36:09,965 WARN  [org.keycloak.events] (default task-51) type=LOGIN_ERROR, realmId=master,
                    clientId=myapp,
                    userId=19aeb848-96fc-44f6-b0a3-59a17570d374, ipAddress=127.0.0.1,
                    error=invalid_user_credentials, auth_method=openid-connect, auth_type=code,
                    redirect_uri=http://localhost:8180/myapp,
                    code_id=b669da14-cdbb-41d0-b055-0810a0334607, username=admin</pre>
</div>
</div>
<div class="paragraph">
<p>This logging is very useful if you want to use a tool like Fail2Ban to detect if there is a hacker bot somewhere that
is trying to guess user passwords.  You can parse the log file for <code>LOGIN_ERROR</code> and pull out the IP Address. Then feed this information
into Fail2Ban so that it can help prevent attacks.</p>
</div>
<div class="paragraph">
<p>The Email Event Listener sends an email to the user&#8217;s account when an event occurs.
The Email Event Listener only supports the following events at the moment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Login Error</p>
</li>
<li>
<p>Update Password</p>
</li>
<li>
<p>Update TOTP</p>
</li>
<li>
<p>Remove TOTP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To enable the Email Listener go to the <code>Config</code> tab and click on the <code>Event Listeners</code> field.  This will show a drop down list box
where you can select email.</p>
</div>
<div class="paragraph">
<p>You can exclude one or more events by editing the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code>
that comes with your distribution and adding for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eventsListener</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;properties&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exclude-events</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="entity">&amp;quot;</span><span class="content">UPDATE_TOTP</span><span class="entity">&amp;quot;</span><span class="content">,</span><span class="entity">&amp;quot;</span><span class="content">REMOVE_TOTP</span><span class="entity">&amp;quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>
  <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="http://www.keycloak.org/docs/3.4/server_installation/">Server Installation and Configuration Guide</a> for more details on
where the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file lives.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="admin-events"><a class="anchor" href="#admin-events"></a>15.2. Admin Events</h3>
<div class="paragraph">
<p>Any action an admin performs within the admin console can be recorded for auditing purposes.
The Admin Console performs administrative functions by invoking on the Keycloak REST interface.  Keycloak
audits these REST invocations.  The resulting events can then be viewed in the Admin Console.</p>
</div>
<div class="paragraph">
<p>To enable auditing of Admin actions, go to the <code>Events</code> left menu item and select the <code>Config</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Event Configuration</div>
<p><span class="image"><img src="./keycloak-images/login-events-config.png" alt="login events config"></span></p>
</div>
<div class="paragraph">
<p>In the <code>Admin Events Settings</code> section, turn on the <code>Save Events</code> switch.</p>
</div>
<div class="paragraph">
<div class="title">Admin Event Configuration</div>
<p><span class="image"><img src="./keycloak-images/admin-events-settings.png" alt="admin events settings"></span></p>
</div>
<div class="paragraph">
<p>The <code>Include Representation</code> switch will include any JSON document that is sent through the admin REST API.  This allows you to view exactly what an admin has done, but can lead to a lot of information stored in the
database.  The <code>Clear admin events</code> button allows you to wipe out the current information stored.</p>
</div>
<div class="paragraph">
<p>To view the admin events go to the <code>Admin Events</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Admin Events</div>
<p><span class="image"><img src="./keycloak-images/admin-events.png" alt="admin events"></span></p>
</div>
<div class="paragraph">
<p>If the <code>Details</code> column has a <code>Representation</code> box, you can click on that to view the JSON that was sent with that operation.</p>
</div>
<div class="paragraph">
<div class="title">Admin Representation</div>
<p><span class="image"><img src="./keycloak-images/admin-events-representation.png" alt="admin events representation"></span></p>
</div>
<div class="paragraph">
<p>You can also filter for the events you are interested in by clicking the <code>Filter</code> button.</p>
</div>
<div class="paragraph">
<div class="title">Admin Event Filter</div>
<p><span class="image"><img src="./keycloak-images/admin-events-filter.png" alt="admin events filter"></span></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_export_import"><a class="anchor" href="#_export_import"></a>16. Export and Import</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak has the ability to export and import the entire database.
This can be especially useful if you want to migrate your whole Keycloak database from one environment to another or migrate to a different database (for example from MySQL to Oracle). Export and import is triggered at server boot time  and its parameters are passed in via Java system properties.
It is important to note that because import and export happens at server startup, no other actions should be taken on the server or the database while this happens.</p>
</div>
<div class="paragraph">
<p>You can export/import your database either to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Directory on local filesystem</p>
</li>
<li>
<p>Single JSON file on your filesystem</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When importing using the directory strategy, note that the files need to follow the naming convention specified below.
If you are importing files which were previously exported, the files already follow this convention.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&lt;REALM_NAME&gt;-realm.json, such as "acme-roadrunner-affairs-realm.json" for the realm named "acme-roadrunner-affairs"</p>
</li>
<li>
<p>&lt;REALM_NAME&gt;-users-&lt;INDEX&gt;.json, such as "acme-roadrunner-affairs-users-0.json" for the first users file of the realm named "acme-roadrunner-affairs"</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you export to a directory, you can also specify the number of users that will be stored in each JSON file.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have bigger amount of users in your database (500 or more), it&#8217;s highly recommended to export into directory rather
      than to single file. Exporting into single file may lead to the very big file. Also the directory provider is using separate transaction for each "page" (file with users),
      which leads to much better performance.
      Default count of users per file (and transaction) is 50, which showed us best performance, but you have possibility to override (See below).
      Exporting to single file is using one transaction per whole export and one per whole import, which results in bad performance with large amount of users.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To export into unencrypted directory you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -Dkeycloak.migration.action=export
-Dkeycloak.migration.provider=dir -Dkeycloak.migration.dir=&lt;DIR TO EXPORT TO&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And similarly for import just use <code>-Dkeycloak.migration.action=import</code> instead of <code>export</code> .
To export into single JSON file you can use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -Dkeycloak.migration.action=export
-Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=&lt;FILE TO EXPORT TO&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of importing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh -Dkeycloak.migration.action=import
-Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=&lt;FILE TO IMPORT&gt;
-Dkeycloak.migration.strategy=OVERWRITE_EXISTING</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other available options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">-Dkeycloak.migration.realmName</dt>
<dd>
<p>This property is used if you want to export just one specified realm instead of all.
If not specified, then all realms will be exported.</p>
</dd>
<dt class="hdlist1">-Dkeycloak.migration.usersExportStrategy</dt>
<dd>
<p>This property is used to specify where users are exported.
Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p>DIFFERENT_FILES - Users will be exported into different files according to the maximum number of users per file. This is default value.</p>
</li>
<li>
<p>SKIP - Exporting of users will be skipped completely.</p>
</li>
<li>
<p>REALM_FILE - All users will be exported to same file with the realm settings. (The result will be a file like "foo-realm.json" with both realm data and users.)</p>
</li>
<li>
<p>SAME_FILE - All users will be exported to same file but different from the realm file. (The result will be a file like "foo-realm.json" with realm data and "foo-users.json" with users.)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">-Dkeycloak.migration.usersPerFile</dt>
<dd>
<p>This property is used to specify the number of users per file (and also per DB transaction). It&#8217;s 50 by default.
It&#8217;s used only if usersExportStrategy is DIFFERENT_FILES</p>
</dd>
<dt class="hdlist1">-Dkeycloak.migration.strategy</dt>
<dd>
<p>This property is used during import.
It can be used to specify how to proceed if a realm with same name already exists in the database where you are going to import data.
Possible values are:</p>
<div class="ulist">
<ul>
<li>
<p>IGNORE_EXISTING - Ignore importing if a realm of this name already exists.</p>
</li>
<li>
<p>OVERWRITE_EXISTING - Remove existing realm and import it again with new data from the JSON file.
If you want to fully migrate one environment to another and ensure that the new environment will contain the same data
as the old one, you can specify this.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When importing realm files that weren&#8217;t exported before, the option <code>keycloak.import</code> can be used.
If more than one realm file needs to be imported, a comma separated list of file names can be specified.
This is more appropriate than the cases before, as this will happen only after the master realm has been initialized.
Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>-Dkeycloak.import=/tmp/realm1.json</p>
</li>
<li>
<p>-Dkeycloak.import=/tmp/realm1.json,/tmp/realm2.json</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="admin-console-export-import"><a class="anchor" href="#admin-console-export-import"></a>16.1. Admin console export/import</h3>
<div class="paragraph">
<p>Import of most resources can be performed from the admin console as well as export of most resources.
Export of users is not supported.</p>
</div>
<div class="paragraph">
<p>Note: Attributes containing secrets or private information will be masked in export file. Export files obtained via Admin Console
are thus not appropriate for backups or data transfer between servers. Only boot-time exports are appropriate for that.</p>
</div>
<div class="paragraph">
<p>The files created during a "startup" export can also be used to import from the admin UI.
This way, you can export from one realm and import to another realm. Or, you can export from one server and import to another.
Note: The admin console export/import allows just one realm per file.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The admin console import allows you to "overwrite" resources if you choose.
Use this feature with caution, especially on a production system. Export .json files from Admin Console Export operation
are generally not appropriate for data import since they contain invalid values for secrets.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The admin console export allows you to export clients, groups, and roles. If there is a great number of any of these
assets in your realm, the operation may take some time to complete. During that time server may not be responsive to user requests.
Use this feature with caution, especially on a production system.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_account-service"><a class="anchor" href="#_account-service"></a>17. User Account Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak has a built-in User Account Service which every user has access to.  This service allows users to manage their account,
change their credentials, update their profile, and view their login sessions.  The URL to this service is <code>&lt;server-root&gt;/auth/realms/{realm-name}/account</code>.</p>
</div>
<div class="paragraph">
<div class="title">Account Service</div>
<p><span class="image"><img src="./keycloak-images/account-service-profile.png" alt="account service profile"></span></p>
</div>
<div class="paragraph">
<p>The initial page is the user&#8217;s profile, which is the <code>Account</code> left menu item.  This is where they specify basic data about themselves.  This screen can be extended
to allow the user to manage additional attributes.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more details.</p>
</div>
<div class="paragraph">
<p>The <code>Password</code> left menu item allows the user to change their password.</p>
</div>
<div class="paragraph">
<div class="title">Password Update</div>
<p><span class="image"><img src="./keycloak-images/account-service-password.png" alt="account service password"></span></p>
</div>
<div class="paragraph">
<p>The <code>Authenticator</code> menu item allows the user to set up OTP if they desire.  This will only show up if OTP is a valid authentication mechanism for your realm.
Users are given directions to install <a href="https://freeotp.github.io/">FreeOTP</a> or <a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2">Google Authenticator</a> on their mobile device to be their OTP generator.
The QR code you see in the screen shot can be scanned into the FreeOTP or Google Authenticator mobile application for nice and easy setup.</p>
</div>
<div class="paragraph">
<div class="title">OTP Authenticator</div>
<p><span class="image"><img src="./keycloak-images/account-service-authenticator.png" alt="account service authenticator"></span></p>
</div>
<div class="paragraph">
<p>The <code>Federated Identity</code> menu item allows the user to link their account with an <a href="#_identity_broker">identity broker</a> (this is usually used to link social provider
accounts together).  This will show the list of external identity providers you have configured for your realm.</p>
</div>
<div class="paragraph">
<div class="title">Federated Identity</div>
<p><span class="image"><img src="./keycloak-images/account-service-federated-identity.png" alt="account service federated identity"></span></p>
</div>
<div class="paragraph">
<p>The <code>Sessions</code> menu item allows the user to view and manage which devices are logged in and from where.  They can perform logout of these sessions from this screen too.</p>
</div>
<div class="paragraph">
<div class="title">Sessions</div>
<p><span class="image"><img src="./keycloak-images/account-service-sessions.png" alt="account service sessions"></span></p>
</div>
<div class="paragraph">
<p>The <code>Applications</code> menu item shows users which applications they have access to.</p>
</div>
<div class="paragraph">
<div class="title">Applications</div>
<p><span class="image"><img src="./keycloak-images/account-service-apps.png" alt="account service apps"></span></p>
</div>
<div class="sect2">
<h3 id="themeable"><a class="anchor" href="#themeable"></a>17.1. Themeable</h3>
<div class="paragraph">
<p>Like all UIs in Keycloak, the User Account Service is completely themeable and internationalizable.
See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="threat-model-mitigation"><a class="anchor" href="#threat-model-mitigation"></a>18. Threat Model Mitigation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter discusses possible security vulnerabilities any authentication server could have and how Keycloak
mitigates those vulnerabilities.
A good list of potential vulnerabilities and what security implementations should do to mitigate them can be found in
the <a href="https://tools.ietf.org/html/rfc6819">OAuth 2.0 Threat Model</a> document put out by the IETF.
Many of those vulnerabilities are discussed here.</p>
</div>
<div class="sect2">
<h3 id="password-guess-brute-force-attacks"><a class="anchor" href="#password-guess-brute-force-attacks"></a>18.1. Password guess: brute force attacks</h3>
<div class="paragraph">
<p>A brute force attack happens when an attacker is trying to guess a user&#8217;s password.
Keycloak has some limited brute force detection capabilities.
If turned on, a user account will be temporarily disabled if a threshold of login failures is reached.
To enable this feature go to the <code>Realm Settings</code> left menu item, click on the <code>Security Defenses</code> tab, then additional
go to the <code>Brute Force Detection</code> sub-tab.</p>
</div>
<div class="paragraph">
<div class="title">Brute Force Detection</div>
<p><span class="image"><img src="./keycloak-images/brute-force.png" alt="brute force"></span></p>
</div>
<div class="paragraph">
<p>The way this works is that if there are <code>Max Login Failures</code> during a period of <code>Failure Reset Time</code>,
the account is temporarily disabled for the <code>Wait Increment</code> multiplied by the number of failures over the max.  After
<code>Failure Reset Time</code> is reached all failures are wiped clean.  The <code>Max Wait</code> is the maximum amount of time
an account can be disabled.  Another preventive measure is that if there are subsequent login failures for one
account that are too quick for a human to initiate the account will be disabled.  This is controlled by the
<code>Quick Login Check Milli Seconds</code> value.  So, if there are two login failures for the same account within that value,
the account will be disabled for <code>Minimum Quick Login Wait</code>.</p>
</div>
<div class="paragraph">
<p>The downside of Keycloak brute force detection is that the server becomes vulnerable to denial of service attacks.
An attacker can simply try to guess passwords for any accounts it knows and these account will be disabled.
Eventually we will expand this functionality to take client IP address into account when deciding whether to block a user.</p>
</div>
<div class="paragraph">
<p>A better option might be a tool like <a href="http://www.fail2ban.org/wiki/index.php/Main_Page">Fail2Ban</a>.  You can point this service at the Keycloak server&#8217;s log file.
Keycloak logs every login failure and client IP address that had the failure.  Fail2Ban can be used to modify
firewalls after it detects an attack to block connections from specific IP addresses.</p>
</div>
<div class="sect3">
<h4 id="password-policies"><a class="anchor" href="#password-policies"></a>18.1.1. Password Policies</h4>
<div class="paragraph">
<p>Another thing you should do to prevent password guess is to have a complex enough password policy to ensure that
users pick hard to guess passwords.  See the <a href="#_password-policies">Password Policies</a> chapter for more details.</p>
</div>
<div class="paragraph">
<p>The best way to prevent password guessing though is to set up the server to use a one-time-password (OTP).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clickjacking"><a class="anchor" href="#clickjacking"></a>18.2. Clickjacking</h3>
<div class="paragraph">
<p>With clickjacking, a malicious site loads the target site in a transparent iFrame overlaid on top of a set of dummy
buttons that are carefully constructed to be placed directly under important buttons on the target site.
When a user clicks a visible button, they are actually clicking a button (such as a "login" button) on the hidden page.
An attacker can steal a user&#8217;s authentication credentials and access their resources.</p>
</div>
<div class="paragraph">
<p>By default, every response by Keycloak sets some specific browser headers that can prevent this from happening.
Specifically, it sets <a href="https://tools.ietf.org/html/rfc7034">X-FRAME_OPTIONS</a> and <a href="http://www.w3.org/TR/CSP/">Content-Security-Policy</a>.
You should take a look at the definition of both of these headers as there is a lot of fine-grain browser access you can control.
In the admin console you can specify the values these headers will have.  Go to the <code>Realm Settings</code> left menu item and
click the <code>Security Defenses</code> tab and make sure you are on the <code>Headers</code> sub-tab.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./keycloak-images/security-headers.png" alt="security headers"></span></p>
</div>
<div class="paragraph">
<p>By default, Keycloak only sets up a <em>same-origin</em> policy for iframes.</p>
</div>
</div>
<div class="sect2">
<h3 id="ssl-https-requirement"><a class="anchor" href="#ssl-https-requirement"></a>18.3. SSL/HTTPS Requirement</h3>
<div class="paragraph">
<p>If you do not use SSL/HTTPS for all communication between the Keycloak auth server and the clients it secures, you will be very vulnerable to man in the middle attacks.
OAuth 2.0/OpenID Connect uses access tokens for security.
Without SSL/HTTPS, attackers can sniff your network and obtain an access token.
Once they have an access token they can do any operation that the token has been given permission for.</p>
</div>
<div class="paragraph">
<p>Keycloak has <a href="#_ssl_modes">three modes for SSL/HTTPS</a>.
SSL can be hard to set up, so out of the box, Keycloak allows non-HTTPS communication over private IP addresses like
localhost, 192.168.x.x, and other private IP addresses.
In production, you should make sure SSL is enabled and required across the board.</p>
</div>
<div class="paragraph">
<p>On the adapter/client side, Keycloak allows you to turn off the SSL trust manager.
The trust manager ensures identity the client is talking to.
It checks the DNS domain name against the server&#8217;s certificate.
In production you should make sure that each of your client adapters is configured to use a truststore.
Otherwise you are vulnerable to DNS man in the middle attacks.</p>
</div>
</div>
<div class="sect2">
<h3 id="csrf-attacks"><a class="anchor" href="#csrf-attacks"></a>18.4. CSRF Attacks</h3>
<div class="paragraph">
<p>Cross-site request forgery (CSRF) is a web-based attack whereby HTTP requests are transmitted from a user that the
web site trusts or has authenticated with(e.g. via HTTP redirects or HTML forms).  Any site that uses cookie based authentication is vulnerable to these types of attacks.
These attacks are mitigated by matching a state cookie against a posted form or query parameter.</p>
</div>
<div class="paragraph">
<p>The OAuth 2.0 login specification requires that a state cookie be used and matched against a transmitted state parameter.
Keycloak fully implements this part of the specification so all logins are protected.</p>
</div>
<div class="paragraph">
<p>The Keycloak Admin Console is a pure JavaScript/HTML5 application that makes REST calls to the backend Keycloak admin REST API.
These calls all require bearer token authentication and are made via JavaScript Ajax calls.
CSRF does not apply here.
The admin REST API can also be configured to validate the CORS origins as well.</p>
</div>
<div class="paragraph">
<p>The only part of Keycloak that really falls into CSRF is the user account management pages.
To mitigate this Keycloak sets a state cookie and also embeds the value of this state cookie within hidden form fields or query parameters in action links.
This query or form parameter is checked against the state cookie to verify that the call was made by the user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unspecific-redirect-uris"><a class="anchor" href="#_unspecific-redirect-uris"></a>18.5. Unspecific Redirect URIs</h3>
<div class="paragraph">
<p>For the <a href="#_oidc-auth-flows">Authorization Code Flow</a>, if you register redirect URIs that
are too general, then it would be possible for a rogue client to impersonate a different client that has a broader scope
of access.  This could happen for instance if two clients live under the same domain.  So, it&#8217;s a good idea to make your
registered redirect URIs as specific as feasible.</p>
</div>
</div>
<div class="sect2">
<h3 id="compromised-access-and-refresh-tokens"><a class="anchor" href="#compromised-access-and-refresh-tokens"></a>18.6. Compromised Access and Refresh Tokens</h3>
<div class="paragraph">
<p>There are a few things you can do to mitigate access tokens and refresh tokens from being stolen. The most important thing is to enforce SSL/HTTPS communication between Keycloak and its clients and applications. It might seem obvious, but since Keycloak does not have SSL enabled by default, an administrator might not realize that it is necessary.</p>
</div>
<div class="paragraph">
<p>Another thing you can do to mitigate leaked access tokens is to shorten their lifespans.  You can specify this within the <a href="#_timeouts">timeouts page</a>.
Short lifespans (minutes) for access tokens for clients and applications to refresh their access tokens after a short amount of time. If an admin detects a leak, they can logout all user sessions to invalidate these refresh tokens or set up a revocation policy. Making sure refresh tokens always stay private to the client and are never transmitted ever is very important as well.</p>
</div>
<div class="paragraph">
<p>If an access token or refresh token is compromised, the first thing you should do is go to the admin console and push a not-before revocation policy to all applications. This will enforce that any tokens issued prior to that date are now invalid. Pushing new not-before policy will also ensure that application will be forced to download new public keys from Keycloak, hence it is also useful for the case, when you think that realm signing key was compromised.
More info in the  <a href="#realm_keys">keys chapter</a>.</p>
</div>
<div class="paragraph">
<p>You can also disable specific applications, clients, and users if you feel that any one of those entities is completely compromised.</p>
</div>
</div>
<div class="sect2">
<h3 id="compromised-authorization-code"><a class="anchor" href="#compromised-authorization-code"></a>18.7. Compromised Authorization Code</h3>
<div class="paragraph">
<p>For the <a href="#_oidc-auth-flows">OIDC Auth Code Flow</a>, it would be very hard for an attacker to compromise Keycloak authorization codes.
Keycloak generates a cryptographically strong random value for its authorization codes so it would be very hard to guess an access token.
An authorization code can only be used once to obtain an access token.
In the admin console you can specify how long an authorization code is valid for on the <a href="#_timeouts">timeouts page</a>.
This value should be really short, as short as a few seconds and just long enough for the client to make the request to obtain a token from the code.</p>
</div>
</div>
<div class="sect2">
<h3 id="open-redirectors"><a class="anchor" href="#open-redirectors"></a>18.8. Open redirectors</h3>
<div class="paragraph">
<p>An attacker could use the end-user authorization endpoint and the redirect URI parameter to abuse the authorization server as an open redirector.
An open redirector is an endpoint using a parameter to automatically redirect a user agent to the location specified by the parameter value without any validation.
An attacker could utilize a user&#8217;s trust in an authorization server to launch a phishing attack.</p>
</div>
<div class="paragraph">
<p>Keycloak requires that all registered applications and clients register at least one redirection URI pattern.
Any time a client asks Keycloak to perform a redirect (on login or logout for example), Keycloak will check the redirect URI vs.
the list of valid registered URI patterns.
It is important that clients and applications register as specific a URI pattern as possible to mitigate open redirector attacks.</p>
</div>
</div>
<div class="sect2">
<h3 id="password-database-compromised"><a class="anchor" href="#password-database-compromised"></a>18.9. Password database compromised</h3>
<div class="paragraph">
<p>Keycloak does not store passwords in raw text.
It stores a hash of them using the PBKDF2 algorithm.  It actually uses
a default of 20,000 hashing iterations!  This is the security community&#8217;s recommended number of iterations.
This can be a rather large performance hit on your system as PBKDF2, by design, gobbles up a significant amount of CPU.
It is up to you to decide how serious you want to be to protect your password database.</p>
</div>
</div>
<div class="sect2">
<h3 id="limiting-scope"><a class="anchor" href="#limiting-scope"></a>18.10. Limiting Scope</h3>
<div class="paragraph">
<p>By default, each new client application has an unlimited scope.  This means that every access token that is created
for that client will contain all the permissions the user has.  If the client gets compromised and the access token
is leaked, then each system that the user has permission to access is now also compromised.  It is highly suggested
that you limit the roles an access token is assigned by using the <a href="#_client_scope">Scope menu</a> for each client.</p>
</div>
</div>
<div class="sect2">
<h3 id="sql-injection-attacks"><a class="anchor" href="#sql-injection-attacks"></a>18.11. SQL Injection Attacks</h3>
<div class="paragraph">
<p>At this point in time, there is no knowledge of any SQL injection vulnerabilities in Keycloak.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="admin-cli"><a class="anchor" href="#admin-cli"></a>19. Admin CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In previous chapters we have described how to use Keycloak Admin Console to perform administrative tasks.
All those tasks can also be performed from command line by using Admin CLI command line tool.</p>
</div>
<div class="sect2">
<h3 id="installing-admin-cli"><a class="anchor" href="#installing-admin-cli"></a>19.1. Installing Admin CLI</h3>
<div class="paragraph">
<p>Admin CLI is packaged inside Keycloak Server distribution. You can find execution scripts inside <code>bin</code> directory.</p>
</div>
<div class="paragraph">
<p>The Linux script is called <code>kcadm.sh</code>, and the one for Windows is called <code>kcadm.bat</code>.</p>
</div>
<div class="paragraph">
<p>In order to use the client from any location on your filesystem you may want to add Keycloak server directory to your PATH.</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ export PATH=$PATH:$KEYCLOAK_HOME/bin
$ kcadm.sh</pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; set PATH=%PATH%;%KEYCLOAK_HOME%\bin
c:\&gt; kcadm</pre>
</div>
</div>
<div class="paragraph">
<p>We assume KEYCLOAK_HOME env variable is set to the path where you extracted Keycloak Server distribution.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To avoid unnecessary repetition the rest of this document will only give Windows examples in places where difference
in command line is more than just in <code>kcadm</code> command name.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="using-admin-cli"><a class="anchor" href="#using-admin-cli"></a>19.2. Using Admin CLI</h3>
<div class="paragraph">
<p>Admin CLI works by making HTTP requests to Admin REST endpoints. Access to them is protected and requires authentication.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Consult Admin REST API documentation for details about JSON attributes for specific endpoints.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You start an authenticated session by providing credentials (i.e. logging in), then you are ready to perform some CRUD operations.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh config credentials --server http://localhost:8080/auth --realm demo --user admin --client admin
$ kcadm.sh create realms -s realm=demorealm -s enabled=true -o
$ CID=$(kcadm.sh create clients -r demorealm -s clientId=my_client -s 'redirectUris=["http://localhost:8980/myapp/*"]' -i)
$ kcadm.sh get clients/$CID/installation/providers/keycloak-oidc-keycloak-json</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm config credentials --server http://localhost:8080/auth --realm demo --user admin --client admin
c:\&gt; kcadm create realms -s realm=demorealm -s enabled=true -o
c:\&gt; kcadm create clients -r demorealm -s clientId=my_client -s "redirectUris=[\"http://localhost:8980/myapp/*\"]" -i &gt; clientid.txt
c:\&gt; set /p CID=&lt;clientid.txt
c:\&gt; kcadm get clients/%CID%/installation/providers/keycloak-oidc-keycloak-json</pre>
</div>
</div>
<div class="paragraph">
<p>In a production environment Keycloak has to be accessed with <code>https:</code> to avoid exposing tokens to network sniffers. If server&#8217;s
certificate is not issued by one of the trusted CAs that are included in Java&#8217;s default certificate truststore, then you will
need to prepare a truststore.jks file, and instruct <code>Admin CLI</code> to use it.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh config truststore --trustpass $PASSWORD ~/.keycloak/truststore.jks</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm config truststore --trustpass %PASSWORD% %HOMEPATH%\.keycloak\truststore.jks</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authenticating"><a class="anchor" href="#authenticating"></a>19.3. Authenticating</h3>
<div class="paragraph">
<p>When logging in with <code>Admin CLI</code> you specify a server endpoint url, and a realm. Then you specify a username,
or alternatively you can specify only a client id, which will result in special, so called 'service account' being used. In the first case,
a password for the specified user has to be used at login. In the latter case there is no user password - only client secret.
Alternatively, <code>Signed JWT</code> can be used.</p>
</div>
<div class="paragraph">
<p>The account used for the session needs to have proper permissions in order to be able to invoke Admin REST API operations.
For example, <code>realm-admin</code> role of <code>realm-management</code> client allows user to administer the realm within which the user is defined.</p>
</div>
<div class="paragraph">
<p>There are two primary mechanisms for authentication. One is using <code>kcadm config credentials</code> to start an authenticated session:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin</pre>
</div>
</div>
<div class="paragraph">
<p>This approach maintains an authenticated session between <code>kcadm</code> command invocations by saving the obtained access token, and
associated refresh token, possibly other secrets as well in a private configuration file. See <a href="#_working_with_alternative_configurations">next chapter</a> for more info on configuration file.</p>
</div>
<div class="paragraph">
<p>Another approach is to authenticate with each command invocation for the duration of that invocation only. This approach results
in more load on the server, and more time spent with round-trips obtaining tokens, but has a benefit of not needing to save any
tokens between invocations, thus nothing is saved to disk. This mode is used when <code>--no-config</code> argument is specified.</p>
</div>
<div class="paragraph">
<p>For example, when performing an operation we specify all the information required for authentication:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms --no-config --server http://localhost:8080/auth --realm master --user admin --password admin</pre>
</div>
</div>
<div class="paragraph">
<p>See built-in help for more information on using <code>Admin CLI</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh help</pre>
</div>
</div>
<div class="paragraph">
<p>See <code>kcadm.sh config credentials --help</code> for more information about starting an authenticated session.</p>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_alternative_configurations"><a class="anchor" href="#_working_with_alternative_configurations"></a>19.4. Working with alternative configurations</h3>
<div class="paragraph">
<p>By default, <code>Admin CLI</code> automatically maintains a configuration file called <code>kcadm.config</code> located under user&#8217;s home
directory - it&#8217;s full pathname is <code>$HOME/.keycloak/kcadm.config</code> (on Windows it&#8217;s <code>%HOMEPATH%\.keycloak\kcadm.config</code>).</p>
</div>
<div class="paragraph">
<p>You can use <code>--config</code> option to point to a different file / location. This way you can maintain multiple authenticated
sessions in parallel.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It&#8217;s best to perform operations tied to a single config file from a single thread.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Make sure to not make config file visible to other users on the system as it contains access tokens, and secrets that should be kept private.
By default the ~/.keycloak directory and its content will be automatically created with proper access limits. However if directory will
exist already with non-default permissions, those will not be updated.</p>
</div>
<div class="paragraph">
<p>You may want to avoid storing any secrets at all inside a config file for the price of less convenience and having to do more token requests.
In that case you can use <code>--no-config</code> option with all your commands. In that case you will have to specify all the authentication info needed by
<code>config credentials</code> command with each <code>kcadm</code> invocation.</p>
</div>
</div>
<div class="sect2">
<h3 id="basic-operations-and-resource-uris"><a class="anchor" href="#basic-operations-and-resource-uris"></a>19.5. Basic operations, and resource URIs</h3>
<div class="paragraph">
<p>Admin CLI allows you to perform CRUD operations against Admin REST API endpoints in quite a generic way, with additional commands
that simplify performing certain tasks.</p>
</div>
<div class="paragraph">
<p>Main usage pattern is the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create ENDPOINT [ARGUMENTS]
$ kcadm.sh get ENDPOINT [ARGUMENTS]
$ kcadm.sh update ENDPOINT [ARGUMENTS]
$ kcadm.sh delete ENDPOINT [ARGUMENTS]</pre>
</div>
</div>
<div class="paragraph">
<p>Where operations <code>create</code>, <code>get</code>, <code>update</code>, and <code>delete</code> are mapped to HTTP verbs POST, GET, PUT, and DELETE, respectively.
ENDPOINT is a target resource URI, and can either be absolute - starting with 'http:' or 'https:', or relative - used to compose an absolute URL
of the following format:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SERVER_URI/admin/realms/REALM/ENDPOINT</pre>
</div>
</div>
<div class="paragraph">
<p>For example, if the server we authenticate against is <code><a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a></code>, and realm is <code>master</code>, then using <code>users</code> as ENDPOINT
will result in the following resource URL: <code><a href="http://localhost:8080/auth/admin/realms/master/users" class="bare">http://localhost:8080/auth/admin/realms/master/users</a></code>.</p>
</div>
<div class="paragraph">
<p>If we set ENDPOINT to <code>clients</code> the effective resource URI would be: <code><a href="http://localhost:8080/auth/admin/realms/master/clients" class="bare">http://localhost:8080/auth/admin/realms/master/clients</a></code>.</p>
</div>
<div class="paragraph">
<p>There is <code>realms</code> endpoint which is treated slightly differently since it is the container for realms. It resolves simply to:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SERVER_URI/admin/realms</pre>
</div>
</div>
<div class="paragraph">
<p>There is also <code>serverinfo</code> which is treated the same way since it is independent of realms.</p>
</div>
<div class="paragraph">
<p>When authenticating as a user with realm-admin powers you may need to perform operations on multiple different realms. In that case
you can specify <code>-r</code> option to tell explicitly which realm the operation should be executed against.
Instead of using REALM as specified via <code>--realm</code> option of <code>kcadm.sh config credentials</code>, the TARGET_REALM will be used:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SERVER_URI/admin/realms/TARGET_REALM/ENDPOINT</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin
$ kcadm.sh create users -s username=testuser -s enabled=true -r demorealm</pre>
</div>
</div>
<div class="paragraph">
<p>In this example we first start a session authenticated as <code>admin</code> user in <code>master</code> realm. Then we perform a POST call against the following
resource URL:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>http://localhost:8080/auth/admin/realms/demorealm/users</pre>
</div>
</div>
<div class="paragraph">
<p>Commands <code>create</code> and <code>update</code> by default send JSON body to the server. You can use <code>-f FILENAME</code> to read a pre-made document from a file.
You can use <code>-f -</code>, and message body will be read from standard input.
But you can also specify individual attributes and their values as seen in the previous <code>create users</code> example, and they will be composed into a JSON body and sent to the server.</p>
</div>
<div class="paragraph">
<p>When using <code>update</code> there are several ways to update a resource. You can first get current state of a resource, and save it into a file,
then edit that file and send it to the server for update. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms/demorealm &gt; demorealm.json
$ vi demorealm.json
$ kcadm.sh update realms/demorealm -f demorealm.json</pre>
</div>
</div>
<div class="paragraph">
<p>This way the resource on the server will be updated with all the attributes in the sent JSON document.</p>
</div>
<div class="paragraph">
<p>Another option is to perform an update on-the-fly using <code>-s, --set</code> options to set new values. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update realms/demorealm -s enabled=false</pre>
</div>
</div>
<div class="paragraph">
<p>That would only update <code>enabled</code> attribute to <code>false</code>.</p>
</div>
<div class="paragraph">
<p>By default <code>update</code> operation first performs a <code>get</code>, and then merges new attribute values with existing.
Mostly this is a preferred behaviour. In some cases the endpoint may support <code>PUT</code> but not <code>GET</code>.
You can use <code>-n</code> option to perform a so called 'no-merge' update which performs a PUT, without first doing a GET.</p>
</div>
</div>
<div class="sect2">
<h3 id="realm-operations"><a class="anchor" href="#realm-operations"></a>19.6. Realm operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Creating a new realm</dt>
<dd>
<p>To create a new enabled realm use <code>create</code> operation on <code>realms</code> endpoint, and set attributes <code>realm</code> and <code>enabled</code>:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create realms -s realm=demorealm -s enabled=true</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Realm is not enabled by default. By enabling it, it can be used for authentication immediately.</p>
</div>
<div class="paragraph">
<p>A description for a new object can be in JSON format as well:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create realms -f demorealm.json</pre>
</div>
</div>
<div class="paragraph">
<p>JSON document with realm attributes can be sent directly from file or piped to standard input.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create realms -f - &lt;&lt; EOF
{ "realm": "demorealm", "enabled": true }
EOF</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; echo { "realm": "demorealm", "enabled": true } | kcadm create realms -f -</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing existing realms</dt>
<dd>
<p>The following will return a list of all realms:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note that a list of realms is additionally filtered on the server to only return realms user is allowed to see.</p>
</div>
<div class="paragraph">
<p>Returning the whole realm description is often too much information as we are often only interested in a subset of attributes like realm name, and if realm is enabled or not.
You can specify which attributes to return by using <code>--fields</code> option:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms --fields realm,enabled</pre>
</div>
</div>
<div class="paragraph">
<p>You can even display the result as comma separated values:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms --fields realm --format csv --noquotes</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting a specific realm</dt>
<dd>
<p>As is common for REST web services, in order to get an individual item of a collection, append an id to collection URI:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms/master</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Updating a realm</dt>
<dd>
<p>In order to only change some attributes of the realm use <code>-s</code> to set new values for the attributes. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update realms/demorealm -s enabled=false</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you want to set all writable attributes with new values, perform a <code>get</code> first, edit current values in JSON file, and resubmit. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms/demorealm &gt; demorealm.json
$ vi demorealm.json
$ kcadm.sh update realms/demorealm -f demorealm.json</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deleting a realm</dt>
<dd>
<p>Here is how to delete a realm:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete realms/demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Turning on all login page options for the realm</dt>
<dd>
<p>Set the attributes controlling specific capabilities to <code>true</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update realms/demorealm -s registrationAllowed=true -s registrationEmailAsUsername=true -s rememberMe=true -s verifyEmail=true -s resetPasswordAllowed=true -s editUsernameAllowed=true</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing the realm keys</dt>
<dd>
<p>Use <code>get</code> operation on <code>keys</code> endpoint of the target realm:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get keys -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Generating new realm keys</dt>
<dd>
<p>To add a new RSA generated keypair, first get <code>id</code> of the target realm. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms/demorealm --fields id --format csv --noquotes</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Then add a new key provider with higher priority than any of the existing providers as revealed by <code>kcadm.sh get keys -r demorealm</code>:</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=rsa-generated -s providerId=rsa-generated -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s 'config.priority=["101"]' -s 'config.enabled=["true"]' -s 'config.active=["true"]' -s 'config.keySize=["2048"]'</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm create components -r demorealm -s name=rsa-generated -s providerId=rsa-generated -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s "config.priority=[\"101\"]" -s "config.enabled=[\"true\"]" -s "config.active=[\"true\"]" -s "config.keySize=[\"2048\"]"</pre>
</div>
</div>
<div class="paragraph">
<p>Attribute <code>parentId</code> should be set to the value of target realm&#8217;s <code>id</code>.</p>
</div>
<div class="paragraph">
<p>The newly added key should now become the active key as revealed by <code>kcadm.sh get keys -r demorealm</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding new realm keys from Java Key Store file</dt>
<dd>
<p>To add a new keypair already prepared as a JKS file on the server, add a new key provider as follows:</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For exmple on Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=java-keystore -s providerId=java-keystore -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s 'config.priority=["101"]' -s 'config.enabled=["true"]' -s 'config.active=["true"]' -s 'config.keystore=["/opt/keycloak/keystore.jks"]' -s 'config.keystorePassword=["secret"]' -s 'config.keyPassword=["secret"]' -s 'config.alias=["localhost"]'</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm create components -r demorealm -s name=java-keystore -s providerId=java-keystore -s providerType=org.keycloak.keys.KeyProvider -s parentId=959844c1-d149-41d7-8359-6aa527fca0b0 -s "config.priority=[\"101\"]" -s "config.enabled=[\"true\"]" -s "config.active=[\"true\"]" -s "config.keystore=[\"/opt/keycloak/keystore.jks\"]" -s "config.keystorePassword=[\"secret\"]" -s "config.keyPassword=[\"secret\"]" -s "config.alias=[\"localhost\"]"</pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to change attribute values for <code>keystore</code>, <code>keystorePassword</code>, <code>keyPassword</code>, and <code>alias</code> to match your specific keystore.</p>
</div>
<div class="paragraph">
<p>Attribute <code>parentId</code> should be set to the value of target realm&#8217;s <code>id</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Making key passive or disabling it</dt>
<dd>
<p>Identify the key you wish to make passive:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get keys -r demorealm</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Use <code>providerId</code> attribute of the key to construct an endpoint uri - <code>components/PROVIDER_ID</code>.</p>
</div>
<div class="paragraph">
<p>Then perform an <code>update</code>. For example on Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update components/PROVIDER_ID -r demorealm -s 'config.active=["false"]'</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm update components/PROVIDER_ID -r demorealm -s "config.active=[\"false\"]"</pre>
</div>
</div>
<div class="paragraph">
<p>Analogously, other key attributes can be updated.</p>
</div>
<div class="paragraph">
<p>To disable the key set new <code>enabled</code> value, for example: <code>'config.enabled=["false"]'</code></p>
</div>
<div class="paragraph">
<p>To change key&#8217;s priority set new <code>priority</code> value, for example: <code>'config.priority=["110"]'</code></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deleting an old key</dt>
<dd>
<p>Make sure that the key you are deleting has been passive for some time, and then disabled for some time in order to prevent any existing tokens
held by applications and users from abruptly failing to work.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Identify the key you wish to make passive:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get keys -r demorealm</pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>providerId</code> of that key to perform a delete. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete components/PROVIDER_ID -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring event logging for a realm</dt>
<dd>
<p>Use <code>update</code> on <code>events/config</code> endpoint.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Attribute <code>eventsListeners</code> contains a list of EventListenerProviderFactory ids, specifying all event listeners receiving events.
Separately, there are attributes that control a built-in event storage which allows querying past events via Admin REST API.
There is separate control over logging of service calls - 'eventsEnabled', and auditing events triggered during Admin Console or Admin REST API - 'adminEventsEnabled'.
You may want to setup expiry of old events so that your database doesn&#8217;t get filled up - 'eventsExpiration' is set to time-to-live expressed in seconds.</p>
</div>
<div class="paragraph">
<p>Here is an example of setting up a built-in event listener that will receive all the events and log them through jboss-logging (error events are logged as <code>WARN</code>, others as <code>DEBUG</code>, using a logger called <code>org.keycloak.events</code>):</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update events/config -r demorealm -s 'eventsListeners=["jboss-logging"]'</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm update events/config -r demorealm -s "eventsListeners=[\"jboss-logging\"]"</pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of turning on storage of all available ERROR events - not including auditing events - for 2 days so they can be retrieved via Admin REST:</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update events/config -r demorealm -s eventsEnabled=true -s 'enabledEventTypes=["LOGIN_ERROR","REGISTER_ERROR","LOGOUT_ERROR","CODE_TO_TOKEN_ERROR","CLIENT_LOGIN_ERROR","FEDERATED_IDENTITY_LINK_ERROR","REMOVE_FEDERATED_IDENTITY_ERROR","UPDATE_EMAIL_ERROR","UPDATE_PROFILE_ERROR","UPDATE_PASSWORD_ERROR","UPDATE_TOTP_ERROR","VERIFY_EMAIL_ERROR","REMOVE_TOTP_ERROR","SEND_VERIFY_EMAIL_ERROR","SEND_RESET_PASSWORD_ERROR","SEND_IDENTITY_PROVIDER_LINK_ERROR","RESET_PASSWORD_ERROR","IDENTITY_PROVIDER_FIRST_LOGIN_ERROR","IDENTITY_PROVIDER_POST_LOGIN_ERROR","CUSTOM_REQUIRED_ACTION_ERROR","EXECUTE_ACTIONS_ERROR","CLIENT_REGISTER_ERROR","CLIENT_UPDATE_ERROR","CLIENT_DELETE_ERROR"]' -s eventsExpiration=172800</pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm update events/config -r demorealm -s eventsEnabled=true -s "enabledEventTypes=[\"LOGIN_ERROR\",\"REGISTER_ERROR\",\"LOGOUT_ERROR\",\"CODE_TO_TOKEN_ERROR\",\"CLIENT_LOGIN_ERROR\",\"FEDERATED_IDENTITY_LINK_ERROR\",\"REMOVE_FEDERATED_IDENTITY_ERROR\",\"UPDATE_EMAIL_ERROR\",\"UPDATE_PROFILE_ERROR\",\"UPDATE_PASSWORD_ERROR\",\"UPDATE_TOTP_ERROR\",\"VERIFY_EMAIL_ERROR\",\"REMOVE_TOTP_ERROR\",\"SEND_VERIFY_EMAIL_ERROR\",\"SEND_RESET_PASSWORD_ERROR\",\"SEND_IDENTITY_PROVIDER_LINK_ERROR\",\"RESET_PASSWORD_ERROR\",\"IDENTITY_PROVIDER_FIRST_LOGIN_ERROR\",\"IDENTITY_PROVIDER_POST_LOGIN_ERROR\",\"CUSTOM_REQUIRED_ACTION_ERROR\",\"EXECUTE_ACTIONS_ERROR\",\"CLIENT_REGISTER_ERROR\",\"CLIENT_UPDATE_ERROR\",\"CLIENT_DELETE_ERROR\"]" -s eventsExpiration=172800</pre>
</div>
</div>
<div class="paragraph">
<p>Here is how you reset stored event types to <strong>all available event types</strong> - setting to empty list is the same as enumerating all:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update events/config -r demorealm -s enabledEventTypes=[]</pre>
</div>
</div>
<div class="paragraph">
<p>And here is how you enable storage of auditing events:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update events/config -r demorealm -s adminEventsEnabled=true -s adminEventsDetailsEnabled=true</pre>
</div>
</div>
<div class="paragraph">
<p>Here is how you get the last 100 events - they are ordered from newest to oldest:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get events --offset 0 --limit 100</pre>
</div>
</div>
<div class="paragraph">
<p>Here is how you delete all saved events:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm delete events</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Flushing the caches</dt>
<dd>
<p>Use <code>create</code> operation, and one of the following endpoints: <code>clear-realm-cache</code>, <code>clear-user-cache</code>, <code>clear-keys-cache</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Set <code>realm</code> to the same value as target realm.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create clear-realm-cache -r demorealm -s realm=demorealm</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create clear-user-cache -r demorealm -s realm=demorealm</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create clear-keys-cache -r demorealm -s realm=demorealm</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="role-operations"><a class="anchor" href="#role-operations"></a>19.7. Role operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Creating a realm role</dt>
<dd>
<p>To create a realm role use <code>roles</code> endpoint:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create roles -r demorealm -s name=user -s 'description=Regular user with limited set of permissions'</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Creating a client role</dt>
<dd>
<p>To create a client role identify the client first - use <code>get</code> to list available clients:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get clients -r demorealm --fields id,clientId</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Then, create a new role by using client&#8217;s <code>id</code> attribute to construct an endpoint uri - <code>clients/ID/roles</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles -r demorealm -s name=editor -s 'description=Editor can edit, and publish any article'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing realm roles</dt>
<dd>
<p>To list existing realm roles use <code>get</code> command on <code>roles</code> endpoint:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get roles -r demorealm</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can also use <code>get-roles</code> command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing client roles</dt>
<dd>
<p>There is a dedicated <code>get-roles</code> command to simplify listing of both realm and client roles. It is an extension of <code>get</code> command and so it behaves
the same with additional semantics for listing roles.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list client roles use <code>get-roles</code> command, passing it either <code>clientId</code> (via <code>--cclientid</code> option) or <code>id</code> (via <code>--cid</code> option) to identify the client.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --cclientid realm-management</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting a specific realm role</dt>
<dd>
<p>Use <code>get</code> command, and role <code>name</code> to construct an endpoint uri for a specific realm role - <code>roles/ROLE_NAME</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get roles/user -r demorealm</pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>user</code> is the name of existing role.</p>
</div>
<div class="paragraph">
<p>Alternatively, use special <code>get-roles</code> command, passing it role <code>name</code> (via <code>--rolename</code> option) or <code>id</code> (via <code>--roleid</code> option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rolename user</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting a specific client role</dt>
<dd>
<p>Use a dedicated <code>get-roles</code> command, passing it either <code>clientId</code> (via <code>--cclientid</code> option) or <code>id</code> (via <code>--cid</code> option) to identify the client,
and passing it either role <code>name</code> (via <code>--rolename</code> option) or 'id' (via <code>--roleid</code>) to identify a specific client role:</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --cclientid realm-management --rolename manage-clients</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Updating a realm role</dt>
<dd>
<p>Use <code>update</code> operation with the same endpoint uri as for getting a specific realm role. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update roles/user -r demorealm -s 'description=Role representing a regular user'</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Updating a client role</dt>
<dd>
<p>Use <code>update</code> operation with the same endpoint uri as for getting a specific client role. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles/editor -r demorealm -s 'description=User that can edit, and publish articles'</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Deleting a realm role</dt>
<dd>
<p>Use <code>delete</code> operation with the same endpoint uri as for getting a specific realm role. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete roles/user -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Deleting a client role</dt>
<dd>
<p>Use <code>delete</code> operation with the same endpoint uri as for getting a specific client role. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles/editor -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Listing assigned, available and effective realm roles for a composite role</dt>
<dd>
<p>Use a dedicated <code>get-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list <strong>assigned</strong> realm roles for the composite role you can specify the target composite role by either <code>name</code> (via --rname option) or <code>id</code> (via --rid option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rname testrole</pre>
</div>
</div>
<div class="paragraph">
<p>To list <strong>effective</strong> realm roles, use additional <code>--effective</code> option.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rname testrole --effective</pre>
</div>
</div>
<div class="paragraph">
<p>To list realm roles that can still be added to the composite role, use <code>--available</code> option instead.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rname testrole --available</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing assigned, available, and effective client roles for a composite role</dt>
<dd>
<p>Use a dedicated <code>get-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list <strong>assigned</strong> client roles for the composite role you can specify the target composite role by either <code>name</code> (via --rname option)
or <code>id</code> (via --rid option), and client by either <code>clientId</code> (via --cclientid option) or <code>id</code> (via --cid option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rname testrole --cclientid realm-management</pre>
</div>
</div>
<div class="paragraph">
<p>To list <strong>effective</strong> realm roles, use additional <code>--effective</code> option.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rname testrole --cclientid realm-management --effective</pre>
</div>
</div>
<div class="paragraph">
<p>To list realm roles that can still be added to the target composite role, use <code>--available</code> option instead.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --rname testrole --cclientid realm-management --available</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding realm roles to a composite role</dt>
<dd>
<p>There is a dedicated <code>add-roles</code> command that can be used for adding both realm roles and client roles.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to add 'user' role to composite role 'testrole' :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh add-roles --rname testrole --rolename user -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing realm roles from a composite role</dt>
<dd>
<p>There is a dedicated <code>remove-roles</code> command that can be used to remove both realm roles and client roles.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to remove 'user' role from target composite role 'testrole':</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh remove-roles --rname testrole --rolename user -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding client roles to a realm role</dt>
<dd>
<p>This is how you create or modify a composite realm role.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Use a dedicated <code>add-roles</code> command that can be used for adding both realm roles and client roles.</p>
</div>
<div class="paragraph">
<p>For example, to add to <code>testrole</code> composite role two roles defined on client <code>realm-management</code> - <code>create-client</code> role and <code>view-users</code> role:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh add-roles -r demorealm --rname testrole --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding client roles to a client role</dt>
<dd>
<p>This is how you create or modify a composite client role.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>First, find out an <code>id</code> of the composite client role - by using <code>get-roles</code> command for example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --cclientid test-client --rolename operations</pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that there exists a client with "clientId": 'test-client', a client role called 'support', and another client role - that will become composite role - that has an "id": "fc400897-ef6a-4e8c-872b-1581b7fa8a71", "name":"operations".</p>
</div>
<div class="paragraph">
<p>In this example 'operations' is our target composite role, and we just got its <code>id</code>.</p>
</div>
<div class="paragraph">
<p>We can now add another role to it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh add-roles -r demorealm --cclientid test-client --rid fc400897-ef6a-4e8c-872b-1581b7fa8a71 --rolename support</pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards all the roles of a composite role can be listed by using <code>get-roles --all</code>. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles --rid fc400897-ef6a-4e8c-872b-1581b7fa8a71 --all</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing client roles from a composite role</dt>
<dd>
<p>Use a dedicated <code>remove-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to remove from <code>testrole</code> composite role two roles defined on client <code>realm management</code> - <code>create-client</code> role and <code>view-users</code> role:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh remove-roles -r demorealm --rname testrole --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-operations"><a class="anchor" href="#client-operations"></a>19.8. Client operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Creating a client</dt>
<dd>
<p>To create a new client perform <code>create</code> command on <code>clients</code> endpoint. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create clients -r demorealm -s clientId=myapp -s enabled=true</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you want to set a secret for adapters to authenticate specify a <code>secret</code>. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create clients -r demorealm -s clientId=myapp -s enabled=true -s clientAuthenticatorType=client-secret -s secret=d0b8122f-8dfb-46b7-b68a-f5cc4e25d000</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing clients</dt>
<dd>
<p>Use <code>get</code> operation on <code>clients</code> endpoint. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get clients -r demorealm --fields id,clientId</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here we filter the output to only list <code>id</code>, and <code>clientId</code> attributes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting a specific client</dt>
<dd>
<p>Use client&#8217;s <code>id</code> to construct an endpoint uri targeting specific client - <code>clients/ID</code>. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Getting current secret for specific client</dt>
<dd>
<p>Use client&#8217;s <code>id</code> to construct an endpoint uri - <code>clients/ID/client-secret</code>. For example</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get clients/$CID/client-secret</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Getting adapter configuration file (keycloak.json) for specific client</dt>
<dd>
<p>Use client&#8217;s <code>id</code> to construct an endpoint uri targeting specific client - <code>clients/ID/installation/providers/keycloak-oidc-keycloak-json</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3/installation/providers/keycloak-oidc-keycloak-json -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting Wildfly subsystem adapter configuration for specific client</dt>
<dd>
<p>Use client&#8217;s <code>id</code> to construct an endpoint uri targeting specific client - <code>clients/ID/installation/providers/keycloak-oidc-jboss-subsystem</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3/installation/providers/keycloak-oidc-jboss-subsystem -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Updating a client</dt>
<dd>
<p>Use <code>update</code> operation with the same endpoint uri as for getting a specific client. For example on Linux:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm -s enabled=false -s publicClient=true -s 'redirectUris=["http://localhost:8080/myapp/*"]' -s baseUrl=http://localhost:8080/myapp -s adminUrl=http://localhost:8080/myapp</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm update clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm -s enabled=false -s publicClient=true -s "redirectUris=[\"http://localhost:8080/myapp/*\"]" -s baseUrl=http://localhost:8080/myapp -s adminUrl=http://localhost:8080/myapp</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deleting a client</dt>
<dd>
<p>Use <code>delete</code> operation with the same endpoint uri as for getting a specific client. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm</pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="user-operations"><a class="anchor" href="#user-operations"></a>19.9. User operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Creating a user</dt>
<dd>
<p>To create a new user perform <code>create</code> operation on <code>users</code> endpoint. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create users -r demorealm -s username=testuser -s enabled=true</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Listing users</dt>
<dd>
<p>Use <code>users</code> endpoint to list users. Number of users may be large, and you may want to limit how many are returned:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get users -r demorealm --offset 0 --limit 1000</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It&#8217;s also possible to filter users by <code>username</code>, <code>firstName</code>, <code>lastName</code>, or <code>email</code>. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get users -r demorealm -q email=google.com
$ kcadm.sh get users -r demorealm -q username=testuser</pre>
</div>
</div>
<div class="paragraph">
<p>Note that filtering doesn&#8217;t use exact matching. For example, the above would match the value of <code>username</code> attribute against '*testuser*' pattern.</p>
</div>
<div class="paragraph">
<p>You can also filter across multiple attributes by specifying multiple <code>-q</code> options, which would return only users
that match condition for all the attributes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting a specific user</dt>
<dd>
<p>Use user&#8217;s <code>id</code> to compose an endpoint uri - <code>users/USER_ID</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Updating a user</dt>
<dd>
<p>Use <code>update</code> operation with the same endpoint uri as for getting a specific user. For example on Linux:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm -s 'requiredActions=["VERIFY_EMAIL","UPDATE_PROFILE","CONFIGURE_TOTP","UPDATE_PASSWORD"]'</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>c:\&gt; kcadm update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm -s "requiredActions=[\"VERIFY_EMAIL\",\"UPDATE_PROFILE\",\"CONFIGURE_TOTP\",\"UPDATE_PASSWORD\"]"</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Deleting a user</dt>
<dd>
<p>Use <code>delete</code> operation with the same endpoint uri as for getting a specific user. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Resetting user&#8217;s password</dt>
<dd>
<p>There is a dedicated <code>set-password</code> command specifically to reset user&#8217;s password. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh set-password -r demorealm --username testuser --new-password NEWPASSWORD --temporary</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>That will set a temporary password for the user, which they will have to change the next time they login.</p>
</div>
<div class="paragraph">
<p>You can use <code>--userid</code> if you want to specify the user by using <code>id</code> attribute.</p>
</div>
<div class="paragraph">
<p>The same can be achieved using <code>update</code> operation on an endpoint constructed from one for getting a specific user - <code>users/USER_ID/reset-password</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2/reset-password -r demorealm -s type=password -s value=NEWPASSWORD -s temporary=true -n</pre>
</div>
</div>
<div class="paragraph">
<p>The last parameter (<code>-n</code>) ensures that only PUT is performed without a prior GET. In this case it is necessary since <code>reset-password</code> endpoint doesn&#8217;t support GET.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing assigned, available, and effective realm roles for a user</dt>
<dd>
<p>Use a dedicated <code>get-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list <strong>assigned</strong> realm roles for the user you can specify the target user by either <code>username</code> or <code>id</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --uusername testuser</pre>
</div>
</div>
<div class="paragraph">
<p>To list <strong>effective</strong> realm roles, use additional <code>--effective</code> option.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --uusername testuser --effective</pre>
</div>
</div>
<div class="paragraph">
<p>To list realm roles that can still be added to the user, use <code>--available</code> option instead.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --uusername testuser --available</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing assigned, available, and effective client roles for a user</dt>
<dd>
<p>Use a dedicated <code>get-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list <strong>assigned</strong> client roles for the user you can specify the target user by either <code>username</code> (via --uusername option) or <code>id</code> (via --uid option),
and client by either <code>clientId</code> (via --cclientid option) or <code>id</code> (via --cid option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management</pre>
</div>
</div>
<div class="paragraph">
<p>To list <strong>effective</strong> realm roles, use additional <code>--effective</code> option.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management --effective</pre>
</div>
</div>
<div class="paragraph">
<p>To list realm roles that can still be added to the user, use <code>--available</code> option instead.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management --available</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding realm roles to a user</dt>
<dd>
<p>Use a dedicated <code>add-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to add 'user' role to user 'testuser' :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh add-roles --username testuser --rolename user -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing realm roles from a user</dt>
<dd>
<p>Use a dedicated <code>remove-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to remove 'user' role from user 'testuser':</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh remove-roles --username testuser --rolename user -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding client roles to a user</dt>
<dd>
<p>Use a dedicated <code>add-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to add to user <code>testuser</code> two roles defined on client <code>realm management</code> - <code>create-client</code> role and <code>view-users</code> role:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh add-roles -r demorealm --uusername testuser --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing client roles from a user</dt>
<dd>
<p>Use a dedicated <code>remove-roles</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to remove from user <code>testuser</code> two roles defined on client <code>realm management</code> - <code>create-client</code> role and <code>view-users</code> role:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh remove-roles -r demorealm --uusername testuser --cclientid realm-management --rolename create-client --rolename view-users</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing user&#8217;s sessions</dt>
<dd>
<p>First identify user&#8217;s <code>id</code> then use it to compose an endpoint uri - <code>users/ID/sessions</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Now use <code>get</code> to retrieve a list of user&#8217;s sessions.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$kcadm get users/6da5ab89-3397-4205-afaa-e201ff638f9e/sessions</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Logging out user from specific session</dt>
<dd>
<p>To logout the user&#8217;s session first get session&#8217;s <code>id</code> as described above.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Use session&#8217;s <code>id</code> to compose an endpoint uri - <code>sessions/ID</code>.</p>
</div>
<div class="paragraph">
<p>Then use <code>delete</code> to invalidate it. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete sessions/d0eaa7cc-8c5d-489d-811a-69d3c4ec84d1</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Logging out user from all sessions</dt>
<dd>
<p>You need user&#8217;s <code>id</code> to construct an endpoint uri - <code>users/ID/logout</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Use 'create' to perform POST on that endpoint uri:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create users/6da5ab89-3397-4205-afaa-e201ff638f9e/logout -r demorealm -s realm=demorealm -s user=6da5ab89-3397-4205-afaa-e201ff638f9e</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="group-operations"><a class="anchor" href="#group-operations"></a>19.10. Group operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Creating a group</dt>
<dd>
<p>Use <code>create</code> operation on <code>groups</code> endpoint to create a new group:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create groups -r demorealm -s name=Group</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Listing groups</dt>
<dd>
<p>Use <code>get</code> operation on <code>groups</code> endpoint to list groups:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get groups -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Getting a specific group</dt>
<dd>
<p>Use group&#8217;s <code>id</code> to construct an endpoint uri - groups/GROUP_ID:</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get groups/51204821-0580-46db-8f2d-27106c6b5ded -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Updating a group</dt>
<dd>
<p>Use <code>update</code> operation with the same endpoint uri as for getting a specific group. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update groups/51204821-0580-46db-8f2d-27106c6b5ded -s 'attributes.email=["group@example.com"]' -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Deleting a group</dt>
<dd>
<p>Use <code>delete</code> operation with the same endpoint uri as for getting a specific group. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete groups/51204821-0580-46db-8f2d-27106c6b5ded -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Creating a sub-group</dt>
<dd>
<p>Find 'id' of the parent group - by listing groups for example. Use that <code>id</code> to construct an endpoint uri - groups/GROUP_ID/children:</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create groups/51204821-0580-46db-8f2d-27106c6b5ded/children -r demorealm -s name=SubGroup</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Moving a group under another group</dt>
<dd>
<p>Find 'id' of existing parent group, and of existing child group. Use parent group&#8217;s <code>id</code> to construct and endpoint uri - groups/PARENT_GROUP_ID/children.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Perform 'create' operation on this endpoint, and pass child group <code>id</code> as JSON body. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create groups/51204821-0580-46db-8f2d-27106c6b5ded/children -r demorealm -s id=08d410c6-d585-4059-bb07-54dcb92c5094</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Get groups for specific user</dt>
<dd>
<p>To get user&#8217;s membership in groups, use user&#8217;s <code>id</code> to compose an endpoint URI - <code>users/USER_ID/groups</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding user to a group</dt>
<dd>
<p>To join user to a group use <code>update</code> operation with an endpoint uri composed from user&#8217;s <code>id</code>, and group&#8217;s <code>id</code> - users/USER_ID/groups/GROUP_ID.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups/ce01117a-7426-4670-a29a-5c118056fe20 -r demorealm -s realm=demorealm -s userId=b544f379-5fc4-49e5-8a8d-5cfb71f46f53 -s groupId=ce01117a-7426-4670-a29a-5c118056fe20 -n</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing user from a group</dt>
<dd>
<p>To remove user from a group use <code>delete</code> operation on the same endpoint uri as used for adding user to a group - users/USER_ID/groups/GROUP_ID.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups/ce01117a-7426-4670-a29a-5c118056fe20 -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing assigned, available, and effective realm roles for a group</dt>
<dd>
<p>Use a dedicated 'get-roles' command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list <strong>assigned</strong> realm roles for the group you can specify the target group by <code>name</code> (via <code>--gname</code> option),
<code>path</code> (via <code>--gpath</code> option), or <code>id</code> (via <code>--gid</code> option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --gname Group</pre>
</div>
</div>
<div class="paragraph">
<p>To list <strong>effective</strong> realm roles, use additional <code>--effective</code> option.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --gname Group --effective</pre>
</div>
</div>
<div class="paragraph">
<p>To list realm roles that can still be added to the group, use <code>--available</code> option instead.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --gname Group --available</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing assigned, available, and effective client roles for a group</dt>
<dd>
<p>Use a dedicated 'get-roles' command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To list <strong>assigned</strong> client roles for the user you can specify the target group by either <code>name</code> (via --gname option) or <code>id</code> (via <code>--gid</code> option),
and client by either <code>clientId</code> (via <code>--cclientid</code> option) or <code>id</code> (via <code>--id</code> option).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management</pre>
</div>
</div>
<div class="paragraph">
<p>To list <strong>effective</strong> realm roles, use additional <code>--effective</code> option.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management --effective</pre>
</div>
</div>
<div class="paragraph">
<p>To list realm roles that can still be added to the group, use <code>--available</code> option instead.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management --available</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="identity-providers-operations"><a class="anchor" href="#identity-providers-operations"></a>19.11. Identity Providers operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing available identity providers</dt>
<dd>
<p>Use <code>serverinfo</code> endpoint to list available identity providers. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get serverinfo -r demorealm --fields 'identityProviders(*)'</pre>
</div>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note that <code>serverinfo</code> endpoint is handled similarly to <code>realms</code> endpoint in that it is not resolved
relative to target realm, because it exists outside any specific realm.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing configured identity providers</dt>
<dd>
<p>Use <code>identity-provider/instances</code> endpoint. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get identity-provider/instances -r demorealm --fields alias,providerId,enabled</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Getting a specific configured identity provider</dt>
<dd>
<p>To get a specific identity provider use <code>alias</code> attribute of identity provider to construct an endpoint uri - <code>identity-provider/instances/ALIAS</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get identity-provider/instances/facebook -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing a specific configured identity provider</dt>
<dd>
<p>Use <code>delete</code> operation with the same endpoint uri as for getting a specific configured identity provider. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete identity-provider/instances/facebook -r demorealm</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a Keycloak OpenID Connect identity provider</dt>
<dd>
<p>Use <code>keycloak-oidc</code> as <code>providerId</code> when creating a new identity provider instance.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Provide config attributes <code>authorizationUrl</code>, <code>tokenUrl</code>, <code>clientId</code>, and <code>clientSecret</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=keycloak-oidc -s providerId=keycloak-oidc -s enabled=true -s 'config.useJwksUrl="true"' -s config.authorizationUrl=http://localhost:8180/auth/realms/demorealm/protocol/openid-connect/auth -s config.tokenUrl=http://localhost:8180/auth/realms/demorealm/protocol/openid-connect/token -s config.clientId=demo-oidc-provider -s config.clientSecret=secret</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring an OpenID Connect identity provider</dt>
<dd>
<p>You configure the generic OpenID Connect provider the same way as Keycloak OpenID Connect provider, except that you set
<code>providerId</code> attribute value to <code>oidc</code>.</p>
</dd>
<dt class="hdlist1">Configuring a SAML 2 identity provider</dt>
<dd>
<p>Use <code>saml</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>singleSignOnServiceUrl</code>, <code>nameIDPolicyFormat</code>, and <code>signatureAlgorithm</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=saml -s providerId=saml -s enabled=true -s 'config.useJwksUrl="true"' -s config.singleSignOnServiceUrl=http://localhost:8180/auth/realms/saml-broker-realm/protocol/saml -s config.nameIDPolicyFormat=urn:oasis:names:tc:SAML:2.0:nameid-format:persistent -s config.signatureAlgorithm=RSA_SHA256</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring a Facebook identity provider</dt>
<dd>
<p>Use <code>facebook</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code> and <code>clientSecret</code>
as obtained from Facebook Developers application configuration page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=facebook -s providerId=facebook -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=FACEBOOK_CLIENT_ID -s config.clientSecret=FACEBOOK_CLIENT_SECRET</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a Google identity provider</dt>
<dd>
<p>Use <code>google</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code> and <code>clientSecret</code>
as obtained from Google Developers application configuration page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=google -s providerId=google -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=GOOGLE_CLIENT_ID -s config.clientSecret=GOOGLE_CLIENT_SECRET</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a Twitter identity provider</dt>
<dd>
<p>Use <code>twitter</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code> and <code>clientSecret</code>
as obtained from Twitter Application Management application configuration page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=google -s providerId=google -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=TWITTER_API_KEY -s config.clientSecret=TWITTER_API_SECRET</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a GitHub identity provider</dt>
<dd>
<p>Use <code>github</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code> and <code>clientSecret</code>
as obtained from GitHub Developer Application Settings page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=github -s providerId=github -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=GITHUB_CLIENT_ID -s config.clientSecret=GITHUB_CLIENT_SECRET</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a LinkedIn identity provider</dt>
<dd>
<p>Use <code>linkedin</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code> and <code>clientSecret</code>
as obtained from LinkedIn Developer Console application page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=linkedin -s providerId=linkedin -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=LINKEDIN_CLIENT_ID -s config.clientSecret=LINKEDIN_CLIENT_SECRET</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a Microsoft Live identity provider</dt>
<dd>
<p>Use <code>microsoft</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code> and <code>clientSecret</code>
as obtained from Microsoft Application Registration Portal page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=microsoft -s providerId=microsoft -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=MICROSOFT_APP_ID -s config.clientSecret=MICROSOFT_PASSWORD</pre>
</div>
</div>
</dd>
<dt class="hdlist1">Configuring a StackOverflow identity provider</dt>
<dd>
<p>Use <code>stackoverflow</code> as <code>providerId</code>. Provide <code>config</code> attributes - <code>clientId</code>, <code>clientSecret</code> and <code>key</code>
as obtained from Stack Apps OAuth page for your application.</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create identity-provider/instances -r demorealm -s alias=stackoverflow -s providerId=stackoverflow -s enabled=true  -s 'config.useJwksUrl="true"' -s config.clientId=STACKAPPS_CLIENT_ID -s config.clientSecret=STACKAPPS_CLIENT_SECRET -s config.key=STACKAPPS_KEY</pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="storage-providers-operations"><a class="anchor" href="#storage-providers-operations"></a>19.12. Storage Providers operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring a Kerberos storage provider</dt>
<dd>
<p>Use <code>create</code> against <code>user-federation/instances</code> endpoint. Specify <code>kerberos</code> as a value of <code>providerName</code> attribute.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create user-federation/instances -r demorealm -s providerName=kerberos -s priority=0 -s config.debug=false -s config.allowPasswordAuthentication=true -s 'config.editMode="UNSYNCED"' -s config.updateProfileFirstLogin=true -s config.allowKerberosAuthentication=true -s 'config.kerberosRealm="KEYCLOAK.ORG"' -s 'config.keyTab="http.keytab"' -s 'config.serverPrincipal="HTTP/localhost@KEYCLOAK.ORG"'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring an LDAP user storage provider</dt>
<dd>
<p>Use <code>create</code> against <code>components</code> endpoint. Specify <code>ldap</code> as a value of <code>providerId</code> attribute, and <code>org.keycloak.storage.UserStorageProvider</code> as value of <code>providerType</code> attribute. Provide realm <code>id</code> as value of <code>parentId</code> attribute.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to create a Kerberos integrated LDAP provider:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=kerberos-ldap-provider -s providerId=ldap -s providerType=org.keycloak.storage.UserStorageProvider -s parentId=3d9c572b-8f33-483f-98a6-8bb421667867  -s 'config.priority=["1"]' -s 'config.fullSyncPeriod=["-1"]' -s 'config.changedSyncPeriod=["-1"]' -s 'config.cachePolicy=["DEFAULT"]' -s config.evictionDay=[] -s config.evictionHour=[] -s config.evictionMinute=[] -s config.maxLifespan=[] -s 'config.batchSizeForSync=["1000"]' -s 'config.editMode=["WRITABLE"]' -s 'config.syncRegistrations=["false"]' -s 'config.vendor=["other"]' -s 'config.usernameLDAPAttribute=["uid"]' -s 'config.rdnLDAPAttribute=["uid"]' -s 'config.uuidLDAPAttribute=["entryUUID"]' -s 'config.userObjectClasses=["inetOrgPerson, organizationalPerson"]' -s 'config.connectionUrl=["ldap://localhost:10389"]'  -s 'config.usersDn=["ou=People,dc=keycloak,dc=org"]' -s 'config.authType=["simple"]' -s 'config.bindDn=["uid=admin,ou=system"]' -s 'config.bindCredential=["secret"]' -s 'config.searchScope=["1"]' -s 'config.useTruststoreSpi=["ldapsOnly"]' -s 'config.connectionPooling=["true"]' -s 'config.pagination=["true"]' -s 'config.allowKerberosAuthentication=["true"]' -s 'config.serverPrincipal=["HTTP/localhost@KEYCLOAK.ORG"]' -s 'config.keyTab=["http.keytab"]' -s 'config.kerberosRealm=["KEYCLOAK.ORG"]' -s 'config.debug=["true"]' -s 'config.useKerberosForPasswordAuthentication=["true"]'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Removing a user storage provider instance</dt>
<dd>
<p>Use storage provider instance&#8217;s <code>id</code> attribute to compose an endpoint uri - <code>components/ID</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Perform <code>delete</code> operation against this endpoint. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh delete components/3d9c572b-8f33-483f-98a6-8bb421667867 -r demorealm</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Triggering synchronization of all users for specific user storage provider</dt>
<dd>
<p>Use storage provider&#8217;s <code>id</code> attribute to compose an endpoint uri - user-storage/ID_OF_USER_STORAGE_INSTANCE/sync
Add <code>action=triggerFullSync</code> query parameter and perform <code>create</code> command.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create user-storage/b7c63d02-b62a-4fc1-977c-947d6a09e1ea/sync?action=triggerFullSync</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Triggering synchronization of changed users for specific user storage provider</dt>
<dd>
<p>Use storage provider&#8217;s <code>id</code> attribute to compose an endpoint uri - user-storage/ID_OF_USER_STORAGE_INSTANCE/sync
Add <code>action=triggerChangedUsersSync</code> query parameter and use <code>create</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create user-storage/b7c63d02-b62a-4fc1-977c-947d6a09e1ea/sync?action=triggerChangedUsersSync</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Test LDAP user storage connectivity</dt>
<dd>
<p>Perform <code>get</code> operation on <code>testLDAPConnection</code> endpoint. Provide query parameters <code>bindCredential</code>, <code>bindDn</code>, <code>connectionUrl</code>, and <code>useTruststoreSpi</code>, and set <code>action</code> query parameter to <code>testConnection</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get testLDAPConnection -q action=testConnection -q bindCredential=secret -q bindDn=uid=admin,ou=system -q connectionUrl=ldap://localhost:10389 -q useTruststoreSpi=ldapsOnly</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Test LDAP user storage authentication</dt>
<dd>
<p>Perform <code>get</code> operation on <code>testLDAPConnection</code> endpoint. Provide query parameters <code>bindCredential</code>, <code>bindDn</code>, <code>connectionUrl</code>, and <code>useTruststoreSpi</code>, and set <code>action</code> query parameter to <code>testAuthentication</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get testLDAPConnection -q action=testAuthentication -q bindCredential=secret -q bindDn=uid=admin,ou=system -q connectionUrl=ldap://localhost:10389 -q useTruststoreSpi=ldapsOnly</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-mappers"><a class="anchor" href="#adding-mappers"></a>19.13. Adding mappers</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding a hardcoded role LDAP mapper</dt>
<dd>
<p>Use <code>create</code> on <code>components</code> endpoint. Set <code>providerType</code> attribute to <code>org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>. Set <code>parentId</code> attribute to <code>id</code> of LDAP provider instance.
Set <code>providerId</code> attribute to <code>hardcoded-ldap-role-mapper</code>. Make sure to provide a value of <code>role</code> config parameter.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=hardcoded-ldap-role-mapper -s providerId=hardcoded-ldap-role-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config.role=["realm-management.create-client"]'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding a MS Active Directory mapper</dt>
<dd>
<p>Use <code>create</code> on <code>components</code> endpoint. Set <code>providerType</code> attribute to <code>org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>. Set <code>parentId</code> attribute to <code>id</code> of LDAP provider instance.
Set <code>providerId</code> attribute to <code>msad-user-account-control-mapper</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=msad-user-account-control-mapper -s providerId=msad-user-account-control-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding an user attribute LDAP mapper</dt>
<dd>
<p>Use <code>create</code> on <code>components</code> endpoint. Set <code>providerType</code> attribute to <code>org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>. Set <code>parentId</code> attribute to <code>id</code> of LDAP provider instance.
Set <code>providerId</code> attribute to <code>user-attribute-ldap-mapper</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=user-attribute-ldap-mapper -s providerId=user-attribute-ldap-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config."user.model.attribute"=["email"]' -s 'config."ldap.attribute"=["mail"]' -s 'config."read.only"=["false"]' -s 'config."always.read.value.from.ldap"=["false"]' -s 'config."is.mandatory.in.ldap"=["false"]'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding a group LDAP mapper</dt>
<dd>
<p>Use <code>create</code> on <code>components</code> endpoint. Set <code>providerType</code> attribute to <code>org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>. Set <code>parentId</code> attribute to <code>id</code> of LDAP provider instance.
Set <code>providerId</code> attribute to <code>group-ldap-mapper</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=group-ldap-mapper -s providerId=group-ldap-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config."groups.dn"=[]' -s 'config."group.name.ldap.attribute"=["cn"]' -s 'config."group.object.classes"=["groupOfNames"]' -s 'config."preserve.group.inheritance"=["true"]' -s 'config."membership.ldap.attribute"=["member"]' -s 'config."membership.attribute.type"=["DN"]' -s 'config."groups.ldap.filter"=[]' -s 'config.mode=["LDAP_ONLY"]' -s 'config."user.roles.retrieve.strategy"=["LOAD_GROUPS_BY_MEMBER_ATTRIBUTE"]' -s 'config."mapped.group.attributes"=["admins-group"]' -s 'config."drop.non.existing.groups.during.sync"=["false"]' -s 'config.roles=["admins"]' -s 'config.groups=["admins-group"]' -s 'config.group=[]' -s 'config.preserve=["true"]' -s 'config.membership=["member"]'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Adding a full name LDAP mapper</dt>
<dd>
<p>Use <code>create</code> on <code>components</code> endpoint. Set <code>providerType</code> attribute to <code>org.keycloak.storage.ldap.mappers.LDAPStorageMapper</code>. Set <code>parentId</code> attribute to <code>id</code> of LDAP provider instance.
Set <code>providerId</code> attribute to <code>full-name-ldap-mapper</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh create components -r demorealm -s name=full-name-ldap-mapper -s providerId=full-name-ldap-mapper -s providerType=org.keycloak.storage.ldap.mappers.LDAPStorageMapper -s parentId=b7c63d02-b62a-4fc1-977c-947d6a09e1ea -s 'config."ldap.full.name.attribute"=["cn"]' -s 'config."read.only"=["false"]' -s 'config."write.only"=["true"]'</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="authentication-operations"><a class="anchor" href="#authentication-operations"></a>19.14. Authentication operations</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Setting a password policy</dt>
<dd>
<p>Set realm&#8217;s <code>passwordPolicy</code> attribute to enumeration expression that includes the specific policy provider id, and optional configuration.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to set password policy to default values - i.e.: 27500 hashing iterations, requiring at least one special character, at least one uppercase character,
at least one digit character, not be equal to user&#8217;s <code>username</code>, and be at least 8 characters long you would use the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update realms/demorealm -s 'passwordPolicy="hashIterations and specialChars and upperCase and digits and notUsername and length"'</pre>
</div>
</div>
<div class="paragraph">
<p>If you want want to use values different from defaults, pass configuration in brackets.</p>
</div>
<div class="paragraph">
<p>For example, to set password policy to 25000 hash iterations, requiring at least two special characters, at least two uppercase characters, at least two lowercase characters, at least two digits, be at least nine characters long, not be equal to user&#8217;s username, and not repeat for at least four changes back:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh update realms/demorealm -s 'passwordPolicy="hashIterations(25000) and specialChars(2) and upperCase(2) and lowerCase(2) and digits(2) and length(9) and notUsername and passwordHistory(4)"'</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Getting the current password policy</dt>
<dd>
<p>Get current realm configuration and filter out everything but <code>passwordPolicy</code> attribute.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For example, to display <code>passwordPolicy</code> for demorealm:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get realms/demorealm --fields passwordPolicy</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Listing authentication flows</dt>
<dd>
<p>Use <code>get</code> operation on <code>authentication/flows</code> endpoint. For example:</p>
<div class="literalblock">
<div class="content">
<pre>$ kcadm.sh get authentication/flows -r demorealm</pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-12-06 12:00:10 JST
</div>
</div>
<ul id="globalnav">
    <li><a href="../getting_started/index.html">Getting Started</a></li>
    <li><a href="../server_installation/index.html">Server Installation</a></li>
    <li><a href="../securing_apps/index.html">Securing Apps</a></li>
    <li><a href="../server_admin/index.html">Server Admin</a></li>
    <li><a href="../server_development/index.html">Server Development</a></li>
    <li><a href="../authorization_services/index.html">Authorization Services</a></li>
    <li><a href="../upgrading/index.html">Upgrading</a></li>
</ul>
</body>
</html>