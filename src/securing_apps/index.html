<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Overview</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Global Navbar */

ul#globalnav {
    background-color: #ededed;

    list-style: none;
    width: 100%;
    margin: 0;
    padding: 0;

    overflow: hidden;
    position: fixed;
    left: 0px;
    top: 0px;
    font-size: 0.6em;
    height: 30px;
}

ul#globalnav::after {
    content: "";
    display: block;
    clear: both;
}

ul#globalnav li {
    float: left;
}

ul#globalnav li a {
    display: inline-block;
    color: #004670;
    text-align: center;
    padding: 0.75em;
    text-decoration: none;
}

ul#globalnav li a:hover {
    color: #428bca;
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    ul#globalnav {
        font-size: 0.75em;
        height: 40px;
    }

    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    ul#globalnav {
        font-size: 1em;
        height: 48px;
    }

    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}

</style>

<style>
/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">1. Overview</a>
<ul class="sectlevel2">
<li><a href="#what-are-client-adapters">1.1. What are Client Adapters?</a></li>
<li><a href="#supported-platforms">1.2. Supported Platforms</a>
<ul class="sectlevel3">
<li><a href="#openid-connect">1.2.1. OpenID Connect</a></li>
<li><a href="#c">1.2.2. C#</a></li>
<li><a href="#python">1.2.3. Python</a></li>
<li><a href="#android">1.2.4. Android</a></li>
<li><a href="#ios">1.2.5. iOS</a></li>
<li><a href="#saml">1.2.6. SAML</a></li>
</ul>
</li>
<li><a href="#supported-protocols">1.3. Supported Protocols</a>
<ul class="sectlevel3">
<li><a href="#openid-connect-2">1.3.1. OpenID Connect</a></li>
<li><a href="#saml-2-0">1.3.2. SAML 2.0</a></li>
<li><a href="#openid-connect-vs-saml">1.3.3. OpenID Connect vs. SAML</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#openid-connect-3">2. OpenID Connect</a>
<ul class="sectlevel2">
<li><a href="#java-adapters">2.1. Java Adapters</a>
<ul class="sectlevel3">
<li><a href="#_java_adapter_config">2.1.1. Java Adapter Config</a></li>
<li><a href="#_jboss_adapter">2.1.2. JBoss EAP/Wildfly Adapter</a></li>
<li><a href="#_fuse_adapter">2.1.3. JBoss Fuse Adapter</a></li>
<li><a href="#_spring_boot_adapter">2.1.4. Spring Boot Adapter</a></li>
<li><a href="#_tomcat_adapter">2.1.5. Tomcat 6, 7 and 8 Adapters</a></li>
<li><a href="#_jetty9_adapter">2.1.6. Jetty 9.x Adapters</a></li>
<li><a href="#_jetty8_adapter">2.1.7. Jetty 8.1.x Adapter</a></li>
<li><a href="#_spring_security_adapter">2.1.8. Spring Security Adapter</a></li>
<li><a href="#_servlet_filter_adapter">2.1.9. Java Servlet Filter Adapter</a></li>
<li><a href="#_jaas_adapter">2.1.10. JAAS plugin</a></li>
<li><a href="#_installed_adapter">2.1.11. CLI / Desktop Applications</a></li>
<li><a href="#security-context">2.1.12. Security Context</a></li>
<li><a href="#_adapter_error_handling">2.1.13. Error Handling</a></li>
<li><a href="#logout">2.1.14. Logout</a></li>
<li><a href="#parameters-forwarding">2.1.15. Parameters Forwarding</a></li>
<li><a href="#_client_authentication_adapter">2.1.16. Client Authentication</a></li>
<li><a href="#_multi_tenancy">2.1.17. Multi Tenancy</a></li>
<li><a href="#_applicationclustering">2.1.18. Application Clustering</a></li>
</ul>
</li>
<li><a href="#_javascript_adapter">2.2. Javascript Adapter</a>
<ul class="sectlevel3">
<li><a href="#session-status-iframe">2.2.1. Session Status iframe</a></li>
<li><a href="#_javascript_implicit_flow">2.2.2. Implicit and Hybrid Flow</a></li>
<li><a href="#earlier-browsers">2.2.3. Earlier Browsers</a></li>
<li><a href="#javascript-adapter-reference">2.2.4. JavaScript Adapter Reference</a></li>
</ul>
</li>
<li><a href="#_nodejs_adapter">2.3. Node.js Adapter</a>
<ul class="sectlevel3">
<li><a href="#installation">2.3.1. Installation</a></li>
<li><a href="#usage-2">2.3.2. Usage</a></li>
<li><a href="#installing-middleware">2.3.3. Installing Middleware</a></li>
<li><a href="#protecting-resources">2.3.4. Protecting Resources</a></li>
<li><a href="#additional-urls">2.3.5. Additional URLs</a></li>
</ul>
</li>
<li><a href="#other-openid-connect-libraries">2.4. Other OpenID Connect Libraries</a>
<ul class="sectlevel3">
<li><a href="#endpoints">2.4.1. Endpoints</a></li>
<li><a href="#flows">2.4.2. Flows</a></li>
<li><a href="#redirect-uris">2.4.3. Redirect URIs</a></li>
<li><a href="#_mod_auth_openidc">2.4.4. mod_auth_openidc Apache HTTPD Module</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#saml-2">3. SAML</a>
<ul class="sectlevel2">
<li><a href="#java-adapters-2">3.1. Java Adapters</a>
<ul class="sectlevel3">
<li><a href="#_saml-general-config">3.1.1. General Adapter Config</a></li>
<li><a href="#_saml_jboss_adapter">3.1.2. JBoss EAP/Wildfly Adapter</a></li>
<li><a href="#_saml-tomcat-adapter">3.1.3. Tomcat SAML adapters</a></li>
<li><a href="#_jetty_saml_adapter">3.1.4. Jetty SAML Adapters</a></li>
<li><a href="#java-servlet-filter-adapter">3.1.5. Java Servlet Filter Adapter</a></li>
<li><a href="#registering-with-an-identity-provider">3.1.6. Registering with an Identity Provider</a></li>
<li><a href="#logout-2">3.1.7. Logout</a></li>
<li><a href="#obtaining-assertion-attributes">3.1.8. Obtaining Assertion Attributes</a></li>
<li><a href="#error-handling">3.1.9. Error Handling</a></li>
<li><a href="#troubleshooting">3.1.10. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_mod_auth_mellon">3.2. mod_auth_mellon Apache HTTPD Module</a>
<ul class="sectlevel3">
<li><a href="#configuring-mod_auth_mellon-with-keycloak">3.2.1. Configuring mod_auth_mellon with Keycloak</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#docker-registry-configuration">4. Docker Registry Configuration</a>
<ul class="sectlevel2">
<li><a href="#docker-registry-configuration-file-installation">4.1. Docker Registry Configuration File Installation</a></li>
<li><a href="#docker-registry-environment-variable-override-installation">4.2. Docker Registry Environment Variable Override Installation</a></li>
<li><a href="#docker-compose-yaml-file">4.3. Docker Compose YAML File</a></li>
</ul>
</li>
<li><a href="#_client_registration">5. Client Registration</a>
<ul class="sectlevel2">
<li><a href="#authentication">5.1. Authentication</a>
<ul class="sectlevel3">
<li><a href="#bearer-token">5.1.1. Bearer Token</a></li>
<li><a href="#_initial_access_token">5.1.2. Initial Access Token</a></li>
<li><a href="#_registration_access_token">5.1.3. Registration Access Token</a></li>
</ul>
</li>
<li><a href="#keycloak-representations">5.2. Keycloak Representations</a></li>
<li><a href="#keycloak-adapter-configuration">5.3. Keycloak Adapter Configuration</a></li>
<li><a href="#openid-connect-dynamic-client-registration">5.4. OpenID Connect Dynamic Client Registration</a></li>
<li><a href="#saml-entity-descriptors">5.5. SAML Entity Descriptors</a></li>
<li><a href="#example-using-curl-2">5.6. Example using CURL</a></li>
<li><a href="#example-using-java-client-registration-api">5.7. Example using Java Client Registration API</a></li>
<li><a href="#client-registration-policies">5.8. Client Registration Policies</a></li>
</ul>
</li>
<li><a href="#_client_registration_cli">6. Client Registration CLI</a>
<ul class="sectlevel2">
<li><a href="#_configuring_a_user_for_client_registration_cli">6.1. Configuring a new regular user for use with Client Registration CLI</a></li>
<li><a href="#_configuring_a_client_for_use_with_client_registration_cli">6.2. Configuring a client for use with Client Registration CLI</a></li>
<li><a href="#_installing_client_registration_cli">6.3. Installing Client Registration CLI</a></li>
<li><a href="#_using_client_registration_cli">6.4. Using Client Registration CLI</a>
<ul class="sectlevel3">
<li><a href="#_logging_in">6.4.1. Logging In</a></li>
<li><a href="#_working_with_alternative_configurations">6.4.2. Working with alternative configurations</a></li>
<li><a href="#_initial_access_and_registration_access_tokens">6.4.3. Initial Access and Registration Access Tokens</a></li>
<li><a href="#_performing_crud_operations">6.4.4. Creating client configuration</a></li>
<li><a href="#retrieving-client-configuration">6.4.5. Retrieving client configuration</a></li>
<li><a href="#modifying-client-configuration">6.4.6. Modifying client configuration</a></li>
<li><a href="#deleting-client-configuration">6.4.7. Deleting client configuration</a></li>
<li><a href="#_refreshing_invalid_registration_access_tokens">6.4.8. Refreshing Invalid Registration Access Tokens</a></li>
</ul>
</li>
<li><a href="#_troubleshooting_2">6.5. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#_token-exchange">7. Token Exchange</a>
<ul class="sectlevel2">
<li><a href="#internal-token-to-internal-token-exchange">7.1. Internal Token to Internal Token Exchange</a>
<ul class="sectlevel3">
<li><a href="#_client_to_client_permission">7.1.1. Granting Permission for the Exchange</a></li>
<li><a href="#making-the-request">7.1.2. Making the Request</a></li>
</ul>
</li>
<li><a href="#internal-token-to-external-token-exchange">7.2. Internal Token to External Token Exchange</a>
<ul class="sectlevel3">
<li><a href="#_grant_permission_external_exchange">7.2.1. Granting Permission for the Exchange</a></li>
<li><a href="#_internal_external_making_request">7.2.2. Making the Request</a></li>
</ul>
</li>
<li><a href="#external-token-to-internal-token-exchange">7.3. External Token to Internal Token Exchange</a>
<ul class="sectlevel3">
<li><a href="#granting-permission-for-the-exchange">7.3.1. Granting Permission for the Exchange</a></li>
<li><a href="#making-the-request-2">7.3.2. Making the Request</a></li>
</ul>
</li>
<li><a href="#impersonation">7.4. Impersonation</a>
<ul class="sectlevel3">
<li><a href="#granting-permission-for-the-exchange-2">7.4.1. Granting Permission for the Exchange</a></li>
<li><a href="#making-the-request-3">7.4.2. Making the Request</a></li>
</ul>
</li>
<li><a href="#direct-naked-impersonation">7.5. Direct Naked Impersonation</a>
<ul class="sectlevel3">
<li><a href="#granting-permission-for-the-exchange-3">7.5.1. Granting Permission for the Exchange</a></li>
<li><a href="#making-the-request-4">7.5.2. Making the Request</a></li>
</ul>
</li>
<li><a href="#expand-permission-model-with-service-accounts">7.6. Expand Permission Model With Service Accounts</a></li>
<li><a href="#exchange-vulnerabilities">7.7. Exchange Vulnerabilities</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a>1. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak supports both OpenID Connect (an extension to OAuth 2.0) and SAML 2.0. When securing clients and services the first thing you need to
decide is which of the two you are going to use. If you want you can also choose to secure some with OpenID Connect and others with SAML.</p>
</div>
<div class="paragraph">
<p>To secure clients and services you are also going to need an adapter or library for the protocol you&#8217;ve selected. Keycloak comes with its own
adapters for selected platforms, but it is also possible to use generic OpenID Connect Resource Provider and SAML Service Provider libraries.</p>
</div>
<div class="sect2">
<h3 id="what-are-client-adapters"><a class="anchor" href="#what-are-client-adapters"></a>1.1. What are Client Adapters?</h3>
<div class="paragraph">
<p>Keycloak client adapters are libraries that makes it very easy to secure applications and services with Keycloak. We call them
adapters rather than libraries as they provide a tight integration to the underlying platform and framework. This makes our adapters easy to use and they
require less boilerplate code than what is typically required by a library.</p>
</div>
</div>
<div class="sect2">
<h3 id="supported-platforms"><a class="anchor" href="#supported-platforms"></a>1.2. Supported Platforms</h3>
<div class="sect3">
<h4 id="openid-connect"><a class="anchor" href="#openid-connect"></a>1.2.1. OpenID Connect</h4>
<div class="sect4">
<h5 id="java"><a class="anchor" href="#java"></a>Java</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_jboss_adapter">JBoss EAP</a></p>
</li>
<li>
<p><a href="#_jboss_adapter">WildFly</a></p>
</li>
<li>
<p><a href="#_fuse_adapter">Fuse</a></p>
</li>
<li>
<p><a href="#_tomcat_adapter">Tomcat</a></p>
</li>
<li>
<p><a href="#_jetty8_adapter">Jetty 8</a></p>
</li>
<li>
<p><a href="#_servlet_filter_adapter">Servlet Filter</a></p>
</li>
<li>
<p><a href="#_spring_security_adapter">Spring Security</a> (community)</p>
</li>
<li>
<p><a href="#_spring_boot_adapter">Spring Boot</a> (community)</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="javascript-client-side"><a class="anchor" href="#javascript-client-side"></a>JavaScript (client-side)</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_javascript_adapter">JavaScript</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="node-js-server-side"><a class="anchor" href="#node-js-server-side"></a>Node.js (server-side)</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_nodejs_adapter">Node.js</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="javascript"><a class="anchor" href="#javascript"></a>JavaScript</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_javascript_adapter">JavaScript</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="node-js"><a class="anchor" href="#node-js"></a>Node.js</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/keycloak/keycloak-nodejs-connect">Keycloak Connect</a> (community)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="c"><a class="anchor" href="#c"></a>1.2.2. C#</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/dylanplecki/KeycloakOwinAuthentication">OWIN</a> (community)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="python"><a class="anchor" href="#python"></a>1.2.3. Python</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://pypi.python.org/pypi/oic/">oidc</a> (generic)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="android"><a class="anchor" href="#android"></a>1.2.4. Android</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/openid/AppAuth-Android">AppAuth</a> (generic)</p>
</li>
<li>
<p><a href="https://github.com/aerogear/aerogear-android-authz">AeroGear</a> (generic)</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="ios"><a class="anchor" href="#ios"></a>1.2.5. iOS</h4>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/openid/AppAuth-iOS">AppAuth</a> (generic)</p>
</li>
<li>
<p><a href="https://github.com/aerogear/aerogear-ios-oauth2">AeroGear</a> (generic)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="apache-http-server"><a class="anchor" href="#apache-http-server"></a>Apache HTTP Server</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/zmartzone/mod_auth_openidc">mod_auth_openidc</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="saml"><a class="anchor" href="#saml"></a>1.2.6. SAML</h4>
<div class="sect4">
<h5 id="java-2"><a class="anchor" href="#java-2"></a>Java</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_saml_jboss_adapter">JBoss EAP</a></p>
</li>
<li>
<p><a href="#_saml_jboss_adapter">WildFly</a></p>
</li>
<li>
<p><a href="#_tomcat_adapter">Tomcat</a></p>
</li>
<li>
<p><a href="#_jetty_saml_adapter">Jetty</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="apache-http-server-2"><a class="anchor" href="#apache-http-server-2"></a>Apache HTTP Server</h5>
<div class="ulist">
<ul>
<li>
<p><a href="#_mod_auth_mellon">mod_auth_mellon</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="supported-protocols"><a class="anchor" href="#supported-protocols"></a>1.3. Supported Protocols</h3>
<div class="sect3">
<h4 id="openid-connect-2"><a class="anchor" href="#openid-connect-2"></a>1.3.1. OpenID Connect</h4>
<div class="paragraph">
<p><a href="http://openid.net/connect/">Open ID Connect</a> (OIDC) is an authentication protocol that is an extension of <a href="https://tools.ietf.org/html/rfc6749">OAuth 2.0</a>.
While OAuth 2.0 is only a framework for building authorization protocols and is mainly incomplete, OIDC is a full-fledged authentication and authorization
protocol.  OIDC also makes heavy use of the <a href="https://jwt.io">Json Web Token</a> (JWT) set of standards.  These standards define an
identity token JSON format and ways to digitally sign and encrypt that data in a compact and web-friendly way.</p>
</div>
<div class="paragraph">
<p>There is really two types of use cases when using OIDC.  The first is an application that asks the Keycloak server to authenticate
a user for them.  After a successful login, the application will receive an <em>identity token</em> and an <em>access token</em>.  The <em>identity token</em>
contains information about the user such as username, email, and other profile information.  The <em>access token</em> is digitally signed by
the realm and contains access information (like user role mappings) that the application can use to determine what resources the user
is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services.  In this case, the client asks Keycloak
to obtain an <em>access token</em> it can use to invoke on other remote services on behalf of the user.  Keycloak authenticates the user
then asks the user for consent to grant access to the client requesting it.  The client then receives the <em>access token</em>.  This <em>access token</em>
is digitally signed by the realm.  The client can make REST invocations on remote services using this <em>access token</em>.  The REST service
extracts the <em>access token</em>, verifies the signature of the token, then decides based on access information within the token whether or not to process
the request.</p>
</div>
</div>
<div class="sect3">
<h4 id="saml-2-0"><a class="anchor" href="#saml-2-0"></a>1.3.2. SAML 2.0</h4>
<div class="paragraph">
<p><a href="http://saml.xml.org/saml-specifications">SAML 2.0</a> is a similar specification to OIDC but a lot older and more mature.  It has its roots in SOAP and the plethora
of WS-* specifications so it tends to be a bit more verbose than OIDC.  SAML 2.0 is primarily an authentication protocol
that works by exchanging XML documents between the authentication server and the application.  XML signatures and encryption are used to verify requests and responses.</p>
</div>
<div class="paragraph">
<p>In Keycloak SAML serves two types of use cases: browser applications and REST invocations.</p>
</div>
<div class="paragraph">
<p>There is really two types of use cases when using SAML.  The first is an application that asks the Keycloak server to authenticate
a user for them.  After a successful login, the application will receive an XML document that contains
something called a SAML assertion that specifies various attributes about the user.  This XML document is digitally signed by
the realm and contains access information (like user role mappings) that the application can use to determine what resources the user
is allowed to access on the application.</p>
</div>
<div class="paragraph">
<p>The second type of use cases is that of a client that wants to gain access to remote services.  In this case, the client asks Keycloak
to obtain a SAML assertion it can use to invoke on other remote services on behalf of the user.</p>
</div>
</div>
<div class="sect3">
<h4 id="openid-connect-vs-saml"><a class="anchor" href="#openid-connect-vs-saml"></a>1.3.3. OpenID Connect vs. SAML</h4>
<div class="paragraph">
<p>Choosing between OpenID Connect and SAML is not just a matter of using a newer protocol (OIDC) instead of the older more mature protocol (SAML).</p>
</div>
<div class="paragraph">
<p>In most cases Keycloak recommends using OIDC.</p>
</div>
<div class="paragraph">
<p>SAML tends to be a bit more verbose than OIDC.</p>
</div>
<div class="paragraph">
<p>Beyond verbosity of exchanged data, if you compare the specifications you&#8217;ll find that OIDC was designed to work with the web while SAML was retrofitted to work on top of the web.  For example, OIDC is also more suited for HTML5/JavaScript applications because it is
easier to implement on the client side than SAML. As tokens are in the JSON format,
they are easier to consume by JavaScript. You will also find several nice features that
make implementing security in your web applications easier. For example, check out the <a href="http://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification">iframe trick</a> that the specification uses to easily determine if a user is still logged in or not.</p>
</div>
<div class="paragraph">
<p>SAML has its uses though. As you see the OIDC specifications evolve you see they implement more and more features that SAML has had for years. What we often see is that people pick SAML over OIDC because of the perception that it is more mature and also because they already have existing applications that are secured with it.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openid-connect-3"><a class="anchor" href="#openid-connect-3"></a>2. OpenID Connect</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how you can secure applications and services with OpenID Connect using either Keycloak adapters or generic OpenID Connect
Resource Provider libraries.</p>
</div>
<div class="sect2">
<h3 id="java-adapters"><a class="anchor" href="#java-adapters"></a>2.1. Java Adapters</h3>
<div class="paragraph">
<p>Keycloak comes with a range of different adapters for Java application. Selecting the correct adapter depends on the target platform.</p>
</div>
<div class="paragraph">
<p>All Java adapters share a set of common configuration options described in the <a href="#_java_adapter_config">Java Adapters Config</a> chapter.</p>
</div>
<div class="sect3">
<h4 id="_java_adapter_config"><a class="anchor" href="#_java_adapter_config"></a>2.1.1. Java Adapter Config</h4>
<div class="paragraph">
<p>Each Java adapter supported by Keycloak can be configured by a simple JSON file.
This is what one might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">customer-portal</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">realm-public-key</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">MIGfMA0GCSqGSIb3D...31LwIDAQAB</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">auth-server-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">https://localhost:8443/auth</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ssl-required</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">external</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">use-resource-role-mappings</span><span class="delimiter">&quot;</span></span> : <span class="value">false</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">enable-cors</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">cors-max-age</span><span class="delimiter">&quot;</span></span> : <span class="integer">1000</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">cors-allowed-methods</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">POST, PUT, DELETE, GET</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">cors-exposed-headers</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">WWW-Authenticate, My-custom-exposed-Header</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">bearer-only</span><span class="delimiter">&quot;</span></span> : <span class="value">false</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">enable-basic-auth</span><span class="delimiter">&quot;</span></span> : <span class="value">false</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">expose-token</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">credentials</span><span class="delimiter">&quot;</span></span> : {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">234234-234234-234234</span><span class="delimiter">&quot;</span></span>
   },

   <span class="key"><span class="delimiter">&quot;</span><span class="content">connection-pool-size</span><span class="delimiter">&quot;</span></span> : <span class="integer">20</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">disable-trust-manager</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">allow-any-hostname</span><span class="delimiter">&quot;</span></span> : <span class="value">false</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">truststore</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/truststore.jks</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">truststore-password</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">geheim</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">client-keystore</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">path/to/client-keystore.jks</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">client-keystore-password</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">geheim</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">client-key-password</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">geheim</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">token-minimum-time-to-live</span><span class="delimiter">&quot;</span></span> : <span class="integer">10</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">min-time-between-jwks-requests</span><span class="delimiter">&quot;</span></span> : <span class="integer">10</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">public-key-cache-ttl</span><span class="delimiter">&quot;</span></span>: <span class="integer">86400</span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">redirect-rewrite-rules</span><span class="delimiter">&quot;</span></span> : {
   <span class="key"><span class="delimiter">&quot;</span><span class="content">^/wsmaster/api/(.*)$</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">/api/$1</span><span class="delimiter">&quot;</span></span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use <code>${&#8230;&#8203;}</code> enclosure for system property replacement. For example <code>${jboss.server.config.dir}</code> would be replaced by <code>/path/to/Keycloak</code>.
Replacement of environment variables is also supported via the <code>env</code> prefix, e.g. <code>${env.MY_ENVIRONMENT_VARIABLE}</code>.</p>
</div>
<div class="paragraph">
<p>The initial config file can be obtained from the the admin console. This can be done by opening the admin console, select <code>Clients</code> from the menu and clicking
on the corresponding client. Once the page for the client is opened click on the <code>Installation</code> tab and select <code>Keycloak OIDC JSON</code>.</p>
</div>
<div class="paragraph">
<p>Here is a description of each configuration option:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">realm</dt>
<dd>
<p>Name of the realm.
This is <em>REQUIRED.</em></p>
</dd>
<dt class="hdlist1">resource</dt>
<dd>
<p>The client-id of the application. Each application has a client-id that is used to identify the application.
This is <em>REQUIRED.</em></p>
</dd>
<dt class="hdlist1">realm-public-key</dt>
<dd>
<p>PEM format of the realm public key. You can obtain this from the administration console.
This is <em>OPTIONAL</em> and it&#8217;s not recommended to set it. If not set, the adapter will download this from Keycloak and
it will always re-download it when needed (eg. Keycloak rotate it&#8217;s keys). However if realm-public-key is set, then adapter
will never download new keys from Keycloak, so when Keycloak rotate it&#8217;s keys, adapter will break.</p>
</dd>
<dt class="hdlist1">auth-server-url</dt>
<dd>
<p>The base URL of the Keycloak server. All other Keycloak pages and REST service endpoints are derived from this. It is usually of the form <code>https://host:port/auth</code>.
This is <em>REQUIRED.</em></p>
</dd>
<dt class="hdlist1">ssl-required</dt>
<dd>
<p>Ensures that all communication to and from the Keycloak server is over HTTPS.
In production this should be set to <code>all</code>.
This is <em>OPTIONAL</em>.
The default value is <em>external</em> meaning that HTTPS is required by default for external requests.
Valid values are 'all', 'external' and 'none'.</p>
</dd>
<dt class="hdlist1">confidential-port</dt>
<dd>
<p>The confidential port used by the Keycloak server for secure connections over SSL/TLS.
This is <em>OPTIONAL</em>.
The default value is <em>8443</em>.</p>
</dd>
<dt class="hdlist1">use-resource-role-mappings</dt>
<dd>
<p>If set to true, the adapter will look inside the token for application level role mappings for the user. If false, it will look at the realm level for user role mappings.
This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">public-client</dt>
<dd>
<p>If set to true, the adapter will not send credentials for the client to Keycloak.
This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">enable-cors</dt>
<dd>
<p>This enables CORS support. It will handle CORS preflight requests. It will also look into the access token to determine valid origins.
This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">cors-max-age</dt>
<dd>
<p>If CORS is enabled, this sets the value of the <code>Access-Control-Max-Age</code> header.
This is <em>OPTIONAL</em>.
If not set, this header is not returned in CORS responses.</p>
</dd>
<dt class="hdlist1">cors-allowed-methods</dt>
<dd>
<p>If CORS is enabled, this sets the value of the <code>Access-Control-Allow-Methods</code> header.
This should be a comma-separated string.
This is <em>OPTIONAL</em>.
If not set, this header is not returned in CORS responses.</p>
</dd>
<dt class="hdlist1">cors-allowed-headers</dt>
<dd>
<p>If CORS is enabled, this sets the value of the <code>Access-Control-Allow-Headers</code> header.
This should be a comma-separated string.
This is <em>OPTIONAL</em>.
If not set, this header is not returned in CORS responses.</p>
</dd>
<dt class="hdlist1">cors-exposed-headers</dt>
<dd>
<p>If CORS is enabled, this sets the value of the <code>Access-Control-Expose-Headers</code> header.
This should be a comma-separated string.
This is <em>OPTIONAL</em>.
If not set, this header is not returned in CORS responses.</p>
</dd>
<dt class="hdlist1">bearer-only</dt>
<dd>
<p>This should be set to <em>true</em> for services. If enabled the adapter will not attempt to authenticate users, but only verify bearer tokens.
This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">autodetect-bearer-only</dt>
<dd>
<p>This should be set to <em>true</em> if your application serves both a web application and web services (e.g. SOAP or REST).
It allows you to redirect unauthenticated users of the web application to the Keycloak login page,
but send an HTTP <code>401</code> status code to unauthenticated SOAP or REST clients instead as they would not understand a redirect to the login page.
Keycloak auto-detects SOAP or REST clients based on typical headers like <code>X-Requested-With</code>, <code>SOAPAction</code> or <code>Accept</code>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">enable-basic-auth</dt>
<dd>
<p>This tells the adapter to also support basic authentication. If this option is enabled, then <em>secret</em> must also be provided.
This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">expose-token</dt>
<dd>
<p>If <code>true</code>, an authenticated browser client (via a Javascript HTTP invocation) can obtain the signed access token via the URL <code>root/k_query_bearer_token</code>.
This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">credentials</dt>
<dd>
<p>Specify the credentials of the application. This is an object notation where the key is the credential type and the value is the value of the credential type.
Currently password and jwt is supported. This is <em>REQUIRED</em> only for clients with 'Confidential' access type.</p>
</dd>
<dt class="hdlist1">connection-pool-size</dt>
<dd>
<p>Adapters will make separate HTTP invocations to the Keycloak server to turn an access code into an access token.
This config option defines how many connections to the Keycloak server should be pooled.
This is <em>OPTIONAL</em>.
The default value is <code>20</code>.</p>
</dd>
<dt class="hdlist1">disable-trust-manager</dt>
<dd>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code> you do not have to specify a truststore.
This setting should only be used during development and <strong>never</strong> in production as it will disable verification of SSL certificates.
This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">allow-any-hostname</dt>
<dd>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code> the Keycloak server&#8217;s certificate is validated via the truststore,
but host name validation is not done.
This setting should only be used during development and <strong>never</strong> in production as it will disable verification of SSL certificates.
This seting may be useful in test environments This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">proxy-url</dt>
<dd>
<p>The URL for the HTTP proxy if one is used.</p>
</dd>
<dt class="hdlist1">truststore</dt>
<dd>
<p>The value is the file path to a keystore file.
If you prefix the path with <code>classpath:</code>, then the truststore will be obtained from the deployment&#8217;s classpath instead.
Used for outgoing HTTPS communications to the Keycloak server.
Client making HTTPS requests need a way to verify the host of the server they are talking to.
This is what the trustore does.
The keystore contains one or more trusted host certificates or certificate authorities.
You can create this truststore by extracting the public certificate of the Keycloak server&#8217;s SSL keystore.
This is <em>REQUIRED</em> unless <code>ssl-required</code> is <code>none</code> or <code>disable-trust-manager</code> is <code>true</code>.</p>
</dd>
<dt class="hdlist1">truststore-password</dt>
<dd>
<p>Password for the truststore keystore.
This is <em>REQUIRED</em> if <code>truststore</code> is set and the truststore requires a password.</p>
</dd>
<dt class="hdlist1">client-keystore</dt>
<dd>
<p>This is the file path to a keystore file.
This keystore contains client certificate for two-way SSL when the adapter makes HTTPS requests to the Keycloak server.
This is <em>OPTIONAL</em>.</p>
</dd>
<dt class="hdlist1">client-keystore-password</dt>
<dd>
<p>Password for the client keystore.
This is <em>REQUIRED</em> if <code>client-keystore</code> is set.</p>
</dd>
<dt class="hdlist1">client-key-password</dt>
<dd>
<p>Password for the client&#8217;s key.
This is <em>REQUIRED</em> if <code>client-keystore</code> is set.</p>
</dd>
<dt class="hdlist1">always-refresh-token</dt>
<dd>
<p>If <em>true</em>, the adapter will refresh token in every request.</p>
</dd>
<dt class="hdlist1">register-node-at-startup</dt>
<dd>
<p>If <em>true</em>, then adapter will send registration request to Keycloak.
It&#8217;s <em>false</em> by default and useful only when application is clustered.
See <a href="#_applicationclustering">Application Clustering</a> for details</p>
</dd>
<dt class="hdlist1">register-node-period</dt>
<dd>
<p>Period for re-registration adapter to Keycloak.
Useful when application is clustered.
See <a href="#_applicationclustering">Application Clustering</a> for details</p>
</dd>
<dt class="hdlist1">token-store</dt>
<dd>
<p>Possible values are <em>session</em> and <em>cookie</em>.
Default is <em>session</em>, which means that adapter stores account info in HTTP Session.
Alternative <em>cookie</em> means storage of info in cookie.
See <a href="#_applicationclustering">Application Clustering</a> for details</p>
</dd>
<dt class="hdlist1">principal-attribute</dt>
<dd>
<p>OpenID Connect ID Token attribute to populate the UserPrincipal name with.
If token attribute is null, defaults to <code>sub</code>.
Possible values are <code>sub</code>, <code>preferred_username</code>, <code>email</code>, <code>name</code>, <code>nickname</code>, <code>given_name</code>, <code>family_name</code>.</p>
</dd>
<dt class="hdlist1">turn-off-change-session-id-on-login</dt>
<dd>
<p>The session id is changed by default on a successful login on some platforms to plug a security attack vector.  Change this to true if you want to turn this off This is <em>OPTIONAL</em>.
The default value is <em>false</em>.</p>
</dd>
<dt class="hdlist1">token-minimum-time-to-live</dt>
<dd>
<p>Amount of time, in seconds, to preemptively refresh an active access token with the Keycloak server before it expires.
This is especially useful when the access token is sent to another REST client where it could expire before being evaluated.
This value should never exceed the realm&#8217;s access token lifespan.
This is <em>OPTIONAL</em>.  The default value is <code>0</code> seconds, so adapter will refresh access token just if it&#8217;s expired.</p>
</dd>
<dt class="hdlist1">min-time-between-jwks-requests</dt>
<dd>
<p>Amount of time, in seconds, specifying minimum interval between two requests to Keycloak to retrieve new public keys.
It is 10 seconds by default.
Adapter will always try to download new public key when it recognize token with unknown <code>kid</code> . However it won&#8217;t try it more
than once per 10 seconds (by default). This is to avoid DoS when attacker sends lots of tokens with bad <code>kid</code> forcing adapter
to send lots of requests to Keycloak.</p>
</dd>
<dt class="hdlist1">public-key-cache-ttl</dt>
<dd>
<p>Amount of time, in seconds, specifying maximum interval between two requests to Keycloak to retrieve new public keys.
It is 86400 seconds (1 day) by default.
Adapter will always try to download new public key when it recognize token with unknown <code>kid</code> . If it recognize token with known <code>kid</code>, it will
just use the public key downloaded previously. However at least once per this configured interval (1 day by default) will be new
public key always downloaded even if the <code>kid</code> of token is already known.</p>
</dd>
<dt class="hdlist1">ignore-oauth-query-parameter</dt>
<dd>
<p>Defaults to <code>false</code>, if set to <code>true</code> will turn off processing of the <code>access_token</code>
query parameter for bearer token processing.  Users will not be able to authenticate
if they only pass in an <code>access_token</code></p>
</dd>
<dt class="hdlist1">redirect-rewrite-rules</dt>
<dd>
<p>If needed, specify the Redirect URI rewrite rule. This is an object notation where the key is the regular expression to which the Redirect URI is to be matched and the value is the replacement String.
<code>$</code> character can be used for backreferences in the replacement String.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_jboss_adapter"><a class="anchor" href="#_jboss_adapter"></a>2.1.2. JBoss EAP/Wildfly Adapter</h4>
<div class="paragraph">
<p>To be able to secure WAR apps deployed on JBoss EAP, WildFly or JBoss AS, you must install and configure the
Keycloak adapter subsystem. You then have two options to secure your WARs.</p>
</div>
<div class="paragraph">
<p>You can provide an adapter config file in your WAR and change the auth-method to KEYCLOAK within web.xml.</p>
</div>
<div class="paragraph">
<p>Alternatively, you don&#8217;t have to modify your WAR at all and you can secure it via the Keycloak adapter subsystem configuration in <code>standalone.xml</code>.
Both methods are described in this section.</p>
</div>
<div class="sect4">
<h5 id="_jboss_adapter_installation"><a class="anchor" href="#_jboss_adapter_installation"></a>Installing the adapter</h5>
<div class="paragraph">
<p>Adapters are available as a separate archive depending on what server version you are using.</p>
</div>
<div class="paragraph">
<p>Install on Wildfly 9, 10 or 11:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $WILDFLY_HOME
$ unzip keycloak-wildfly-adapter-dist-3.4.1.CR1.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install on Wildfly 8:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $WILDFLY_HOME
$ unzip keycloak-wf8-adapter-dist-3.4.1.CR1.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install on JBoss EAP 7:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $EAP_HOME
$ unzip keycloak-eap7-adapter-dist-3.4.1.CR1.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install on JBoss EAP 6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $EAP_HOME
$ unzip keycloak-eap6-adapter-dist-3.4.1.CR1.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install on JBoss AS 7.1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $JBOSS_HOME
$ unzip keycloak-as7-adapter-dist-3.4.1.CR1.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>This ZIP archive contains JBoss Modules specific to the Keycloak adapter. It also contains JBoss CLI scripts to configure the adapter subsystem.</p>
</div>
<div class="paragraph">
<p>To configure the adapter subsystem if the server is not running execute:</p>
</div>
<div class="listingblock">
<div class="title">Wildfly 11</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ ./bin/jboss-cli.sh --file=adapter-elytron-install-offline.cli</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Any other server but Wildfly 11</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ ./bin/jboss-cli.sh --file=adapter-install-offline.cli</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The offline script is not available for JBoss EAP 6
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alternatively, if the server is running execute:</p>
</div>
<div class="listingblock">
<div class="title">Wildfly 11</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ ./bin/jboss-cli.sh --file=adapter-elytron-install.cli</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Any other server but Wildfly 11</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ ./bin/jboss-cli.sh --file=adapter-install.cli</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="required-per-war-configuration"><a class="anchor" href="#required-per-war-configuration"></a>Required Per WAR Configuration</h5>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding configuration and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>keycloak.json</code> adapter configuration file within the <code>WEB-INF</code> directory of your WAR.</p>
</div>
<div class="paragraph">
<p>The format of this configuration file is described in the <a href="#_java_adapter_config">Java adapter configuration</a> section.</p>
</div>
<div class="paragraph">
<p>Next you must set the <code>auth-method</code> to <code>KEYCLOAK</code> in <code>web.xml</code>.
You also have to use standard servlet security to specify role-base constraints on your URLs.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;module-name&gt;</span>application<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Admins<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/admin/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>
    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/customers/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>

    <span class="tag">&lt;login-config&gt;</span>
        <span class="tag">&lt;auth-method&gt;</span>KEYCLOAK<span class="tag">&lt;/auth-method&gt;</span>
        <span class="tag">&lt;realm-name&gt;</span>this is ignored currently<span class="tag">&lt;/realm-name&gt;</span>
    <span class="tag">&lt;/login-config&gt;</span>

    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="securing-wars-via-adapter-subsystem"><a class="anchor" href="#securing-wars-via-adapter-subsystem"></a>Securing WARs via Adapter Subsystem</h5>
<div class="paragraph">
<p>You do not have to modify your WAR to secure it with Keycloak. Instead you can externally secure it via the Keycloak Adapter Subsystem.
While you don&#8217;t have to specify KEYCLOAK as an <code>auth-method</code>, you still have to define the <code>security-constraints</code> in <code>web.xml</code>.
You do not, however, have to create a <code>WEB-INF/keycloak.json</code> file.
This metadata is instead defined within server configuration (i.e. <code>standalone.xml</code>) in the Keycloak subsystem definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;extensions&gt;</span>
  <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.keycloak-adapter-subsystem</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/extensions&gt;</span>

<span class="tag">&lt;profile&gt;</span>
  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WAR MODULE NAME.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;realm&gt;</span>demo<span class="tag">&lt;/realm&gt;</span>
        <span class="tag">&lt;auth-server-url&gt;</span>http://localhost:8081/auth<span class="tag">&lt;/auth-server-url&gt;</span>
        <span class="tag">&lt;ssl-required&gt;</span>external<span class="tag">&lt;/ssl-required&gt;</span>
        <span class="tag">&lt;resource&gt;</span>customer-portal<span class="tag">&lt;/resource&gt;</span>
        <span class="tag">&lt;credential</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/credential&gt;</span>
     <span class="tag">&lt;/secure-deployment&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span>
<span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secure-deployment</code> <code>name</code> attribute identifies the WAR you want to secure.
Its value is the <code>module-name</code> defined in <code>web.xml</code> with <code>.war</code> appended. The rest of the configuration corresponds pretty much one to one with the <code>keycloak.json</code> configuration options defined in <a href="#_java_adapter_config">Java adapter configuration</a>.</p>
</div>
<div class="paragraph">
<p>The exception is the <code>credential</code> element.</p>
</div>
<div class="paragraph">
<p>To make it easier for you, you can go to the Keycloak Administration Console and go to the Client/Installation tab of the application this WAR is aligned with.
It provides an example XML file you can cut and paste.</p>
</div>
<div class="paragraph">
<p>If you have multiple deployments secured by the same realm you can share the realm configuration in a separate element. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;auth-server-url&gt;</span>http://localhost:8080/auth<span class="tag">&lt;/auth-server-url&gt;</span>
        <span class="tag">&lt;ssl-required&gt;</span>external<span class="tag">&lt;/ssl-required&gt;</span>
    <span class="tag">&lt;/realm&gt;</span>
    <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer-portal.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;realm&gt;</span>demo<span class="tag">&lt;/realm&gt;</span>
        <span class="tag">&lt;resource&gt;</span>customer-portal<span class="tag">&lt;/resource&gt;</span>
        <span class="tag">&lt;credential</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/credential&gt;</span>
    <span class="tag">&lt;/secure-deployment&gt;</span>
    <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">product-portal.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;realm&gt;</span>demo<span class="tag">&lt;/realm&gt;</span>
        <span class="tag">&lt;resource&gt;</span>product-portal<span class="tag">&lt;/resource&gt;</span>
        <span class="tag">&lt;credential</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>password<span class="tag">&lt;/credential&gt;</span>
    <span class="tag">&lt;/secure-deployment&gt;</span>
    <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">database.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;realm&gt;</span>demo<span class="tag">&lt;/realm&gt;</span>
        <span class="tag">&lt;resource&gt;</span>database-service<span class="tag">&lt;/resource&gt;</span>
        <span class="tag">&lt;bearer-only&gt;</span>true<span class="tag">&lt;/bearer-only&gt;</span>
    <span class="tag">&lt;/secure-deployment&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="security-domain"><a class="anchor" href="#security-domain"></a>Security Domain</h5>
<div class="paragraph">
<p>To propagate the security context to the EJB tier you need to configure it to use the "keycloak" security domain. This
can be achieved with the @SecurityDomain annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>import org.jboss.ejb3.annotation.SecurityDomain;
...

@Stateless
@SecurityDomain("keycloak")
public class CustomerService {

    @RolesAllowed("user")
    public List&lt;String&gt; getCustomers() {
        return db.getCustomers();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fuse_adapter"><a class="anchor" href="#_fuse_adapter"></a>2.1.3. JBoss Fuse Adapter</h4>
<div class="paragraph">
<p>Currently Keycloak supports securing your web applications running inside <a href="https://developers.redhat.com/products/fuse/overview/">JBoss Fuse</a>.</p>
</div>
<div class="paragraph">
<p>It leverages <a href="#_jetty9_adapter">Jetty 9 adapter</a> as JBoss Fuse 6.3.0 Rollup 5 is bundled with <a href="http://www.eclipse.org/jetty/">Jetty 9.2 server</a>
under the covers and Jetty is used for running various kinds of web applications.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The only supported version of Fuse is JBoss Fuse 6.3.0 Rollup 5. If you use earlier versions of Fuse, it is possible that some functions will not work correctly. In particular, the <a href="http://hawt.io">Hawtio</a> integration will not work with earlier versions of Fuse.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Security for the following items is supported for Fuse:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Classic WAR applications deployed on Fuse with Pax Web War Extender</p>
</li>
<li>
<p>Servlets deployed on Fuse as OSGI services with Pax Web Whiteboard Extender</p>
</li>
<li>
<p><a href="http://camel.apache.org/">Apache Camel</a> Jetty endpoints running with the <a href="http://camel.apache.org/jetty.html">Camel Jetty</a> component</p>
</li>
<li>
<p><a href="http://cxf.apache.org/">Apache CXF</a> endpoints running on their own separate <a href="http://cxf.apache.org/docs/jetty-configuration.html">Jetty engine</a></p>
</li>
<li>
<p><a href="http://cxf.apache.org/">Apache CXF</a> endpoints running on the default engine provided by the CXF servlet</p>
</li>
<li>
<p>SSH and JMX admin access</p>
</li>
<li>
<p><a href="http://hawt.io">Hawtio administration console</a></p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="securing-your-web-applications-inside-fuse"><a class="anchor" href="#securing-your-web-applications-inside-fuse"></a>Securing Your Web Applications Inside Fuse</h5>
<div class="paragraph">
<p>You must first install the Keycloak Karaf feature. Next you will need to perform the steps according to the type of application you want to secure.
All referenced web applications require injecting the Keycloak Jetty authenticator into the underlying Jetty server. The steps to achieve this depend on the application type. The details are described below.</p>
</div>
<div class="paragraph">
<p>The best place to start is look at Fuse demo bundled as part of Keycloak examples in directory <code>fuse</code> . Most of the steps should be understandable from testing and
understanding the demo.</p>
</div>
</div>
<div class="sect4">
<h5 id="_fuse_install_feature"><a class="anchor" href="#_fuse_install_feature"></a>Installing the Keycloak Feature</h5>
<div class="paragraph">
<p>You must first install the <code>keycloak</code> feature in the JBoss Fuse environment. The keycloak feature includes the Fuse adapter and all third-party dependencies. You can install it either from the Maven repository or from an archive.</p>
</div>
<div class="sect5">
<h6 id="installing-from-the-maven-repository"><a class="anchor" href="#installing-from-the-maven-repository"></a>Installing from the Maven Repository</h6>
<div class="paragraph">
<p>As a prerequisite, you must be online and have access to the Maven repository.</p>
</div>
<div class="paragraph">
<p>For community it&#8217;s sufficient to be online as all the artifacts and 3rd party dependencies should be available in the maven central repository.</p>
</div>
<div class="paragraph">
<p>To install the keycloak feature using the Maven repository, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start JBoss Fuse 6.3.0 Rollup 5; then in the Karaf terminal type:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/3.4.1.CR1/xml/features
features:install keycloak</code></pre>
</div>
</div>
</li>
<li>
<p>You might also need to install the Jetty 9 feature:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>features:install keycloak-jetty9-adapter</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are using JBoss Fuse 6.2 or later, use <code>keycloak-jetty8-adapter</code>. However, upgrading to JBoss Fuse 6.3.0 Rollup 5 is recommended.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Ensure that the features were installed:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>features:list | grep keycloak</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="installing-from-the-zip-bundle"><a class="anchor" href="#installing-from-the-zip-bundle"></a>Installing from the ZIP bundle</h6>
<div class="paragraph">
<p>This is useful if you are offline or do not want to use Maven to obtain the JAR files and other artifacts.</p>
</div>
<div class="paragraph">
<p>To install the Fuse adapter from the ZIP archive, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the Keycloak Fuse adapter ZIP archive.</p>
</li>
<li>
<p>Unzip it into the root directory of JBoss Fuse. The dependencies are then installed under the <code>system</code> directory. You can overwrite all existing jar files.</p>
<div class="paragraph">
<p>Use this for JBoss Fuse 6.3.0 Rollup 5:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd /path-to-fuse/jboss-fuse-6.3.0.redhat-254
unzip -q /path-to-adapter-zip/keycloak-fuse-adapter-3.4.1.CR1.zip</code></pre>
</div>
</div>
</li>
<li>
<p>Start Fuse and run these commands in the fuse/karaf terminal:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/3.4.1.CR1/xml/features
features:install keycloak</code></pre>
</div>
</div>
</li>
<li>
<p>Install the corresponding Jetty adapter. Since the artifacts are available directly in the JBoss Fuse <code>system</code> directory, you do not need to use the Maven repository.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fuse_adapter_classic_war"><a class="anchor" href="#_fuse_adapter_classic_war"></a>Securing a Classic WAR Application</h5>
<div class="paragraph">
<p>The needed steps to secure your WAR application are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <code>/WEB-INF/web.xml</code> file, declare the necessary:</p>
<div class="ulist">
<ul>
<li>
<p>security constraints in the &lt;security-constraint&gt; element</p>
</li>
<li>
<p>login configuration in the &lt;login-config&gt; element</p>
</li>
<li>
<p>security roles in the &lt;security-role&gt; element.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
         <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;module-name&gt;</span>customer-portal<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;welcome-file-list&gt;</span>
        <span class="tag">&lt;welcome-file&gt;</span>index.html<span class="tag">&lt;/welcome-file&gt;</span>
    <span class="tag">&lt;/welcome-file-list&gt;</span>

    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/customers/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>

    <span class="tag">&lt;login-config&gt;</span>
        <span class="tag">&lt;auth-method&gt;</span>BASIC<span class="tag">&lt;/auth-method&gt;</span>
        <span class="tag">&lt;realm-name&gt;</span>does-not-matter<span class="tag">&lt;/realm-name&gt;</span>
    <span class="tag">&lt;/login-config&gt;</span>

    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Add the <code>jetty-web.xml</code> file with the authenticator to the <code>/WEB-INF/jetty-web.xml</code> file.</p>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot;
 &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="tag">&lt;Configure</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.webapp.WebAppContext</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;Get</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Set</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;New</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jetty.KeycloakJettyAuthenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;/New&gt;</span>
        <span class="tag">&lt;/Set&gt;</span>
    <span class="tag">&lt;/Get&gt;</span>
<span class="tag">&lt;/Configure&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Within the <code>/WEB-INF/</code> directory of your WAR, create a new file, keycloak.json. The format of this configuration file is described in the <a href="#_java_adapter_config">Java Adapters Config</a> section. It is also possible to make this file available externally as described in <a href="#config_external_adapter">Configuring the External Adapter</a>.</p>
</li>
<li>
<p>Ensure your WAR application imports <code>org.keycloak.adapters.jetty</code> and maybe some more packages in the <code>META-INF/MANIFEST.MF</code> file, under the <code>Import-Package</code> header. Using <code>maven-bundle-plugin</code> in your project properly generates OSGI headers in manifest.
Note that "*" resolution for the package does not import the <code>org.keycloak.adapters.jetty</code> package, since it is not used by the application or the Blueprint or Spring descriptor, but is rather used in the <code>jetty-web.xml</code> file.</p>
<div class="paragraph">
<p>The list of the packages to import might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>org.keycloak.adapters.jetty;version="3.4.1.CR1",
org.keycloak.adapters;version="3.4.1.CR1",
org.keycloak.constants;version="3.4.1.CR1",
org.keycloak.util;version="3.4.1.CR1",
org.keycloak.*;version="3.4.1.CR1",
*;resolution:=optional</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="config_external_adapter"><a class="anchor" href="#config_external_adapter"></a>Configuring the External Adapter</h6>
<div class="paragraph">
<p>If you do not want the <code>keycloak.json</code> adapter configuration file to be bundled inside your WAR application, but instead made available externally and loaded based on naming conventions, use this configuration method.</p>
</div>
<div class="paragraph">
<p>To enable the functionality, add this section to your <code>/WEB_INF/web.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>keycloak.config.resolver<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That component uses <code>keycloak.config</code> or <code>karaf.etc</code> java properties to search for a base folder to locate the configuration.
Then inside one of those folders it searches for a file called <code>&lt;your_web_context&gt;-keycloak.json</code>.</p>
</div>
<div class="paragraph">
<p>So, for example, if your web application has context <code>my-portal</code>, then your adapter configuration is loaded from the  <code>$FUSE_HOME/etc/my-portal-keycloak.json</code> file.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fuse_adapter_servlet_whiteboard"><a class="anchor" href="#_fuse_adapter_servlet_whiteboard"></a>Securing a Servlet Deployed as an OSGI Service</h5>
<div class="paragraph">
<p>You can use this method if you have a servlet class inside your OSGI bundled project that is not deployed as a classic WAR application. Fuse uses Pax Web Whiteboard Extender to deploy such servlets as web applications.</p>
</div>
<div class="paragraph">
<p>To secure your servlet with Keycloak, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Keycloak provides PaxWebIntegrationService, which allows injecting jetty-web.xml and configuring security constraints for your application. You need to declare such services in the <code>OSGI-INF/blueprint/blueprint.xml</code> file inside your application. Note that your servlet needs to depend on it.
An example configuration:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;blueprint</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0</span>
           <span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- Using jetty bean just for the compatibility with other fuse services --&gt;</span>
    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">servletConstraintMapping</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintMapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.util.security.Constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cst1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">roles</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;list&gt;</span>
                        <span class="tag">&lt;value&gt;</span>user<span class="tag">&lt;/value&gt;</span>
                    <span class="tag">&lt;/list&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataConstraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pathSpec</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/product-portal/*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakPaxWebIntegration</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.osgi.PaxWebIntegrationService</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">init-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jettyWebXmlLocation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/jetty-web.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bundleContext</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">blueprintBundleContext</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMappings</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;ref</span> <span class="attribute-name">component-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">servletConstraintMapping</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">productServlet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.example.ProductPortalServlet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">depends-on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakPaxWebIntegration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;service</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">productServlet</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.servlet.Servlet</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;service-properties&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">alias</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/product-portal</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">servlet-name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ProductServlet</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;entry</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak.config.file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/keycloak.json</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/service-properties&gt;</span>
    <span class="tag">&lt;/service&gt;</span>

<span class="tag">&lt;/blueprint&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>You might need to have the <code>WEB-INF</code> directory inside your project (even if your project is not a web application) and create the  <code>/WEB-INF/jetty-web.xml</code> and <code>/WEB-INF/keycloak.json</code> files as in the <a href="#_fuse_adapter_classic_war">Classic WAR application</a> section.
Note you don&#8217;t need the <code>web.xml</code> file as the security-constraints are declared in the blueprint configuration file.</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> must contain at least these imports:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>org.keycloak.adapters.jetty;version="3.4.1.CR1",
org.keycloak.adapters;version="3.4.1.CR1",
org.keycloak.constants;version="3.4.1.CR1",
org.keycloak.util;version="3.4.1.CR1",
org.keycloak.*;version="3.4.1.CR1",
*;resolution:=optional</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="securing-an-apache-camel-application"><a class="anchor" href="#securing-an-apache-camel-application"></a>Securing an Apache Camel Application</h5>
<div class="paragraph">
<p>You can secure Apache Camel endpoints implemented with the <a href="http://camel.apache.org/jetty.html">camel-jetty</a> component by adding securityHandler with <code>KeycloakJettyAuthenticator</code> and the proper security constraints injected. You can add the <code>OSGI-INF/blueprint/blueprint.xml</code> file to your Camel application with a similar configuration as below. The roles, security constraint mappings, and Keycloak adapter configuration might differ slightly depending on your environment and needs.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="tag">&lt;blueprint</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns:camel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://camel.apache.org/schema/blueprint</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
       <span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd</span>
       <span class="content">http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kcAdapterConfig</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.representations.adapters.config.AdapterConfig</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin-camel-endpoint</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bearerOnly</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authServerUrl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslRequired</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakAuthenticator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jetty.KeycloakJettyAuthenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adapterConfig</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kcAdapterConfig</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.util.security.Constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Customers</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">roles</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;value&gt;</span>admin<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataConstraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMapping</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintMapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pathSpec</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintSecurityHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakAuthenticator</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMappings</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;ref</span> <span class="attribute-name">component-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMapping</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BASIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realmName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">does-not-matter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionHandler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jetty.spi.WrappingSessionHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">handler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">helloProcessor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.example.CamelHelloProcessor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;camelContext</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">blueprintContext</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">trace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://camel.apache.org/schema/blueprint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;route</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">httpBridge</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;from</span> <span class="attribute-name">uri</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jetty:http://0.0.0.0:8383/admin-camel-endpoint?handlers=sessionHandler</span><span class="entity">&amp;amp;</span><span class="content">matchOnUriPrefix=true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;process</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">helloProcessor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;log</span> <span class="attribute-name">message</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">The message from camel endpoint contains ${body}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/route&gt;</span>
    <span class="tag">&lt;/camelContext&gt;</span>

<span class="tag">&lt;/blueprint&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> needs to contain these imports:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>javax.servlet;version="[3,4)",
javax.servlet.http;version="[3,4)",
org.apache.camel.*,
org.apache.camel;version="[2.13,3)",
org.eclipse.jetty.security;version="[8,10)",
org.eclipse.jetty.server.nio;version="[8,10)",
org.eclipse.jetty.util.security;version="[8,10)",
org.keycloak.*;version="3.4.1.CR1",
org.osgi.service.blueprint,
org.osgi.service.blueprint.container,
org.osgi.service.event,</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="camel-restdsl"><a class="anchor" href="#camel-restdsl"></a>Camel RestDSL</h5>
<div class="paragraph">
<p>Camel RestDSL is a Camel feature used to define your REST endpoints in a fluent way. But you must still use specific implementation classes and provide instructions on how to integrate with Keycloak.</p>
</div>
<div class="paragraph">
<p>The way to configure the integration mechanism depends on the Camel component for which you configure your RestDSL-defined routes.</p>
</div>
<div class="paragraph">
<p>The following example shows how to configure integration using the Jetty component, with references to some of the beans defined in previous Blueprint example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandlerRest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintSecurityHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakAuthenticator</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMappings</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;list&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">component-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMapping</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/list&gt;</span>
    <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BASIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realmName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">does-not-matter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionHandlerRest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jetty.spi.WrappingSessionHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">handler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandlerRest</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/bean&gt;</span>


<span class="tag">&lt;camelContext</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">blueprintContext</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">trace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://camel.apache.org/schema/blueprint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;restConfiguration</span> <span class="attribute-name">component</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jetty</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">contextPath</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/restdsl</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8484</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="comment">&lt;!--the link with Keycloak security handlers happens here--&gt;</span>
        <span class="tag">&lt;endpointProperty</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">handlers</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessionHandlerRest</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/endpointProperty&gt;</span>
        <span class="tag">&lt;endpointProperty</span> <span class="attribute-name">key</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">matchOnUriPrefix</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/endpointProperty&gt;</span>
    <span class="tag">&lt;/restConfiguration&gt;</span>

    <span class="tag">&lt;rest</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/hello</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
        <span class="tag">&lt;description&gt;</span>Hello rest service<span class="tag">&lt;/description&gt;</span>
        <span class="tag">&lt;get</span> <span class="attribute-name">uri</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outType</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java.lang.String</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;description&gt;</span>Just an helllo<span class="tag">&lt;/description&gt;</span>
            <span class="tag">&lt;to</span> <span class="attribute-name">uri</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">direct:justDirect</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/get&gt;</span>

    <span class="tag">&lt;/rest&gt;</span>

    <span class="tag">&lt;route</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">justDirect</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;from</span> <span class="attribute-name">uri</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">direct:justDirect</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;process</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">helloProcessor</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;log</span> <span class="attribute-name">message</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RestDSL correctly invoked ${body}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;setBody&gt;</span>
            <span class="tag">&lt;constant&gt;</span>(__This second sentence is returned from a Camel RestDSL endpoint__)<span class="tag">&lt;/constant&gt;</span>
        <span class="tag">&lt;/setBody&gt;</span>
    <span class="tag">&lt;/route&gt;</span>

<span class="tag">&lt;/camelContext&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fuse_adapter_cxf_separate"><a class="anchor" href="#_fuse_adapter_cxf_separate"></a>Securing an Apache CXF Endpoint on a Separate Jetty Engine</h5>
<div class="paragraph">
<p>To run your CXF endpoints secured by Keycloak on separate Jetty engines, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add <code>META-INF/spring/beans.xml</code> to your application, and in it,  declare <code>httpj:engine-factory</code> with Jetty SecurityHandler with injected <code>KeycloakJettyAuthenticator</code>. The configuration for a CFX JAX-WS application might resemble this one:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="tag">&lt;beans</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.springframework.org/schema/beans</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:jaxws</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://cxf.apache.org/jaxws</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns:httpj</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://cxf.apache.org/transports/http-jetty/configuration</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
        <span class="content">http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
        <span class="content">http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd</span>
        <span class="content">http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd</span>
        <span class="content">http://cxf.apache.org/transports/http-jetty/configuration http://cxf.apache.org/schemas/configuration/http-jetty.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;import</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:META-INF/cxf/cxf.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kcAdapterConfig</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.representations.adapters.config.AdapterConfig</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">custom-cxf-endpoint</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bearerOnly</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authServerUrl</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sslRequired</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakAuthenticator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jetty.KeycloakJettyAuthenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">adapterConfig</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">local</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kcAdapterConfig</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.util.security.Constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Customers</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">roles</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;value&gt;</span>user<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataConstraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMapping</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintMapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pathSpec</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintSecurityHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticator</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloakAuthenticator</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMappings</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;ref</span> <span class="attribute-name">local</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMapping</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authMethod</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BASIC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realmName</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">does-not-matter</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;httpj:engine-factory</span> <span class="attribute-name">bus</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cxf</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kc-cxf-endpoint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;httpj:engine</span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8282</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;httpj:handlers&gt;</span>
                <span class="tag">&lt;ref</span> <span class="attribute-name">local</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/httpj:handlers&gt;</span>
            <span class="tag">&lt;httpj:sessionSupport&gt;</span>true<span class="tag">&lt;/httpj:sessionSupport&gt;</span>
        <span class="tag">&lt;/httpj:engine&gt;</span>
    <span class="tag">&lt;/httpj:engine-factory&gt;</span>

    <span class="tag">&lt;jaxws:endpoint</span>
                    <span class="attribute-name">implementor</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.example.ws.ProductImpl</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8282/ProductServiceCF</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">depends-on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kc-cxf-endpoint</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

<span class="tag">&lt;/beans&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the CXF JAX-RS application, the only difference might be in the configuration of the endpoint dependent on engine-factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;jaxrs:server</span> <span class="attribute-name">serviceClass</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.example.rs.CustomerService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8282/rest</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">depends-on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">kc-cxf-endpoint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jaxrs:providers&gt;</span>
        <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/jaxrs:providers&gt;</span>
<span class="tag">&lt;/jaxrs:server&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> must contain those imports:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>META-INF.cxf;version="[2.7,3.2)",
META-INF.cxf.osgi;version="[2.7,3.2)";resolution:=optional,
org.apache.cxf.bus;version="[2.7,3.2)",
org.apache.cxf.bus.spring;version="[2.7,3.2)",
org.apache.cxf.bus.resource;version="[2.7,3.2)",
org.apache.cxf.transport.http;version="[2.7,3.2)",
org.apache.cxf.*;version="[2.7,3.2)",
org.springframework.beans.factory.config,
org.eclipse.jetty.security;version="[8,10)",
org.eclipse.jetty.util.security;version="[8,10)",
org.keycloak.*;version="3.4.1.CR1"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fuse_adapter_cxf_builtin"><a class="anchor" href="#_fuse_adapter_cxf_builtin"></a>Securing an Apache CXF Endpoint on the Default Jetty Engine</h5>
<div class="paragraph">
<p>Some services automatically come with deployed servlets on startup. One such service is the CXF servlet running in the http://localhost:8181/cxf context. Securing such endpoints can be complicated. One approach, which Keycloak is currently using, is ServletReregistrationService, which undeploys a built-in servlet at startup, enabling you to redeploy it on a context secured by Keycloak.</p>
</div>
<div class="paragraph">
<p>The configuration file <code>OSGI-INF/blueprint/blueprint.xml</code> inside your application might resemble the one below. Note that it adds the JAX-RS <code>customerservice</code> endpoint, which is endpoint-specific to your application, but more importantly, secures the entire <code>/cxf</code> context.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;blueprint</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xmlns:jaxrs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://cxf.apache.org/blueprint/jaxrs</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span>
                <span class="content">http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd</span>
                <span class="content">http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="comment">&lt;!-- JAXRS Application --&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerBean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.example.rs.CxfCustomerService</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

    <span class="tag">&lt;jaxrs:server</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cxfJaxrsServer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/customerservice</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;jaxrs:providers&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/jaxrs:providers&gt;</span>
        <span class="tag">&lt;jaxrs:serviceBeans&gt;</span>
            <span class="tag">&lt;ref</span> <span class="attribute-name">component-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerBean</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/jaxrs:serviceBeans&gt;</span>
    <span class="tag">&lt;/jaxrs:server&gt;</span>


    <span class="comment">&lt;!-- Securing of whole /cxf context by unregister default cxf servlet from paxweb and re-register with applied security constraints --&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cxfConstraintMapping</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.security.ConstraintMapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;bean</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.util.security.Constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cst1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">roles</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;list&gt;</span>
                        <span class="tag">&lt;value&gt;</span>user<span class="tag">&lt;/value&gt;</span>
                    <span class="tag">&lt;/list&gt;</span>
                <span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataConstraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/bean&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pathSpec</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/cxf/*</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cxfKeycloakPaxWebIntegration</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.osgi.PaxWebIntegrationService</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">init-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bundleContext</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">blueprintBundleContext</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jettyWebXmlLocation</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/jetty-web.xml</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraintMappings</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;list&gt;</span>
                <span class="tag">&lt;ref</span> <span class="attribute-name">component-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cxfConstraintMapping</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/list&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

    <span class="tag">&lt;bean</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultCxfReregistration</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.osgi.ServletReregistrationService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">depends-on</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cxfKeycloakPaxWebIntegration</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">init-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">destroy-method</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stop</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bundleContext</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">blueprintBundleContext</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">managedServiceReference</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;reference</span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.osgi.service.cm.ManagedService</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">filter</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(service.pid=org.apache.cxf.osgi)</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5000</span><span class="delimiter">&quot;</span></span>  <span class="tag">/&gt;</span>
        <span class="tag">&lt;/property&gt;</span>
    <span class="tag">&lt;/bean&gt;</span>

<span class="tag">&lt;/blueprint&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result, all other CXF services running on the default CXF HTTP destination are also secured. Similarly, when the application is undeployed, the entire <code>/cxf</code> context becomes unsecured as well. For this reason, using your own Jetty engine for your applications as described in <a href="#_fuse_adapter_cxf_separate">Secure CXF Application on separate Jetty Engine</a> then gives you more
control over security for each individual application.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>WEB-INF</code> directory might need to be inside your project (even if your project is not a web application). You might also need to edit the <code>/WEB-INF/jetty-web.xml</code> and <code>/WEB-INF/keycloak.json</code> files in a similar way as in <a href="#_fuse_adapter_classic_war">Classic WAR application</a>.
Note that you do not need the <code>web.xml</code> file as the security constraints are declared in the blueprint configuration file.</p>
</li>
<li>
<p>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> must contain these imports:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>META-INF.cxf;version="[2.7,3.2)",
META-INF.cxf.osgi;version="[2.7,3.2)";resolution:=optional,
org.apache.cxf.transport.http;version="[2.7,3.2)",
org.apache.cxf.*;version="[2.7,3.2)",
com.fasterxml.jackson.jaxrs.json;version="[2.5,3)",
org.eclipse.jetty.security;version="[8,10)",
org.eclipse.jetty.util.security;version="[8,10)",
org.keycloak.*;version="3.4.1.CR1",
org.keycloak.adapters.jetty;version="3.4.1.CR1",
*;resolution:=optional</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fuse_adapter_admin"><a class="anchor" href="#_fuse_adapter_admin"></a>Securing Fuse Administration Services</h5>
<div class="sect5">
<h6 id="using-ssh-authentication-to-fuse-terminal"><a class="anchor" href="#using-ssh-authentication-to-fuse-terminal"></a>Using SSH Authentication to Fuse Terminal</h6>
<div class="paragraph">
<p>Keycloak mainly addresses use cases for authentication of web applications; however, if your other web services and applications are protected
with Keycloak, protecting non-web administration services such as SSH with Keycloak credentials is a best pracrice. You can do this using the JAAS login module, which allows remote connection to Keycloak and verifies credentials based on
<a href="#_resource_owner_password_credentials_flow">Resource Owner Password Credentials</a>.</p>
</div>
<div class="paragraph">
<p>To enable SSH authentication, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In  Keycloak create a client (for example, <code>ssh-jmx-admin-client</code>), which will be used for SSH authentication.
This client needs to have <code>Direct Access Grants Enabled</code> selected to <code>On</code>.</p>
</li>
<li>
<p>In the <code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code> file, update or specify this property:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>sshRealm=keycloak</code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>$FUSE_HOME/etc/keycloak-direct-access.json</code> file with content similar to the following (based on your environment and Keycloak client settings):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ssh-jmx-admin-client</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">ssl-required</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">external</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">auth-server-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">credentials</span><span class="delimiter">&quot;</span></span>: {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This file specifies the client application configuration, which is used by JAAS DirectAccessGrantsLoginModule from the <code>keycloak</code> JAAS realm for SSH authentication.</p>
</div>
</li>
<li>
<p>Start Fuse and install the <code>keycloak</code> JAAS realm. The easiest way is to install the <code>keycloak-jaas</code> feature, which has the JAAS realm predefined. You can override the feature&#8217;s predefined realm by using your own <code>keycloak</code> JAAS realm with higher ranking. For details see the https:access.redhat.com/documentation/en-us/red_hat_jboss_fuse/6.3/html-single/security_guide/#ESBSecureContainer[JBoss Fuse documentation].</p>
<div class="paragraph">
<p>Use these commands in the Fuse terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/3.4.1.CR1/xml/features
features:install keycloak-jaas</code></pre>
</div>
</div>
</li>
<li>
<p>Log in using SSH as <code>admin</code> user by typing the following in the terminal:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>ssh -o PubkeyAuthentication=no -p 8101 admin@localhost</code></pre>
</div>
</div>
</li>
<li>
<p>Log in with password <code>password</code>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
On some later operating systems, you might also need to use the SSH command&#8217;s -o option <code>-o HostKeyAlgorithms=+ssh-dss</code> because later SSH clients do not allow use of the <code>ssh-dss</code> algorithm, by default. However, by default, it is currently used in JBoss Fuse 6.3.0 Rollup 5.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that the user needs to have realm role <code>admin</code> to perform all operations or another role to perform a subset of operations (for example, the <strong>viewer</strong> role that restricts the user to run only read-only Karaf commands). The available roles are configured in <code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code> or <code>$FUSE_HOME/etc/system.properties</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="using-jmx-authentication"><a class="anchor" href="#using-jmx-authentication"></a>Using JMX Authentication</h6>
<div class="paragraph">
<p>JMX authentication might be necessary if you want to use jconsole or another external tool to remotely connect to JMX through RMI. Otherwise it might be better to use hawt.io/jolokia, since the jolokia agent is installed in hawt.io by default. For more details see <a href="#_hawtio">Hawtio Admin Console</a>.</p>
</div>
<div class="paragraph">
<p>To use JMX authentication, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the <code>$FUSE_HOME/etc/org.apache.karaf.management.cfg</code> file, change the jmxRealm property to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>jmxRealm=keycloak</code></pre>
</div>
</div>
</li>
<li>
<p>Install the <code>keycloak-jaas</code> feature and configure the <code>$FUSE_HOME/etc/keycloak-direct-access.json</code> file as described in the SSH section above.</p>
</li>
<li>
<p>In jconsole you can use a URL such as:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>service:jmx:rmi://localhost:44444/jndi/rmi://localhost:1099/karaf-root</code></pre>
</div>
</div>
<div class="paragraph">
<p>and credentials: admin/password (based on the user with admin privileges according to your environment).</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_hawtio"><a class="anchor" href="#_hawtio"></a>Securing the Hawtio Administration Console</h5>
<div class="paragraph">
<p>To secure the Hawtio Administration Console with Keycloak, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add these properties to the <code>$FUSE_HOME/etc/system.properties</code> file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>hawtio.keycloakEnabled=true
hawtio.realm=keycloak
hawtio.keycloakClientConfig=file://${karaf.base}/etc/keycloak-hawtio-client.json
hawtio.rolePrincipalClasses=org.keycloak.adapters.jaas.RolePrincipal,org.apache.karaf.jaas.boot.principal.RolePrincipal</code></pre>
</div>
</div>
</li>
<li>
<p>Create a client in the Keycloak administration console in your realm. For example, in the Keycloak <code>demo</code> realm, create a client <code>hawtio-client</code>, specify <code>public</code> as the Access Type, and specify a redirect URI pointing to Hawtio: http://localhost:8181/hawtio/*. You must also have a corresponding Web Origin configured (in this case, http://localhost:8181).</p>
</li>
<li>
<p>Create the <code>keycloak-hawtio-client.json</code> file in the <code>$FUSE_HOME/etc</code> directory using content similar to that shown in the example below. Change the <code>realm</code>, <code>resource</code>, and <code>auth-server-url</code> properties according to your Keycloak environment. The <code>resource</code> property must point to the client created in the previous step. This file is used by the client (Hawtio Javascript application) side.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio-client</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">auth-server-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ssl-required</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">external</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">public-client</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create the <code>keycloak-hawtio.json</code> file in the <code>$FUSE_HOME/etc</code> dicrectory using content similar to that shown in the example below. Change the <code>realm</code> and <code>auth-server-url</code> properties according to your Keycloak environment. This file is used by the adapters on the server (JAAS Login module) side.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">realm</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">jaas</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">bearer-only</span><span class="delimiter">&quot;</span></span> : <span class="value">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">auth-server-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">ssl-required</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">external</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">use-resource-role-mappings</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">principal-attribute</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">preferred_username</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</li>
<li>
<p>Start JBoss Fuse 6.3.0 Rollup 5 and install the keycloak feature if you have not already done so. The commands in Karaf terminal are similar to this example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/3.4.1.CR1/xml/features
features:install keycloak</code></pre>
</div>
</div>
</li>
<li>
<p>Go to <a href="http://localhost:8181/hawtio" class="bare">http://localhost:8181/hawtio</a> and log in as a user from your Keycloak realm.</p>
<div class="paragraph">
<p>Note that the user needs to have the proper realm role to successfully authenticate to Hawtio. The available roles are configured in the <code>$FUSE_HOME/etc/system.properties</code> file in <code>hawtio.roles</code>.</p>
</div>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="securing-hawtio-on-jboss-eap-6-4"><a class="anchor" href="#securing-hawtio-on-jboss-eap-6-4"></a>Securing Hawtio on JBoss EAP 6.4</h6>
<div class="paragraph">
<p>To run Hawtio on the JBoss EAP 6.4 server, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up Keycloak as described in the previous section, Securing the Hawtio Administration Console. It is assumed that:</p>
<div class="ulist">
<ul>
<li>
<p>you have a Keycloak realm <code>demo</code> and client <code>hawtio-client</code></p>
</li>
<li>
<p>your Keycloak is running on <code>localhost:8080</code></p>
</li>
<li>
<p>the JBoss EAP 6.4 server with deployed Hawtio will be running on <code>localhost:8181</code>. The directory with this server is referred in next steps as <code>$EAP_HOME</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Copy the <code>hawtio-wildfly-1.4.0.redhat-630254.war</code> archive to the <code>$EAP_HOME/standalone/configuration</code> directory. For more details about deploying Hawtio see the <a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_fuse/6.3/html-single/deploying_into_a_web_server/">Fuse Hawtio documentation</a>.</p>
</li>
<li>
<p>Copy the <code>keycloak-hawtio.json</code> and <code>keycloak-hawtio-client.json</code> files with the above content to the <code>$EAP_HOME/standalone/configuration</code> directory.</p>
</li>
<li>
<p>Install the Keycloak adapter subsystem to your JBoss EAP 6.4 server as described in the <a href="#_jboss_adapter">JBoss adapter documentation</a>.</p>
</li>
<li>
<p>In the <code>$EAP_HOME/standalone/configuration/standalone.xml</code> file configure the system properties as in this example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;extensions&gt;</span>
...
<span class="tag">&lt;/extensions&gt;</span>

<span class="tag">&lt;system-properties&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.authenticationEnabled</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.realm</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.roles</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">admin,viewer</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.rolePrincipalClasses</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jaas.RolePrincipal</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.keycloakEnabled</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.keycloakClientConfig</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.server.config.dir}/keycloak-hawtio-client.json</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio.keycloakServerConfig</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.server.config.dir}/keycloak-hawtio.json</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/system-properties&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the Hawtio realm to the same file in the <code>security-domains</code> section:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;security-domain</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">cache-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;authentication&gt;</span>
        <span class="tag">&lt;login-module</span> <span class="attribute-name">code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jaas.BearerTokenLoginModule</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">flag</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;module-option</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak-config-file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${hawtio.keycloakServerConfig}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/login-module&gt;</span>
    <span class="tag">&lt;/authentication&gt;</span>
<span class="tag">&lt;/security-domain&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the <code>secure-deployment</code> section <code>hawtio</code> to the adapter subsystem. This ensures that the Hawtio WAR is able to find the JAAS login module classes.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hawtio-wildfly-1.4.0.redhat-630254.war</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Restart the JBoss EAP 6.4 server with Hawtio:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">cd $EAP_HOME/bin
./standalone.sh -Djboss.socket.binding.port-offset=101</code></pre>
</div>
</div>
</li>
<li>
<p>Access Hawtio at <a href="http://localhost:8181/hawtio" class="bare">http://localhost:8181/hawtio</a>. It is secured by Keycloak.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_boot_adapter"><a class="anchor" href="#_spring_boot_adapter"></a>2.1.4. Spring Boot Adapter</h4>
<div class="paragraph">
<p>To be able to secure Spring Boot apps you must add the Keycloak Spring Boot adapter JAR to your app.
You then have to provide some extra configuration via normal Spring Boot configuration (<code>application.properties</code>).  Let&#8217;s go over these steps.</p>
</div>
<div class="sect4">
<h5 id="_spring_boot_adapter_installation"><a class="anchor" href="#_spring_boot_adapter_installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>The Keycloak Spring Boot adapter takes advantage of Spring Boot&#8217;s autoconfiguration so all you need to do is add the Keycloak Spring Boot starter to your project.
They Keycloak Spring Boot Starter is also directly available from the <a href="http://start.spring.io/">Spring Start Page</a>.
To add it manually and if you are using Maven, add the following to your dependencies :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>keycloak-spring-boot-starter<span class="tag">&lt;/artifactId&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Make also sure to add the Adapter POM dependency :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencyManagement&gt;</span>
  <span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>org.keycloak.bom<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>keycloak-adapter-bom<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;version&gt;</span>3.4.1.CR1<span class="tag">&lt;/version&gt;</span>
      <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
      <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
  <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Currently the following embedded containers are supported and do not require any extra dependencies if using the Starter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tomcat</p>
</li>
<li>
<p>Undertow</p>
</li>
<li>
<p>Jetty</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_spring_boot_adapter_configuration"><a class="anchor" href="#_spring_boot_adapter_configuration"></a>Required Spring Boot Adapter Configuration</h5>
<div class="paragraph">
<p>This section describes how to configure your Spring Boot app to use Keycloak.</p>
</div>
<div class="paragraph">
<p>Instead of a <code>keycloak.json</code> file, you configure the realm for the Spring Boot Keycloak adapter via the normal Spring Boot configuration.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>keycloak.realm = demorealm
keycloak.auth-server-url = http://127.0.0.1:8080/auth
keycloak.ssl-required = external
keycloak.resource = demoapp
keycloak.credentials.secret = 11111111-1111-1111-1111-111111111111
keycloak.use-resource-role-mappings = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can disable the Keycloak Spring Boot Adapter (for example in tests) by setting <code>keycloak.enabled = false</code>.</p>
</div>
<div class="paragraph">
<p>To configure a Policy Enforcer, unlike keycloak.json, <code>policy-enforcer-config</code> must be used instead of just <code>policy-enforcer</code>.</p>
</div>
<div class="paragraph">
<p>You also need to specify the Java EE security config that would normally go in the <code>web.xml</code>.
The Spring Boot Adapter will set the <code>login-method</code> to <code>KEYCLOAK</code> and configure the <code>security-constraints</code> at startup time.
Here&#8217;s an example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>keycloak.securityConstraints[0].authRoles[0] = admin
keycloak.securityConstraints[0].authRoles[1] = user
keycloak.securityConstraints[0].securityCollections[0].name = insecure stuff
keycloak.securityConstraints[0].securityCollections[0].patterns[0] = /insecure

keycloak.securityConstraints[1].authRoles[0] = admin
keycloak.securityConstraints[1].securityCollections[0].name = admin stuff
keycloak.securityConstraints[1].securityCollections[0].patterns[0] = /admin</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you plan to deploy your Spring Application as a WAR then you should not use the Spring Boot Adapter and use the dedicated adapter for the application server or servlet container you are using. Your Spring Boot should also contain a <code>web.xml</code> file.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tomcat_adapter"><a class="anchor" href="#_tomcat_adapter"></a>2.1.5. Tomcat 6, 7 and 8 Adapters</h4>
<div class="paragraph">
<p>To be able to secure WAR apps deployed on Tomcat 6, 7 and 8 you must install the Keycloak Tomcat 6, 7 or 8 adapter into your Tomcat installation.
You then have to provide some extra configuration in each WAR you deploy to Tomcat.
Let&#8217;s go over these steps.</p>
</div>
<div class="sect4">
<h5 id="_tomcat_adapter_installation"><a class="anchor" href="#_tomcat_adapter_installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>Adapters are no longer included with the appliance or war distribution.
Each adapter is a separate download on the Keycloak download site.
They are also available as a maven artifact.</p>
</div>
<div class="paragraph">
<p>You must unzip the adapter distro into Tomcat&#8217;s <code>lib/</code> directory.
Including adapter&#8217;s jars within your WEB-INF/lib directory will not work!  The Keycloak adapter is implemented as a Valve and valve code must reside in Tomcat&#8217;s main lib/ directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $TOMCAT_HOME/lib
$ unzip keycloak-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-tomcat8-adapter-dist.zip</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="required-per-war-configuration-2"><a class="anchor" href="#required-per-war-configuration-2"></a>Required Per WAR Configuration</h5>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>META-INF/context.xml</code> file in your WAR package.
This is a Tomcat specific config file and you must define a Keycloak specific Valve.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;Context path="/your-context-path"&gt;
    &lt;Valve className="org.keycloak.adapters.tomcat.KeycloakAuthenticatorValve"/&gt;
&lt;/Context&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you must create a <code>keycloak.json</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.</p>
</div>
<div class="paragraph">
<p>The format of this config file is described in the <a href="#_java_adapter_config">Java adapter configuration</a></p>
</div>
<div class="paragraph">
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs.
Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jetty9_adapter"><a class="anchor" href="#_jetty9_adapter"></a>2.1.6. Jetty 9.x Adapters</h4>
<div class="paragraph">
<p>Keycloak has a separate adapter for Jetty 9.1.x, Jetty 9.2.x and Jetty 9.3.x that you will have to install into your Jetty installation.
You then have to provide some extra configuration in each WAR you deploy to Jetty.
Let&#8217;s go over these steps.</p>
</div>
<div class="sect4">
<h5 id="_jetty9_adapter_installation"><a class="anchor" href="#_jetty9_adapter_installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site.
They are also available as a maven artifact.</p>
</div>
<div class="paragraph">
<p>You must unzip the Jetty 9.x  distro into Jetty 9.x&#8217;s <a href="https://www.eclipse.org/jetty/documentation/current/startup-base-and-home.html">base directory</a>.
Including adapter&#8217;s jars within your WEB-INF/lib directory will not work!
In the example below, the Jetty base is named <code>your-base</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd your-base
$ unzip keycloak-jetty93-adapter-dist-2.5.0.Final.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you will have to enable the <code>keycloak</code> module for your Jetty base:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ java -jar $JETTY_HOME/start.jar --add-to-startd=keycloak</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_jetty9_per_war"><a class="anchor" href="#_jetty9_per_war"></a>Required Per WAR Configuration</h5>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>WEB-INF/jetty-web.xml</code> file in your WAR package.
This is a Jetty specific config file and you must define a Keycloak specific authenticator within it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd"&gt;
&lt;Configure class="org.eclipse.jetty.webapp.WebAppContext"&gt;
    &lt;Get name="securityHandler"&gt;
        &lt;Set name="authenticator"&gt;
            &lt;New class="org.keycloak.adapters.jetty.KeycloakJettyAuthenticator"&gt;
            &lt;/New&gt;
        &lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Configure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you must create a <code>keycloak.json</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.</p>
</div>
<div class="paragraph">
<p>The format of this config file is described in the <a href="#_java_adapter_config">Java adapter configuration</a>            section.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The Jetty 9.1.x adapter will not be able to find the <code>keycloak.json</code> file.
You will have to define all adapter settings within the <code>jetty-web.xml</code> file as described below.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Instead of using keycloak.json, you can define everything within the <code>jetty-web.xml</code>.
You&#8217;ll just have to figure out how the json settings match to the <code>org.keycloak.representations.adapters.config.AdapterConfig</code>            class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;?xml version="1.0"?&gt;
&lt;!DOCTYPE Configure PUBLIC "-//Mort Bay Consulting//DTD Configure//EN" "http://www.eclipse.org/jetty/configure_9_0.dtd"&gt;
&lt;Configure class="org.eclipse.jetty.webapp.WebAppContext"&gt;
  &lt;Get name="securityHandler"&gt;
    &lt;Set name="authenticator"&gt;
        &lt;New class="org.keycloak.adapters.jetty.KeycloakJettyAuthenticator"&gt;
            &lt;Set name="adapterConfig"&gt;
                &lt;New class="org.keycloak.representations.adapters.config.AdapterConfig"&gt;
                    &lt;Set name="realm"&gt;tomcat&lt;/Set&gt;
                    &lt;Set name="resource"&gt;customer-portal&lt;/Set&gt;
                    &lt;Set name="authServerUrl"&gt;http://localhost:8081/auth&lt;/Set&gt;
                    &lt;Set name="sslRequired"&gt;external&lt;/Set&gt;
                    &lt;Set name="credentials"&gt;
                        &lt;Map&gt;
                            &lt;Entry&gt;
                                &lt;Item&gt;secret&lt;/Item&gt;
                                &lt;Item&gt;password&lt;/Item&gt;
                            &lt;/Entry&gt;
                        &lt;/Map&gt;
                    &lt;/Set&gt;
                &lt;/New&gt;
            &lt;/Set&gt;
        &lt;/New&gt;
    &lt;/Set&gt;
  &lt;/Get&gt;
&lt;/Configure&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You do not have to crack open your WAR to secure it with keycloak.
Instead create the jetty-web.xml file in your webapps directory with the name of yourwar.xml.
Jetty should pick it up.
In this mode, you&#8217;ll have to declare keycloak.json configuration directly within the xml file.</p>
</div>
<div class="paragraph">
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs.
Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;web-app xmlns="http://java.sun.com/xml/ns/javaee"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
      version="3.0"&gt;

	&lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jetty8_adapter"><a class="anchor" href="#_jetty8_adapter"></a>2.1.7. Jetty 8.1.x Adapter</h4>
<div class="paragraph">
<p>Keycloak has a separate adapter for Jetty 8.1.x that you will have to install into your Jetty installation.
You then have to provide some extra configuration in each WAR you deploy to Jetty.
Let&#8217;s go over these steps.</p>
</div>
<div class="sect4">
<h5 id="_jetty8_adapter_installation"><a class="anchor" href="#_jetty8_adapter_installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site.
They are also available as a maven artifact.</p>
</div>
<div class="paragraph">
<p>You must unzip the Jetty 8.1.x  distro into Jetty 8.1.x&#8217;s root directory.
Including adapter&#8217;s jars within your WEB-INF/lib directory will not work!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $JETTY_HOME
$ unzip keycloak-jetty81-adapter-dist.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you will have to enable the keycloak option.
Edit start.ini and add keycloak to the options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>#===========================================================
# Start classpath OPTIONS.
# These control what classes are on the classpath
# for a full listing do
#   java -jar start.jar --list-options
#-----------------------------------------------------------
OPTIONS=Server,jsp,jmx,resources,websocket,ext,plus,annotations,keycloak</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="required-per-war-configuration-3"><a class="anchor" href="#required-per-war-configuration-3"></a>Required Per WAR Configuration</h5>
<div class="paragraph">
<p>Enabling Keycloak for your WARs is the same as the Jetty 9.x adapter.
Our 8.1.x adapter supports both keycloak.json and the jboss-web.xml advanced configuration.
See <a href="#_jetty9_per_war">Required Per WAR Configuration</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_security_adapter"><a class="anchor" href="#_spring_security_adapter"></a>2.1.8. Spring Security Adapter</h4>
<div class="paragraph">
<p>To secure an application with Spring Security and Keycloak, add this adapter as a dependency to your project.
You then have to provide some extra beans in your Spring Security configuration file and add the Keycloak security filter to your pipeline.</p>
</div>
<div class="paragraph">
<p>Unlike the other Keycloak Adapters, you should not configure your security in web.xml.
However, keycloak.json is still required.</p>
</div>
<div class="sect4">
<h5 id="adapter-installation"><a class="anchor" href="#adapter-installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>Add Keycloak Spring Security adapter as a dependency to your Maven POM or Gradle build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>keycloak-spring-security-adapter<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>3.4.1.CR1<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="spring-security-configuration"><a class="anchor" href="#spring-security-configuration"></a>Spring Security Configuration</h5>
<div class="paragraph">
<p>The Keycloak Spring Security adapter takes advantage of Spring Security&#8217;s flexible security configuration syntax.</p>
</div>
<div class="sect5">
<h6 id="java-configuration"><a class="anchor" href="#java-configuration"></a>Java Configuration</h6>
<div class="paragraph">
<p>Keycloak provides a KeycloakWebSecurityConfigurerAdapter as a convenient base class for creating a <a href="https://docs.spring.io/spring-security/site/docs/4.0.x/apidocs/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html">WebSecurityConfigurer</a>                instance.
The implementation allows customization by overriding methods.
While its use is not required, it greatly simplifies your security context configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>@KeycloakConfiguration
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    /**
     * Registers the KeycloakAuthenticationProvider with the authentication manager.
     */
    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.authenticationProvider(keycloakAuthenticationProvider());
    }

    /**
     * Defines the session authentication strategy.
     */
    @Bean
    @Override
    protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
        return new RegisterSessionAuthenticationStrategy(new SessionRegistryImpl());
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception
    {
        super.configure(http);
        http
                .authorizeRequests()
                .antMatchers("/customers*").hasRole("USER")
                .antMatchers("/admin*").hasRole("ADMIN")
                .anyRequest().permitAll();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You must provide a session authentication strategy bean which should be of type <code>RegisterSessionAuthenticationStrategy</code> for public or confidential applications and <code>NullAuthenticatedSessionStrategy</code> for bearer-only applications.</p>
</div>
<div class="paragraph">
<p>Spring Security&#8217;s <code>SessionFixationProtectionStrategy</code> is currently not supported because it changes the session identifier after login via Keycloak.
If the session identifier changes, universal log out will not work because Keycloak is unaware of the new session identifier.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>@KeycloakConfiguration</code> annotation is a metadata annotion that defines all annotations that are needed to integrate
Keycloak in Spring Security. If you have a complexe Spring Security setup you can simply have a look ath the annotations of
the <code>@KeycloakConfiguration</code> annotation and create your own custom meta annotation or just use specific Spring annotations
for the Keycloak adapter.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="xml-configuration"><a class="anchor" href="#xml-configuration"></a>XML Configuration</h6>
<div class="paragraph">
<p>While Spring Security&#8217;s XML namespace simplifies configuration, customizing the configuration can be a bit verbose.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:security="http://www.springframework.org/schema/security"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd"&gt;

    &lt;context:component-scan base-package="org.keycloak.adapters.springsecurity" /&gt;

    &lt;security:authentication-manager alias="authenticationManager"&gt;
        &lt;security:authentication-provider ref="keycloakAuthenticationProvider" /&gt;
    &lt;/security:authentication-manager&gt;

    &lt;bean id="adapterDeploymentContext" class="org.keycloak.adapters.springsecurity.AdapterDeploymentContextFactoryBean"&gt;
        &lt;constructor-arg value="/WEB-INF/keycloak.json" /&gt;
    &lt;/bean&gt;

    &lt;bean id="keycloakAuthenticationEntryPoint" class="org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationEntryPoint" /&gt;
    &lt;bean id="keycloakAuthenticationProvider" class="org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider" /&gt;
    &lt;bean id="keycloakPreAuthActionsFilter" class="org.keycloak.adapters.springsecurity.filter.KeycloakPreAuthActionsFilter" /&gt;
    &lt;bean id="keycloakAuthenticationProcessingFilter" class="org.keycloak.adapters.springsecurity.filter.KeycloakAuthenticationProcessingFilter"&gt;
        &lt;constructor-arg name="authenticationManager" ref="authenticationManager" /&gt;
    &lt;/bean&gt;

    &lt;bean id="keycloakLogoutHandler" class="org.keycloak.adapters.springsecurity.authentication.KeycloakLogoutHandler"&gt;
        &lt;constructor-arg ref="adapterDeploymentContext" /&gt;
    &lt;/bean&gt;

    &lt;bean id="logoutFilter" class="org.springframework.security.web.authentication.logout.LogoutFilter"&gt;
        &lt;constructor-arg name="logoutSuccessUrl" value="/" /&gt;
        &lt;constructor-arg name="handlers"&gt;
            &lt;list&gt;
                &lt;ref bean="keycloakLogoutHandler" /&gt;
                &lt;bean class="org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler" /&gt;
            &lt;/list&gt;
        &lt;/constructor-arg&gt;
        &lt;property name="logoutRequestMatcher"&gt;
            &lt;bean class="org.springframework.security.web.util.matcher.AntPathRequestMatcher"&gt;
                &lt;constructor-arg name="pattern" value="/sso/logout**" /&gt;
                &lt;constructor-arg name="httpMethod" value="GET" /&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;security:http auto-config="false" entry-point-ref="keycloakAuthenticationEntryPoint"&gt;
        &lt;security:custom-filter ref="keycloakPreAuthActionsFilter" before="LOGOUT_FILTER" /&gt;
        &lt;security:custom-filter ref="keycloakAuthenticationProcessingFilter" before="FORM_LOGIN_FILTER" /&gt;
        &lt;security:intercept-url pattern="/customers**" access="ROLE_USER" /&gt;
        &lt;security:intercept-url pattern="/admin**" access="ROLE_ADMIN" /&gt;
        &lt;security:custom-filter ref="logoutFilter" position="LOGOUT_FILTER" /&gt;
    &lt;/security:http&gt;

&lt;/beans&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="multi-tenancy"><a class="anchor" href="#multi-tenancy"></a>Multi Tenancy</h5>
<div class="paragraph">
<p>The Keycloak Spring Security adapter also supports multi tenancy.
Instead of injecting <code>AdapterDeploymentContextFactoryBean</code> with the path to <code>keycloak.json</code> you can inject an implementation of the <code>KeycloakConfigResolver</code> interface.
More details on how to implement the <code>KeycloakConfigResolver</code> can be found in <a href="#_multi_tenancy">Multi Tenancy</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="naming-security-roles"><a class="anchor" href="#naming-security-roles"></a>Naming Security Roles</h5>
<div class="paragraph">
<p>Spring Security, when using role-based authentication, requires that role names start with <code>ROLE_</code>.
For example, an administrator role must be declared in Keycloak as <code>ROLE_ADMIN</code> or similar, not simply <code>ADMIN</code>.</p>
</div>
<div class="paragraph">
<p>The class <code>org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider</code>            supports an optional <code>org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper</code>            which can be used to map roles coming from Keycloak to roles recognized by Spring Security.
Use, for example, <code>org.springframework.security.core.authority.mapping.SimpleAuthorityMapper</code> to insert the <code>ROLE_</code> prefix and convert the role name to upper case.
The class is part of Spring Security Core module.</p>
</div>
</div>
<div class="sect4">
<h5 id="client-to-client-support"><a class="anchor" href="#client-to-client-support"></a>Client to Client Support</h5>
<div class="paragraph">
<p>To simplify communication between clients, Keycloak provides an extension of Spring&#8217;s <code>RestTemplate</code> that handles bearer token authentication for you.
To enable this feature your security configuration must add the <code>KeycloakRestTemplate</code> bean.
Note that it must be scoped as a prototype to function correctly.</p>
</div>
<div class="paragraph">
<p>For Java configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>@Configuration
@EnableWebSecurity
@ComponentScan(basePackageClasses = KeycloakSecurityComponents.class)
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter {

    ...

    @Autowired
    public KeycloakClientRequestFactory keycloakClientRequestFactory;

    @Bean
    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public KeycloakRestTemplate keycloakRestTemplate() {
        return new KeycloakRestTemplate(keycloakClientRequestFactory);
    }

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For XML configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;bean id="keycloakRestTemplate" class="org.keycloak.adapters.springsecurity.client.KeycloakRestTemplate" scope="prototype"&gt;
    &lt;constructor-arg name="factory" ref="keycloakClientRequestFactory" /&gt;
&lt;/bean&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your application code can then use <code>KeycloakRestTemplate</code> any time it needs to make a call to another client.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>@Service
public class RemoteProductService implements ProductService {

    @Autowired
    private KeycloakRestTemplate template;

    private String endpoint;

    @Override
    public List&lt;String&gt; getProducts() {
        ResponseEntity&lt;String[]&gt; response = template.getForEntity(endpoint, String[].class);
        return Arrays.asList(response.getBody());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="spring-boot-integration"><a class="anchor" href="#spring-boot-integration"></a>Spring Boot Integration</h5>
<div class="paragraph">
<p>The Spring Boot and the Spring Security adapters can be combined.</p>
</div>
<div class="paragraph">
<p>If you are using the Keycloak Spring Boot Starter to make use of the Spring Security adapter you just need to add the Spring Security starter :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="sect5">
<h6 id="using-spring-boot-configuration"><a class="anchor" href="#using-spring-boot-configuration"></a>Using Spring Boot Configuration</h6>
<div class="paragraph">
<p>By Default, the Spring Security Adapter looks for a <code>keycloak.json</code> configuration file. You can make sure it looks at the configuration provided by the Spring Boot Adapter by adding this bean :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>@Bean
public KeycloakConfigResolver KeycloakConfigResolver() {
    return new KeycloakSpringBootConfigResolver();
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="avoid-double-filter-bean-registration"><a class="anchor" href="#avoid-double-filter-bean-registration"></a>Avoid double Filter bean registration</h6>
<div class="paragraph">
<p>Spring Boot attempts to eagerly register filter beans with the web application context.
Therefore, when running the Keycloak Spring Security adapter in a Spring Boot environment, it may be necessary to add two <code>FilterRegistrationBean</code>s to your security configuration to prevent the Keycloak filters from being registered twice.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>@Configuration
@EnableWebSecurity
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    ...

    @Bean
    public FilterRegistrationBean keycloakAuthenticationProcessingFilterRegistrationBean(
            KeycloakAuthenticationProcessingFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean keycloakPreAuthActionsFilterRegistrationBean(
            KeycloakPreAuthActionsFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_servlet_filter_adapter"><a class="anchor" href="#_servlet_filter_adapter"></a>2.1.9. Java Servlet Filter Adapter</h4>
<div class="paragraph">
<p>If you are deploying your Java Servlet application on a platform where there is no Keycloak adapter you opt to use the servlet filter adapter.
This adapter works a bit differently than the other adapters. You do not define security constraints in web.xml.
Instead you define a filter mapping using the Keycloak servlet filter adapter to secure the url patterns you want to secure.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Backchannel logout works a bit differently than the standard adapters.
Instead of invalidating the HTTP session it marks the session id as logged out.
There&#8217;s no standard way to invalidate an HTTP session based on a session id.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;module-name&gt;</span>application<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;filter&gt;</span>
        <span class="tag">&lt;filter-name&gt;</span>Keycloak Filter<span class="tag">&lt;/filter-name&gt;</span>
        <span class="tag">&lt;filter-class&gt;</span>org.keycloak.adapters.servlet.KeycloakOIDCFilter<span class="tag">&lt;/filter-class&gt;</span>
    <span class="tag">&lt;/filter&gt;</span>
    <span class="tag">&lt;filter-mapping&gt;</span>
        <span class="tag">&lt;filter-name&gt;</span>Keycloak Filter<span class="tag">&lt;/filter-name&gt;</span>
        <span class="tag">&lt;url-pattern&gt;</span>/keycloak/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;url-pattern&gt;</span>/protected/*<span class="tag">&lt;/url-pattern&gt;</span>
    <span class="tag">&lt;/filter-mapping&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the snippet above there are two url-patterns.
 <em>/protected/*</em> are the files we want protected, while the <em>/keycloak/*</em> url-pattern handles callbacks from the Keycloak server.</p>
</div>
<div class="paragraph">
<p>If you need to exclude some paths beneath the configured <code>url-patterns</code> you can use the Filter init-param <code>keycloak.config.skipPattern</code> to configure
a regular expression that describes a path-pattern for which the keycloak filter should immediately delegate to the filter-chain.
By default no skipPattern is configured.</p>
</div>
<div class="paragraph">
<p>Patterns are matched against the <code>requestURI</code> without the <code>context-path</code>. Given the context-path <code>/myapp</code> a request for <code>/myapp/index.html</code> will be matched with <code>/index.html</code> against the skip pattern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;init-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>keycloak.config.skipPattern<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>^/(path1|path2|path3).*<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/init-param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you should configure your client in the Keycloak Admin Console with an Admin URL that points to a secured section covered by the filter&#8217;s url-pattern.</p>
</div>
<div class="paragraph">
<p>The Admin URL will make callbacks to the Admin URL to do things like backchannel logout.
So, the Admin URL in this example should be <code>http[s]://hostname/{context-root}/keycloak</code>.</p>
</div>
<div class="paragraph">
<p>The Keycloak filter has the same configuration parameters as the other adapters except you must define them as filter init params instead of context params.</p>
</div>
<div class="paragraph">
<p>To use this filter, include this maven artifact in your WAR poms:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>keycloak-servlet-filter-adapter<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>3.4.1.CR1<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jaas_adapter"><a class="anchor" href="#_jaas_adapter"></a>2.1.10. JAAS plugin</h4>
<div class="paragraph">
<p>It&#8217;s generally not needed to use JAAS for most of the applications, especially if they are HTTP based, and you should most likely choose one of our other adapters.
However, some applications and systems may still rely on pure legacy JAAS solution.
Keycloak provides two login modules to help in these situations.</p>
</div>
<div class="paragraph">
<p>The provided login modules are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule</dt>
<dd>
<p>This login module allows to authenticate with username/password from Keycloak.
It&#8217;s using <a href="#_resource_owner_password_credentials_flow">Resource Owner Password Credentials</a> flow to validate if the provided
username/password is valid. It&#8217;s useful for non-web based systems, which need to rely on JAAS and want to use Keycloak, but can&#8217;t use the standard browser
based flows due to their non-web nature. Example of such application could be messaging or SSH.</p>
</dd>
<dt class="hdlist1">org.keycloak.adapters.jaas.BearerTokenLoginModule</dt>
<dd>
<p>This login module allows to authenticate with Keycloak access token passed to it through CallbackHandler as password.
It may be useful for example in case, when you have Keycloak access token from standard based authentication flow and your web application then
needs to talk to external non-web based system, which rely on JAAS. For example a messaging system.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Both modules use the following configuration properties:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">keycloak-config-file</dt>
<dd>
<p>The location of the <code>keycloak.json</code> configuration file. The configuration file can either be located on the filesystem or on the classpath. If it&#8217;s located
on the classpath you need to prefix the location with <code>classpath:</code> (for example <code>classpath:/path/keycloak.json</code>).
This is <em>REQUIRED.</em></p>
</dd>
<dt class="hdlist1"><code>role-principal-class</code></dt>
<dd>
<p>Configure alternative class for Role principals attached to JAAS Subject.
Default value is <code>org.keycloak.adapters.jaas.RolePrincipal</code>. Note: The class is required to have a constructor with a single <code>String</code> argument.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_installed_adapter"><a class="anchor" href="#_installed_adapter"></a>2.1.11. CLI / Desktop Applications</h4>
<div class="paragraph">
<p>Keycloak supports securing desktop
(e.g. Swing, JavaFX) or CLI applications via the
<code>KeycloakInstalled</code> adapter by performing the authentication step via the system browser.</p>
</div>
<div class="paragraph">
<p>The <code>KeycloakInstalled</code> adapter supports a <code>desktop</code> and a <code>manual</code>
variant. The desktop variant uses the system browser
to gather the user credentials. The manual variant
reads the user credentials from <code>STDIN</code>.</p>
</div>
<div class="paragraph">
<p>Tip: Google provides some more information about this approach on at
<a href="https://developers.google.com/identity/protocols/OAuth2InstalledApp">OAuth2InstalledApp</a>.</p>
</div>
<div class="sect4">
<h5 id="how-it-works"><a class="anchor" href="#how-it-works"></a>How it works</h5>
<div class="paragraph">
<p>To authenticate a user with the <code>desktop</code> variant the <code>KeycloakInstalled</code>
adapter opens a desktop browser window where a user uses the regular Keycloak
login pages to login when the <code>loginDesktop()</code> method is called on the <code>KeycloakInstalled</code> object.</p>
</div>
<div class="paragraph">
<p>The login page URL is opened with redirect parameter
that points to a local <code>ServerSocket</code> listening on a free ephemeral port
on <code>localhost</code> which is started by the adapter.</p>
</div>
<div class="paragraph">
<p>After a succesful login the <code>KeycloakInstalled</code> receives the authorization code
from the incoming HTTP request and performs the authorization code flow.
Once the code to token exchange is completed the <code>ServerSocket</code> is shutdown.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If the user already has an active Keycloak session then
the login form is not shown but the code to token exchange is continued,
which enables a smooth Web based SSO experience.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The client eventually receives the tokens (access_token, refresh_token,
id_token) which can then be used to call backend services.</p>
</div>
<div class="paragraph">
<p>The <code>KeycloakInstalled</code> adapter provides support for renewal of stale tokens.</p>
</div>
</div>
<div class="sect4">
<h5 id="_installed_adapter_installation"><a class="anchor" href="#_installed_adapter_installation"></a>Adapter Installation</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>keycloak-installed-adapter<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>3.4.1.CR1<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="client-configuration"><a class="anchor" href="#client-configuration"></a>Client Configuration</h5>
<div class="paragraph">
<p>The application needs to be configured as a <code>public</code> OpenID Connect client with
<code>Standard Flow Enabled</code> and http://localhost:* as an allowed <code>Valid Redirect URI</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="usage"><a class="anchor" href="#usage"></a>Usage</h5>
<div class="paragraph">
<p>The <code>KeycloakInstalled</code> adapter reads it&#8217;s configuration from
<code>META-INF/keycloak.json</code> on the classpath. Custom configurations
can be supplied with an <code>InputStream</code> or a <code>KeycloakDeployment</code>
through the <code>KeycloakInstalled</code> constructor.</p>
</div>
<div class="paragraph">
<p>In the example below, the client configuration for <code>desktop-app</code>
uses the following <code>keycloak.json</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
  "realm": "desktop-app-auth",
  "auth-server-url": "http://localhost:8081/auth",
  "ssl-required": "external",
  "resource": "desktop-app",
  "public-client": true,
  "use-resource-role-mappings": true
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>the following sketch demonstrates working with the <code>KeycloakInstalled</code> adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>// reads the configuration from classpath: META-INF/keycloak.json
KeycloakInstalled keycloak = new KeycloakInstalled();

// opens desktop browser
keycloak.loginDesktop();

AccessToken token = keycloak.getToken();
// use token to send backend request

// ensure token is valid for at least 30 seconds
long minValidity = 30L;
String tokenString = keycloak.getTokenString(minValidity, TimeUnit.SECONDS);


 // when you want to logout the user.
keycloak.logout();</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The <code>KeycloakInstalled</code> class supports customization of the http responses returned by
login / logout requests via the <code>loginResponseWriter</code> and <code>logoutResponseWriter</code> attributes.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="example"><a class="anchor" href="#example"></a>Example</h5>
<div class="paragraph">
<p>The following provides an example for the configuration mentioned above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>import java.util.Locale;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

import org.keycloak.adapters.installed.KeycloakInstalled;
import org.keycloak.representations.AccessToken;

public class DesktopApp {

	public static void main(String[] args) throws Exception {

		KeycloakInstalled keycloak = new KeycloakInstalled();
		keycloak.setLocale(Locale.ENGLISH);
		keycloak.loginDesktop();

		AccessToken token = keycloak.getToken();
		Executors.newSingleThreadExecutor().submit(() -&gt; {

			System.out.println("Logged in...");
			System.out.println("Token: " + token.getSubject());
			System.out.println("Username: " + token.getPreferredUsername());
			try {
				System.out.println("AccessToken: " + keycloak.getTokenString());
			} catch (Exception ex) {
				ex.printStackTrace();
			}

			int timeoutSeconds = 20;
			System.out.printf("Logging out in...%d Seconds%n", timeoutSeconds);
			try {
				TimeUnit.SECONDS.sleep(timeoutSeconds);
			} catch (Exception e) {
				e.printStackTrace();
			}

			try {
				keycloak.logout();
			} catch (Exception e) {
				e.printStackTrace();
			}

			System.out.println("Exiting...");
			System.exit(0);
		});
	}
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="security-context"><a class="anchor" href="#security-context"></a>2.1.12. Security Context</h4>
<div class="paragraph">
<p>The <code>KeycloakSecurityContext</code> interface is available if you need to access to the tokens directly. This could be useful if you want to retrieve additional
details from the token (such as user profile information) or you want to invoke a RESTful service that is protected by Keycloak.</p>
</div>
<div class="paragraph">
<p>In servlet environments it is available in secured invocations as an attribute in HttpServletRequest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">httpServletRequest
    .getAttribute(KeycloakSecurityContext.class.getName());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, it is available in secure and insecure requests in the HttpSession:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">httpServletRequest.getSession()
    .getAttribute(KeycloakSecurityContext.class.getName());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adapter_error_handling"><a class="anchor" href="#_adapter_error_handling"></a>2.1.13. Error Handling</h4>
<div class="paragraph">
<p>Keycloak has some error handling facilities for servlet based client adapters.
When an error is encountered in authentication, Keycloak will call <code>HttpServletResponse.sendError()</code>.
You can set up an error-page within your <code>web.xml</code> file to handle the error however you want.
Keycloak can throw 400, 401, 403, and 500 errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;error-page&gt;</span>
    <span class="tag">&lt;error-code&gt;</span>403<span class="tag">&lt;/error-code&gt;</span>
    <span class="tag">&lt;location&gt;</span>/ErrorHandler<span class="tag">&lt;/location&gt;</span>
<span class="tag">&lt;/error-page&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Keycloak also sets a <code>HttpServletRequest</code> attribute that you can retrieve.
The attribute name is <code>org.keycloak.adapters.spi.AuthenticationError</code>, which should be casted to <code>org.keycloak.adapters.OIDCAuthenticationError</code>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.keycloak.adapters.OIDCAuthenticationError</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.OIDCAuthenticationError.Reason</span>;
...

OIDCAuthenticationError error = (OIDCAuthenticationError) httpServletRequest
    .getAttribute(<span class="string"><span class="delimiter">'</span><span class="content">org.keycloak.adapters.spi.AuthenticationError</span><span class="delimiter">'</span></span>);

Reason reason = error.getReason();
<span class="predefined-type">System</span>.out.println(reason.name());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="logout"><a class="anchor" href="#logout"></a>2.1.14. Logout</h4>
<div class="paragraph">
<p>You can log out of a web application in multiple ways.
For Java EE servlet containers, you can call HttpServletRequest.logout(). For other browser applications, you can redirect the browser to
<code>http://auth-server/auth/realms/{realm-name}/protocol/openid-connect/logout?redirect_uri=encodedRedirectUri</code>, which logs you out if you have an SSO session with your browser.</p>
</div>
</div>
<div class="sect3">
<h4 id="parameters-forwarding"><a class="anchor" href="#parameters-forwarding"></a>2.1.15. Parameters Forwarding</h4>
<div class="paragraph">
<p>The Keycloak  initial authorization endpoint request has support for various parameters. Most of the parameters are described in
<a href="http://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint">OIDC specification</a>. Some parameters are added automatically by the adapter based
on the adapter configuration. However, there are also a few parameters that can be added on a per-invocation basis. When you open the secured application URI,
the particular parameter will be forwarded to the Keycloak authorization endpoint.</p>
</div>
<div class="paragraph">
<p>For example, if you request an offline token, then you can open the secured application URI with the <code>scope</code> parameter like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://myappserver/mysecuredapp?scope=offline_access</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the parameter <code>scope=offline_access</code> will be automatically forwarded to the Keycloak authorization endpoint.</p>
</div>
<div class="paragraph">
<p>The supported parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>scope</p>
</li>
<li>
<p>prompt</p>
</li>
<li>
<p>max_age</p>
</li>
<li>
<p>login_hint</p>
</li>
<li>
<p>kc_idp_hint</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Most of the parameters are described in the <a href="http://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint">OIDC specification</a>.
The only exception is parameter <code>kc_idp_hint</code>, which is specific to Keycloak and contains the name of the identity provider to automatically use.
For more information see the <code>Identity Brokering</code> section in <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_client_authentication_adapter"><a class="anchor" href="#_client_authentication_adapter"></a>2.1.16. Client Authentication</h4>
<div class="paragraph">
<p>When a confidential OIDC client needs to send a backchannel request (for example, to exchange code for the token, or to refresh the token) it needs to authenticate against the Keycloak server. By default, there are two ways to authenticate the client: client ID and client secret, or client authentication with signed JWT.</p>
</div>
<div class="sect4">
<h5 id="client-id-and-client-secret"><a class="anchor" href="#client-id-and-client-secret"></a>Client ID and Client Secret</h5>
<div class="paragraph">
<p>This is the traditional method described in the OAuth2 specification. The client has a secret, which needs to be known to both the adapter (application) and the Keycloak server.
You can generate the secret for a particular client in the Keycloak administration console, and then paste this secret into the <code>keycloak.json</code> file on the application side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>"credentials": {
    "secret": "19666a4f-32dd-4049-b082-684c74115f28"
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="client-authentication-with-signed-jwt"><a class="anchor" href="#client-authentication-with-signed-jwt"></a>Client Authentication with Signed JWT</h5>
<div class="paragraph">
<p>This is based on the <a href="https://tools.ietf.org/html/rfc7523">RFC7523</a> specification. It works this way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The client must have the private key and certificate. For  Keycloak this is available through the traditional <code>keystore</code> file, which is either available on the client application&#8217;s classpath or somewhere on the file system.</p>
</li>
<li>
<p>Once the client application is started, it allows to download its public key in <a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html">JWKS</a> format using a URL such as http://myhost.com/myapp/k_jwks, assuming that http://myhost.com/myapp is the base URL of your client application. This URL can be used by Keycloak (see below).</p>
</li>
<li>
<p>During authentication, the client generates a JWT token and signs it with its private key and sends it to Keycloak in
the particular backchannel request (for example, code-to-token request) in the <code>client_assertion</code> parameter.</p>
</li>
<li>
<p>Keycloak must have the public key or certificate of the client so that it can verify the signature on JWT. In Keycloak you need to configure client credentials for your client. First you need to choose <code>Signed JWT</code> as the method of authenticating your client in the tab <code>Credentials</code> in administration console.
Then you can choose to either:</p>
<div class="ulist">
<ul>
<li>
<p>Configure the JWKS URL where Keycloak can download the client&#8217;s public keys. This can be a URL such as  http://myhost.com/myapp/k_jwks (see details above). This option is the most flexible, since the client can rotate its keys anytime and Keycloak then always downloads new keys when needed without needing to change the configuration. More accurately,  Keycloak downloads new keys when it sees the token signed by an unknown <code>kid</code> (Key ID).</p>
</li>
<li>
<p>Upload the client&#8217;s public key or certificate, either in PEM format, in JWK format, or from the keystore. With this option, the public key is hardcoded and must be changed when the client generates a new key pair.
You can even generate your own keystore from the Keycloak admininstration console if you don&#8217;t have your own available.
For more details on how to set up the Keycloak administration console see <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For set up on the adapter side you need to have something like this in your <code>keycloak.json</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>"credentials": {
  "jwt": {
    "client-keystore-file": "classpath:keystore-client.jks",
    "client-keystore-type": "JKS",
    "client-keystore-password": "storepass",
    "client-key-password": "keypass",
    "client-key-alias": "clientkey",
    "token-expiration": 10
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this configuration, the keystore file <code>keystore-client.jks</code> must be available on classpath in your WAR. If you do not use the prefix <code>classpath:</code>
you can point to any file on the file system where the client application is running.</p>
</div>
<div class="paragraph">
<p>For inspiration, you can take a look at the examples distribution into the main demo example into the <code>product-portal</code> application.</p>
</div>
</div>
<div class="sect4">
<h5 id="add-your-own-client-authentication-method"><a class="anchor" href="#add-your-own-client-authentication-method"></a>Add Your Own Client Authentication Method</h5>
<div class="paragraph">
<p>You can add your own client authentication method as well. You will need to implement both client-side and server-side providers. For more details see the <code>Authentication SPI</code> section in <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multi_tenancy"><a class="anchor" href="#_multi_tenancy"></a>2.1.17. Multi Tenancy</h4>
<div class="paragraph">
<p>Multi Tenancy, in our context, means that a single target application (WAR) can be secured with multiple Keycloak realms. The realms can be located
one the same Keycloak instance or on different instances.</p>
</div>
<div class="paragraph">
<p>In practice, this means that the application needs to have multiple <code>keycloak.json</code> adapter configuration files.</p>
</div>
<div class="paragraph">
<p>You could have multiple instances of your WAR with different adapter configuration files deployed to different context-paths. However, this may be inconvenient
and you may also want to select the realm based on something else than context-path.</p>
</div>
<div class="paragraph">
<p>Keycloak makes it possible to have a custom config resolver so you can choose what adapter config is used for each request.</p>
</div>
<div class="paragraph">
<p>To achieve this first you need to create an implementation of <code>org.keycloak.adapters.KeycloakConfigResolver</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example</span>;

<span class="keyword">import</span> <span class="include">org.keycloak.adapters.KeycloakConfigResolver</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.KeycloakDeployment</span>;
<span class="keyword">import</span> <span class="include">org.keycloak.adapters.KeycloakDeploymentBuilder</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">PathBasedKeycloakConfigResolver</span> <span class="directive">implements</span> KeycloakConfigResolver {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> KeycloakDeployment resolve(OIDCHttpFacade.Request request) {
        <span class="keyword">if</span> (path.startsWith(<span class="string"><span class="delimiter">&quot;</span><span class="content">alternative</span><span class="delimiter">&quot;</span></span>)) {
            KeycloakDeployment deployment = cache.get(realm);
            <span class="keyword">if</span> (<span class="predefined-constant">null</span> == deployment) {
                <span class="predefined-type">InputStream</span> is = getClass().getResourceAsStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">/tenant1-keycloak.json</span><span class="delimiter">&quot;</span></span>);
                <span class="keyword">return</span> KeycloakDeploymentBuilder.build(is);
            }
        } <span class="keyword">else</span> {
            <span class="predefined-type">InputStream</span> is = getClass().getResourceAsStream(<span class="string"><span class="delimiter">&quot;</span><span class="content">/default-keycloak.json</span><span class="delimiter">&quot;</span></span>);
            <span class="keyword">return</span> KeycloakDeploymentBuilder.build(is);
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You also need to configure which <code>KeycloakConfigResolver</code> implementation to use with the <code>keycloak.config.resolver</code> context-param in your <code>web.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app&gt;</span>
    ...
    <span class="tag">&lt;context-param&gt;</span>
        <span class="tag">&lt;param-name&gt;</span>keycloak.config.resolver<span class="tag">&lt;/param-name&gt;</span>
        <span class="tag">&lt;param-value&gt;</span>example.PathBasedKeycloakConfigResolver<span class="tag">&lt;/param-value&gt;</span>
    <span class="tag">&lt;/context-param&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_applicationclustering"><a class="anchor" href="#_applicationclustering"></a>2.1.18. Application Clustering</h4>
<div class="paragraph">
<p>This chapter is related to supporting clustered applications deployed to JBoss EAP, WildFly and JBoss AS.</p>
</div>
<div class="paragraph">
<p>There are a few options available depending on whether your application is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stateless or stateful</p>
</li>
<li>
<p>Distributable (replicated http session) or non-distributable</p>
</li>
<li>
<p>Relying on sticky sessions provided by load balancer</p>
</li>
<li>
<p>Hosted on same domain as Keycloak</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dealing with clustering is not quite as simple as for a regular application. Mainly due to the fact that both the browser and the server-side application
sends requests to Keycloak, so it&#8217;s not as simple as enabling sticky sessions on your load balancer.</p>
</div>
<div class="sect4">
<h5 id="stateless-token-store"><a class="anchor" href="#stateless-token-store"></a>Stateless token store</h5>
<div class="paragraph">
<p>By default, the web application secured by Keycloak uses the HTTP session to store security context. This means that you either have to
enable sticky sessions or replicate the HTTP session.</p>
</div>
<div class="paragraph">
<p>As an alternative to storing the security context in the HTTP session the adapter can be configured to store this in a cookie instead. This is useful if you want
to make your application stateless or if you don&#8217;t want to store the security context in the HTTP session.</p>
</div>
<div class="paragraph">
<p>To use the cookie store for saving the security context, edit your applications <code>WEB-INF/keycloak.json</code> and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="key"><span class="delimiter">&quot;</span><span class="content">token-store</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">cookie</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default value for <code>token-store</code> is <code>session</code>, which stores the security context in the HTTP session.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One limitation of using the cookie store is that the whole security context is passed in the cookie for every HTTP request. This may impact performance.</p>
</div>
<div class="paragraph">
<p>Another small limitation is limited support for Single-Sign Out. It works without issues if you init servlet logout (HttpServletRequest.logout) from the
application itself as the adapter will delete the KEYCLOAK_ADAPTER_STATE cookie. However, back-channel logout initialized from a different application isn&#8217;t
propagated by Keycloak to applications using cookie store. Hence it&#8217;s recommended to use a short value for the access token timeout (for example 1 minute).</p>
</div>
</div>
<div class="sect4">
<h5 id="relative-uri-optimization"><a class="anchor" href="#relative-uri-optimization"></a>Relative URI optimization</h5>
<div class="paragraph">
<p>In deployment scenarios where Keycloak and the application is hosted on the same domain (through a reverse proxy or load balancer) it can be
convenient to use relative URI options in your client configuration.</p>
</div>
<div class="paragraph">
<p>With relative URIs the URI is resolved as relative to the URL used to access Keycloak.</p>
</div>
<div class="paragraph">
<p>For example if the URL to your application is <code>https://acme.org/myapp</code> and the URL to Keycloak is <code>https://acme.org/auth</code>, then you can use
the redirect-uri <code>/myapp</code> instead of <code>https://acme.org/myapp</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="admin-url-configuration"><a class="anchor" href="#admin-url-configuration"></a>Admin URL configuration</h5>
<div class="paragraph">
<p>Admin URL for a particular client can be configured in the Keycloak Administration Console.
It&#8217;s used by the Keycloak server to send backend requests to the application for various tasks, like logout users or push revocation policies.</p>
</div>
<div class="paragraph">
<p>For example the way backchannel logout works is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User sends logout request from one application</p>
</li>
<li>
<p>The application sends logout request to Keycloak</p>
</li>
<li>
<p>The Keycloak server invalidates the user session</p>
</li>
<li>
<p>The Keycloak server then sends a backchannel request to application with an admin url that are associated with the session</p>
</li>
<li>
<p>When an application receives the logout request it invalidates the corresponding HTTP session</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If admin URL contains <code>${application.session.host}</code> it will be replaced with the URL to the node associated with the HTTP session.</p>
</div>
</div>
<div class="sect4">
<h5 id="_registration_app_nodes"><a class="anchor" href="#_registration_app_nodes"></a>Registration of application nodes</h5>
<div class="paragraph">
<p>The previous section describes how Keycloak can send logout request to node associated with a specific HTTP session.
However, in some cases admin may want to propagate admin tasks to all registered cluster nodes, not just one of them.
For example to push a new not before policy to the application or to logout all users from the application.</p>
</div>
<div class="paragraph">
<p>In this case Keycloak needs to be aware of all application cluster nodes, so it can send the event to all of them.
To achieve this, we support auto-discovery mechanism:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When a new application node joins the cluster, it sends a registration request to the Keycloak server</p>
</li>
<li>
<p>The request may be re-sent to Keycloak in configured periodic intervals</p>
</li>
<li>
<p>If the Keycloak server doesn&#8217;t receive a re-registration request within a specified timeout then it automatically unregisters the specific node</p>
</li>
<li>
<p>The node is also unregistered in Keycloak when it sends an unregistration request, which is usually during node shutdown or application undeployment.
This may not work properly for forced shutdown when undeployment listeners are not invoked, which results in the need for automatic unregistration</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sending startup registrations and periodic re-registration is disabled by default as it&#8217;s only required for some clustered applications.</p>
</div>
<div class="paragraph">
<p>To enable the feature edit the <code>WEB-INF/keycloak.json</code> file for your application and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>"register-node-at-startup": true,
"register-node-period": 600,</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means the adapter will send the registration request on startup and re-register every 10 minutes.</p>
</div>
<div class="paragraph">
<p>In the Keycloak Administration Console you can specify the maximum node re-registration timeout (should be larger than <em>register-node-period</em> from
the adapter configuration). You can also manually add and remove cluster nodes in through the Adminstration Console, which is useful if you don&#8217;t want to rely
on the automatic registration feature or if you want to remove stale application nodes in the event your not using the automatic unregistration feature.</p>
</div>
</div>
<div class="sect4">
<h5 id="_refresh_token_each_req"><a class="anchor" href="#_refresh_token_each_req"></a>Refresh token in each request</h5>
<div class="paragraph">
<p>By default the application adapter will only refresh the access token when it&#8217;s expired. However, you can also configure the adapter to refresh the token on every
request. This may have a performance impact as your application will send more requests to the Keycloak server.</p>
</div>
<div class="paragraph">
<p>To enable the feature edit the <code>WEB-INF/keycloak.json</code> file for your application and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>"always-refresh-token": true</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This may have a significant impact on performance. Only enable this feature if you can&#8217;t rely on backchannel messages to propagate logout and not before
    policies. Another thing to consider is that by default access tokens has a short expiration so even if logout is not propagated the token will expire within
    minutes of the logout.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_javascript_adapter"><a class="anchor" href="#_javascript_adapter"></a>2.2. Javascript Adapter</h3>
<div class="paragraph">
<p>Keycloak comes with a client-side JavaScript library that can be used to secure HTML5/JavaScript applications. The JavaScript adapter has built-in support for Cordova applications.</p>
</div>
<div class="paragraph">
<p>The library can be retrieved directly from the Keycloak server at <code>/auth/js/keycloak.js</code> and is also distributed as a ZIP archive.</p>
</div>
<div class="paragraph">
<p>A best practice is to load the JavaScript adapter directly from Keycloak Server as it will automatically be updated when you upgrade the server. If you copy the adapter to your web application instead, make sure you upgrade the adapter only after you have upgraded the server.</p>
</div>
<div class="paragraph">
<p>One important thing to note about using client-side applications is that the client has to be a public client as there is no secure way to store client
credentials in a client-side application. This makes it very important to make sure the redirect URIs you have configured for the client are correct and as specific as possible.</p>
</div>
<div class="paragraph">
<p>To use the JavaScript adapter you must first create a client for your application in the Keycloak Administration Console. Make sure <code>public</code>
is selected for <code>Access Type</code>.</p>
</div>
<div class="paragraph">
<p>You also need to configure valid redirect URIs and valid web origins. Be as specific as possible as failing to do so may result in a security vulnerability.</p>
</div>
<div class="paragraph">
<p>Once the client is created click on the <code>Installation</code> tab select <code>Keycloak OIDC JSON</code> for <code>Format Option</code> then click <code>Download</code>. The downloaded
<code>keycloak.json</code> file should be hosted on your web server at the same location as your HTML pages.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can skip the configuration file and manually configure the adapter.</p>
</div>
<div class="paragraph">
<p>The following example shows how to initialize the JavaScript adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;script&gt;</span>
<span class="inline">        <span class="keyword">var</span> keycloak = Keycloak();
        keycloak.init().success(<span class="keyword">function</span>(authenticated) {
            alert(authenticated ? <span class="string"><span class="delimiter">'</span><span class="content">authenticated</span><span class="delimiter">'</span></span> : <span class="string"><span class="delimiter">'</span><span class="content">not authenticated</span><span class="delimiter">'</span></span>);
        }).error(<span class="keyword">function</span>() {
            alert(<span class="string"><span class="delimiter">'</span><span class="content">failed to initialize</span><span class="delimiter">'</span></span>);
        });</span>
    <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/head&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>keycloak.json</code> file is in a different location you can specify it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> keycloak = Keycloak(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/myapp/keycloak.json</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can pass in a JavaScript object with the required configuration instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> keycloak = Keycloak({
    <span class="key">url</span>: <span class="string"><span class="delimiter">'</span><span class="content">http://keycloak-server/auth</span><span class="delimiter">'</span></span>,
    <span class="key">realm</span>: <span class="string"><span class="delimiter">'</span><span class="content">myrealm</span><span class="delimiter">'</span></span>,
    <span class="key">clientId</span>: <span class="string"><span class="delimiter">'</span><span class="content">myapp</span><span class="delimiter">'</span></span>
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default to authenticate you need to call the <code>login</code> function. However, there are two options available to make the adapter automatically authenticate. You
can pass <code>login-required</code> or <code>check-sso</code> to the init function. <code>login-required</code> will authenticate the client if the user is logged-in to Keycloak
or display the login page if not. <code>check-sso</code> will only authenticate the client if the user is already logged-in, if the user is not logged-in the browser will be
redirected back to the application and remain unauthenticated.</p>
</div>
<div class="paragraph">
<p>To enable <code>login-required</code> set <code>onLoad</code> to <code>login-required</code> and pass to the init method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>keycloak.init({ onLoad: 'login-required' })</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the user is authenticated the application can make requests to RESTful services secured by Keycloak by including the bearer token in the
<code>Authorization</code> header. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">var</span> <span class="function">loadData</span> = <span class="keyword">function</span> () {
    document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">username</span><span class="delimiter">'</span></span>).innerText = keycloak.subject;

    <span class="keyword">var</span> url = <span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/restful-service</span><span class="delimiter">'</span></span>;

    <span class="keyword">var</span> req = <span class="keyword">new</span> XMLHttpRequest();
    req.open(<span class="string"><span class="delimiter">'</span><span class="content">GET</span><span class="delimiter">'</span></span>, url, <span class="predefined-constant">true</span>);
    req.setRequestHeader(<span class="string"><span class="delimiter">'</span><span class="content">Accept</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>);
    req.setRequestHeader(<span class="string"><span class="delimiter">'</span><span class="content">Authorization</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Bearer </span><span class="delimiter">'</span></span> + keycloak.token);

    req.<span class="function">onreadystatechange</span> = <span class="keyword">function</span> () {
        <span class="keyword">if</span> (req.readyState == <span class="integer">4</span>) {
            <span class="keyword">if</span> (req.status == <span class="integer">200</span>) {
                alert(<span class="string"><span class="delimiter">'</span><span class="content">Success</span><span class="delimiter">'</span></span>);
            } <span class="keyword">else</span> <span class="keyword">if</span> (req.status == <span class="integer">403</span>) {
                alert(<span class="string"><span class="delimiter">'</span><span class="content">Forbidden</span><span class="delimiter">'</span></span>);
            }
        }
    }

    req.send();
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to keep in mind is that the access token by default has a short life expiration so you may need to refresh the access token prior to sending the
request. You can do this by the <code>updateToken</code> method. The <code>updateToken</code> method returns a promise object which makes it easy to invoke the service only if the
token was successfully refreshed and for example display an error to the user if it wasn&#8217;t. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.updateToken(<span class="integer">30</span>).success(<span class="keyword">function</span>() {
    loadData();
}).error(<span class="keyword">function</span>() {
    alert(<span class="string"><span class="delimiter">'</span><span class="content">Failed to refresh token</span><span class="delimiter">'</span></span>);
});</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="session-status-iframe"><a class="anchor" href="#session-status-iframe"></a>2.2.1. Session Status iframe</h4>
<div class="paragraph">
<p>By default, the JavaScript adapter creates a hidden iframe that is used to detect if a Single-Sign Out has occurred.
This does not require any network traffic, instead the status is retrieved by looking at a special status cookie.
This feature can be disabled by setting <code>checkLoginIframe: false</code> in the options passed to the <code>init</code> method.</p>
</div>
<div class="paragraph">
<p>You should not rely on looking at this cookie directly. It&#8217;s format can change and it&#8217;s also associated with the URL of the Keycloak server, not
your application.</p>
</div>
</div>
<div class="sect3">
<h4 id="_javascript_implicit_flow"><a class="anchor" href="#_javascript_implicit_flow"></a>2.2.2. Implicit and Hybrid Flow</h4>
<div class="paragraph">
<p>By default, the JavaScript adapter uses the <a href="http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization Code</a> flow.</p>
</div>
<div class="paragraph">
<p>With this flow the Keycloak server returns an authorization code, not an authentication token, to the application. The JavaScript adapter exchanges
the <code>code</code> for an access token and a refresh token after the browser is redirected back to the application.</p>
</div>
<div class="paragraph">
<p>Keycloak also supports the <a href="http://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth">Implicit</a> flow where an access token
is sent immediately after successful authentication with Keycloak. This may have better performance than standard flow, as there is no additional
request to exchange the code for tokens, but it has implications when the access token expires.</p>
</div>
<div class="paragraph">
<p>However, sending the access token in the URL fragment can be a security vulnerability. For example the token could be leaked through web server logs and or
browser history.</p>
</div>
<div class="paragraph">
<p>To enable implicit flow, you need to enable the <code>Implicit Flow Enabled</code> flag for the client in the Keycloak Administration Console.
You also need to pass the parameter <code>flow</code> with value <code>implicit</code> to <code>init</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({ <span class="key">flow</span>: <span class="string"><span class="delimiter">'</span><span class="content">implicit</span><span class="delimiter">'</span></span> })</code></pre>
</div>
</div>
<div class="paragraph">
<p>One thing to note is that only an access token is provided and there is no refresh token. This means that once the access token has expired the application
has to do the redirect to the Keycloak again to obtain a new access token.</p>
</div>
<div class="paragraph">
<p>Keycloak also supports the <a href="http://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth">Hybrid</a> flow.</p>
</div>
<div class="paragraph">
<p>This requires the client to have both the <code>Standard Flow Enabled</code> and <code>Implicit Flow Enabled</code> flags enabled in the admin console.
The Keycloak server will then send both the code and tokens to your application.
The access token can be used immediately while the code can be exchanged for access and refresh tokens.
Similar to the implicit flow, the hybrid flow is good for performance because the access token is available immediately.
But, the token is still sent in the URL, and the security vulnerability mentioned earlier may still apply.</p>
</div>
<div class="paragraph">
<p>One advantage in the Hybrid flow is that the refresh token is made available to the application.</p>
</div>
<div class="paragraph">
<p>For the Hybrid flow, you need to pass the parameter <code>flow</code> with value <code>hybrid</code> to the <code>init</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.init({ <span class="key">flow</span>: <span class="string"><span class="delimiter">'</span><span class="content">hybrid</span><span class="delimiter">'</span></span> })</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="earlier-browsers"><a class="anchor" href="#earlier-browsers"></a>2.2.3. Earlier Browsers</h4>
<div class="paragraph">
<p>The JavaScript adapter depends on Base64 (window.btoa and window.atob) and HTML5 History API.
If you need to support browsers that do not have these available (for example, IE9) you need to add polyfillers.</p>
</div>
<div class="paragraph">
<p>Example polyfill libraries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/davidchambers/Base64.js" class="bare">https://github.com/davidchambers/Base64.js</a></p>
</li>
<li>
<p><a href="https://github.com/devote/HTML5-History-API" class="bare">https://github.com/devote/HTML5-History-API</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="javascript-adapter-reference"><a class="anchor" href="#javascript-adapter-reference"></a>2.2.4. JavaScript Adapter Reference</h4>
<div class="sect4">
<h5 id="constructor"><a class="anchor" href="#constructor"></a>Constructor</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="keyword">new</span> Keycloak();
<span class="keyword">new</span> Keycloak(<span class="string"><span class="delimiter">'</span><span class="content">http://localhost/keycloak.json</span><span class="delimiter">'</span></span>);
<span class="keyword">new</span> Keycloak({ <span class="key">url</span>: <span class="string"><span class="delimiter">'</span><span class="content">http://localhost/auth</span><span class="delimiter">'</span></span>, <span class="key">realm</span>: <span class="string"><span class="delimiter">'</span><span class="content">myrealm</span><span class="delimiter">'</span></span>, <span class="key">clientId</span>: <span class="string"><span class="delimiter">'</span><span class="content">myApp</span><span class="delimiter">'</span></span> });</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="properties"><a class="anchor" href="#properties"></a>Properties</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">authenticated</dt>
<dd>
<p>Is <code>true</code> if the user is authenticated, <code>false</code> otherwise.</p>
</dd>
<dt class="hdlist1">token</dt>
<dd>
<p>The base64 encoded token that can be sent in the <code>Authorization</code> header in requests to services.</p>
</dd>
<dt class="hdlist1">tokenParsed</dt>
<dd>
<p>The parsed token as a JavaScript object.</p>
</dd>
<dt class="hdlist1">subject</dt>
<dd>
<p>The user id.</p>
</dd>
<dt class="hdlist1">idToken</dt>
<dd>
<p>The base64 encoded ID token.</p>
</dd>
<dt class="hdlist1">idTokenParsed</dt>
<dd>
<p>The parsed id token as a JavaScript object.</p>
</dd>
<dt class="hdlist1">realmAccess</dt>
<dd>
<p>The realm roles associated with the token.</p>
</dd>
<dt class="hdlist1">resourceAccess</dt>
<dd>
<p>The resource roles associated with the token.</p>
</dd>
<dt class="hdlist1">refreshToken</dt>
<dd>
<p>The base64 encoded refresh token that can be used to retrieve a new token.</p>
</dd>
<dt class="hdlist1">refreshTokenParsed</dt>
<dd>
<p>The parsed refresh token as a JavaScript object.</p>
</dd>
<dt class="hdlist1">timeSkew</dt>
<dd>
<p>The estimated time difference between the browser time and the Keycloak server in seconds. This value is just an estimation, but is accurate
enough when determining if a token is expired or not.</p>
</dd>
<dt class="hdlist1">responseMode</dt>
<dd>
<p>Response mode passed in init (default value is fragment).</p>
</dd>
<dt class="hdlist1">flow</dt>
<dd>
<p>Flow passed in init.</p>
</dd>
<dt class="hdlist1">responseType</dt>
<dd>
<p>Response type sent to Keycloak with login requests. This is determined based on the flow value used during initialization, but can be overridden by setting this value.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="methods"><a class="anchor" href="#methods"></a>Methods</h5>
<div class="sect5">
<h6 id="init-options"><a class="anchor" href="#init-options"></a>init(options)</h6>
<div class="paragraph">
<p>Called to initialize the adapter.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>onLoad - Specifies an action to do on load. Supported values are 'login-required' or 'check-sso'.</p>
</li>
<li>
<p>token - Set an initial value for the token.</p>
</li>
<li>
<p>refreshToken - Set an initial value for the refresh token.</p>
</li>
<li>
<p>idToken - Set an initial value for the id token (only together with token or refreshToken).</p>
</li>
<li>
<p>timeSkew - Set an initial value for skew between local time and Keycloak server in seconds (only together with token or refreshToken).</p>
</li>
<li>
<p>checkLoginIframe - Set to enable/disable monitoring login state (default is true).</p>
</li>
<li>
<p>checkLoginIframeInterval - Set the interval to check login state (default is 5 seconds).</p>
</li>
<li>
<p>responseMode - Set the OpenID Connect response mode send to Keycloak server at login request. Valid values are query or fragment . Default value is fragment, which means that after successful authentication will Keycloak redirect to javascript application with OpenID Connect parameters added in URL fragment. This is generally safer and recommended over query.</p>
</li>
<li>
<p>flow - Set the OpenID Connect flow. Valid values are standard, implicit or hybrid.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Returns promise to set functions to be invoked on success or error.</p>
</div>
</div>
<div class="sect5">
<h6 id="login-options"><a class="anchor" href="#login-options"></a>login(options)</h6>
<div class="paragraph">
<p>Redirects to login form on (options is an optional object with redirectUri and/or prompt fields).</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to after login.</p>
</li>
<li>
<p>prompt - By default the login screen is displayed if the user is not logged-in to Keycloak. To only authenticate to the application if the user is already logged-in and not display the login page if the user is not logged-in, set this option to <code>none</code>. To always require re-authentication and ignore SSO, set this option to <code>login</code> .</p>
</li>
<li>
<p>maxAge - Used just if user is already authenticated. Specifies maximum time since the authentication of user happened. If user is already authenticated for longer time than <code>maxAge</code>, the SSO is ignored and he will need to re-authenticate again.</p>
</li>
<li>
<p>loginHint - Used to pre-fill the username/email field on the login form.</p>
</li>
<li>
<p>action - If value is 'register' then user is redirected to registration page, otherwise to login page.</p>
</li>
<li>
<p>locale - Specifies the desired locale for the UI.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="createloginurl-options"><a class="anchor" href="#createloginurl-options"></a>createLoginUrl(options)</h6>
<div class="paragraph">
<p>Returns the URL to login form on (options is an optional object with redirectUri and/or prompt fields).</p>
</div>
<div class="paragraph">
<p>Options is an Object, which supports same options like the function <code>login</code> .</p>
</div>
</div>
<div class="sect5">
<h6 id="logout-options"><a class="anchor" href="#logout-options"></a>logout(options)</h6>
<div class="paragraph">
<p>Redirects to logout.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to after logout.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="createlogouturl-options"><a class="anchor" href="#createlogouturl-options"></a>createLogoutUrl(options)</h6>
<div class="paragraph">
<p>Returns the URL to logout the user.</p>
</div>
<div class="paragraph">
<p>Options is an Object, where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirectUri - Specifies the uri to redirect to after logout.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="register-options"><a class="anchor" href="#register-options"></a>register(options)</h6>
<div class="paragraph">
<p>Redirects to registration form. Shortcut for login with option action = 'register'</p>
</div>
<div class="paragraph">
<p>Options are same as for the login method but 'action' is set to 'register'</p>
</div>
</div>
<div class="sect5">
<h6 id="createregisterurl-options"><a class="anchor" href="#createregisterurl-options"></a>createRegisterUrl(options)</h6>
<div class="paragraph">
<p>Returns the url to registration page. Shortcut for createLoginUrl with option action = 'register'</p>
</div>
<div class="paragraph">
<p>Options are same as for the createLoginUrl method but 'action' is set to 'register'</p>
</div>
</div>
<div class="sect5">
<h6 id="accountmanagement"><a class="anchor" href="#accountmanagement"></a>accountManagement()</h6>
<div class="paragraph">
<p>Redirects to the Account Management Console.</p>
</div>
</div>
<div class="sect5">
<h6 id="createaccounturl"><a class="anchor" href="#createaccounturl"></a>createAccountUrl()</h6>
<div class="paragraph">
<p>Returns the URL to the Account Management Console.</p>
</div>
</div>
<div class="sect5">
<h6 id="hasrealmrole-role"><a class="anchor" href="#hasrealmrole-role"></a>hasRealmRole(role)</h6>
<div class="paragraph">
<p>Returns true if the token has the given realm role.</p>
</div>
</div>
<div class="sect5">
<h6 id="hasresourcerole-role-resource"><a class="anchor" href="#hasresourcerole-role-resource"></a>hasResourceRole(role, resource)</h6>
<div class="paragraph">
<p>Returns true if the token has the given role for the resource (resource is optional, if not specified clientId is used).</p>
</div>
</div>
<div class="sect5">
<h6 id="loaduserprofile"><a class="anchor" href="#loaduserprofile"></a>loadUserProfile()</h6>
<div class="paragraph">
<p>Loads the users profile.</p>
</div>
<div class="paragraph">
<p>Returns promise to set functions to be invoked if the profile was loaded successfully, or if the profile could not be
loaded.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.loadUserProfile().success(<span class="keyword">function</span>(profile) {
        alert(JSON.stringify(test, <span class="predefined-constant">null</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">  </span><span class="delimiter">&quot;</span></span>));
    }).error(<span class="keyword">function</span>() {
        alert(<span class="string"><span class="delimiter">'</span><span class="content">Failed to load user profile</span><span class="delimiter">'</span></span>);
    });</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="istokenexpired-minvalidity"><a class="anchor" href="#istokenexpired-minvalidity"></a>isTokenExpired(minValidity)</h6>
<div class="paragraph">
<p>Returns true if the token has less than minValidity seconds left before it expires (minValidity is optional, if not specified 0 is used).</p>
</div>
</div>
<div class="sect5">
<h6 id="updatetoken-minvalidity"><a class="anchor" href="#updatetoken-minvalidity"></a>updateToken(minValidity)</h6>
<div class="paragraph">
<p>If the token expires within minValidity seconds (minValidity is optional, if not specified 5 is used) the token is refreshed.
If the session status iframe is enabled, the session status is also checked.</p>
</div>
<div class="paragraph">
<p>Returns promise to set functions that can be invoked if the token is still valid, or if the token is no longer valid.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.updateToken(<span class="integer">5</span>).success(<span class="keyword">function</span>(refreshed) {
        <span class="keyword">if</span> (refreshed) {
            alert(<span class="string"><span class="delimiter">'</span><span class="content">Token was successfully refreshed</span><span class="delimiter">'</span></span>);
        } <span class="keyword">else</span> {
            alert(<span class="string"><span class="delimiter">'</span><span class="content">Token is still valid</span><span class="delimiter">'</span></span>);
        }
    }).error(<span class="keyword">function</span>() {
        alert(<span class="string"><span class="delimiter">'</span><span class="content">Failed to refresh the token, or the session has expired</span><span class="delimiter">'</span></span>);
    });</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="cleartoken"><a class="anchor" href="#cleartoken"></a>clearToken()</h6>
<div class="paragraph">
<p>Clear authentication state, including tokens.
This can be useful if application has detected the session was expired, for example if updating token fails.</p>
</div>
<div class="paragraph">
<p>Invoking this results in onAuthLogout callback listener being invoked.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="callback-events"><a class="anchor" href="#callback-events"></a>Callback Events</h5>
<div class="paragraph">
<p>The adapter supports setting callback listeners for certain events.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">keycloak.<span class="function">onAuthSuccess</span> = <span class="keyword">function</span>() { alert(<span class="string"><span class="delimiter">'</span><span class="content">authenticated</span><span class="delimiter">'</span></span>); }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The available events are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>onReady(authenticated) - Called when the adapter is initialized.</p>
</li>
<li>
<p>onAuthSuccess - Called when a user is successfully authenticated.</p>
</li>
<li>
<p>onAuthError - Called if there was an error during authentication.</p>
</li>
<li>
<p>onAuthRefreshSuccess - Called when the token is refreshed.</p>
</li>
<li>
<p>onAuthRefreshError - Called if there was an error while trying to refresh the token.</p>
</li>
<li>
<p>onAuthLogout - Called if the user is logged out (will only be called if the session status iframe is enabled, or in Cordova mode).</p>
</li>
<li>
<p>onTokenExpired - Called when the access token is expired. If a refresh token is available the token can be refreshed with updateToken, or in cases where it is not (that is, with implicit flow) you can redirect to login screen to obtain a new access token.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nodejs_adapter"><a class="anchor" href="#_nodejs_adapter"></a>2.3. Node.js Adapter</h3>
<div class="paragraph">
<p>Keycloak provides a Node.js adapter built on top of <a href="https://github.com/senchalabs/connect">Connect</a> to protect server-side JavaScript apps — the goal was to be flexible enough to integrate with frameworks like <a href="https://expressjs.com/">Express.js</a>.</p>
</div>
<div class="paragraph">
<p>The library can be downloaded directly from <a href="https://www.npmjs.com/package/keycloak-connect"> Keycloak organization</a> and the source is available at
<a href="https://github.com/keycloak/keycloak-nodejs-connect">GitHub</a>.</p>
</div>
<div class="paragraph">
<p>To use the Node.js adapter, first you must create a client for your application in the Keycloak Administration Console. The adapter supports public, confidential, and bearer-only access type. Which one to choose depends on the use-case scenario.</p>
</div>
<div class="paragraph">
<p>Once the client is created click the <code>Installation</code> tab, select <code>Keycloak OIDC JSON</code> for <code>Format Option</code>, and then click <code>Download</code>. The downloaded <code>keycloak.json</code> file should be at the root folder of your project.</p>
</div>
<div class="sect3">
<h4 id="installation"><a class="anchor" href="#installation"></a>2.3.1. Installation</h4>
<div class="paragraph">
<p>Assuming you&#8217;ve already installed <a href="https://nodejs.org">Node.js</a>, create a folder for your application:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir myapp &amp;&amp; cd myapp</pre>
</div>
</div>
<div class="paragraph">
<p>Use <code>npm init</code> command to create a <code>package.json</code> for your application. Now add the Keycloak connect adapter in the dependencies list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">    "dependencies": {
        "keycloak-connect": "3.4.1-cr.1"
    }</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usage-2"><a class="anchor" href="#usage-2"></a>2.3.2. Usage</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Instantiate a Keycloak class</dt>
<dd>
<p>The <code>Keycloak</code> class provides a central point for configuration
and integration with your application.  The simplest creation
involves no arguments.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="keyword">var</span> session = require(<span class="string"><span class="delimiter">'</span><span class="content">express-session</span><span class="delimiter">'</span></span>);
    <span class="keyword">var</span> Keycloak = require(<span class="string"><span class="delimiter">'</span><span class="content">keycloak-connect</span><span class="delimiter">'</span></span>);

    <span class="keyword">var</span> memoryStore = <span class="keyword">new</span> session.MemoryStore();
    <span class="keyword">var</span> keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore });</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, this will locate a file named <code>keycloak.json</code> alongside
the main executable of your application to initialize keycloak-specific
settings (public key, realm name, various URLs).  The <code>keycloak.json</code> file
is obtained from the Keycloak Admin Console.</p>
</div>
<div class="paragraph">
<p>Instantiation with this method results in all of the reasonable defaults
being used. As alternative, it&#8217;s also possible to provide a configuration
object, rather than the <code>keycloak.json</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    let kcConfig = {
    <span class="key">clientId</span>: <span class="string"><span class="delimiter">'</span><span class="content">myclient</span><span class="delimiter">'</span></span>,
    <span class="key">bearerOnly</span>: <span class="predefined-constant">true</span>,
    <span class="key">serverUrl</span>: <span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">'</span></span>,
    <span class="key">realm</span>: <span class="string"><span class="delimiter">'</span><span class="content">myrealm</span><span class="delimiter">'</span></span>,
    <span class="key">realmPublicKey</span>: <span class="string"><span class="delimiter">'</span><span class="content">MIIBIjANB...</span><span class="delimiter">'</span></span>
};

let keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore }, kcConfig);</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Configuring a web session store</dt>
<dd>
<p>If you want to use web sessions to manage
server-side state for authentication, you need to initialize the
<code>Keycloak(&#8230;&#8203;)</code> with at least a <code>store</code> parameter, passing in the actual
session store that <code>express-session</code> is using.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="keyword">var</span> session = require(<span class="string"><span class="delimiter">'</span><span class="content">express-session</span><span class="delimiter">'</span></span>);
    <span class="keyword">var</span> memoryStore = <span class="keyword">new</span> session.MemoryStore();

    <span class="keyword">var</span> keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">store</span>: memoryStore });</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Passing a custom scope value</dt>
<dd>
<p>By default, the scope value <code>openid</code> is passed as a query parameter to Keycloak&#8217;s login URL, but you can add an additional custom value:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="keyword">var</span> keycloak = <span class="keyword">new</span> Keycloak({ <span class="key">scope</span>: <span class="string"><span class="delimiter">'</span><span class="content">offline_access</span><span class="delimiter">'</span></span> });</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="installing-middleware"><a class="anchor" href="#installing-middleware"></a>2.3.3. Installing Middleware</h4>
<div class="paragraph">
<p>Once instantiated, install the middleware into your connect-capable app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="keyword">var</span> app = express();

    app.use( keycloak.middleware() );</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="protecting-resources"><a class="anchor" href="#protecting-resources"></a>2.3.4. Protecting Resources</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Simple authentication</dt>
<dd>
<p>To enforce that an user must be authenticated before accessing a resource,
simply use a no-argument version of <code>keycloak.protect()</code>:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/complain</span><span class="delimiter">'</span></span>, keycloak.protect(), complaintHandler );</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Role-based authorization</dt>
<dd>
<p>To secure a resource with an application role for the current app:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/special</span><span class="delimiter">'</span></span>, keycloak.protect(<span class="string"><span class="delimiter">'</span><span class="content">special</span><span class="delimiter">'</span></span>), specialHandler );</code></pre>
</div>
</div>
<div class="paragraph">
<p>To secure a resource with an application role for a <strong>different</strong> app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/extra-special</span><span class="delimiter">'</span></span>, keycloak.protect(<span class="string"><span class="delimiter">'</span><span class="content">other-app:special</span><span class="delimiter">'</span></span>, extraSpecialHandler );</code></pre>
</div>
</div>
<div class="paragraph">
<p>To secure a resource with a realm role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/admin</span><span class="delimiter">'</span></span>, keycloak.protect( <span class="string"><span class="delimiter">'</span><span class="content">realm:admin</span><span class="delimiter">'</span></span> ), adminHandler );</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Advanced authorization</dt>
<dd>
<p>To secure resources based on parts of the URL itself, assuming a role exists
for each section:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    <span class="keyword">function</span> <span class="function">protectBySection</span>(token, request) {
      <span class="keyword">return</span> token.hasRole( request.params.section );
    }

    app.get( <span class="string"><span class="delimiter">'</span><span class="content">/:section/:page</span><span class="delimiter">'</span></span>, keycloak.protect( protectBySection ), sectionHandler );</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="additional-urls"><a class="anchor" href="#additional-urls"></a>2.3.5. Additional URLs</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Explicit user-triggered logout</dt>
<dd>
<p>By default, the middleware catches calls to <code>/logout</code> to send the user through a
Keycloak-centric logout workflow. This can be changed by specifying a <code>logout</code>
configuration parameter to the <code>middleware()</code> call:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.use( keycloak.middleware( { <span class="key">logout</span>: <span class="string"><span class="delimiter">'</span><span class="content">/logoff</span><span class="delimiter">'</span></span> } ));</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Keycloak Admin Callbacks</dt>
<dd>
<p>Also, the middleware supports callbacks from the Keycloak console to log out a single
session or all sessions.  By default, these type of admin callbacks occur relative
to the root URL of <code>/</code> but can be changed by providing an <code>admin</code> parameter
to the <code>middleware()</code> call:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">    app.use( keycloak.middleware( { <span class="key">admin</span>: <span class="string"><span class="delimiter">'</span><span class="content">/callbacks</span><span class="delimiter">'</span></span> } );</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="other-openid-connect-libraries"><a class="anchor" href="#other-openid-connect-libraries"></a>2.4. Other OpenID Connect Libraries</h3>
<div class="paragraph">
<p>Keycloak can be secured by supplied adapters that are usually easier to use and provide better integration with Keycloak. However, if an adapter is not available for your programming language, framework, or platform you might opt to use a generic OpenID Connect Resource Provider (RP) library instead. This chapter describes details specific to Keycloak and does not contain specific protocol details. For more information see the <a href="http://openid.net/connect/">OpenID Connect specifications</a> and <a href="https://tools.ietf.org/html/rfc6749">OAuth2 specification</a>.</p>
</div>
<div class="sect3">
<h4 id="endpoints"><a class="anchor" href="#endpoints"></a>2.4.1. Endpoints</h4>
<div class="paragraph">
<p>The most important endpoint to understand is the <code>well-known</code> configuration endpoint. It lists endpoints and other configuration options relevant to the OpenID Connect implementation in Keycloak. The endpoint is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/.well-known/openid-configuration</pre>
</div>
</div>
<div class="paragraph">
<p>To obtain the full URL, add the base URL for Keycloak and replace <code>{realm-name}</code> with the name of your realm. For example:</p>
</div>
<div class="paragraph">
<p>http://localhost:8080/auth/realms/master/.well-known/openid-configuration</p>
</div>
<div class="paragraph">
<p>Some RP libraries retrieve all required endpoints from this endpoint, but for others you might need to list the endpoints individually.</p>
</div>
<div class="sect4">
<h5 id="authorization-endpoint"><a class="anchor" href="#authorization-endpoint"></a>Authorization Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/auth</pre>
</div>
</div>
<div class="paragraph">
<p>The authorization endpoint performs authentication of the end-user. This is done by redirecting the user agent to this endpoint.</p>
</div>
<div class="paragraph">
<p>For more details see the <a href="http://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint">Authorization Endpoint</a> section in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="token-endpoint"><a class="anchor" href="#token-endpoint"></a>Token Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/token</pre>
</div>
</div>
<div class="paragraph">
<p>The token endpoint is used to obtain tokens. Tokens can either be obtained by exchanging an authorization code or by supplying credentials directly depending on what flow is used.
The token endpoint is also used to obtain new access tokens when they expire.</p>
</div>
<div class="paragraph">
<p>For more details see the <a href="http://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint">Token Endpoint</a> section in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="userinfo-endpoint"><a class="anchor" href="#userinfo-endpoint"></a>Userinfo Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/userinfo</pre>
</div>
</div>
<div class="paragraph">
<p>The userinfo endpoint returns standard claims about the authenticated user, and is protected by a bearer token.</p>
</div>
<div class="paragraph">
<p>For more details see the <a href="http://openid.net/specs/openid-connect-core-1_0.html#UserInfo">Userinfo Endpoint</a> section in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="logout-endpoint"><a class="anchor" href="#logout-endpoint"></a>Logout Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/logout</pre>
</div>
</div>
<div class="paragraph">
<p>The logout endpoint logs out the authenticated user.</p>
</div>
<div class="paragraph">
<p>The user agent can be redirected to the endpoint, in which case the active user session is logged out. Afterward the user agent is redirected back to the application.</p>
</div>
<div class="paragraph">
<p>The endpoint can also be invoked directly by the application. To invoke this endpoint directly the refresh token needs to be included as well as the credentials required to authenticate the client.</p>
</div>
</div>
<div class="sect4">
<h5 id="certificate-endpoint"><a class="anchor" href="#certificate-endpoint"></a>Certificate Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/certs</pre>
</div>
</div>
<div class="paragraph">
<p>The certificate endpoint returns the public keys enabled by the realm, encoded as a JSON Web Key (JWK). Depending on the realm settings there can be one or more keys enabled for verifying tokens. For more information see the <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a> and the <a href="https://tools.ietf.org/html/rfc7517">JSON Web Key specification</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="introspection-endpoint"><a class="anchor" href="#introspection-endpoint"></a>Introspection Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/protocol/openid-connect/token/introspect</pre>
</div>
</div>
<div class="paragraph">
<p>The introspection endpoint is used to retrieve the active state of a token. It can only be invoked by confidential clients.</p>
</div>
<div class="paragraph">
<p>For more details see <a href="https://tools.ietf.org/html/rfc7662">OAuth 2.0 Token Introspection specification</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="dynamic-client-registration-endpoint"><a class="anchor" href="#dynamic-client-registration-endpoint"></a>Dynamic Client Registration Endpoint</h5>
<div class="literalblock">
<div class="content">
<pre>/realms/{realm-name}/clients-registrations/openid-connect</pre>
</div>
</div>
<div class="paragraph">
<p>The dynamic client registration endpoint is used to dynamically register clients.</p>
</div>
<div class="paragraph">
<p>For more details see the <a href="#_client_registration">Client Registration chapter</a> and the
<a href="https://openid.net/specs/openid-connect-registration-1_0.html">OpenID Connect Dynamic Client Registration specification</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flows"><a class="anchor" href="#flows"></a>2.4.2. Flows</h4>
<div class="sect4">
<h5 id="authorization-code"><a class="anchor" href="#authorization-code"></a>Authorization Code</h5>
<div class="paragraph">
<p>The Authorization Code flow redirects the user agent to Keycloak. Once the user has successfully authenticated with Keycloak an
Authorization Code is created and the user agent is redirected back to the application. The application then uses the authorization code along with its
credentials to obtain an Access Token, Refresh Token and ID Token from Keycloak.</p>
</div>
<div class="paragraph">
<p>The flow is targeted towards web applications, but is also recommended for native applications, including mobile applications, where it is possible to embed
a user agent.</p>
</div>
<div class="paragraph">
<p>For more details refer to the <a href="http://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth">Authorization Code Flow</a> in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="implicit"><a class="anchor" href="#implicit"></a>Implicit</h5>
<div class="paragraph">
<p>The Implicit flow redirects works similarly to the Authorization Code flow, but instead of returning a Authorization Code the Access Token and ID Token is
returned. This reduces the need for the extra invocation to exchange the Authorization Code for an Access Token. However, it does not include a Refresh
Token. This results in the need to either permit Access Tokens with a long expiration, which is problematic as it&#8217;s very hard to invalidate these. Or
requires a new redirect to obtain new Access Token once the initial Access Token has expired. The Implicit flow is useful if the application only wants to
authenticate the user and deals with logout itself.</p>
</div>
<div class="paragraph">
<p>There&#8217;s also a Hybrid flow where both the Access Token and an Authorization Code is returned.</p>
</div>
<div class="paragraph">
<p>One thing to note is that both the Implicit flow and Hybrid flow has potential security risks as the Access Token may be leaked through web server logs and
browser history. This is somewhat mitigated by using short expiration for Access Tokens.</p>
</div>
<div class="paragraph">
<p>For more details refer to the <a href="http://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth">Implicit Flow</a> in the OpenID Connect specification.</p>
</div>
</div>
<div class="sect4">
<h5 id="_resource_owner_password_credentials_flow"><a class="anchor" href="#_resource_owner_password_credentials_flow"></a>Resource Owner Password Credentials</h5>
<div class="paragraph">
<p>Resource Owner Password Credentials, referred to as Direct Grant in Keycloak, allows exchanging user credentials for tokens. It&#8217;s not recommended
to use this flow unless you absolutely need to. Examples where this could be useful are legacy applications and command-line interfaces.</p>
</div>
<div class="paragraph">
<p>There are a number of limitations of using this flow, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User credentials are exposed to the application</p>
</li>
<li>
<p>Applications need login pages</p>
</li>
<li>
<p>Application needs to be aware of the authentication scheme</p>
</li>
<li>
<p>Changes to authentication flow requires changes to application</p>
</li>
<li>
<p>No support for identity brokering or social login</p>
</li>
<li>
<p>Flows are not supported (user self-registration, required actions, etc.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For a client to be permitted to use the Resource Owner Password Credentials grant the client has to have the <code>Direct Access Grants Enabled</code> option enabled.</p>
</div>
<div class="paragraph">
<p>This flow is not included in OpenID Connect, but is a part of the OAuth 2.0 specification.</p>
</div>
<div class="paragraph">
<p>For more details refer to the <a href="https://tools.ietf.org/html/rfc6749#section-4.3">Resource Owner Password Credentials Grant</a> chapter in the OAuth 2.0 specification.</p>
</div>
<div class="sect5">
<h6 id="example-using-curl"><a class="anchor" href="#example-using-curl"></a>Example using CURL</h6>
<div class="paragraph">
<p>The following example shows how to obtain an access token for a user in the realm <code>master</code> with username <code>user</code> and password <code>password</code>. The example is using
the confidential client <code>myclient</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl \
  -d &quot;client_id=myclient&quot; \
  -d &quot;client_secret=40cc097b-2a57-4c17-b36a-8fdf3fc2d578&quot; \
  -d &quot;username=user&quot; \
  -d &quot;password=password&quot; \
  -d &quot;grant_type=password&quot; \
  &quot;http://localhost:8080/auth/realms/master/protocol/openid-connect/token&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="client-credentials"><a class="anchor" href="#client-credentials"></a>Client Credentials</h5>
<div class="paragraph">
<p>Client Credentials is used when clients (applications and services) wants to obtain access on behalf of themselves rather than on behalf of a user. This can
for example be useful for background services that applies changes to the system in general rather than for a specific user.</p>
</div>
<div class="paragraph">
<p>Keycloak provides support for clients to authenticate either with a secret or with public/private keys.</p>
</div>
<div class="paragraph">
<p>This flow is not included in OpenID Connect, but is a part of the OAuth 2.0 specification.</p>
</div>
<div class="paragraph">
<p>For more details refer to the <a href="https://tools.ietf.org/html/rfc6749#section-4.4">Client Credentials Grant</a> chapter in the OAuth 2.0 specification.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="redirect-uris"><a class="anchor" href="#redirect-uris"></a>2.4.3. Redirect URIs</h4>
<div class="paragraph">
<p>When using the redirect based flows it&#8217;s important to use valid redirect uris for your clients. The redirect uris should be as specific as possible. This
especially applies to client-side (public clients) applications. Failing to do so could result in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Open redirects - this can allow attackers to create spoof links that looks like they are coming from your domain</p>
</li>
<li>
<p>Unauthorized entry - when users are already authenticated with Keycloak an attacker can use a public client where redirect uris have not be configured correctly to gain access by redirecting the user without the users knowledge</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In production for web applications always use <code>https</code> for all redirect URIs. Do not allow redirects to http.</p>
</div>
<div class="paragraph">
<p>There&#8217;s also a few special redirect URIs:</p>
</div>
<div id="_installed_applications_url" class="dlist">
<dl>
<dt class="hdlist1"><code>http://localhost</code></dt>
<dd>
<p>This redirect URI is useful for native applications and allows the native application to create a web server on a random port that can be used to obtain the
authorization code. This redirect uri allows any port.</p>
</dd>
</dl>
</div>
<div id="_installed_applications_urn" class="dlist">
<dl>
<dt class="hdlist1"><code>urn:ietf:wg:oauth:2.0:oob</code></dt>
<dd>
<p>If its not possible to start a web server in the client (or a browser is not available) it is possible to use the special <code>urn:ietf:wg:oauth:2.0:oob</code> redirect uri.
When this redirect uri is used Keycloak displays a page with the code in the title and in a box on the page.
The application can either detect that the browser title has changed, or the user can copy/paste the code manually to the application.
With this redirect uri it is also possible for a user to use a different device to obtain a code to paste back to the application.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_mod_auth_openidc"><a class="anchor" href="#_mod_auth_openidc"></a>2.4.4. mod_auth_openidc Apache HTTPD Module</h4>
<div class="paragraph">
<p>The <a href="https://github.com/zmartzone/mod_auth_openidc">mod_auth_openidc</a> is an Apache HTTP plugin for OpenID Connect. If your language/environment supports using Apache HTTPD
as a proxy, then you can use <em>mod_auth_openidc</em> to secure your web application with OpenID Connect.  Configuration of this module
is beyond the scope of this document.  Please see the <em>mod_auth_openidc</em> Github repo for more details on configuration.</p>
</div>
<div class="paragraph">
<p>To configure <em>mod_auth_openidc</em> you&#8217;ll need</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The client_id.</p>
</li>
<li>
<p>The client_secret.</p>
</li>
<li>
<p>The redirect_uri to your application.</p>
</li>
<li>
<p>The Keycloak openid-configuration url</p>
</li>
<li>
<p><em>mod_auth_openidc</em> specific Apache HTTPD module config.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example configuration would look like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">LoadModule auth_openidc_module modules/mod_auth_openidc.so

ServerName ${HOSTIP}

<span class="tag">&lt;VirtualHost</span> <span class="error">*</span><span class="attribute-name">:80</span><span class="tag">&gt;</span>

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    #this is required by mod_auth_openidc
    OIDCCryptoPassphrase a-random-secret-used-by-apache-oidc-and-balancer

    OIDCProviderMetadataURL ${KC_ADDR}/auth/realms/${KC_REALM}/.well-known/openid-configuration

    OIDCClientID ${CLIENT_ID}
    OIDCClientSecret ${CLIENT_SECRET}
    OIDCRedirectURI http://${HOSTIP}/${CLIENT_APP_NAME}/redirect_uri

    # maps the prefered_username claim to the REMOTE_USER environment variable
    OIDCRemoteUserClaim preferred_username

    <span class="tag">&lt;Location</span> <span class="error">/</span><span class="error">$</span><span class="error">{</span><span class="attribute-name">CLIENT_APP_NAME</span><span class="error">}</span><span class="tag">/&gt;</span>
        AuthType openid-connect
        Require valid-user
    <span class="tag">&lt;/Location&gt;</span>
<span class="tag">&lt;/VirtualHost&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Further information on how to configure mod_auth_openidc can be found on the <a href="https://github.com/zmartzone/mod_auth_openidc">mod_auth_openidc</a>
project page.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="saml-2"><a class="anchor" href="#saml-2"></a>3. SAML</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how you can secure applications and services with SAML using either Keycloak client adapters or generic
SAML provider libraries.</p>
</div>
<div class="sect2">
<h3 id="java-adapters-2"><a class="anchor" href="#java-adapters-2"></a>3.1. Java Adapters</h3>
<div class="paragraph">
<p>Keycloak comes with a range of different adapters for Java application. Selecting the correct adapter depends on the target platform.</p>
</div>
<div class="sect3">
<h4 id="_saml-general-config"><a class="anchor" href="#_saml-general-config"></a>3.1.1. General Adapter Config</h4>
<div class="paragraph">
<p>Each SAML client adapter supported by Keycloak can be configured by a simple XML text file.
This is what one might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;keycloak-saml-adapter</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:keycloak:saml:adapter</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:keycloak:saml:adapter http://www.keycloak.org/schema/keycloak_saml_adapter_1_9.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/sales-post-sig/</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">sslPolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">nameIDPolicyFormat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">logoutPage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout.jsp</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">forceAuthentication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">isPassive</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">turnOffChangeSessionIdOnLogin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">autodetectBearerOnly</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Keys&gt;</span>
            <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
                <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;PrivateKey</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-sig/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test123</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-sig/</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/KeyStore&gt;</span>
            <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span>
        <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_NAME_ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;RoleIdentifiers&gt;</span>
            <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Role</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/RoleIdentifiers&gt;</span>
        <span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">signaturesRequired</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;SingleSignOnService</span> <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">bindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/auth/realms/demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
                    <span class="tag">/&gt;</span>

            <span class="tag">&lt;SingleLogoutService</span>
                    <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">responseBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">postBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/auth/realms/demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
                    <span class="attribute-name">redirectBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081/auth/realms/demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
                    <span class="tag">/&gt;</span>
            <span class="tag">&lt;Keys&gt;</span>
                <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/KeyStore&gt;</span>
                <span class="tag">&lt;/Key&gt;</span>
            <span class="tag">&lt;/Keys&gt;</span>
        <span class="tag">&lt;/IDP&gt;</span>
     <span class="tag">&lt;/SP&gt;</span>
<span class="tag">&lt;/keycloak-saml-adapter&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Some of these configuration switches may be adapter specific and some are common across all adapters.
For Java adapters you can use <code>${&#8230;&#8203;}</code> enclosure as System property replacement.
For example <code>${jboss.server.config.dir}</code>.</p>
</div>
<div class="sect4">
<h5 id="sp-element"><a class="anchor" href="#sp-element"></a>SP Element</h5>
<div class="paragraph">
<p>Here is the explanation of the SP element attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sp</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">sslPolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ssl</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">nameIDPolicyFormat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">format</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">forceAuthentication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">isPassive</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">autodetectBearerOnly</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
<span class="tag">&lt;/SP&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">entityID</dt>
<dd>
<p>This is the identifier for this client.
The IdP needs this value to determine who the client is that is communicating with it. This setting is <em>REQUIRED</em>.</p>
</dd>
<dt class="hdlist1">sslPolicy</dt>
<dd>
<p>This is the SSL policy the adapter will enforce.
Valid values are: <code>ALL</code>, <code>EXTERNAL</code>, and <code>NONE</code>.
For <code>ALL</code>, all requests must come in via HTTPS.
For <code>EXTERNAL</code>, only non-private IP addresses must come over the wire via HTTPS.
For <code>NONE</code>, no requests are required to come over via HTTPS.
This setting is <em>OPTIONAL</em>. Default value is <code>EXTERNAL</code>.</p>
</dd>
<dt class="hdlist1">nameIDPolicyFormat</dt>
<dd>
<p>SAML clients can request a specific NameID Subject format.
Fill in this value if you want a specific format.
It must be a standard SAML format identifier: <code>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code>.
This setting is <em>OPTIONAL</em>.
By default, no special format is requested.</p>
</dd>
<dt class="hdlist1">forceAuthentication</dt>
<dd>
<p>SAML clients can request that a user is re-authenticated even if they are already logged in at the IdP.
Set this to <code>true</code> to enable. This setting is <em>OPTIONAL</em>.
Default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">isPassive</dt>
<dd>
<p>SAML clients can request that a user is never asked to authenticate even if they are not logged in at the IdP.
Set this to <code>true</code> if you want this.
Do not use together with <code>forceAuthentication</code> as they are opposite. This setting is <em>OPTIONAL</em>.
Default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">turnOffChangeSessionIdOnLogin</dt>
<dd>
<p>The session ID is changed by default on a successful login on some platforms to plug a security attack vector.
Change this to <code>true</code> to disable this.  It is recommended you do not turn it off.
Default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">autodetectBearerOnly</dt>
<dd>
<p>This should be set to <em>true</em> if your application serves both a web application and web services (e.g. SOAP or REST).
It allows you to redirect unauthenticated users of the web application to the Keycloak login page,
but send an HTTP <code>401</code> status code to unauthenticated SOAP or REST clients instead as they would not understand a redirect to the login page.
Keycloak auto-detects SOAP or REST clients based on typical headers like <code>X-Requested-With</code>, <code>SOAPAction</code> or <code>Accept</code>.
The default value is <em>false</em>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_saml-sp-keys"><a class="anchor" href="#_saml-sp-keys"></a>Service Provider Keys and Key Elements</h5>
<div class="paragraph">
<p>If the IdP requires that the client application (or SP) sign all of its requests and/or if the IdP will encrypt assertions, you must define the keys used to do this.
For client-signed documents you must define both the private and public key or certificate that is used to sign documents.
For encryption, you only have to define the private key that is used to decrypt it.</p>
</div>
<div class="paragraph">
<p>There are two ways to describe your keys.
They can be stored within a Java KeyStore or you can copy/paste the keys directly within <code>keycloak-saml.xml</code> in the PEM format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">        <span class="tag">&lt;Keys&gt;</span>
            <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
               ...
            <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Key</code> element has two optional attributes <code>signing</code> and <code>encryption</code>.
When set to true these tell the adapter what the key will be used for.
If both attributes are set to true, then the key will be used for both signing documents and decrypting encrypted assertions.
You must set at least one of these attributes to true.</p>
</div>
<div class="sect5">
<h6 id="_saml-keystore"><a class="anchor" href="#_saml-keystore"></a>KeyStore element</h6>
<div class="paragraph">
<p>Within the <code>Key</code> element you can load your keys and certificates from a Java Keystore.  This is declared within
a <code>KeyStore</code> element.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">        <span class="tag">&lt;Keys&gt;</span>
            <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
                <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;PrivateKey</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myPrivate</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test123</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myCertAlias</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/KeyStore&gt;</span>
            <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the XML config attributes that are defined with the <code>KeyStore</code> element.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">file</dt>
<dd>
<p>File path to the key store. This option is <em>OPTIONAL</em>.  The file or resource attribute must be set.</p>
</dd>
<dt class="hdlist1">resource</dt>
<dd>
<p>WAR resource path to the KeyStore.
This is a path used in method call to ServletContext.getResourceAsStream(). This option is <em>OPTIONAL</em>.  The file or resource attribute must be set.</p>
</dd>
<dt class="hdlist1">password</dt>
<dd>
<p>The password of the KeyStore. This option is <em>REQUIRED</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you are defining keys that the SP will use to sign document, you must also specify references to your private keys
and certificates within the Java KeyStore.
The <code>PrivateKey</code> and <code>Certificate</code> elements in the above example define an <code>alias</code> that points to the key or cert
within the keystore.  Keystores require an additional password to access private keys.
In the <code>PrivateKey</code> element you must define this password within a <code>password</code> attribute.</p>
</div>
</div>
<div class="sect5">
<h6 id="key-pems"><a class="anchor" href="#key-pems"></a>Key PEMS</h6>
<div class="paragraph">
<p>Within the <code>Key</code> element you declare your keys and certificates directly using the sub elements
<code>PrivateKeyPem</code>, <code>PublicKeyPem</code>, and <code>CertificatePem</code>.
The values contained in these elements must conform to the PEM key format.
You usually use this option if you are generating keys using <code>openssl</code> or similar command line tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Keys&gt;</span>
   <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;PrivateKeyPem&gt;</span>
         2341251234AB31234==231BB998311222423522334
      <span class="tag">&lt;/PrivateKeyPem&gt;</span>
      <span class="tag">&lt;CertificatePem&gt;</span>
         211111341251234AB31234==231BB998311222423522334
      <span class="tag">&lt;/CertificatePem&gt;</span>
   <span class="tag">&lt;/Key&gt;</span>
<span class="tag">&lt;/Keys&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="sp-principalnamemapping-element"><a class="anchor" href="#sp-principalnamemapping-element"></a>SP PrincipalNameMapping element</h5>
<div class="paragraph">
<p>This element is optional.
When creating a Java Principal object that you obtain from methods such as <code>HttpServletRequest.getUserPrincipal()</code>, you can define what name is returned by the <code>Principal.getName()</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SP</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
  <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_NAME_ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/SP&gt;</span>

<span class="tag">&lt;SP</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
  <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_ATTRIBUTE</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">attribute</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/SP&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>policy</code> attribute defines the policy used to populate this value.
The possible values for this attribute are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">FROM_NAME_ID</dt>
<dd>
<p>This policy just uses whatever the SAML subject value is.  This is the default setting</p>
</dd>
<dt class="hdlist1">FROM_ATTRIBUTE</dt>
<dd>
<p>This will pull the value from one of the attributes declared in the SAML assertion received from the server.
You&#8217;ll need to specify the name of the SAML assertion attribute to use within the <code>attribute</code> XML attribute.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="roleidentifiers-element"><a class="anchor" href="#roleidentifiers-element"></a>RoleIdentifiers Element</h5>
<div class="paragraph">
<p>The <code>RoleIdentifiers</code> element defines what SAML attributes within the assertion received from the user should be used
as role identifiers within the Java EE Security Context for the user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;RoleIdentifiers&gt;</span>
     <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Role</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">member</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">memberOf</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/RoleIdentifiers&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default <code>Role</code> attribute values are converted to Java EE roles.
Some IdPs send roles using a <code>member</code> or <code>memberOf</code> attribute assertion.
You can define one or more <code>Attribute</code> elements to specify which SAML attributes must be converted into roles.</p>
</div>
</div>
<div class="sect4">
<h5 id="idp-element"><a class="anchor" href="#idp-element"></a>IDP Element</h5>
<div class="paragraph">
<p>Everything in the IDP element describes the settings for the identity provider (authentication server) the SP is communicating with.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">signaturesRequired</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">signatureAlgorithm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">RSA_SHA1</span><span class="delimiter">&quot;</span></span>
     <span class="attribute-name">signatureCanonicalizationMethod</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/10/xml-exc-c14n#</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
...
<span class="tag">&lt;/IDP&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the attribute config options you can specify within the <code>IDP</code> element declaration.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">entityID</dt>
<dd>
<p>This is the issuer ID of the IDP. This setting is <em>REQUIRED</em>.</p>
</dd>
<dt class="hdlist1">signaturesRequired</dt>
<dd>
<p>If set to <code>true</code>, the client adapter will sign every document it sends to the IDP.
Also, the client will expect that the IDP will be signing any documents sent to it.
This switch sets the default for all request and response types, but you will see later that you have some fine grain control over this.
This setting is <em>OPTIONAL</em> and will default to <code>false</code>.</p>
</dd>
<dt class="hdlist1">signatureAlgorithm</dt>
<dd>
<p>This is the signature algorithm that the IDP expects signed documents to use.
Allowed values are: <code>RSA_SHA1</code>, <code>RSA_SHA256</code>, <code>RSA_SHA512</code>, and <code>DSA_SHA1</code>.
This setting is <em>OPTIONAL</em>
and defaults to <code>RSA_SHA256</code>.</p>
</dd>
<dt class="hdlist1">signatureCanonicalizationMethod</dt>
<dd>
<p>This is the signature canonicalization method that the IDP expects signed documents to use.  This setting is  <em>OPTIONAL</em>.
The default value is <code>http://www.w3.org/2001/10/xml-exc-c14n#</code> and should be good for most IDPs.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-singlesignonservice"><a class="anchor" href="#_sp-idp-singlesignonservice"></a>IDP SingleSignOnService sub element</h5>
<div class="paragraph">
<p>The <code>SingleSignOnService</code> sub element defines the login SAML endpoint of the IDP.
The client adapter will send requests
to the IDP formatted via the settings within this element when it wants to login.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SingleSignOnService</span> <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">bindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are the config attributes you can define on this element:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">signRequest</dt>
<dd>
<p>Should the client sign authn requests? This setting is <em>OPTIONAL</em>.
Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">validateResponseSignature</dt>
<dd>
<p>Should the client expect the IDP to sign the assertion response document sent back from an auhtn request?
This setting <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">requestBinding</dt>
<dd>
<p>This is the SAML binding type used for communicating with the IDP.  This setting is <em>OPTIONAL</em>.
The default value is <code>POST</code>, but you can set it to <code>REDIRECT</code> as well.</p>
</dd>
<dt class="hdlist1">responseBinding</dt>
<dd>
<p>SAML allows the client to request what binding type it wants authn responses to use.
The values of this can be <code>POST</code> or <code>REDIRECT</code>.  This setting is <em>OPTIONAL</em>.
The default is that the client will not request a specific binding type for responses.</p>
</dd>
<dt class="hdlist1">assertionConsumerServiceUrl</dt>
<dd>
<p>URL of the assertion consumer service (ACS) where the IDP login service should send responses to.
This setting is <em>OPTIONAL</em>. By default it is unset, relying on the configuration in the IdP.
When set, it must end in <code>/saml</code>, e.g. <code>http://sp.domain.com/my/endpoint/for/saml</code>. The value
of this property is sent in <code>AssertionConsumerServiceURL</code> attribute of SAML <code>AuthnRequest</code> message.
This property is typically  accompanied by the <code>responseBinding</code> attribute.</p>
</dd>
<dt class="hdlist1">bindingUrl</dt>
<dd>
<p>This is the URL for the IDP login service that the client will send requests to. This setting is <em>REQUIRED</em>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="idp-singlelogoutservice-sub-element"><a class="anchor" href="#idp-singlelogoutservice-sub-element"></a>IDP SingleLogoutService sub element</h5>
<div class="paragraph">
<p>The <code>SingleLogoutService</code> sub element defines the logout SAML endpoint of the IDP.   The client adapter will send requests
to the IDP formatted via the settings within this element when it wants to logout.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;SingleLogoutService</span> <span class="attribute-name">validateRequestSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">signResponse</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">redirect</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">responseBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">post</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">postBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">posturl</span><span class="delimiter">&quot;</span></span>
                     <span class="attribute-name">redirectBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">redirecturl</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">signRequest</dt>
<dd>
<p>Should the client sign logout requests it makes to the IDP? This setting is <em>OPTIONAL</em>.
Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">signResponse</dt>
<dd>
<p>Should the client sign logout responses it sends to the IDP requests? This setting is <em>OPTIONAL</em>.
Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">validateRequestSignature</dt>
<dd>
<p>Should the client expect signed logout request documents from the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">validateResponseSignature</dt>
<dd>
<p>Should the client expect signed logout response documents from the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</dd>
<dt class="hdlist1">requestBinding</dt>
<dd>
<p>This is the SAML binding type used for communicating SAML requests to the IDP. This setting is <em>OPTIONAL</em>.
The default value is <code>POST</code>, but you can set it to REDIRECT as well.</p>
</dd>
<dt class="hdlist1">responseBinding</dt>
<dd>
<p>This is the SAML binding type used for communicating SAML responses to the IDP. The values of this can be <code>POST</code> or <code>REDIRECT</code>.  This setting is <em>OPTIONAL</em>.
The default value is <code>POST</code>, but you can set it to <code>REDIRECT</code> as well.</p>
</dd>
<dt class="hdlist1">postBindingUrl</dt>
<dd>
<p>This is the URL for the IDP&#8217;s logout service when using the POST binding. This setting is <em>REQUIRED</em> if using the <code>POST</code> binding.</p>
</dd>
<dt class="hdlist1">redirectBindingUrl</dt>
<dd>
<p>This is the URL for the IDP&#8217;s logout service when using the REDIRECT binding. This setting is <em>REQUIRED</em> if using the REDIRECT binding.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-keys"><a class="anchor" href="#_sp-idp-keys"></a>IDP Keys sub element</h5>
<div class="paragraph">
<p>The Keys sub element of IDP is only used to define the certificate or public key to use to verify documents signed by the IDP.
It is defined in the same way as the <a href="#_saml-sp-keys">SP&#8217;s Keys element</a>.
But again, you only have to define one certificate or public key reference. Note that, if both IDP and SP are realized by
Keycloak server and adapter, respectively, there is no need to specify the keys for signature validation, see below.</p>
</div>
<div id="_sp-idp-keys-automatic" class="paragraph">
<p>It is possible to configure SP to obtain public keys for IDP signature validation
from published certificates automatically, provided both SP and IDP are
implemented by Keycloak.
This is done by removing all declarations of signature validation keys in Keys
sub element. If the Keys sub element would then remain empty, it can be omitted
completely. The keys are then automatically obtained by SP from SAML descriptor,
location of which is derived from SAML endpoint URL specified in the
<a href="#_sp-idp-singlesignonservice">IDP SingleSignOnService sub element</a>.
Settings of the HTTP client that is used for SAML descriptor retrieval usually
needs no additional configuration, however it can be configured in the
<a href="#_sp-idp-httpclient">IDP HttpClient sub element</a>.</p>
</div>
<div class="paragraph">
<p>It is also possible to specify multiple keys for signature verification. This is done by declaring multiple Key elements
within Keys sub element that have <code>signing</code> attribute set to <code>true</code>.
This is useful for example in situation when the IDP signing keys are rotated: There is
usually a transition period when new SAML protocol messages and assertions are signed
with the new key but those signed by previous key should still be accepted.</p>
</div>
<div class="paragraph">
<p>It is not possible to configure Keycloak to both obtain the keys
for signature verification automatically and define additional static signature
verification keys.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">       <span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;Keys&gt;</span>
                <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                        <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;/KeyStore&gt;</span>
                <span class="tag">&lt;/Key&gt;</span>
            <span class="tag">&lt;/Keys&gt;</span>
        <span class="tag">&lt;/IDP&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_sp-idp-httpclient"><a class="anchor" href="#_sp-idp-httpclient"></a>IDP HttpClient sub element</h5>
<div class="paragraph">
<p>The <code>HttpClient</code> optional sub element defines the properties of HTTP client used
for automatic obtaining of certificates containing public keys for IDP signature
verification via SAML descriptor of the IDP when
<a href="#_sp-idp-keys-automatic">enabled</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;HttpClient</span> <span class="attribute-name">connectionPoolSize</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">disableTrustManager</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">allowAnyHostname</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">clientKeystore</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:keystore.jks</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">clientKeystorePassword</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pwd</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">truststore</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:truststore.jks</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">truststorePassword</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">pwd</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">proxyUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://proxy/</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">connectionPoolSize</dt>
<dd>
<p>Adapters will make separate HTTP invocations to the Keycloak server to turn an access code into an access token.
This config option defines how many connections to the Keycloak server should be pooled.
This is <em>OPTIONAL</em>.
The default value is <code>10</code>.</p>
</dd>
<dt class="hdlist1">disableTrustManager</dt>
<dd>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code> you do not have to specify a truststore.
This setting should only be used during development and <strong>never</strong> in production as it will disable verification of SSL certificates.
This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">allowAnyHostname</dt>
<dd>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code>
the Keycloak server&#8217;s certificate is validated via the truststore,
but host name validation is not done.
This setting should only be used during development and <strong>never</strong> in production
as it will partly disable verification of SSL certificates.
This seting may be useful in test environments. This is <em>OPTIONAL</em>.
The default value is <code>false</code>.</p>
</dd>
<dt class="hdlist1">truststore</dt>
<dd>
<p>The value is the file path to a keystore file.
If you prefix the path with <code>classpath:</code>, then the truststore will be obtained from the deployment&#8217;s classpath instead.
Used for outgoing HTTPS communications to the Keycloak server.
Client making HTTPS requests need a way to verify the host of the server they are talking to.
This is what the trustore does.
The keystore contains one or more trusted host certificates or certificate authorities.
You can create this truststore by extracting the public certificate of the Keycloak server&#8217;s SSL keystore.
This is <em>REQUIRED</em> unless <code>disableTrustManager</code> is <code>true</code>.</p>
</dd>
<dt class="hdlist1">truststorePassword</dt>
<dd>
<p>Password for the truststore keystore.
This is <em>REQUIRED</em> if <code>truststore</code> is set and the truststore requires a password.</p>
</dd>
<dt class="hdlist1">clientKeystore</dt>
<dd>
<p>This is the file path to a keystore file.
This keystore contains client certificate for two-way SSL when the adapter makes HTTPS requests to the Keycloak server.
This is <em>OPTIONAL</em>.</p>
</dd>
<dt class="hdlist1">clientKeystorePassword</dt>
<dd>
<p>Password for the client keystore and for the client&#8217;s key.
This is <em>REQUIRED</em> if <code>clientKeystore</code> is set.</p>
</dd>
<dt class="hdlist1">proxyUrl</dt>
<dd>
<p>URL to HTTP proxy to use for HTTP connections.
This is <em>OPTIONAL</em>.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_saml_jboss_adapter"><a class="anchor" href="#_saml_jboss_adapter"></a>3.1.2. JBoss EAP/Wildfly Adapter</h4>
<div class="paragraph">
<p>To be able to secure WAR apps deployed on JBoss EAP or Wildfly, you must install and configure the Keycloak SAML Adapter Subsystem.</p>
</div>
<div class="paragraph">
<p>You then provide a keycloak config, <code>/WEB-INF/keycloak-saml.xml</code> file in your WAR and change the auth-method to KEYCLOAK-SAML within web.xml.
Both methods are described in this section.</p>
</div>
<div class="sect4">
<h5 id="_saml-jboss-adapter-installation"><a class="anchor" href="#_saml-jboss-adapter-installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>Each adapter is a separate download on the Keycloak download site.</p>
</div>
<div class="paragraph">
<p>Install on Wildfly 9 or 10, 11 or JBoss EAP 7:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $WILDFLY_HOME
$ unzip keycloak-saml-wildfly-adapter-dist.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Install on JBoss EAP 6.x:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $JBOSS_HOME
$ unzip keycloak-saml-eap6-adapter-dist.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>These zip files create new JBoss Modules specific to the Wildfly/JBoss EAP SAML Adapter within your Wildfly or JBoss EAP distro.</p>
</div>
<div class="paragraph">
<p>After adding the modules, you must then enable the Keycloak SAML Subsystem within your app server&#8217;s server configuration: <code>domain.xml</code> or <code>standalone.xml</code>.</p>
</div>
<div class="paragraph">
<p>There is a CLI script that will help you modify your server configuration.
Start the server and run the script  from the server&#8217;s bin directory:</p>
</div>
<div class="listingblock">
<div class="title">Wildfly 11</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ ./bin/jboss-cli.sh --file=adapter-elytron-install-saml.cli</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Any other server but Wildfly 11</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $JBOSS_HOME/bin
$ jboss-cli.sh -c --file=adapter-install-saml.cli</code></pre>
</div>
</div>
<div class="paragraph">
<p>The script will add the extension, subsystem, and optional security-domain as described below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:1.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;extensions&gt;</span>
        <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.keycloak-saml-adapter-subsystem</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          ...
    <span class="tag">&lt;/extensions&gt;</span>

    <span class="tag">&lt;profile&gt;</span>
        <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-saml:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         ...
    <span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>keycloak</code> security domain should be used with EJBs and other components when you need the security context created
in the secured web tier to be propagated to the EJBs (other EE component) you are invoking.
Otherwise this configuration is optional.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;server</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:1.4</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:security:1.2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;security-domains&gt;</span>
...
      <span class="tag">&lt;security-domain</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;authentication&gt;</span>
           <span class="tag">&lt;login-module</span> <span class="attribute-name">code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.jboss.KeycloakLoginModule</span><span class="delimiter">&quot;</span></span>
                         <span class="attribute-name">flag</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/authentication&gt;</span>
      <span class="tag">&lt;/security-domain&gt;</span>
    <span class="tag">&lt;/security-domains&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, if you have a JAX-RS service that is an EJB within your WEB-INF/classes directory,
you&#8217;ll want to annotate it with the <code>@SecurityDomain</code> annotation as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">import org.jboss.ejb3.annotation.SecurityDomain;
import org.jboss.resteasy.annotations.cache.NoCache;

import javax.annotation.security.RolesAllowed;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import java.util.ArrayList;
import java.util.List;

@Path(&quot;customers&quot;)
@Stateless
@SecurityDomain(&quot;keycloak&quot;)
public class CustomerService {

    @EJB
    CustomerDB db;

    @GET
    @Produces(&quot;application/json&quot;)
    @NoCache
    @RolesAllowed(&quot;db_user&quot;)
    public List<span class="tag">&lt;String&gt;</span> getCustomers() {
        return db.getCustomers();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We hope to improve our integration in the future so that you don&#8217;t have to specify the
<code>@SecurityDomain</code> annotation when you want to propagate a keycloak security context to the EJB tier.</p>
</div>
</div>
<div class="sect4">
<h5 id="per-war-configuration"><a class="anchor" href="#per-war-configuration"></a>Per WAR Configuration</h5>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.
The format of this config file is described in the <a href="#_saml-general-config">General Adapter Config</a> section.</p>
</div>
<div class="paragraph">
<p>Next you must set the <code>auth-method</code> to <code>KEYCLOAK-SAML</code> in <code>web.xml</code>.
You also have to use standard servlet security to specify role-base constraints on your URLs.
Here&#8217;s an example <em>web.xml</em> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;module-name&gt;</span>customer-portal<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Admins<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/admin/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>
    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/customers/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>

    <span class="tag">&lt;login-config&gt;</span>
        <span class="tag">&lt;auth-method&gt;</span>KEYCLOAK-SAML<span class="tag">&lt;/auth-method&gt;</span>
        <span class="tag">&lt;realm-name&gt;</span>this is ignored currently<span class="tag">&lt;/realm-name&gt;</span>
    <span class="tag">&lt;/login-config&gt;</span>

    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All standard servlet settings except the <code>auth-method</code> setting.</p>
</div>
</div>
<div class="sect4">
<h5 id="securing-wars-via-keycloak-saml-subsystem"><a class="anchor" href="#securing-wars-via-keycloak-saml-subsystem"></a>Securing WARs via Keycloak SAML Subsystem</h5>
<div class="paragraph">
<p>You do not have to crack open a WAR to secure it with Keycloak.
Alternatively, you can externally secure it via the Keycloak SAML Adapter Subsystem.
While you don&#8217;t have to specify KEYCLOAK-SAML as an <code>auth-method</code>, you still have to define the <code>security-constraints</code> in <code>web.xml</code>.
You do not, however, have to create a <code>WEB-INF/keycloak-saml.xml</code> file.
This metadata is instead defined within the XML in your server&#8217;s <code>domain.xml</code> or <code>standalone.xml</code> subsystem configuration section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;extensions&gt;</span>
  <span class="tag">&lt;extension</span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.keycloak-saml-adapter-subsystem</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/extensions&gt;</span>

<span class="tag">&lt;profile&gt;</span>
  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-saml:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WAR MODULE NAME.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">APPLICATION URL</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
      <span class="tag">&lt;/SP&gt;</span>
    <span class="tag">&lt;/secure-deployment&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span>
<span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>secure-deployment</code> <code>name</code> attribute identifies the WAR you want to secure.
Its value is the <code>module-name</code> defined in <code>web.xml</code> with <code>.war</code> appended.
The rest of the configuration uses the same XML syntax as <code>keycloak-saml.xml</code> configuration defined in <a href="#_saml-general-config">General Adapter Config</a>.</p>
</div>
<div class="paragraph">
<p>An example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-saml:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;secure-deployment</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">saml-post-encryption.war</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;SP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-enc/</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">sslPolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">EXTERNAL</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">nameIDPolicyFormat</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">logoutPage</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/logout.jsp</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">forceAuthentication</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;Keys&gt;</span>
        <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">encryption</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;PrivateKey</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-enc/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test123</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/sales-post-enc/</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/KeyStore&gt;</span>
        <span class="tag">&lt;/Key&gt;</span>
      <span class="tag">&lt;/Keys&gt;</span>
      <span class="tag">&lt;PrincipalNameMapping</span> <span class="attribute-name">policy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FROM_NAME_ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;RoleIdentifiers&gt;</span>
        <span class="tag">&lt;Attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Role</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/RoleIdentifiers&gt;</span>
      <span class="tag">&lt;IDP</span> <span class="attribute-name">entityID</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;SingleSignOnService</span> <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">bindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth/realms/saml-demo/protocol/saml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;SingleLogoutService</span>
            <span class="attribute-name">validateRequestSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">validateResponseSignature</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">signRequest</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">signResponse</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">requestBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">responseBinding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POST</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">postBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth/realms/saml-demo/protocol/saml</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">redirectBindingUrl</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth/realms/saml-demo/protocol/saml</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;Keys&gt;</span>
          <span class="tag">&lt;Key</span> <span class="attribute-name">signing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
            <span class="tag">&lt;KeyStore</span> <span class="attribute-name">resource</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/WEB-INF/keystore.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">store123</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;Certificate</span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">saml-demo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/KeyStore&gt;</span>
          <span class="tag">&lt;/Key&gt;</span>
        <span class="tag">&lt;/Keys&gt;</span>
      <span class="tag">&lt;/IDP&gt;</span>
    <span class="tag">&lt;/SP&gt;</span>
   <span class="tag">&lt;/secure-deployment&gt;</span>
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_saml-tomcat-adapter"><a class="anchor" href="#_saml-tomcat-adapter"></a>3.1.3. Tomcat SAML adapters</h4>
<div class="paragraph">
<p>To be able to secure WAR apps deployed on Tomcat 6, 7 and 8 you must install the Keycloak Tomcat 6, 7 or 8 SAML adapter into your Tomcat installation.
You then have to provide some extra configuration in each WAR you deploy to Tomcat.
Let&#8217;s go over these steps.</p>
</div>
<div class="sect4">
<h5 id="_saml-tomcat-adapter-installation"><a class="anchor" href="#_saml-tomcat-adapter-installation"></a>Adapter Installation</h5>
<div class="paragraph">
<p>Adapters are no longer included with the appliance or war distribution.
Each adapter is a separate download on the Keycloak download site.
They are also available as a maven artifact.</p>
</div>
<div class="paragraph">
<p>You must unzip the adapter distro into Tomcat&#8217;s <code>lib/</code> directory.
Including adapter&#8217;s jars within your WEB-INF/lib directory will not work!  The Keycloak SAML adapter is implemented as
a Valve and valve code must reside in Tomcat&#8217;s main lib/ directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $TOMCAT_HOME/lib
$ unzip keycloak-saml-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-saml-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-saml-tomcat8-adapter-dist.zip</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="per-war-configuration-2"><a class="anchor" href="#per-war-configuration-2"></a>Per WAR Configuration</h5>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>META-INF/context.xml</code> file in your WAR package.
This is a Tomcat specific config file and you must define a Keycloak specific Valve.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;Context</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/your-context-path</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;Valve</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.saml.tomcat.SamlAuthenticatorValve</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/Context&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you must create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.
The format of this config file is described in the <a href="#_saml-general-config">General Adapter Config</a> section.</p>
</div>
<div class="paragraph">
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs.
Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;module-name&gt;</span>customer-portal<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>

    <span class="tag">&lt;login-config&gt;</span>
        <span class="tag">&lt;auth-method&gt;</span>BASIC<span class="tag">&lt;/auth-method&gt;</span>
        <span class="tag">&lt;realm-name&gt;</span>this is ignored currently<span class="tag">&lt;/realm-name&gt;</span>
    <span class="tag">&lt;/login-config&gt;</span>

    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jetty_saml_adapter"><a class="anchor" href="#_jetty_saml_adapter"></a>3.1.4. Jetty SAML Adapters</h4>
<div class="paragraph">
<p>To be able to secure WAR apps deployed on Jetty you must install the Keycloak Jetty 9.x or 8.x SAML adapter into your Jetty installation.
You then have to provide some extra configuration in each WAR you deploy to Jetty.
Let&#8217;s go over these steps.</p>
</div>
<div class="sect4">
<h5 id="_jetty9_saml_adapter_installation"><a class="anchor" href="#_jetty9_saml_adapter_installation"></a>Jetty 9 Adapter Installation</h5>
<div class="paragraph">
<p>Keycloak has a separate SAML adapter for Jetty 9.x.
You then have to provide some extra configuration in each WAR you deploy to Jetty.
Let&#8217;s go over these steps.</p>
</div>
<div class="paragraph">
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site.
They are also available as a maven artifact.</p>
</div>
<div class="paragraph">
<p>You must unzip the Jetty 9.x  distro into Jetty 9.x&#8217;s root directory.
Including adapter&#8217;s jars within your WEB-INF/lib directory will not work!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $JETTY_HOME
$ unzip keycloak-saml-jetty92-adapter-dist.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you will have to enable the keycloak module for your jetty.base.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd your-base
$ java -jar $JETTY_HOME/start.jar --add-to-startd=keycloak</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_saml-jetty9-per-war"><a class="anchor" href="#_saml-jetty9-per-war"></a>Jetty 9 Per WAR Configuration</h5>
<div class="paragraph">
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
</div>
<div class="paragraph">
<p>The first thing you must do is create a <code>WEB-INF/jetty-web.xml</code> file in your WAR package.
This is a Jetty specific config file and you must define a Keycloak specific authenticator within it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="doctype">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="tag">&lt;Configure</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.eclipse.jetty.webapp.WebAppContext</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;Get</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">securityHandler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;Set</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;New</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.keycloak.adapters.saml.jetty.KeycloakSamlAuthenticator</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;/New&gt;</span>
        <span class="tag">&lt;/Set&gt;</span>
    <span class="tag">&lt;/Get&gt;</span>
<span class="tag">&lt;/Configure&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next you must create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.
The format of this config file is described in the <a href="#_saml-general-config">General Adapter Config</a> section.</p>
</div>
<div class="paragraph">
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs.
Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;module-name&gt;</span>customer-portal<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;security-constraint&gt;</span>
        <span class="tag">&lt;web-resource-collection&gt;</span>
            <span class="tag">&lt;web-resource-name&gt;</span>Customers<span class="tag">&lt;/web-resource-name&gt;</span>
            <span class="tag">&lt;url-pattern&gt;</span>/*<span class="tag">&lt;/url-pattern&gt;</span>
        <span class="tag">&lt;/web-resource-collection&gt;</span>
        <span class="tag">&lt;auth-constraint&gt;</span>
            <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
        <span class="tag">&lt;/auth-constraint&gt;</span>
        <span class="tag">&lt;user-data-constraint&gt;</span>
            <span class="tag">&lt;transport-guarantee&gt;</span>CONFIDENTIAL<span class="tag">&lt;/transport-guarantee&gt;</span>
        <span class="tag">&lt;/user-data-constraint&gt;</span>
    <span class="tag">&lt;/security-constraint&gt;</span>

    <span class="tag">&lt;login-config&gt;</span>
        <span class="tag">&lt;auth-method&gt;</span>BASIC<span class="tag">&lt;/auth-method&gt;</span>
        <span class="tag">&lt;realm-name&gt;</span>this is ignored currently<span class="tag">&lt;/realm-name&gt;</span>
    <span class="tag">&lt;/login-config&gt;</span>

    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>admin<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
    <span class="tag">&lt;security-role&gt;</span>
        <span class="tag">&lt;role-name&gt;</span>user<span class="tag">&lt;/role-name&gt;</span>
    <span class="tag">&lt;/security-role&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jetty-8-adapter-installation"><a class="anchor" href="#jetty-8-adapter-installation"></a>Jetty 8 Adapter Installation</h5>
<div class="paragraph">
<p>Keycloak has a separate SAML adapter for Jetty 8.1.x that you will have to install into your Jetty installation.
You then have to provide some extra configuration in each WAR you deploy to Jetty.
Let&#8217;s go over these steps.</p>
</div>
<div class="paragraph">
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site.
They are also available as a maven artifact.</p>
</div>
<div class="paragraph">
<p>You must unzip the Jetty 8.1.x  distro into Jetty 8.1.x&#8217;s root directory.
Including adapter&#8217;s jars within your WEB-INF/lib directory will not work!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ cd $JETTY_HOME
$ unzip keycloak-saml-jetty81-adapter-dist.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, you will have to enable the keycloak option.
Edit start.ini and add keycloak to the options</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>#===========================================================
# Start classpath OPTIONS.
# These control what classes are on the classpath
# for a full listing do
#   java -jar start.jar --list-options
#-----------------------------------------------------------
OPTIONS=Server,jsp,jmx,resources,websocket,ext,plus,annotations,keycloak</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="jetty-8-per-war-configuration"><a class="anchor" href="#jetty-8-per-war-configuration"></a>Jetty 8 Per WAR Configuration</h5>
<div class="paragraph">
<p>Enabling Keycloak for your WARs is the same as the Jetty 9.x adapter.
See <a href="#_saml-jetty9-per-war">Jetty 9 Per War Configuration</a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="java-servlet-filter-adapter"><a class="anchor" href="#java-servlet-filter-adapter"></a>3.1.5. Java Servlet Filter Adapter</h4>
<div class="paragraph">
<p>If you want to use SAML with a Java servlet application that doesn&#8217;t have an adapter for that servlet platform, you can
opt to use the servlet filter adapter that Keycloak has.
This adapter works a little differently than the other adapters.
You still have to specify a <code>/WEB-INF/keycloak-saml.xml</code> file as defined in
the <a href="#_saml-general-config">General Adapter Config</a> section, but
you do not define security constraints in <em>web.xml</em>.
Instead you define a filter mapping using the Keycloak servlet filter adapter to secure the url patterns you want to secure.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Backchannel logout works a bit differently than the standard adapters.
      Instead of invalidating the http session it instead marks the session ID as logged out.
      There&#8217;s just no way of arbitrarily invalidating an http session based on a session ID.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Backchannel logout does not currently work when you have a clustered application that uses the SAML filter.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;web-app</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;module-name&gt;</span>customer-portal<span class="tag">&lt;/module-name&gt;</span>

    <span class="tag">&lt;filter&gt;</span>
        <span class="tag">&lt;filter-name&gt;</span>Keycloak Filter<span class="tag">&lt;/filter-name&gt;</span>
        <span class="tag">&lt;filter-class&gt;</span>org.keycloak.adapters.saml.servlet.SamlFilter<span class="tag">&lt;/filter-class&gt;</span>
    <span class="tag">&lt;/filter&gt;</span>
    <span class="tag">&lt;filter-mapping&gt;</span>
        <span class="tag">&lt;filter-name&gt;</span>Keycloak Filter<span class="tag">&lt;/filter-name&gt;</span>
        <span class="tag">&lt;url-pattern&gt;</span>/*<span class="tag">&lt;/url-pattern&gt;</span>
    <span class="tag">&lt;/filter-mapping&gt;</span>
<span class="tag">&lt;/web-app&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Keycloak filter has the same configuration parameters available as the other adapters except you must
define them as filter init params instead of context params.</p>
</div>
<div class="paragraph">
<p>You can define multiple filter mappings if you have various different secure and unsecure url patterns.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
You must have a filter mapping that covers <code>/saml</code>.
         This mapping covers all server callbacks.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When registering SPs with an IdP, you must register <code>http[s]://hostname/{context-root}/saml</code> as your Assert Consumer Service URL and Single Logout Service URL.</p>
</div>
<div class="paragraph">
<p>To use this filter, include this maven artifact in your WAR poms:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
   <span class="tag">&lt;groupId&gt;</span>org.keycloak<span class="tag">&lt;/groupId&gt;</span>
   <span class="tag">&lt;artifactId&gt;</span>keycloak-saml-servlet-filter-adapter<span class="tag">&lt;/artifactId&gt;</span>
   <span class="tag">&lt;version&gt;</span>3.4.1.CR1<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="registering-with-an-identity-provider"><a class="anchor" href="#registering-with-an-identity-provider"></a>3.1.6. Registering with an Identity Provider</h4>
<div class="paragraph">
<p>For each servlet-based adapter, the endpoint you register for the assert consumer service URL and and single logout service
must be the base URL of your servlet application with <code>/saml</code> appended to it, that is, <code>https://example.com/contextPath/saml</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="logout-2"><a class="anchor" href="#logout-2"></a>3.1.7. Logout</h4>
<div class="paragraph">
<p>There are multiple ways you can logout from a web application.
For Java EE servlet containers, you can call <code>HttpServletRequest.logout()</code>. For any other browser application, you can point
the browser at any url of your web application that has a security constraint and pass in a query parameter GLO, i.e. <code>http://myapp?GLO=true</code>.
This will log you out if you have an SSO session with your browser.</p>
</div>
<div class="sect4">
<h5 id="_saml_logout_in_cluster"><a class="anchor" href="#_saml_logout_in_cluster"></a>Logout in Clustered Environment</h5>
<div class="paragraph">
<p>Internally, the SAML adapter stores a mapping between the SAML session index, principal name (when known), and HTTP session ID.
This mapping can be maintained in JBoss application server family (Wildfly 10/11, EAP 6/7) across cluster for distributable
applications. As a precondition, the HTTP sessions need to be distributed across cluster (i.e. application is marked with
<code>&lt;distributable/&gt;</code> tag in application&#8217;s <code>web.xml</code>).</p>
</div>
<div class="paragraph">
<p>To enable the functionality, add the following section to your <code>/WEB_INF/web.xml</code> file:</p>
</div>
<div class="paragraph">
<p>For EAP 7, Wildfly 10/11:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>keycloak.sessionIdMapperUpdater.classes<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>org.keycloak.adapters.saml.wildfly.infinispan.InfinispanSessionCacheIdMapperUpdater<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For EAP 6:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;context-param&gt;</span>
    <span class="tag">&lt;param-name&gt;</span>keycloak.sessionIdMapperUpdater.classes<span class="tag">&lt;/param-name&gt;</span>
    <span class="tag">&lt;param-value&gt;</span>org.keycloak.adapters.saml.jbossweb.infinispan.InfinispanSessionCacheIdMapperUpdater<span class="tag">&lt;/param-value&gt;</span>
<span class="tag">&lt;/context-param&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the session cache of the deployment is named <code><em>deployment-cache</em></code>, the cache used for SAML mapping will be named
as <code><em>deployment-cache</em>.ssoCache</code>. The name of the cache can be overridden by a context parameter
<code>keycloak.sessionIdMapperUpdater.infinispan.cacheName</code>. The cache container containing the cache will be the same as
the one containing the deployment session cache, but can be overridden by a context parameter
<code>keycloak.sessionIdMapperUpdater.infinispan.containerName</code>.</p>
</div>
<div class="paragraph">
<p>By default, the configuration of the SAML mapping cache will be derived from session cache. The configuration can
be manually overridden in cache configuration section of the server just the same as other caches.</p>
</div>
<div class="paragraph">
<p>Currently, to provide reliable service, it is recommended to use replicated cache for the SAML session cache.
Using distributed cache may lead to results where the SAML logout request would land to a node with no access
to SAML session index to HTTP session mapping which would lead to unsuccessful logout.</p>
</div>
</div>
<div class="sect4">
<h5 id="_saml_logout_in_cross_dc"><a class="anchor" href="#_saml_logout_in_cross_dc"></a>Logout in Cross DC Scenario</h5>
<div class="paragraph">
<p>The cross DC scenario only applies to Wildfly 10 and higher, and EAP 7 and higher.</p>
</div>
<div class="paragraph">
<p>Special handling is needed for handling sessions that span multiple data centers. Imagine the following scenario:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Login requests are handled within cluster in data center 1.</p>
</li>
<li>
<p>Admin issues logout request for a particular SAML session, the request lands in data center 2.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The data center 2 has to log out all sessions that are present in data center 1 (and all other data centers that
share HTTP sessions).</p>
</div>
<div class="paragraph">
<p>To cover this case, the SAML session cache described <a href="#_saml_logout_in_cluster">above</a> needs to be replicated
not only within individual clusters but across all the data centers e.g.
<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_data_grid/6.6/html/administration_and_configuration_guide/chap-externalize_sessions#Externalize_HTTP_Session_from_JBoss_EAP_6.x_to_JBoss_Data_Grid">via standalone Infinispan/JDG server</a>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A cache has to be added to the standalone Infinispan/JDG server.</p>
</li>
<li>
<p>The cache from previous item has to be added as a remote store for the respective SAML session cache.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once remote store is found to be present on SAML session cache during deployment, it is watched for changes
and the local SAML session cache is updated accordingly.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obtaining-assertion-attributes"><a class="anchor" href="#obtaining-assertion-attributes"></a>3.1.8. Obtaining Assertion Attributes</h4>
<div class="paragraph">
<p>After a successful SAML login, your application code may want to obtain attribute values passed with the SAML assertion.
<code>HttpServletRequest.getUserPrincipal()</code> returns a <code>Principal</code> object that you can typecast into a Keycloak specific class
called <code>org.keycloak.adapters.saml.SamlPrincipal</code>.
This object allows you to look at the raw assertion and also has convenience functions to look up attribute values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">org.keycloak.adapters.saml</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">SamlPrincipal</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span>, <span class="predefined-type">Principal</span> {
    <span class="comment">/**
     * Get full saml assertion
     *
     * @return
     */</span>
    <span class="directive">public</span> AssertionType getAssertion() {
       ...
    }

    <span class="comment">/**
     * Get SAML subject sent in assertion
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSamlSubject() {
        ...
    }

    <span class="comment">/**
     * Subject nameID format
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getNameIDFormat() {
        ...
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        ...
    }

    <span class="comment">/**
     * Convenience function that gets Attribute value by attribute name
     *
     * @param name
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getAttributes(<span class="predefined-type">String</span> name) {
        ...

    }

    <span class="comment">/**
     * Convenience function that gets Attribute value by attribute friendly name
     *
     * @param friendlyName
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; getFriendlyAttributes(<span class="predefined-type">String</span> friendlyName) {
        ...
    }

    <span class="comment">/**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     * @param name
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getAttribute(<span class="predefined-type">String</span> name) {
        ...
    }

    <span class="comment">/**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     *
     * @param friendlyName
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getFriendlyAttribute(<span class="predefined-type">String</span> friendlyName) {
        ...
    }

    <span class="comment">/**
     * Get set of all assertion attribute names
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getAttributeNames() {
        ...
    }

    <span class="comment">/**
     * Get set of all assertion friendly attribute names
     *
     * @return
     */</span>
    <span class="directive">public</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; getFriendlyNames() {
        ...
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="error-handling"><a class="anchor" href="#error-handling"></a>3.1.9. Error Handling</h4>
<div class="paragraph">
<p>Keycloak has some error handling facilities for servlet based client adapters.
When an error is encountered in authentication, the client adapter will call <code>HttpServletResponse.sendError()</code>.
You can set up an <code>error-page</code> within your <code>web.xml</code> file to handle the error however you want.
The client adapter can throw 400, 401, 403, and 500 errors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;error-page&gt;</span>
    <span class="tag">&lt;error-code&gt;</span>403<span class="tag">&lt;/error-code&gt;</span>
    <span class="tag">&lt;location&gt;</span>/ErrorHandler<span class="tag">&lt;/location&gt;</span>
<span class="tag">&lt;/error-page&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The client adapter also sets an <code>HttpServletRequest</code> attribute that you can retrieve.
The attribute name is <code>org.keycloak.adapters.spi.AuthenticationError</code>.
Typecast this object to: <code>org.keycloak.adapters.saml.SamlAuthenticationError</code>.
This class can tell you exactly what happened.
If this attribute is not set, then the adapter was not responsible for the error code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">public</span> <span class="reserved">class</span> SamlAuthenticationError <span class="reserved">implements</span> AuthenticationError {
    <span class="reserved">public</span> <span class="reserved">static</span> <span class="reserved">enum</span> Reason {
        EXTRACTION_FAILURE,
        INVALID_SIGNATURE,
        ERROR_STATUS
    }

    <span class="reserved">public</span> Reason getReason() {
        <span class="keyword">return</span> reason;
    }
    <span class="reserved">public</span> StatusResponseType getStatus() {
        <span class="keyword">return</span> status;
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>3.1.10. Troubleshooting</h4>
<div class="paragraph">
<p>The best way to troubleshoot problems is to turn on debugging for SAML in both the client adapter and Keycloak Server. Using your logging framework, set the log level to <code>DEBUG</code> for the <code>org.keycloak.saml</code> package. Turning this on allows you to see the SAML requests and response documents being sent to and from the server.
==== Migration from older versions</p>
</div>
<div class="sect4">
<h5 id="migrating-to-1-9-0"><a class="anchor" href="#migrating-to-1-9-0"></a>Migrating to 1.9.0</h5>
<div class="sect5">
<h6 id="saml-sp-client-adapter-changes"><a class="anchor" href="#saml-sp-client-adapter-changes"></a>SAML SP Client Adapter Changes</h6>
<div class="paragraph">
<p>Keycloak SAML SP Client Adapter now requires a specific endpoint, <code>/saml</code> to be registered with your IdP.
The SamlFilter must also be bound to /saml in addition to any other binding it has.
This had to be done because SAML POST binding would eat the request input stream and this would be really bad for clients that relied on it.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mod_auth_mellon"><a class="anchor" href="#_mod_auth_mellon"></a>3.2. mod_auth_mellon Apache HTTPD Module</h3>
<div class="paragraph">
<p>The <a href="https://github.com/UNINETT/mod_auth_mellon">mod_auth_mellon</a> module is an Apache HTTPD plugin for SAML. If your language/environment supports using Apache HTTPD as a proxy, then you can use mod_auth_mellon to secure your web application with SAML. For more details on this module see the <em>mod_auth_mellon</em> Github repo.</p>
</div>
<div class="paragraph">
<p>To configure mod_auth_mellon you&#8217;ll need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An Identity Provider (IdP) entity descriptor XML file, which describes the connection to Keycloak or another SAML IdP</p>
</li>
<li>
<p>An SP entity descriptor XML file, which describes the SAML connections and configuration for the application you are securing.</p>
</li>
<li>
<p>A private key PEM file, which is a text file in the PEM format that defines the private key the application uses to sign documents.</p>
</li>
<li>
<p>A certificate PEM file, which is a text file that defines the certificate for your application.</p>
</li>
<li>
<p>mod_auth_mellon-specific Apache HTTPD module configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have already defined and registered the client application within a realm on the Keycloak application server, Keycloak can generate all the files you need except the Apache HTTPD module configuration.</p>
</div>
<div class="paragraph">
<p>To generate the Apache HTTPD module configuration, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to the Installation page of your SAML client and select the Mod Auth Mellon files option.</p>
<div class="paragraph">
<div class="title">mod_auth_mellon config download</div>
<p><span class="image"><img src="./keycloak-images/mod-auth-mellon-config-download.png" alt="mod auth mellon config download"></span></p>
</div>
</li>
<li>
<p>Click <strong>Download</strong> to download a zip file that contains the XML descriptor and PEM files you need.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="configuring-mod_auth_mellon-with-keycloak"><a class="anchor" href="#configuring-mod_auth_mellon-with-keycloak"></a>3.2.1. Configuring mod_auth_mellon with Keycloak</h4>
<div class="paragraph">
<p>There are two hosts involved:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The host on which Keycloak is running, which will be referred to as $idp_host because Keycloak is a SAML identity provider (IdP).</p>
</li>
<li>
<p>The host on which the web application is running, which will be referred to as $sp_host. In SAML an application using an IdP is called a service provider (SP).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All of the following steps need to performed on $sp_host with root privileges.</p>
</div>
<div class="sect4">
<h5 id="installing-the-packages"><a class="anchor" href="#installing-the-packages"></a>Installing the Packages</h5>
<div class="paragraph">
<p>To install the necessary packages, you will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apache Web Server (httpd)</p>
</li>
<li>
<p>Mellon SAML SP add-on module for Apache</p>
</li>
<li>
<p>Tools to create X509 certificates</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install the necessary packages, run this command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>yum install httpd mod_auth_mellon mod_ssl openssl</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="creating-a-configuration-directory-for-apache-saml"><a class="anchor" href="#creating-a-configuration-directory-for-apache-saml"></a>Creating a Configuration Directory for Apache SAML</h5>
<div class="paragraph">
<p>It is advisable to keep configuration files related to Apache&#8217;s use of SAML in one location.</p>
</div>
<div class="paragraph">
<p>Create a new directory named saml2 located under the Apache configuration root /etc/httpd:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir /etc/httpd/saml2</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configuring-the-mellon-service-provider"><a class="anchor" href="#configuring-the-mellon-service-provider"></a>Configuring the Mellon Service Provider</h5>
<div class="paragraph">
<p>Configuration files for Apache add-on modules are located in the /etc/httpd/conf.d directory and have a file name extension of .conf. You need to create the /etc/httpd/conf.d/mellon.conf file and place Mellon&#8217;s configuration directives in it.</p>
</div>
<div class="paragraph">
<p>Mellon&#8217;s configuration directives can roughly be broken down into two classes of information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which URLs to protect with SAML authentication</p>
</li>
<li>
<p>What SAML parameters will be used when a protected URL is referenced.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Apache configuration directives typically follow a hierarchical tree structure in the URL space, which are known as locations. You need to specify one or more URL locations for Mellon to protect. You have flexibility in how you add the configuration parameters that apply to each location. You can either add all the necessary parameters to the location block or you can add Mellon parameters to a common location high up in the URL location hierarchy that specific protected locations inherit (or some combination of the two). Since it is common for an SP to operate in the same way no matter which location triggers SAML actions, the example configuration used here places common Mellon configuration directives in the root of the hierarchy and then specific locations to be protected by Mellon can be defined with minimal directives. This strategy avoids duplicating the same parameters for each protected location.</p>
</div>
<div class="paragraph">
<p>This example has just one protected location: https://$sp_host/protected.</p>
</div>
<div class="paragraph">
<p>To configure the Mellon service provider, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the file /etc/httpd/conf.d/mellon.conf with this content:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"> <span class="tag">&lt;Location</span> <span class="error">/</span> <span class="tag">&gt;</span>
    MellonEnable info
    MellonEndpointPath /mellon/
    MellonSPMetadataFile /etc/httpd/saml2/mellon_metadata.xml
    MellonSPPrivateKeyFile /etc/httpd/saml2/mellon.key
    MellonSPCertFile /etc/httpd/saml2/mellon.crt
    MellonIdPMetadataFile /etc/httpd/saml2/idp_metadata.xml
 <span class="tag">&lt;/Location&gt;</span>
 <span class="tag">&lt;Location</span> <span class="error">/</span><span class="attribute-name">private</span> <span class="tag">&gt;</span>
    AuthType Mellon
    MellonEnable auth
    Require valid-user
 <span class="tag">&lt;/Location&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some of the files referenced in the code above are created in later steps.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="creating-the-service-provider-metadata"><a class="anchor" href="#creating-the-service-provider-metadata"></a>Creating the Service Provider Metadata</h5>
<div class="paragraph">
<p>In SAML IdPs and SPs exchange SAML metadata, which is in XML format. The schema for the metadata is a standard, thus assuring participating SAML entities can consume each other&#8217;s metadata. You need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Metadata for the IdP that the SP utilizes</p>
</li>
<li>
<p>Metadata describing the SP provided to the IdP</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>One of the components of SAML metadata is X509 certificates. These certificates are used for two purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sign SAML messages so the receiving end can prove the message originated from the expected party.</p>
</li>
<li>
<p>Encrypt the message during transport (seldom used because SAML messages typically occur on TLS-protected transports)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use your own certificates if you already have a Certificate Authority (CA) or you can generate a self-signed certificate. For simplicity in this example a self-signed certificate is used.</p>
</div>
<div class="paragraph">
<p>Because Mellon&#8217;s SP metadata must reflect the capabilities of the installed version of mod_auth_mellon, must be valid SP metadata XML, and must contain an X509 certificate (whose creation can be obtuse unless you are familiar with X509 certificate generation) the most expedient way to produce the SP metadata is to use a tool included in the mod_auth_mellon package (mellon_create_metadata.sh). The generated metadata can always be edited later because it is a text file. The tool also creates your X509 key and certificate.</p>
</div>
<div class="paragraph">
<p>SAML IdPs and SPs identify themselves using a unique name known as an EntityID. To use the Mellon metadata creation tool you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The EntityID, which is typically the URL of the SP, and often the URL of the SP where the SP metadata can be retrieved</p>
</li>
<li>
<p>The URL where SAML messages for the SP will be consumed, which Mellon calls the MellonEndPointPath.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To create the SP metadata, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a few helper shell variables:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>fqdn=`hostname`
mellon_endpoint_url="https://${fqdn}/mellon"
mellon_entity_id="${mellon_endpoint_url}/metadata"
file_prefix="$(echo "$mellon_entity_id" | sed 's/[^A-Za-z.]/_/g' | sed 's/__*/_/g')"</code></pre>
</div>
</div>
</li>
<li>
<p>Invoke the Mellon metadata creation tool by running this command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/usr/libexec/mod_auth_mellon/mellon_create_metadata.sh $mellon_entity_id $mellon_endpoint_url</code></pre>
</div>
</div>
</li>
<li>
<p>Move the generated files to their destination (referenced in the /etc/httpd/conf.d/mellon.conf file created above):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>mv ${file_prefix}.cert /etc/httpd/saml2/mellon.crt
mv ${file_prefix}.key /etc/httpd/saml2/mellon.key
mv ${file_prefix}.xml /etc/httpd/saml2/mellon_metadata.xml</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="adding-the-mellon-service-provider-to-the-keycloak-identity-provider"><a class="anchor" href="#adding-the-mellon-service-provider-to-the-keycloak-identity-provider"></a>Adding the Mellon Service Provider to the Keycloak Identity Provider</h5>
<div class="paragraph">
<p>Assumption: The Keycloak IdP has already been installed on the $idp_host.</p>
</div>
<div class="paragraph">
<p>Keycloak supports multiple tenancy where all users, clients, and so on are grouped in what is called a realm. Each realm is independent of other realms. You can use an existing realm in your Keycloak, but this example shows how to create a new realm called test_realm and use that realm.</p>
</div>
<div class="paragraph">
<p>All these operations are performed using the Keycloak administration web console. You must have the admin username and password for $idp_host.</p>
</div>
<div class="paragraph">
<p>To complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open the Admin Console and log on by entering the admin username and password.</p>
<div class="paragraph">
<p>After logging into the administration console there will be an existing realm. When Keycloak is first set up a root realm, master, is created by default. Any previously created realms are listed in the upper left corner of the administration console in a drop-down list.</p>
</div>
</li>
<li>
<p>From the realm drop-down list select <strong>Add realm</strong>.</p>
</li>
<li>
<p>In the Name field type <code>test_realm</code> and click <strong>Create</strong>.</p>
</li>
</ol>
</div>
<div class="sect5">
<h6 id="adding-the-mellon-service-provider-as-a-client-of-the-realm"><a class="anchor" href="#adding-the-mellon-service-provider-as-a-client-of-the-realm"></a>Adding the Mellon Service Provider as a Client of the Realm</h6>
<div class="paragraph">
<p>In Keycloak SAML SPs are known as clients. To add the SP we must be in the Clients section of the realm.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click the Clients menu item on the left and click <strong>Create</strong> in the upper right corner to create a new client.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="adding-the-mellon-sp-client"><a class="anchor" href="#adding-the-mellon-sp-client"></a>Adding the Mellon SP Client</h6>
<div class="paragraph">
<p>To add the Mellon SP client, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set the client protocol to SAML. From the Client Protocol drop down list, select <strong>saml</strong>.</p>
</li>
<li>
<p>Provide the Mellon SP metadata file created above (/etc/httpd/saml2/mellon_metadata.xml). Depending on where your browser is running you might have to copy the SP metadata from $sp_host to the machine on which your browser is running so the browser can find the file.</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="editing-the-mellon-sp-client"><a class="anchor" href="#editing-the-mellon-sp-client"></a>Editing the Mellon SP Client</h6>
<div class="paragraph">
<p>There are several client configuration parameters we suggest setting:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ensure "Force POST Binding" is On.</p>
</li>
<li>
<p>Add paosResponse to the Valid Redirect URIs list:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy the postResponse URL in "Valid Redirect URIs" and paste it into the empty add text fields just below the "+".</p>
</li>
<li>
<p>Change "postResponse" to "paosResponse". (The paosResponse URL is needed for SAML ECP.)</p>
</li>
<li>
<p>Click <strong>Save</strong> at the bottom.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Many SAML SPs determine authorization based on a user&#8217;s membership in a group. The Keycloak IdP can manage user group information but it does not supply the user&#8217;s groups unless the IdP is configured to supply it as a SAML attribute.</p>
</div>
<div class="paragraph">
<p>To configure the IdP to supply the user&#8217;s groups as as a SAML attribute, complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Click the Mappers tab of the client.</p>
</li>
<li>
<p>In the upper right corner of the Mappers page, click <strong>Create</strong>.</p>
</li>
<li>
<p>From the Mapper Type drop-down list select <strong>Group list</strong>.</p>
</li>
<li>
<p>Set Name to "group list."</p>
</li>
<li>
<p>Set the SAML attribute name to "groups."</p>
</li>
<li>
<p>Click <strong>Save</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The remaining steps are performed on $sp_host.</p>
</div>
</div>
<div class="sect5">
<h6 id="retrieving-the-identity-provider-metadata"><a class="anchor" href="#retrieving-the-identity-provider-metadata"></a>Retrieving the Identity Provider Metadata</h6>
<div class="paragraph">
<p>Now that you have created the realm on the IdP you need to retrieve the IdP metadata associated with it so the Mellon SP recognizes it. In the /etc/httpd/conf.d/mellon.conf file created previously, the MellonIdPMetadataFile is specified as /etc/httpd/saml2/idp_metadata.xml but until now that file has not existed on $sp_host. To get that file we will retrieve it from the IdP.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Retrieve the file from the IdP by substituting $idp_host with the correct value:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>curl -k -o /etc/httpd/saml2/idp_metadata.xml \
https://$idp_host/auth/realms/test_realm/protocol/saml/descriptor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mellon is now fully configured.</p>
</div>
</li>
<li>
<p>To run a syntax check for Apache configuration files:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>apachectl configtest</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Configtest is equivalent to the -t argument to apachectl. If the configuration test shows any errors, correct them before proceeding.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Restart the Apache server:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>systemctl restart httpd.service</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You have now set up both Keycloak as a SAML IdP in the test_realm and mod_auth_mellon as SAML SP protecting the URL $sp_host/protected (and everything beneath it) by authenticating against the <code>$idp_host</code> IdP.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="docker-registry-configuration"><a class="anchor" href="#docker-registry-configuration"></a>4. Docker Registry Configuration</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Docker authentication is disabled by default. To enable see <a href="http://www.keycloak.org/docs/3.4/server_installation/#_profiles">Profiles</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This section describes how you can configure a Docker registry to use Keycloak as its authentication server.</p>
</div>
<div class="paragraph">
<p>For more information on how to set up and configure a Docker registry, see the <a href="https://docs.docker.com/registry/configuration/">Docker Registry Configuration Guide</a>.</p>
</div>
<div class="sect2">
<h3 id="docker-registry-configuration-file-installation"><a class="anchor" href="#docker-registry-configuration-file-installation"></a>4.1. Docker Registry Configuration File Installation</h3>
<div class="paragraph">
<p>For users with more advanced docker registry configurations, it is generally recommended to provide your own registry configuration file.  The Keycloak docker provider supports this mechanism via the <em>Registry Config File</em> Format Option.  Choosing this option will generate output similar to the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>auth:
  token:
    realm: http://localhost:8080/auth/auth/realms/master/protocol/docker-v2/auth
    service: docker-test
    issuer: http://localhost:8080/auth/auth/realms/master</pre>
</div>
</div>
<div class="paragraph">
<p>This output can then be copied into any existing registry config file.  See the <a href="https://docs.docker.com/registry/configuration/">registry config file specification</a> for more information on how the file should be set up, or start with href:https://github.com/docker/distribution/blob/master/cmd/registry/config-example.yml[a basic example].</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t forget to configure the <code>rootcertbundle</code> field with the location of the Keycloak realm&#8217;s pulic certificate.  The auth configuration will not work without this argument.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="docker-registry-environment-variable-override-installation"><a class="anchor" href="#docker-registry-environment-variable-override-installation"></a>4.2. Docker Registry Environment Variable Override Installation</h3>
<div class="paragraph">
<p>Often times it is appropriate to use a simple environment variable override for develop or POC Docker registries.  While this approach is usually not recommended for production use, it can be helpful when one requires quick-and-dirty way to stand up a registry.  Simply use the <em>Variable Override</em> Format Option from the client installation tab, and an output should appear like the one below:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>REGISTRY_AUTH_TOKEN_REALM: http://localhost:8080/auth/auth/realms/master/protocol/docker-v2/auth
REGISTRY_AUTH_TOKEN_SERVICE: docker-test
REGISTRY_AUTH_TOKEN_ISSUER: http://localhost:8080/auth/auth/realms/master</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Don&#8217;t forget to configure the <code>REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE</code> override with the location of the Keycloak realm&#8217;s pulic certificate.  The auth configuration will not work without this argument.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="docker-compose-yaml-file"><a class="anchor" href="#docker-compose-yaml-file"></a>4.3. Docker Compose YAML File</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This installation method is meant to be an easy way to get a docker registry authenticating against a keycloak server.  It is intended for development purposes only and should never be used in a production or production-like environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The zip file installation mechanism provides a quickstart for developers who want to understand how the keycloak server can interact with the docker registry.  In order to configure:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the desired realm, create a client configuration.  At this point you won&#8217;t have a docker registry - the quickstart will take care of that part.</p>
</li>
<li>
<p>Choose the "Docker Compose YAML" option from the installation tab and download the .zip file</p>
</li>
<li>
<p>Unzip the archive to the desired location, and open the directory.</p>
</li>
<li>
<p>Start the docker registry with <code>docker-compose up</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>INFO: it is recommended that you configure the docker registry client in a realm other than 'master', since the HTTP Basic auth flow will not present forms.</p>
</div>
<div class="paragraph">
<p>Once the above configuration has taken place, and the keycloak server and docker registry are running, docker authentication should be successful:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[user ~]# docker login localhost:5000 -u $username
Password: *******
Login Succeeded</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client_registration"><a class="anchor" href="#_client_registration"></a>5. Client Registration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order for an application or service to utilize Keycloak it has to register a client in Keycloak.
An admin can do this through the admin console (or admin REST endpoints), but clients can also register themselves through the Keycloak client
registration service.</p>
</div>
<div class="paragraph">
<p>The Client Registration Service provides built-in support for Keycloak Client Representations, OpenID Connect Client Meta Data and SAML Entity Descriptors.
The Client Registration Service endpoint is <code>/realms/&lt;realm&gt;/clients-registrations/&lt;provider&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The built-in supported <code>providers</code> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>default - Keycloak Client Representation (JSON)</p>
</li>
<li>
<p>install - Keycloak Adapter Configuration (JSON)</p>
</li>
<li>
<p>openid-connect - OpenID Connect Client Metadata Description (JSON)</p>
</li>
<li>
<p>saml2-entity-descriptor - SAML Entity Descriptor (XML)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections will describe how to use the different providers.</p>
</div>
<div class="sect2">
<h3 id="authentication"><a class="anchor" href="#authentication"></a>5.1. Authentication</h3>
<div class="paragraph">
<p>To invoke the Client Registration Services you usually need a token. The token can be a bearer token, an initial access token or a registration access token.
There is an alternative to register new client without any token as well, but then you need to configure Client Registration Policies (see below).</p>
</div>
<div class="sect3">
<h4 id="bearer-token"><a class="anchor" href="#bearer-token"></a>5.1.1. Bearer Token</h4>
<div class="paragraph">
<p>The bearer token can be issued on behalf of a user or a Service Account. The following permissions are required to invoke the endpoints (see <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a> for more details):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>create-client or manage-client - To create clients</p>
</li>
<li>
<p>view-client or manage-client - To view clients</p>
</li>
<li>
<p>manage-client - To update or delete client</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are using a bearer token to create clients it&#8217;s recommend to use a token from a Service Account with only the <code>create-client</code> role (see <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a> for more details).</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_access_token"><a class="anchor" href="#_initial_access_token"></a>5.1.2. Initial Access Token</h4>
<div class="paragraph">
<p>The recommended approach to registering new clients is by using initial access tokens.
An initial access token can only be used to create clients and has a configurable expiration as well as a configurable limit on how many clients can be created.</p>
</div>
<div class="paragraph">
<p>An initial access token can be created through the admin console.
To create a new initial access token first select the realm in the admin console, then click on <code>Realm Settings</code> in the menu on the left, followed by
<code>Client Registration</code> in the tabs displayed in the page. Then finally click on <code>Initial Access Tokens</code> sub-tab.</p>
</div>
<div class="paragraph">
<p>You will now be able to see any existing initial access tokens. If you have access you can delete tokens that are no longer required. You can only retrieve the
value of the token when you are creating it. To create a new token click on <code>Create</code>. You can now optionally add how long the token should be valid, also how
many clients can be created using the token. After you click on <code>Save</code> the token value is displayed.</p>
</div>
<div class="paragraph">
<p>It is important that you copy/paste this token now as you won&#8217;t be able to retrieve it later. If you forget to copy/paste it, then delete the token and create another one.</p>
</div>
<div class="paragraph">
<p>The token value is used as a standard bearer token when invoking the Client Registration Services, by adding it to the Authorization header in the request.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Authorization: bearer eyJhbGciOiJSUz...</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_registration_access_token"><a class="anchor" href="#_registration_access_token"></a>5.1.3. Registration Access Token</h4>
<div class="paragraph">
<p>When you create a client through the Client Registration Service the response will include a registration access token.
The registration access token provides access to retrieve the client configuration later, but also to update or delete the client.
The registration access token is included with the request in the same way as a bearer token or initial access token.
Registration access tokens are only valid once when it&#8217;s used the response will include a new token.</p>
</div>
<div class="paragraph">
<p>If a client was created outside of the Client Registration Service it won&#8217;t have a registration access token associated with it.
You can create one through the admin console. This can also be useful if you loose the token for a particular client.
To create a new token find the client in the admin console and click on <code>Credentials</code>. Then click on <code>Generate registration access token</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-representations"><a class="anchor" href="#keycloak-representations"></a>5.2. Keycloak Representations</h3>
<div class="paragraph">
<p>The <code>default</code> client registration provider can be used to create, retrieve, update and delete a client.
It uses Keycloak Client Representation format which provides support for configuring clients exactly as they can be configured through the admin
console, including for example configuring protocol mappers.</p>
</div>
<div class="paragraph">
<p>To create a client create a Client Representation (JSON) then perform an HTTP POST request to <code>/realms/&lt;realm&gt;/clients-registrations/default</code>.</p>
</div>
<div class="paragraph">
<p>It will return a Client Representation that also includes the registration access token.
You should save the registration access token somewhere if you want to retrieve the config, update or delete the client later.</p>
</div>
<div class="paragraph">
<p>To retrieve the Client Representation perform an HTTP GET request to <code>/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>It will also return a new registration access token.</p>
</div>
<div class="paragraph">
<p>To update the Client Representation perform an HTTP PUT request with the updated Client Representation to:
<code>/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>It will also return a new registration access token.</p>
</div>
<div class="paragraph">
<p>To delete the Client Representation perform an HTTP DELETE request to:
<code>/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-adapter-configuration"><a class="anchor" href="#keycloak-adapter-configuration"></a>5.3. Keycloak Adapter Configuration</h3>
<div class="paragraph">
<p>The <code>installation</code> client registration provider can be used to retrieve the adapter configuration for a client.
In addition to token authentication you can also authenticate with client credentials using HTTP basic authentication.
To do this include the following header in the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Authorization: basic BASE64(client-id + ':' + client-secret)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To retrieve the Adapter Configuration then perfrom an HTTP GET request to <code>/realms/&lt;realm&gt;/clients-registrations/install/&lt;client id&gt;</code>.</p>
</div>
<div class="paragraph">
<p>No authentication is required for public clients.
This means that for the JavaScript adapter you can load the client configuration directly from Keycloak using the above URL.</p>
</div>
</div>
<div class="sect2">
<h3 id="openid-connect-dynamic-client-registration"><a class="anchor" href="#openid-connect-dynamic-client-registration"></a>5.4. OpenID Connect Dynamic Client Registration</h3>
<div class="paragraph">
<p>Keycloak implements <a href="https://openid.net/specs/openid-connect-registration-1_0.html">OpenID Connect Dynamic Client Registration</a>, which extends <a href="https://tools.ietf.org/html/rfc7591">OAuth 2.0 Dynamic Client Registration Protocol</a> and <a href="https://tools.ietf.org/html/rfc7592">OAuth 2.0 Dynamic Client Registration Management Protocol</a>.</p>
</div>
<div class="paragraph">
<p>The endpoint to use these specifications to register clients in Keycloak is <code>/realms/&lt;realm&gt;/clients-registrations/openid-connect[/&lt;client id&gt;]</code>.</p>
</div>
<div class="paragraph">
<p>This endpoints can also be found in the OpenID Connect Discovery endpoint for the realm, <code>/realms/&lt;realm&gt;/.well-known/openid-configuration</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="saml-entity-descriptors"><a class="anchor" href="#saml-entity-descriptors"></a>5.5. SAML Entity Descriptors</h3>
<div class="paragraph">
<p>The SAML Entity Descriptor endpoint only supports using SAML v2 Entity Descriptors to create clients.
It doesn&#8217;t support retrieving, updating or deleting clients.
For those operations the Keycloak representation endpoints should be used.
When creating a client a Keycloak Client Representation is returned with details about the created client, including a registration access token.</p>
</div>
<div class="paragraph">
<p>To create a client perform an HTTP POST request with the SAML Entity Descriptor to <code>/realms/&lt;realm&gt;/clients-registrations/saml2-entity-descriptor</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="example-using-curl-2"><a class="anchor" href="#example-using-curl-2"></a>5.6. Example using CURL</h3>
<div class="paragraph">
<p>The following example creates a client with the clientId <code>myclient</code> using CURL. You need to replace <code>eyJhbGciOiJSUz&#8230;&#8203;</code> with a proper initial access token or
bearer token.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d '{ &quot;clientId&quot;: &quot;myclient&quot; }' \
    -H &quot;Content-Type:application/json&quot; \
    -H &quot;Authorization: bearer eyJhbGciOiJSUz...&quot; \
    http://localhost:8080/auth/realms/master/clients-registrations/default</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-using-java-client-registration-api"><a class="anchor" href="#example-using-java-client-registration-api"></a>5.7. Example using Java Client Registration API</h3>
<div class="paragraph">
<p>The Client Registration Java API makes it easy to use the Client Registration Service using Java.
To use include the dependency <code>org.keycloak:keycloak-client-registration-api:&gt;VERSION&lt;</code> from Maven.</p>
</div>
<div class="paragraph">
<p>For full instructions on using the Client Registration refer to the JavaDocs.
Below is an example of creating a client. You need to replace <code>eyJhbGciOiJSUz&#8230;&#8203;</code> with a proper initial access token or bearer token.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> token = <span class="string"><span class="delimiter">&quot;</span><span class="content">eyJhbGciOiJSUz...</span><span class="delimiter">&quot;</span></span>;

ClientRepresentation client = <span class="keyword">new</span> ClientRepresentation();
client.setClientId(CLIENT_ID);

ClientRegistration reg = ClientRegistration.create()
    .url(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8080/auth</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">myrealm</span><span class="delimiter">&quot;</span></span>)
    .build();

reg.auth(Auth.token(token));

client = reg.create(client);

<span class="predefined-type">String</span> registrationAccessToken = client.getRegistrationAccessToken();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="client-registration-policies"><a class="anchor" href="#client-registration-policies"></a>5.8. Client Registration Policies</h3>
<div class="paragraph">
<p>Keycloak currently supports 2 ways how can be new clients registered through Client Registration Service.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authenticated requests - Request to register new client must contain either <code>Initial Access Token</code> or <code>Bearer Token</code> as mentioned above.</p>
</li>
<li>
<p>Anonymous requests - Request to register new client doesn&#8217;t need to contain any token at all</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Anonymous client registration requests are very interesting and powerful feature, however you usually don&#8217;t want that anyone is able to register new
client without any limitations. Hence we have <code>Client Registration Policy SPI</code>, which provide a way to limit who can register new clients and under which conditions.</p>
</div>
<div class="paragraph">
<p>In Keycloak admin console, you can click to <code>Client Registration</code> tab and then <code>Client Registration Policies</code> sub-tab. Here you will see what policies
are configured by default for anonymous requests and what policies are configured for authenticated requests.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The anonymous requests (requests without any token) are allowed just for creating (registration) of new clients. So when you register
new client through anonymous request, the response will contain Registration Access Token, which must be used for Read, Update or Delete request of particular client.
However using this Registration Access Token from anonymous registration will be then subject to Anonymous Policy too! This means that for example request for update
client also needs to come from Trusted Host if you have <code>Trusted Hosts</code> policy. Also for example it won&#8217;t be allowed to disable <code>Consent Required</code> when updating client and
when <code>Consent Required</code> policy is present etc.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Currently we have these policy implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Trusted Hosts Policy - You can configure list of trusted hosts and trusted domains. Request to Client Registration Service can be sent just from those hosts or domains.
Request sent from some untrusted IP will be rejected. URLs of newly registered client must also use just those trusted hosts or domains. For example it won&#8217;t be allowed
to set <code>Redirect URI</code> of client pointing to some untrusted host. By default, there is not any whitelisted host, so anonymous client registration is de-facto disabled by default.</p>
</li>
<li>
<p>Consent Required Policy - Newly registered clients will have <code>Consent Allowed</code> switch enabled. So after successful authentication, user will always
see consent screen when he needs to approve personal info and permissions (protocol mappers and roles). It means that client won&#8217;t have access to any personal
info or permission of user unless user approves it.</p>
</li>
<li>
<p>Protocol Mappers Policy - Allows to configure list of whitelisted protocol mapper implementations. New client can&#8217;t be registered
or updated if it contains some non-whitelisted protocol mapper. Note that this policy is used for authenticated requests as well, so
even for authenticated request there are some limitations which protocol mappers can be used.</p>
</li>
<li>
<p>Client Template Policy - Allow to whitelist <code>Client Templates</code>, which can be used with newly registered or updated clients.
There are no whitelisted templates by default.</p>
</li>
<li>
<p>Full Scope Policy - Newly registered clients will have <code>Full Scope Allowed</code> switch disabled. This means they won&#8217;t have any scoped
realm roles or client roles of other clients.</p>
</li>
<li>
<p>Max Clients Policy - Rejects registration if current number of clients in the realm is same or bigger than specified limit. It&#8217;s 200 by default for anonymous registrations.</p>
</li>
<li>
<p>Client Disabled Policy - Newly registered client will be disabled. This means that admin needs to manually approve and enable all newly registered clients.
This policy is not used by default even for anonymous registration.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_client_registration_cli"><a class="anchor" href="#_client_registration_cli"></a>6. Client Registration CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Client Registration CLI</code> is a command line interface tool for application developers to configure new clients in self-service manner
when integrating with Keycloak. It is specifically designed to interact with Keycloak Client Registration REST endpoints.</p>
</div>
<div class="paragraph">
<p>In order for any application to be able to use Keycloak it is necessary to create or obtain a client configuration. Usually a new client is configured for
each new application hosted on a unique hostname. When application interacts with Keycloak it needs to identify itself with a <code>client_id</code> in order for Keycloak
to be able to provide login page, SSO session management, and other services.</p>
</div>
<div class="paragraph">
<p><code>Client Registration CLI</code> allows you to configure application clients from a command line, and can be used in shell scripts as well.</p>
</div>
<div class="paragraph">
<p>To allow a particular user to use <code>Client Registration CLI</code> the Keycloak administrator will typically use <code>Admin Console</code> to configure
 a new user with proper roles, or configure a new client and client secret to grant access to <code>Client Registration REST API</code>.</p>
</div>
<div class="sect2">
<h3 id="_configuring_a_user_for_client_registration_cli"><a class="anchor" href="#_configuring_a_user_for_client_registration_cli"></a>6.1. Configuring a new regular user for use with Client Registration CLI</h3>
<div class="paragraph">
<p>Login as <code>admin</code> into <code>Admin Console</code> (e.g. <code><a href="http://localhost:8080/auth/admin" class="bare">http://localhost:8080/auth/admin</a></code>). Select a realm you want to administer.
If you want to use existing user, select that user for edit, otherwise create a new user. Go to <code>Role Mappings</code> tab. Under
<code>Client Roles</code> select <code>realm-management</code> (if in master realm, select <code>NAME-realm</code> where NAME is name of the target realm - users in master realm can have access to any other realms).
Under <code>Available Roles</code> select <code>manage-client</code> for full set of client management permissions. Alternatively you can choose
<code>view-clients</code> for read-only or <code>create-client</code> for ability to create new clients.
These permissions grant user the capability to perform operations without the use of <a href="#_initial_access_token">Initial Access Token</a> or
<a href="#_registration_access_token">Registration Access Token</a>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to not assign users any of <code>realm-management</code> roles. In that case user can still login with <code>Registration Client CLI</code>
but will not be able to use it without being in possession of an <code>Initial Access Token</code>. Trying to perform any operations
without it will result in <code>403 Forbidden</code> error.</p>
</div>
<div class="paragraph">
<p>Administrator can issue <code>Initial Access Tokens</code> from <code>Admin Console</code> by selecting <code>Client Registration</code> tab under <code>Realm Settings</code>, then <code>Initial Access Token</code> sub-tab.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_a_client_for_use_with_client_registration_cli"><a class="anchor" href="#_configuring_a_client_for_use_with_client_registration_cli"></a>6.2. Configuring a client for use with Client Registration CLI</h3>
<div class="paragraph">
<p>By default the <code>Client Registration CLI</code> identifies to the server as <code>admin-cli</code> client which is automatically configured for every new realm.
No additional client configuration is necessary when logging in with username. You may wish to strengthen security by
configuring the client <code>Access Type</code> as <code>Confidential</code>, and under <code>Credentials</code> tab select <code>ClientId and Secret</code>. When
running <code>kcreg config credentials</code> you would then also have to provide a secret by using <code>--secret</code> option.</p>
</div>
<div class="paragraph">
<p>If you want to use a separate client configuration for <code>Registration Client CLI</code> then you can create a new client - you can call it <code>reg-cli</code>
for example. When running <code>kcreg config credentials</code> you then need to specify which <code>clientId</code> to use e.g. <code>--client reg-cli</code>.</p>
</div>
<div class="paragraph">
<p>If you want to use a service account associated with the client, you first need to enable service accounts. In <code>Admin Console</code>
go to <code>Clients</code> section, and select a client for edit. Then under <code>Settings</code> change the <code>Access Type</code> to <code>Confidential</code>, and toggle
<code>Service Accounts Enabled</code> setting to <code>On</code>. Make sure to <code>Save</code> the configuration.</p>
</div>
<div class="paragraph">
<p>Under <code>Credentials</code> tab you can choose to configure either <code>Client Id and Secret</code>, or <code>Signed JWT</code>.</p>
</div>
<div class="paragraph">
<p>Having done that you can then omit specifying user during <code>kcreg config credentials</code>, and only provide client secret or keystore info.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installing_client_registration_cli"><a class="anchor" href="#_installing_client_registration_cli"></a>6.3. Installing Client Registration CLI</h3>
<div class="paragraph">
<p>Client Registration CLI is packaged inside Keycloak Server distribution. You can find execution scripts inside <code>bin</code> directory.</p>
</div>
<div class="paragraph">
<p>The Linux script is called <code>kcreg.sh</code>, and the one for Windows is called <code>kcreg.bat</code>.</p>
</div>
<div class="paragraph">
<p>In order to setup the client for use from any location on the filesystem you may want to add Keycloak server directory to your PATH.</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ export PATH=$PATH:$KEYCLOAK_HOME/bin
$ kcreg.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c:\&gt; set PATH=%PATH%;%KEYCLOAK_HOME%\bin
c:\&gt; kcreg</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where KEYCLOAK_HOME refers to a directory where Keycloak Server distribution was unpacked.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_client_registration_cli"><a class="anchor" href="#_using_client_registration_cli"></a>6.4. Using Client Registration CLI</h3>
<div class="paragraph">
<p>First you need to start an authenticated session (i.e. logging in) by providing credentials. Then you perform operations on Client Registration REST endpoint.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh config credentials --server http://localhost:8080/auth --realm demo --user user --client reg-cli
$ kcreg.sh create -s clientId=my_client -s 'redirectUris=[&quot;http://localhost:8980/myapp/*&quot;]'
$ kcreg.sh get my_client</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c:\&gt; kcreg config credentials --server http://localhost:8080/auth --realm demo --user user --client reg-cli
c:\&gt; kcreg create -s clientId=my_client -s &quot;redirectUris=[\&quot;http://localhost:8980/myapp/*\&quot;]&quot;
c:\&gt; kcreg get my_client</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a production environment Keycloak has to be accessed with <code>https:</code> to avoid exposing tokens to network sniffers. If server&#8217;s
certificate is not issued by one of the trusted CAs that are included in Java&#8217;s default certificate truststore, you will
need to prepare a truststore.jks file, and instruct <code>Client Registration CLI</code> to use it.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh config truststore --trustpass $PASSWORD ~/.keycloak/truststore.jks</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c:\&gt; kcreg config truststore --trustpass %PASSWORD% %HOMEPATH%\.keycloak\truststore.jks</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_logging_in"><a class="anchor" href="#_logging_in"></a>6.4.1. Logging In</h4>
<div class="paragraph">
<p>When logging in with <code>Client Registration CLI</code> you specify a server endpoint url, and a realm. Then you specify a username
or, alternatively, a client id, which will result in special service account being used. In the first case,
a password for the specified user has to be used at login. In the latter case there is no user password - only client secret
or a <code>Signed JWT</code> is used.</p>
</div>
<div class="paragraph">
<p>Regardless of the method, the account that logs in needs proper permissions to be able to perform client
registration operations. Keep in mind that any account in non-master realm can only have permissions to manage clients within the same realm.
If you need to manage different realms, you can either configure multiple users in different realms, or you can create a single user in <code>master</code> realm and
add it roles for managing clients in different realms.</p>
</div>
<div class="paragraph">
<p><code>Client Registration CLI</code> by itself does not support configuring users, for that you would need to use <code>Admin Console</code>
web interface or Admin Client CLI command line tool (see <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a> for more details).</p>
</div>
<div class="paragraph">
<p>When <code>kcreg</code> successfully logs in it receives authorization tokens and saves them into private config file so they can be
used for subsequent invocations. See <a href="#_working_with_alternative_configurations">next chapter</a> for more info on configuration file.</p>
</div>
<div class="paragraph">
<p>See built-in help for more information on using <code>Client Registration CLI</code>.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh help</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or on Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c:\&gt; kcreg help</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <code>kcreg config credentials --help</code> for more information about starting an authenticated session.</p>
</div>
</div>
<div class="sect3">
<h4 id="_working_with_alternative_configurations"><a class="anchor" href="#_working_with_alternative_configurations"></a>6.4.2. Working with alternative configurations</h4>
<div class="paragraph">
<p>By default, <code>Client Registration CLI</code> automatically maintains a configuration file at a default location - <code>./.keycloak/kcreg.config</code>
under user&#8217;s home directory.</p>
</div>
<div class="paragraph">
<p>You can always use <code>--config</code> option to point to a different file / location. This way you can mantain multiple authenticated
sessions in parallel. It is safest to perform operations tied to a single config file from a single thread.</p>
</div>
<div class="paragraph">
<p>Make sure to not make the config file visible to other users on the system as it contains access tokens, and secrets that should be kept private.</p>
</div>
<div class="paragraph">
<p>You may want to avoid storing any secrets at all inside a config file for the price of less convenience and having to do more token requests.
In that case you can use <code>--no-config</code> option with all your commands. You will have to specify all authentication info with each
<code>kcreg</code> invocation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_initial_access_and_registration_access_tokens"><a class="anchor" href="#_initial_access_and_registration_access_tokens"></a>6.4.3. Initial Access and Registration Access Tokens</h4>
<div class="paragraph">
<p><code>Client Registration CLI</code> can be used by developers who don&#8217;t have an account configured at Keycloak server they want to use.
That&#8217;s possible when realm administrator issues developer an <code>Initial Access Token</code>. It is up to realm administrator to decide
how to issue and distribute these tokens. Admin can limit Initial Access Token&#8217;s maximum age, and a total number of clients
that can be created with it. Many Initial Access Tokens can be created, and it&#8217;s up to realm administrator to distribute them
to application developers.</p>
</div>
<div class="paragraph">
<p>Once a developer is in possession of Initial Access Token they can use it to create new clients without authenticating
with <code>kcreg config credentials</code>. Rather, Initial Access Token can be stored in configuration, or specified as part of <code>kcreg create</code>
command.</p>
</div>
<div class="paragraph">
<p>For example on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh config initial-token $TOKEN
$ kcreg.sh create -s clientId=myclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh create -s clientId=myclient -t $TOKEN</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c:\&gt; kcreg config initial-token %TOKEN%
c:\&gt; kcreg create -s clientId=myclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c:\&gt; kcreg create -s clientId=myclient -t %TOKEN%</code></pre>
</div>
</div>
<div class="paragraph">
<p>When Initial Access Token is used, the server response will include a newly issued Registration Access Token.
Any subsequent operation for that client needs to be performed by authenticating with that token which is only valid for that client.</p>
</div>
<div class="paragraph">
<p><code>Client Registration CLI</code> automatically uses its private configuration file to save, and use this token with its associated client.
As long as the same configuration file is used for all client operations, the developer will not need to
authenticate in order to read, update, or delete a client that was created this way.</p>
</div>
<div class="paragraph">
<p>You can read more about Initial Access and Registration Access Tokens in <a href="#_client_registration">Client Registration chapter</a>.</p>
</div>
<div class="paragraph">
<p>See <code>kcreg config initial-token --help</code> and <code>kcreg config registration-token --help</code> for more information on how to configure them with <code>Client Registration CLI</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_performing_crud_operations"><a class="anchor" href="#_performing_crud_operations"></a>6.4.4. Creating client configuration</h4>
<div class="paragraph">
<p>After authenticating with credentials or configuring Initial Access Token, the first operation will usually be to create a new client.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve seen the simplest create command already. Often we may want to use a prepared JSON file as a template and set / override
some of the attributes. For example, here is how you read a JSON file, override any <code>clientId</code> it may contain,
set any other attributes as well, and after successful creation print the configuration to standard output.</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s 'redirectUris=[&quot;/myclient/*&quot;]' -o</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s &quot;redirectUris=[\&quot;/myclient/*\&quot;]&quot; -o</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <code>kcreg create --help</code> for more information about <code>kcreg create</code>.</p>
</div>
<div class="paragraph">
<p>You can use <code>kcreg attrs</code> to list available attributes. Keep in mind that many configuration attributes are not checked for
validity or consistency. It is up to you to specify proper values. Also note that you should not have any <code>id</code> fields in your
template and should not specify them as arguments to <code>kcreg create</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="retrieving-client-configuration"><a class="anchor" href="#retrieving-client-configuration"></a>6.4.5. Retrieving client configuration</h4>
<div class="paragraph">
<p>You can retrieve an existing client by using <code>kcreg get</code>.</p>
</div>
<div class="paragraph">
<p>For example, on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh get myclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg get myclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also get client configuration as adapter configuration file which you can package with your web application.</p>
</div>
<div class="paragraph">
<p>For example, on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh get myclient -e install &gt; keycloak.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg get myclient -e install &gt; keycloak.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <code>kcreg get --help</code> for more information about <code>kcreg get</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="modifying-client-configuration"><a class="anchor" href="#modifying-client-configuration"></a>6.4.6. Modifying client configuration</h4>
<div class="paragraph">
<p>There are two modes of updating client configuration.</p>
</div>
<div class="paragraph">
<p>One is to submit a complete new state to the server after getting current configuration, saving it into a file, editing it, and posting it back.</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh get myclient &gt; myclient.json
$ vi myclient.json
$ kcreg.sh update myclient -f myclient.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg get myclient &gt; myclient.json
C:\&gt; notepad myclient.json
C:\&gt; kcreg update myclient -f myclient.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way is to fetch current client, set or delete fields on it, and post it back all in one single step.</p>
</div>
<div class="paragraph">
<p>For example, on Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh update myclient -s enabled=false -d redirectUris</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg update myclient -s enabled=false -d redirectUris</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can even use a file that only contains changes to be applied so you don&#8217;t have to specify too many values as arguments.
In this case specify <code>--merge</code> to tell <code>Client Registration CLI</code> that rather than treating JSON file as full
new configuration, it should treat it as a set of attributes to be applied over existing configuration.</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh update myclient --merge -d redirectUris -f mychanges.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg update myclient --merge -d redirectUris -f mychanges.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <code>kcreg update --help</code> for more information about <code>kcreg update</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="deleting-client-configuration"><a class="anchor" href="#deleting-client-configuration"></a>6.4.7. Deleting client configuration</h4>
<div class="paragraph">
<p>You may sometimes also need to delete a client.</p>
</div>
<div class="paragraph">
<p>On Linux:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ kcreg.sh delete myclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\&gt; kcreg delete myclient</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <code>kcreg delete --help</code> for more information about <code>kcreg delete</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_refreshing_invalid_registration_access_tokens"><a class="anchor" href="#_refreshing_invalid_registration_access_tokens"></a>6.4.8. Refreshing Invalid Registration Access Tokens</h4>
<div class="paragraph">
<p>When performing a CRUD operation using <code>--no-config</code> mode, <code>Client Registration CLI</code> can no longer handle Registration Access Tokens for you.
In that case it is possible to lose track of most recently issued Registration Access Token for a client, which makes it impossible to
perform any further CRUD operations on that client without authenticating with account that has 'manage-clients' permissions.</p>
</div>
<div class="paragraph">
<p>If you have permissions, you can issue a new Registration Access Token for the client, and have it printed to stdout or saved to a config
file of your choice. Otherwise you have to ask realm administrator to issue new Registration Access Token for your client, and send it
to you. You can then pass it to any CRUD command via <code>--token</code> option. You can also use <code>kcreg config registration-token</code>
command to save the new token in configuration file, and have <code>Client Registration CLI</code> automatically handle it for you from that point on.</p>
</div>
<div class="paragraph">
<p>See <code>kcreg update-token --help</code> for more information about <code>kcreg update-token</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_2"><a class="anchor" href="#_troubleshooting_2"></a>6.5. Troubleshooting</h3>
<div class="ulist">
<ul>
<li>
<p>Q: When logging in I get an error: <code>Parameter client_assertion_type is missing [invalid_client]</code></p>
<div class="paragraph">
<p>A: Your client is configured with <code>Signed JWT</code> token credentials which means you have to use <code>--keystore</code> parameter when logging in.</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token-exchange"><a class="anchor" href="#_token-exchange"></a>7. Token Exchange</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Keycloak, token exchange is the process of using a set of credentials or token to obtain an entirely different token.
A client may want to invoke on a less trusted application so it may want to downgrade the current token it has.
A client may want to exchange a {project_token} for a token stored for a linked social provider account.
You may want to trust external tokens minted by other Keycloak realms or foreign IDPs. A client may have a need
to impersonate a user.  Here&#8217;s a short summary of the current capabilities of Keycloak around token exchange.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A client can exchange an existing Keycloak token created for a specific client for a new token targeted to a different client</p>
</li>
<li>
<p>A client can exchange an existing Keycloak token for an external token, i.e. a linked Facebook account</p>
</li>
<li>
<p>A client can exchange an external token for a Keycloak token.</p>
</li>
<li>
<p>A client can impersonate a user</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Token exchange in Keycloak is a very loose implementation of the <a href="http://www.ietf.org/id/draft-ietf-oauth-token-exchange-09.txt">OAuth Token Exchange</a> specification at the IETF.
We have extended it a little, ignored some of it, and loosely interpreted other parts of the specification.  It is
a simple grant type invocation on a realm&#8217;s OpenID Connect token endpoint.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/realms/{realm}/protocol/openid-connect/token</pre>
</div>
</div>
<div class="paragraph">
<p>It accepts form parameters (<code>application/x-www-form-urlencoded</code>) as input and the output depends on the type of token you requested an exchange for.
Token exchange is a client endpoint so requests must provide authentication information for the calling client.
Public clients specify their client identifier as a form parameter.  Confidential clients can also use form parameters
to pass their client id and secret, Basic Auth, or however your admin has configured the client authentication flow in your
realm.  Here&#8217;s a list of form parameters</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">client_id</dt>
<dd>
<p><em>REQUIRED MAYBE.</em>  This parameter is required for clients using form parameters for authentication.  If you are using
Basic Auth, a client JWT token, or client cert authentication, then do not specify this parameter.</p>
</dd>
<dt class="hdlist1">client_secret</dt>
<dd>
<p><em>REQUIRED MAYBE</em>.  This parameter is required for clients using form parameters for authentication and using a client secret as a credential.
Do not specify this parameter if client invocations in your realm are authenticated by a different means.</p>
</dd>
<dt class="hdlist1">grant_type</dt>
<dd>
<p><em>REQUIRED.</em>  The value of the parameter must be <code>urn:ietf:params:oauth:grant-type:token-exchange</code>.</p>
</dd>
<dt class="hdlist1">subject_token</dt>
<dd>
<p><em>OPTIONAL.</em>  A security token that represents the identity of the party on behalf of whom the request is being made.  It is required if you are exchanging an existing token for a new one.</p>
</dd>
<dt class="hdlist1">subject_issuer</dt>
<dd>
<p><em>OPTIONAL.</em> Identifies the issuer of the <code>subject_token</code>.  It can be left blank if the token comes from the current realm or if the issuer
can be determined from the <code>subject_token_type</code>.  Otherwise it is required to be specified. Valid values are the alias of an <code>Identity Provider</code> configured for your realm.  Or an issuer claim identifier
configured by a specific <code>Identity Provider</code>.</p>
</dd>
<dt class="hdlist1">subject_token_type</dt>
<dd>
<p><em>OPTIONAL.</em>  This parameter is the type of the token passed with the <code>subject_token</code> parameter.  This defaults
to <code>urn:ietf:params:oauth:token-type:access_token</code> if the <code>subject_token</code> comes from the realm and is an access token.
If it is an external token, this parameter may or may not have to be specified depending on the requirements of the
<code>subject_issuer</code>.</p>
</dd>
<dt class="hdlist1">requested_token_type</dt>
<dd>
<p><em>OPTIONAL.</em> This parameter represents the type of token the client wants to exchange for.  Currently only oauth
and OpenID Connect token types are supported.  The default value for this depends on whether the
is <code>urn:ietf:params:oauth:token-type:refresh_token</code> in which case you will be returned both an access token and refresh
token within the response.  Other appropriate values are <code>urn:ietf:params:oauth:token-type:access_token</code> and <code>urn:ietf:params:oauth:token-type:id_token</code></p>
</dd>
<dt class="hdlist1">audience</dt>
<dd>
<p><em>OPTIONAL.</em>  This parameter specifies the target client you want the new token minted for.</p>
</dd>
<dt class="hdlist1">requested_issuer</dt>
<dd>
<p><em>OPTIONAL.</em>  This parameter specifies that the client wants a token minted by an external provider.  It must
be the alias of an <code>Identity Provider</code> configured within the realm.</p>
</dd>
<dt class="hdlist1">requested_subject</dt>
<dd>
<p><em>OPTIONAL.</em> This specifies a username or user id if your client wants to impersonate a different user.</p>
</dd>
<dt class="hdlist1">scope</dt>
<dd>
<p><em>NOT IMPLEMENTED.</em> This parameter represents the target set of OAuth and OpenID Connect scopes the client
is requesting.  It is not implemented at this time but will be once Keycloak has better support for
scopes in general.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We currently only support OpenID Connect and OAuth exchanges.  Support for SAML based clients and identity providers may be added in the future depending on user demand.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A successful response from an exchange invocation will return the HTTP 200 response code with a content type that
depends on the <code>requested-token-type</code> and <code>requested_issuer</code> the client asks for.  OAuth requested token types will return
a JSON document as described in the <a href="http://www.ietf.org/id/draft-ietf-oauth-token-exchange-09.txt">OAuth Token Exchange</a> specification.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
   "access_token" : ".....",
   "refresh_token" : ".....",
   "expires_in" : "...."
 }</pre>
</div>
</div>
<div class="paragraph">
<p>Clients requesting a refresh token will get back both an access and refresh token in the response.  Clients requesting only
access token type will only get an access token in the response.  Expiration information may or may not be included for
clients requesting a an external issuer through the `requested_issuer`paramater.</p>
</div>
<div class="paragraph">
<p>Error responses generally fall under the 400 HTTP response code category, but other error status codes may be returned
depending on the severity of the error.  Error responses may include content depending on the <code>requested_issuer</code>.
OAuth based exchanges may return a JSON document as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
   "error" : "...."
   "error_description" : "...."
}</pre>
</div>
</div>
<div class="paragraph">
<p>Additional error claims may be returned depending on the exchange type.  For example, OAuth Identity Providers may include
an additional <code>account-link-url</code> claim if the user does not have a link to an identity provider.  This link can be used
for a client initiated link request.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Token exchange setup requires knowledge of fine grain admin permissions (See the <a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a> for more information).  You will need to grant clients
      permission to exchange.  This is discussed more later in this chapter.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The rest of this chapter discusses the setup requirements and provides examples for different exchange scenarios.
For simplicity&#8217;s sake, let&#8217;s call a token minted by the current realm as an <em>internal</em> token and a token minted by
an external realm or identity provider as an <em>external</em> token.</p>
</div>
<div class="sect2">
<h3 id="internal-token-to-internal-token-exchange"><a class="anchor" href="#internal-token-to-internal-token-exchange"></a>7.1. Internal Token to Internal Token Exchange</h3>
<div class="paragraph">
<p>With an internal token to token exchange you have an existing token minted to a specific client and you want to exchange
this token for a new one minted for a different target client.  Why would you want to do this?  This generally happens
when a client has a token minted for itself, and needs to make additional requests to other applications that require different
claims and permissions within the access token.  Other reasons this type of exchange might be required is if you
need to perform a "permission downgrade" where your app needs to invoke on a less trusted app and you don&#8217;t want
to propagate your current access token.</p>
</div>
<div class="sect3">
<h4 id="_client_to_client_permission"><a class="anchor" href="#_client_to_client_permission"></a>7.1.1. Granting Permission for the Exchange</h4>
<div class="paragraph">
<p>Clients that want to exchange tokens for a different client need to be authorized in the admin console to do so.
You&#8217;ll need to define a <code>token-exchange</code> fine grain permission in the target client you want permission to exchange to.</p>
</div>
<div class="paragraph">
<div class="title">Target Client Permission</div>
<p><span class="image"><img src="./keycloak-images/exchange-target-client-permission-unset.png" alt="exchange target client permission unset"></span></p>
</div>
<div class="paragraph">
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
</div>
<div class="paragraph">
<div class="title">Target Client Permission</div>
<p><span class="image"><img src="./keycloak-images/exchange-target-client-permission-set.png" alt="exchange target client permission set"></span></p>
</div>
<div class="paragraph">
<p>You should see a <code>token-exchange</code> link on the page.  Click that to start defining the permission.  It will bring you
to this page.</p>
</div>
<div class="paragraph">
<div class="title">Target Client Exchange Permission Setup</div>
<p><span class="image"><img src="./keycloak-images/exchange-target-client-permission-setup.png" alt="exchange target client permission setup"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to define a policy for this permission.  Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create
a <code>Client</code> Policy.</p>
</div>
<div class="paragraph">
<div class="title">Client Policy Creation</div>
<p><span class="image"><img src="./keycloak-images/exchange-target-client-policy.png" alt="exchange target client policy"></span></p>
</div>
<div class="paragraph">
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange.  After you
create this policy, go back to the target client&#8217;s <code>token-exchange</code> permission and add the client policy you just
defined.</p>
</div>
<div class="paragraph">
<div class="title">Apply Client Policy</div>
<p><span class="image"><img src="./keycloak-images/exchange-target-client-exchange-apply-policy.png" alt="exchange target client exchange apply policy"></span></p>
</div>
<div class="paragraph">
<p>Your client now has permission to invoke.  If you do not do this correctly, you will get a 403 Forbidden response if you
try to make an exchange.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request"><a class="anchor" href="#making-the-request"></a>7.1.2. Making the Request</h4>
<div class="paragraph">
<p>When your client is exchanging an existing token for a token targeting another client, you must use the <code>audience</code> parameter.
This parameter must be the client identifier for the target client that you configured in the admin console.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:refresh_token&quot;
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subject_token</code> parameter must be an access token for the target realm.  If your <code>requested_token_type</code> parameter
is a refresh token type, then the response will contain both an access token, refresh token, and expiration.  Here&#8217;s
an example JSON response you get back from this call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">refresh_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="integer">3600</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="internal-token-to-external-token-exchange"><a class="anchor" href="#internal-token-to-external-token-exchange"></a>7.2. Internal Token to External Token Exchange</h3>
<div class="paragraph">
<p>You can exchange a realm token for an externl token minted by an external identity provider.  This external identity provider
must be configured within the <code>Identity Provider</code> section of the admin console.  Currently only OAuth/OpenID Connect based external
identity providers are supported, this includes all social providers.  Keycloak does not perform a backchannel exchange to the external provider.  So if the account
is not linked, you will not be able to get the external token.  To be able to obtain an external token one of
these conditions must be met:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The user must have logged in with the external identity provider at least once</p>
</li>
<li>
<p>The user must have linked with the external identity provider through the User Account Service</p>
</li>
<li>
<p>The user account was linked through the external identity provider using <a href="http://www.keycloak.org/docs/3.4/server_development/">Client Initiated Account Linking</a> API.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the external identity provider must have been configured to store tokens, or, one of the above actions must
have been performed with the same user session as the internal token you are exchanging.</p>
</div>
<div class="paragraph">
<p>If the account is not linked, the exchange response will contain a link you can use to establish it.  This is
discussed more in the <a href="#_internal_external_making_request">Making the Request</a> section.</p>
</div>
<div class="sect3">
<h4 id="_grant_permission_external_exchange"><a class="anchor" href="#_grant_permission_external_exchange"></a>7.2.1. Granting Permission for the Exchange</h4>
<div class="paragraph">
<p>Internal to external token exchange requests will be denied with a 403, Forbidden response until you grant
permission for the calling client to exchange tokens with the external identity provider.  To grant permission
to the client you must go to the identity provider&#8217;s configuration page to the <code>Permissions</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Identity Provider Permission</div>
<p><span class="image"><img src="./keycloak-images/exchange-idp-permission-unset.png" alt="exchange idp permission unset"></span></p>
</div>
<div class="paragraph">
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
</div>
<div class="paragraph">
<div class="title">Identity Provider Permission</div>
<p><span class="image"><img src="./keycloak-images/exchange-idp-permission-set.png" alt="exchange idp permission set"></span></p>
</div>
<div class="paragraph">
<p>You should see a <code>token-exchange</code> link on the page.  Click that to start defining the permission.  It will bring you
to this page.</p>
</div>
<div class="paragraph">
<div class="title">Identity Provider Exchange Permission Setup</div>
<p><span class="image"><img src="./keycloak-images/exchange-idp-permission-setup.png" alt="exchange idp permission setup"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to define a policy for this permission.  Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create
a <code>Client</code> Policy.</p>
</div>
<div class="paragraph">
<div class="title">Client Policy Creation</div>
<p><span class="image"><img src="./keycloak-images/exchange-idp-client-policy.png" alt="exchange idp client policy"></span></p>
</div>
<div class="paragraph">
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange.  After you
create this policy, go back to the identity providers&#8217;s <code>token-exchange</code> permission and add the client policy you just
defined.</p>
</div>
<div class="paragraph">
<div class="title">Apply Client Policy</div>
<p><span class="image"><img src="./keycloak-images/exchange-idp-apply-policy.png" alt="exchange idp apply policy"></span></p>
</div>
<div class="paragraph">
<p>Your client now has permission to invoke.  If you do not do this correctly, you will get a 403 Forbidden response if you
try to make an exchange.</p>
</div>
</div>
<div class="sect3">
<h4 id="_internal_external_making_request"><a class="anchor" href="#_internal_external_making_request"></a>7.2.2. Making the Request</h4>
<div class="paragraph">
<p>When your client is exchanging an existing internal token to an external one, you must provide the
<code>requested_issuer</code> parameter.  The parameter must be the alias of a configured identity provider.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:refresh_token&quot;
    -d &quot;requested_issuer=google&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>subject_token</code> parameter must be an access token for the target realm.  The <code>requested_token_type</code> parameter
must be <code>urn:ietf:params:oauth:token-type:access_token</code> or left blank.  No other requested token type is supported
at this time.  Here&#8217;s
an example successful JSON response you get back from this call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="integer">3600</span>
   <span class="key"><span class="delimiter">&quot;</span><span class="content">account-link-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">https://....</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the external identity provider is not linked for whatever reason, you will get an HTTP 400 response code with
this JSON document:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">error_description</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>
   <span class="key"><span class="delimiter">&quot;</span><span class="content">account-link-url</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">https://....</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>error</code> claim will be either <code>token_expired</code> or <code>not_linked</code>.  The <code>account-link-url</code> claim is provided
so that the client can perform <a href="http://www.keycloak.org/docs/3.4/server_development/">Client Initiated Account Linking</a>.  Most (all?)
providers are requiring linking through browser OAuth protocol.  With the <code>account-link-url</code> just add a <code>redirect_uri</code>
query parameter to it and you can forward browsers to perform the link.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="external-token-to-internal-token-exchange"><a class="anchor" href="#external-token-to-internal-token-exchange"></a>7.3. External Token to Internal Token Exchange</h3>
<div class="paragraph">
<p>You can trust and exchange external tokens minted by external identity providers for internal tokens.  This can be
used to bridge between realms or just to trust tokens from your social provider.  It works similarly to an identity provider
browser login in that a new user is imported into your realm if it doesn&#8217;t exist.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The current limitation on external token exchanges is that if the external token maps to an existing user an
       exchange will not be allowed unless the existing user already has an account link to the external identity
       provider.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the exchange is complete, a user session will be created within the realm, and you will receive an access
and or refresh token depending on the <code>requested_toke_type</code> parameter value.  You should note that this new
user session will remain active until it times out or until you call the logout endpoint of the realm passing this
new access token.</p>
</div>
<div class="paragraph">
<p>These types of changes required a configured identity provider in the admin console.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
SAML identity providers are not supported at this time.  Twitter tokens cannot be exchanged either.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="granting-permission-for-the-exchange"><a class="anchor" href="#granting-permission-for-the-exchange"></a>7.3.1. Granting Permission for the Exchange</h4>
<div class="paragraph">
<p>Before external token exchanges can be done, you must grant permission for the calling client to make the exchange.  This
permission is granted in the same manner as <a href="#_grant_permission_external_exchange">interal to external permission is granted</a>.</p>
</div>
<div class="paragraph">
<p>If you also provide an <code>audience</code> parameter whose value points to a different client other than the calling one, you
must also grant the calling client permission to exchange to the target client specific in the <code>audience</code> parameter.  How
to do this is <a href="#_client_to_client_permission">discussed earlier</a> in this section.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request-2"><a class="anchor" href="#making-the-request-2"></a>7.3.2. Making the Request</h4>
<div class="paragraph">
<p>The <code>subject_token_type</code> must either be <code>urn:ietf:params:oauth:token-type:access_token</code> or <code>urn:ietf:params:oauth:token-type:jwt</code>.
If the type is <code>urn:ietf:params:oauth:token-type:access_token</code> you must specify the <code>subject_issuer</code> parameter and it must be the
alias of the configured identity provider.  If the type is <code>urn:ietf:params:oauth:token-type:jwt</code>, the provider will be matched via
the <code>issuer</code> claim within the JWT which must be the alias of the provider, or a registered issuer within the providers configuration.</p>
</div>
<div class="paragraph">
<p>For validation, if the token is an access token, the provider&#8217;s user info service will be invoked to validate the token.  A successful call
will mean that the access token is valid.  If the subject token is a JWT and if the provider has signature validation enabled, that will be attempted,
otherwise, it will default to also invoking on the user info service to validate the token.</p>
</div>
<div class="paragraph">
<p>By default, the internal token minted will use the calling client to determine what&#8217;s in the token using the protocol
mappers defined for the calling client.  Alternatively, you can specify a different target client using the <code>audience</code>
parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    -d &quot;subject_issuer=myOidcProvider&quot; \
    --data-urlencode &quot;subject_token_type=urn:ietf:params:oauth:token-type:access_token&quot;
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your <code>requested_token_type</code> parameter
is a refresh token type, then the response will contain both an access token, refresh token, and expiration.  Here&#8217;s
an example JSON response you get back from this call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
   <span class="key"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">refresh_token</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">....</span><span class="delimiter">&quot;</span></span>,
   <span class="key"><span class="delimiter">&quot;</span><span class="content">expires_in</span><span class="delimiter">&quot;</span></span> : <span class="integer">3600</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="impersonation"><a class="anchor" href="#impersonation"></a>7.4. Impersonation</h3>
<div class="paragraph">
<p>For internal and external token exchanges, the client can request on behalf of a user to impersonate a different user.
For example, you may have an admin application that needs to impersonate a user so that a support engineer can debug
a problem.</p>
</div>
<div class="sect3">
<h4 id="granting-permission-for-the-exchange-2"><a class="anchor" href="#granting-permission-for-the-exchange-2"></a>7.4.1. Granting Permission for the Exchange</h4>
<div class="paragraph">
<p>The user that the subject token represents must have permission to impersonate other users.  See the
<a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a> on how to enable this permission.  It can be done through a role or through
fine grain admin permissions.</p>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request-3"><a class="anchor" href="#making-the-request-3"></a>7.4.2. Making the Request</h4>
<div class="paragraph">
<p>Make the request as described in other chapters except additionally specify the <code>request_subject</code> parameter.  The
value of this parameter must be a username or user id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="direct-naked-impersonation"><a class="anchor" href="#direct-naked-impersonation"></a>7.5. Direct Naked Impersonation</h3>
<div class="paragraph">
<p>You can make an internal token exchange request without providing a <code>subject_token</code>.  This is called a direct
naked impersonation because it places a lot of trust in a client as that client can impersonate any user in the realm.
You might need this to bridge for applications where it is impossible to obtain a subject token to exchange.  For example,
you may be integrating a legacy application that performs login directly with LDAP.  In that case, the legacy app
is able to authenticate users itself, but not able to obtain a token.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It is very risky to enable direct naked impersonation for a client.  If the client&#8217;s credentials are ever
         stolen, that client can impersonate any user in the system.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="granting-permission-for-the-exchange-3"><a class="anchor" href="#granting-permission-for-the-exchange-3"></a>7.5.1. Granting Permission for the Exchange</h4>
<div class="paragraph">
<p>If the <code>audience</code> parameter is provided, then the calling client must have permission to exchange to the client.  How
to set this up is discussed earlier in this chapter.</p>
</div>
<div class="paragraph">
<p>Additionally, the calling client must be granted permission to impersonate users.  In the admin console, go to the
<code>Users</code> screen and click on the <code>Permissions</code> tab.</p>
</div>
<div class="paragraph">
<div class="title">Users Permission</div>
<p><span class="image"><img src="./keycloak-images/exchange-users-permission-unset.png" alt="exchange users permission unset"></span></p>
</div>
<div class="paragraph">
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
</div>
<div class="paragraph">
<div class="title">Identity Provider Permission</div>
<p><span class="image"><img src="./keycloak-images/exchange-users-permission-set.png" alt="exchange users permission set"></span></p>
</div>
<div class="paragraph">
<p>You should see a <code>impersonation</code> link on the page.  Click that to start defining the permission.  It will bring you
to this page.</p>
</div>
<div class="paragraph">
<div class="title">Users Impersonation Permission Setup</div>
<p><span class="image"><img src="./keycloak-images/exchange-users-permission-setup.png" alt="exchange users permission setup"></span></p>
</div>
<div class="paragraph">
<p>You&#8217;ll have to define a policy for this permission.  Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create
a <code>Client</code> Policy.</p>
</div>
<div class="paragraph">
<div class="title">Client Policy Creation</div>
<p><span class="image"><img src="./keycloak-images/exchange-users-client-policy.png" alt="exchange users client policy"></span></p>
</div>
<div class="paragraph">
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange.  After you
create this policy, go back to the users' <code>impersonation</code> permission and add the client policy you just
defined.</p>
</div>
<div class="paragraph">
<div class="title">Apply Client Policy</div>
<p><span class="image"><img src="./keycloak-images/exchange-users-apply-policy.png" alt="exchange users apply policy"></span></p>
</div>
<div class="paragraph">
<p>Your client now has permission to impersonate users.  If you do not do this correctly, you will get a 403 Forbidden response if you
try to make this type of exchange.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Public clients are not allowed to do direct naked impersonations.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="making-the-request-4"><a class="anchor" href="#making-the-request-4"></a>7.5.2. Making the Request</h4>
<div class="paragraph">
<p>To make the request, simply specify the <code>requested_subject</code> parameter.  This must be the username or user id of
a valid user.  You can also specify an <code>audience</code> parameter if you wish.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="expand-permission-model-with-service-accounts"><a class="anchor" href="#expand-permission-model-with-service-accounts"></a>7.6. Expand Permission Model With Service Accounts</h3>
<div class="paragraph">
<p>When granting clients permission to exchange, you don&#8217;t necessarily have to manually enable those permissions for each and every client.
If the client has a service account associated with it, you can use a role to group permissions together and assign exchange permissions
by assigning a role to the client&#8217;s service account.  For example, you might define a <code>naked-exchange</code> role and any service account that has that
role can do a naked exchange.</p>
</div>
</div>
<div class="sect2">
<h3 id="exchange-vulnerabilities"><a class="anchor" href="#exchange-vulnerabilities"></a>7.7. Exchange Vulnerabilities</h3>
<div class="paragraph">
<p>When you start allowing token exchanges, there&#8217;s various things you have to both be aware of and careful of.</p>
</div>
<div class="paragraph">
<p>The first is public clients.  Public clients do not have or require a client credential in order to perform an exchange.  Anybody that has a valid
token will be able to <em>impersonate</em> the public client and perform the exchanges that public client is allowed to perform.  If there
are any untrustworthy clients that are managed by your realm, public clients may open up vulnerabilities in your permission models.
This is why direct naked exchanges do not allow public clients and will abort with an error if the calling client is public.</p>
</div>
<div class="paragraph">
<p>It is possible to exchange social tokens provided by Facebook, Google, etc. for a realm token.  Be careful and vigilante on what
the exchange token is allowed to do as its not hard to create fake accounts on these social websites.  Use default roles, groups, and identity provider mappers to control what attributes and roles
are assigned to the external social user.</p>
</div>
<div class="paragraph">
<p>Direct naked exchanges are quite dangerous.  You are putting a lot of trust in the calling client that it will never leak out
its client credentials.  If those credentials are leaked, then the thief can impersonate anybody in your system.  This is in direct
contrast to confidential clients that have existing tokens.  You have two factors of authentication, the access token and the client
credentials, and you&#8217;re only dealing with one user.  So use direct naked exchanges sparingly.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-12-06 12:00:10 JST
</div>
</div>
<ul id="globalnav">
    <li><a href="../getting_started/index.html">Getting Started</a></li>
    <li><a href="../server_installation/index.html">Server Installation</a></li>
    <li><a href="../securing_apps/index.html">Securing Apps</a></li>
    <li><a href="../server_admin/index.html">Server Admin</a></li>
    <li><a href="../server_development/index.html">Server Development</a></li>
    <li><a href="../authorization_services/index.html">Authorization Services</a></li>
    <li><a href="../upgrading/index.html">Upgrading</a></li>
</ul>
</body>
</html>